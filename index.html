<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>çˆ±çš„å®ˆæŠ¤</title>
    <style>
        html, body {
            margin: 0; 
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: fixed;
            top: 0;
            left: 0;
        }
        
        body {
            background: linear-gradient(rgb(255, 154, 158), rgb(250, 208, 196)); /* é»˜è®¤é»‘åº•ï¼Œå®é™…ç”±Canvasç»˜åˆ¶ */
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
            user-select: none; 
            touch-action: none;
        }
        
        #gameCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: block;
            z-index: 1;
        }

        /* é®ç½©å±‚é€šç”¨ */
        .overlay-screen {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100vw; 
            height: 100vh;
            margin: 0;
            padding: 20px; 
            box-sizing: border-box;
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center;
            z-index: 100; 
            transition: opacity 0.3s;
        }

        /* === é¦–é¡µæ ·å¼ä¿®æ”¹ï¼šå˜ä¸ºé€æ˜ï¼Œè®©CanvasèƒŒæ™¯é€å‡ºæ¥ === */
        #start-screen {
            background: rgba(255, 255, 255, 0.1); /* ææ·¡çš„é®ç½©ï¼Œå‡¸æ˜¾èƒŒæ™¯é±¼ */
            backdrop-filter: blur(2px); /* è½»å¾®æ¨¡ç³Šï¼Œè®©æ–‡å­—æ›´æ¸…æ™° */
        }

        /* æ¸¸æˆä¸­çš„é®ç½© (æš‚åœ/ç»“æŸ) ä¿æŒä¸é€æ˜åº¦é«˜ä¸€ç‚¹ */
        .game-overlay {
            background: rgba(255, 255, 255, 0.92);
            color: #d63384;
            backdrop-filter: blur(8px);
        }

        h1 {
            font-size: 40px; margin-bottom: 10px; text-align: center; font-weight: 900;
            color: #fff;
            /* å¼ºåŠ›æ–‡å­—æè¾¹å’Œé˜´å½±ï¼Œç¡®ä¿åœ¨åŠ¨æ€èƒŒæ™¯ä¸Šæ¸…æ™°å¯è§ */
            text-shadow: 0 0 10px rgba(255,105,180, 0.8), 2px 2px 0px rgba(0,0,0,0.2);
            letter-spacing: 2px;
        }

        /* é¦–é¡µæè¿°æ–‡å­—ï¼šåŠ ä¸ªåŠé€æ˜åº•ï¼Œé˜²çœ‹ä¸æ¸… */
        #start-desc {
            font-size: 16px; color: #fff; text-align: center;
            margin-bottom: 30px; line-height: 1.8; max-width: 90%;
            background: rgba(0,0,0,0.2);
            padding: 10px 20px;
            border-radius: 15px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            font-weight: 500;
            min-height: 60px;
            display: flex; align-items: center; justify-content: center;
        }

        .hint { font-size: 14px; color: #ff758c; background: #fff0f5; padding: 5px 10px; border-radius: 10px; margin-bottom: 20px;}

        .btn-group { display: flex; flex-direction: column; gap: 15px; width: 80%; max-width: 300px; padding-bottom: 20px;}

        button {
            padding: 15px 10px; font-size: 18px; border: none; border-radius: 50px;
            cursor: pointer; font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: transform 0.1s;
            color: white; outline: none; -webkit-tap-highlight-color: transparent;
            border: 1px solid rgba(255,255,255,0.4);
        }
        button:active { transform: scale(0.96); }

        .btn-easy { background: linear-gradient(45deg, #a8e063, #56ab2f); }
        .btn-normal { background: linear-gradient(45deg, #ff9a9e, #fecfef); color: #c71585; }
        .btn-hard { background: linear-gradient(45deg, #ff512f, #dd2476); }

        .btn-restart { background: #fff; border: 2px solid #ff758c; color: #ff758c; margin-top: 20px; width: 60%;}
        .btn-resume { background: linear-gradient(45deg, #4facfe, #00f2fe); color: white; }
        .btn-quit { background: #fff; border: 2px solid #999; color: #999; }

        #ui-layer {
            position: absolute;
            top: max(15px, env(safe-area-inset-top)); left: max(15px, env(safe-area-inset-left));
            width: calc(100% - 80px); pointer-events: none; z-index: 50;
        }

        .score-text { color: #d63384; font-weight: bold; font-size: 18px; text-shadow: 1px 1px 0px rgba(255,255,255,0.8); }
        .sub-text { font-size: 12px; opacity: 0.8; margin-top:5px; color:#666; }

        #pause-btn {
            position: absolute;
            top: max(15px, env(safe-area-inset-top)); right: max(15px, env(safe-area-inset-right));
            width: 45px; height: 45px; border-radius: 50%;
            background: rgba(255, 255, 255, 0.6); border: 2px solid #fff;
            color: #ff758c; font-size: 20px;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; pointer-events: auto; z-index: 60;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .floating-text {
            position: absolute; font-weight: bold; font-size: 20px;
            pointer-events: none; animation: floatUp 1.5s ease-out forwards;
            text-shadow: 1px 1px 2px white; white-space: nowrap; z-index: 55;
        }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-50px) scale(1.2); } }

        #buff-bar { margin-top: 8px; display: flex; gap: 8px; }
        .buff-icon {
            width: 24px; height: 24px; border-radius: 50%; font-size: 14px;
            display: flex; justify-content: center; align-items: center;
            color: white; box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }

        #fever-container {
            margin-top: 8px; width: 150px; height: 12px;
            background: rgba(255,255,255,0.6); border-radius: 10px;
            overflow: hidden; border: 2px solid #ff758c; position: relative;
        }
        #fever-bar {
            width: 0%; height: 100%; background: linear-gradient(90deg, #ff9a9e, #ff0055); transition: width 0.2s;
        }
        #fever-text { position: absolute; top: -18px; left: 0; font-size: 11px; color: #ff0055; font-weight: bold; text-shadow: 0 0 2px white; }

        .fever-mode-bg { animation: rainbowBorder 1s infinite; }
        @keyframes rainbowBorder {
            0% { box-shadow: inset 0 0 20px #ff0000; } 50% { box-shadow: inset 0 0 20px #00ffff; } 100% { box-shadow: inset 0 0 20px #ff00ff; }
        }

        #unlock-msg {
            position: absolute; top: 20%; width: 100%; text-align: center;
            font-size: 24px; color: #ff4081; font-weight: bold; text-shadow: 2px 2px 0 #fff;
            opacity: 0; pointer-events: none; z-index: 60; transition: opacity 0.5s;
        }

        #event-banner {
            position: absolute; top: 150px; width: 100%; text-align: center;
            pointer-events: none; z-index: 55; opacity: 0; transition: opacity 0.5s;
        }
        .event-title { font-size: 28px; font-weight: 900; color: #fff; text-shadow: 0 0 10px #ff0055; margin-bottom: 5px; }
        .event-desc { font-size: 16px; color: #fff; text-shadow: 1px 1px 2px #000; background: rgba(0,0,0,0.4); display: inline-block; padding: 5px 15px; border-radius: 20px;}
    </style>
</head>
<body>

<div id="particles-container"></div>
<div id="unlock-msg">âš ï¸ æ–°æŒ‘æˆ˜å‡ºç°! âš ï¸</div>

<div id="event-banner">
    <div class="event-title" id="event-title">âš¡ äº‹ä»¶å‘ç”Ÿ âš¡</div>
    <div class="event-desc" id="event-desc">æè¿°æ–‡å­—</div>
</div>

<div id="ui-layer" style="display:none;">
    <div class="score-text">æ‹çˆ±æŒ‡æ•°: <span id="score">0</span> â¤ï¸</div>
    <div class="sub-text">æˆ‘ä»¬åœ¨ä¸€èµ·: <span id="size-display">1</span> å¤©</div>
    <div style="margin-top:12px; position:relative;">
        <div id="fever-text">å¿ƒåŠ¨å€¼ ğŸ’– (åƒçˆ±å¿ƒå¢åŠ )</div>
        <div id="fever-container"><div id="fever-bar"></div></div>
    </div>
    <div id="buff-bar"></div>
</div>

<button id="pause-btn" style="display:none;" onclick="pauseGame(event)">â¸</button>

<!-- å¼€å§‹ç•Œé¢ (èƒŒæ™¯é€æ˜ï¼Œæ˜¾ç¤ºCanvas) -->
<div id="start-screen" class="overlay-screen">
    <h1>ğŸ’– çˆ±çš„å®ˆæŠ¤ ğŸ’–</h1>
    <p id="start-desc">æ­£åœ¨åŠ è½½çˆ±çš„èª“è¨€...</p>
    <div class="btn-group">
        <button class="btn-easy" onclick="startGame('easy')">ğŸ° ç”œèœœçº¦ä¼š (ç®€å•)</button>
        <button class="btn-normal" onclick="startGame('normal')">ğŸ  å¹¸ç¦æ—¥å¸¸ (æ™®é€š)</button>
        <button class="btn-hard" onclick="startGame('hard')">ğŸ›¡ï¸ å®ˆæŠ¤ä¸€ç”Ÿ (å›°éš¾)</button>
    </div>
</div>

<!-- æš‚åœç•Œé¢ -->
<div id="pause-screen" class="overlay-screen game-overlay" style="display: none;">
    <h2 style="color:#ff758c;">æ¸¸æˆæš‚åœ</h2>
    <div class="btn-group">
        <button class="btn-resume" onclick="resumeGame()">â–¶ ç»§ç»­çˆ±</button>
        <button class="btn-quit" onclick="quitGameFromPause()">âœ– ä¼‘æ¯ä¸€ä¸‹ (ç»“æŸ)</button>
    </div>
</div>

<!-- ç»“æŸç•Œé¢ -->
<div id="game-over-screen" class="overlay-screen game-overlay" style="display: none;">
    <h2 style="font-size: 28px; color: #ff5858;">åˆ«æ€•ï¼Œèªä»”åœ¨å‘¢</h2>
    <p id="death-reason" style="font-size: 16px;">å¦‚æœä¸å¼€å¿ƒäº†ï¼Œæˆ‘æ¥å“„ä½ ~</p>
    <p style="font-size: 20px;">æ”¶è·çˆ±å¿ƒ: <span id="final-score" style="color: #ff4081; font-weight:bold;">0</span></p>
    <button class="btn-restart" onclick="showStartScreen()">å†çˆ±ä¸€æ¬¡</button>
</div>

<canvas id="gameCanvas"></canvas>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const uiLayer = document.getElementById('ui-layer');
    const buffBar = document.getElementById('buff-bar');
    const pauseBtn = document.getElementById('pause-btn');
    const startScreen = document.getElementById('start-screen');
    const startDesc = document.getElementById('start-desc');
    const gameOverScreen = document.getElementById('game-over-screen');
    const pauseScreen = document.getElementById('pause-screen');
    const scoreEl = document.getElementById('score');
    const sizeEl = document.getElementById('size-display');
    const finalScoreEl = document.getElementById('final-score');
    const deathReasonEl = document.getElementById('death-reason');
    const particlesContainer = document.getElementById('particles-container');
    const feverBar = document.getElementById('fever-bar');
    const unlockMsg = document.getElementById('unlock-msg');
    const eventBanner = document.getElementById('event-banner');
    const eventTitle = document.getElementById('event-title');
    const eventDesc = document.getElementById('event-desc');
    const body = document.body;

    const input = { x: 0, y: 0 };
    let animationId;
    let score = 0;
    let gameRunning = false;
    let isPaused = false;
    let frameCount = 0;
    let currentDifficulty = {};
    let currentDifficultyName = '';
    let feverValue = 0;
    let isFeverMode = false;
    let feverTimer = 0;
    let unlockedStages = { 500: false, 1000: false, 2000: false, 3000: false };

    // é¦–é¡µæ°›å›´å…ƒç´ 
    let ambientFish = [];
    let ambientBubbles = [];

    let currentEvent = null;
    let eventTimer = 0;
    let nextEventCooldown = 600;
    let currentForce = { x: 0, y: 0 };
    let flowParticles = [];
    
    // æ¸¸æˆä¸­çš„æ°”æ³¡ç³»ç»Ÿ
    let gameBubbles = [];
    let lightRays = []; // å…‰æ–‘æ•ˆæœ
    let particles = []; // ç²’å­ç‰¹æ•ˆ
    let comboCount = 0; // è¿å‡»æ•°
    let comboTimer = 0; // è¿å‡»è®¡æ—¶å™¨
    let screenShake = { x: 0, y: 0, intensity: 0 }; // å±å¹•éœ‡åŠ¨
    let scoreAnimations = []; // åˆ†æ•°åŠ¨ç”»

    const LOVE_WORDS = ["çˆ±ä½ ", "æŠ±æŠ±", "æƒ³ä½ ", "äº²äº²", "ä¹–å®", "çœŸæ£’", "å¥½å¯çˆ±", "ç¾ç¾å“’", "è´´è´´", "Love U"];

    const START_QUOTES = [
        // === â¤ï¸ æ·±æƒ…å‘Šç™½ç¯‡ ===
        "è¿·é›¾ä¸­ï¼Œèªä»”æ˜¯å”¯ä¸€çš„ç¯å¡”ã€‚<br>æ²¡æœ‰ä»–ï¼Œä¸–ç•Œå°†ä¸€ç‰‡æ¼†é»‘ã€‚",
        "è¿™ä¸ä»…ä»…æ˜¯ä¸€ä¸ªæ¸¸æˆã€‚<br>è¿™æ˜¯æˆ‘æƒ³ä¸€ç›´å®ˆæŠ¤ä½ çš„å†³å¿ƒã€‚",
        "ä¸ç®¡ä¸–ç•Œå˜å¾—å¤šå¿«ï¼Œ<br>èªä»”æ°¸è¿œæ¸¸åœ¨ä½ èº«ååŠæ­¥çš„è·ç¦»ã€‚",
        "çˆ±ä¸æ˜¯ä¸å—ä¼¤ï¼Œ<br>è€Œæ˜¯å—ä¼¤æ—¶ï¼Œæœ‰äººæ›¿ä½ æŒ¡åœ¨èº«å‰ã€‚",
        "è™½ç„¶æˆ‘ä»¬åªæ˜¯å°å°çš„é±¼ï¼Œ<br>ä½†æˆ‘ä»¬çš„çˆ±å¯ä»¥å¡«æ»¡æ•´ç‰‡æµ·æ´‹ã€‚",
        "èªä»”å˜å°äº†ä¹Ÿæ²¡å…³ç³»ï¼Œ<br>åªè¦ä½ å¹³å®‰é•¿å¤§ï¼Œä¸€åˆ‡éƒ½å€¼å¾—ã€‚",
        "ä½ æ˜¯ç²‰è‰²çš„æ¢¦ï¼Œ<br>æˆ‘æ˜¯å®ˆæŠ¤è¿™æ¢¦å¢ƒçš„è“è‰²éª‘å£«ã€‚",
        "æ¯ä¸€æ¬¡[é‡æ¥]ï¼Œ<br>éƒ½æ˜¯ä¸ºäº†å†ä¸€æ¬¡ä¸ä½ ç›¸é‡ã€‚",

        // === ğŸŒŠ ç”Ÿå­˜å“²å­¦ç¯‡ ===
        "ç”Ÿæ´»å°±åƒé€†æ°´è¡ŒèˆŸã€‚<br>é‡åˆ°[æ¿€æµ]æ—¶ï¼Œè¦ç”¨åŠ›é€†é£å‰è¡Œå“¦ï¼",
        "[å†·æˆ˜]è™½ç„¶ä¸ä¼šè‡´å‘½ï¼Œ<br>ä½†é‚£ç§å‡å›ºçš„ç©ºæ°”è®©äººå¯¸æ­¥éš¾è¡Œã€‚",
        "é‚£äº›[åæƒ…ç»ª]å°±åƒæ°”æ³¡ï¼Œ<br>ç­‰ä½ é•¿å¤§äº†ï¼Œè½»è½»ä¸€ç¢°å°±ç¢äº†ã€‚",
        "åˆ«è¢«[çƒ‚æ¡ƒèŠ±]å’Œ[å«‰å¦’]ç»Šå€’ã€‚<br>ä½ å€¼å¾—æ‹¥æœ‰æœ€å¥½çš„çˆ±å¿ƒå’Œæ˜Ÿæ˜Ÿï¼",
        "çœŸæ­£çš„å®ˆæŠ¤ï¼Œä¸æ˜¯æŠŠä½ å…³åœ¨æ¸©å®¤ï¼Œ<br>è€Œæ˜¯é™ªä½ ä»æµ…æµ·æ¸¸å‘æ·±æ¸Šã€‚",
        "å½“å·¨å¤§çš„[ç°å®å‹åŠ›]é€¼è¿‘æ—¶ï¼Œ<br>èº²é¿å¹¶ä¸å¯è€»ï¼Œæ˜¯ä¸ºäº†æ›´å¥½åœ°ç”Ÿå­˜ã€‚",
        "æœ‰äº›è·¯åªèƒ½ä¸€ä¸ªäººèµ°ï¼Œ<br>ä½†åœ¨å¿ƒé‡Œï¼Œæˆ‘ä»¬ä»æœªåˆ†å¼€ã€‚",
        "å“ªæ€•è¦åœ¨é»‘æš—çš„[å›°éš¾æ¨¡å¼]é‡Œæ‘¸ç´¢ï¼Œ<br>ä¹Ÿè¦ç›¸ä¿¡å…‰å°±åœ¨å‰æ–¹ã€‚",

        // === ğŸ® ç¡¬æ ¸æ”»ç•¥ç¯‡ ===
        "å¼€å±€å°±èƒ½åƒæ‰ç»¿è‰²çš„[çç¢ğŸ¦ ]å“¦ï¼<br>æ…¢æ…¢é•¿å¤§ï¼Œå†å»æŒ‘æˆ˜æ›´å¤§çš„å›°éš¾ã€‚",
        "å›°éš¾æ¨¡å¼ä¸‹ï¼Œ[æŠ¤èº«ç¬¦ğŸ›¡ï¸]æ˜¯ 1% çš„å¥‡è¿¹ã€‚<br>ä½†åªè¦æœ‰çˆ±ï¼Œæˆ‘ä»¬æ— æ‰€ç•æƒ§ã€‚",
        "å½“[è¿·é›¾]é™ä¸´æ—¶ï¼Œåˆ«å®³æ€•ã€‚<br>ç´§ç´§è·Ÿç€èªä»”ï¼Œåˆ«èµ°ä¸¢äº†ï¼",
        "æƒ³è¦[æ— æ•Œçˆ†å‘]å—ï¼Ÿ<br>åªæœ‰æ”¶é›†ç²‰è‰²çš„çˆ±å¿ƒæ‰èƒ½ç§¯æ”’å¿ƒåŠ¨å€¼ï¼",
        "å¦‚æœä¸å°å¿ƒè¢«[å†°å†»]äº†ï¼Œ<br>è®°å¾—èº²åœ¨èªä»”èº«åï¼Œç­‰æ˜¥æš–èŠ±å¼€ã€‚",
        "[å¹¸è¿æ˜ŸğŸŒŸ]æ˜¯å¯é‡ä¸å¯æ±‚çš„ï¼Œ<br>å°±åƒé‚£ä¸ªå¯¹çš„äººï¼Œé‡åˆ°äº†å°±åˆ«æ”¾æ‰‹ã€‚",
        "åˆ«å¿˜äº†åƒ[ç”œèœœç³–æœğŸ¬]ï¼Œ<br>é‚£æ˜¯ç”Ÿæ´»å¶å°”ç»™ä½ çš„å°ç¡®å¹¸ã€‚",
        "é‡åˆ°[ç£é“ğŸ§²]æ—¶ï¼Œ<br>ä¹Ÿæ˜¯æˆ‘ä»¬åŒå‘å¥”èµ´æœ€å¿«çš„æ—¶å€™ï¼",
        "å°å¿ƒé‚£åªé»‘è‰²çš„[ç„¦è™‘]ï¼Œ<br>å®ƒæ¸¸å¾—å¾ˆå¿«ï¼Œåˆ«è®©å®ƒè¿½ä¸Šä½ ã€‚",
        "[äº‰åµ]æ€»æ˜¯æ¥å¾—å¿«å»å¾—å¿«ï¼Œ<br>ä½†åœ¨é‚£ä¹‹å‰ï¼Œè¯·å…ˆé¿å…¶é”‹èŠ’ã€‚"
    ];

    const DIFFICULTY_SETTINGS = {
        'easy':   {
            spawnRate: 40, speedMultiplier: 0.6, feverFactor: 2.0,
            fogRadius: 80, weights: [0.6, 0.3, 0.1],
            eventProb: { fog: 0.3, current: 0.3, starfall: 0.4 }
        },
        'normal': {
            spawnRate: 45, speedMultiplier: 0.9, feverFactor: 1.0,
            fogRadius: 50, weights: [0.4, 0.2, 0.4],
            eventProb: { fog: 0.4, current: 0.4, starfall: 0.2 }
        },
        'hard':   {
            spawnRate: 25, speedMultiplier: 1.4, feverFactor: 0.3,
            fogRadius: 18, weights: [0.08, 0.02, 0.90], // åé±¼æƒé‡é«˜ï¼Œä½†é€šè¿‡åˆ†æ•°æ§åˆ¶å¤§é±¼å‡ºç°é¢‘ç‡
            eventProb: { fog: 0.5, current: 0.45, starfall: 0.05 }
        }
    };

    const GAME_OBJECTS = {
        good: [
            { type: 'heart', r: 8, color: '#ff4081', score: 10, fever: 2, speed: [1, 2], name: 'å°æƒŠå–œ', minScore: 0 },
            { type: 'heart', r: 15, color: '#ff0055', score: 20, fever: 5, speed: [1.5, 2.5], name: 'å¤§ç¤¼ç‰©', minScore: 100 },
            { type: 'heart', subtype: 'star', r: 12, color: '#FFD700', score: 50, fever: 15, speed: [3, 5], name: 'å¹¸è¿æ˜Ÿ', minScore: 300 },
            { type: 'heart', subtype: 'diamond', r: 20, color: '#E0FFFF', score: 500, fever: 100, speed: [4, 6], name: 'æ°¸æ’é’»æˆ’', minScore: 2500, rarity: 0.01 }
        ],
        buff: [
            { type: 'buff', subtype: 'candy', r: 12, color: '#FFD700', speed: [1, 1.5], name: 'ç”œèœœç³–æœ', minScore: 0 },
            { type: 'buff', subtype: 'summon', r: 14, color: '#00BFFF', speed: [1, 1.5], name: 'æŠ¤èº«ç¬¦', minScore: 0 },
            { type: 'buff', subtype: 'magnet', r: 12, color: '#FF6347', speed: [1, 1.5], name: 'åŒå‘å¥”èµ´', minScore: 100 },
            { type: 'buff', subtype: 'hunter', r: 13, color: '#00CED1', speed: [1, 1.5], name: 'èªä»”å‡ºå‡»', minScore: 200 }
        ],
        bad: [
            // æ—©æœŸå‡ºç°çš„å„ç§å°é±¼ï¼Œä¸°å¯Œé¢œè‰²å’Œç±»å‹
            { type: 'bad', subtype: 'tiny', r: 6, color: '#AED581', speed: [1, 1.5], name: 'çç¢', minScore: 0 },
            { type: 'bad', subtype: 'normal', r: 12, color: '#8BC34A', speed: [2, 3], name: 'å°æ‘©æ“¦', minScore: 0 },
            { type: 'bad', subtype: 'goldfish', r: 10, color: '#FFA500', speed: [1.5, 2.5], name: 'å°å›°æ‰°', minScore: 0 },
            { type: 'bad', subtype: 'clownfish', r: 8, color: '#FF6347', speed: [2, 3], name: 'å°éº»çƒ¦', minScore: 0 },
            { type: 'bad', subtype: 'tropical', r: 9, color: '#FF69B4', speed: [2, 3.5], name: 'å°æ³¢æŠ˜', minScore: 0 },
            { type: 'bad', subtype: 'angelfish', r: 11, color: '#FFD700', speed: [1.8, 2.8], name: 'å°æ’æ›²', minScore: 0 },
            
            // ä¸­ç­‰å¤§å°çš„é±¼ï¼ˆr: 20-30ï¼‰ï¼Œ50-200åˆ†é˜¶æ®µ
            { type: 'bad', subtype: 'normal', r: 25, color: '#9E9E9E', speed: [1.5, 2.5], name: 'åæƒ…ç»ª', minScore: 50 },
            { type: 'bad', subtype: 'goldfish', r: 22, color: '#FF8C00', speed: [1.8, 2.8], name: 'ä¸­ç­‰å›°æ‰°', minScore: 50 },
            { type: 'bad', subtype: 'tropical', r: 24, color: '#FF1493', speed: [2, 3], name: 'ä¸­ç­‰æ³¢æŠ˜', minScore: 50 },
            { type: 'bad', subtype: 'clownfish', r: 20, color: '#FF4500', speed: [2.2, 3.2], name: 'ä¸­ç­‰éº»çƒ¦', minScore: 50 },
            { type: 'bad', subtype: 'angelfish', r: 23, color: '#FFA500', speed: [2, 3], name: 'ä¸­ç­‰æ’æ›²', minScore: 50 },
            { type: 'bad', subtype: 'dolphin', r: 28, color: '#4682B4', speed: [1.5, 2.5], name: 'ä¸­ç­‰å‹åŠ›', minScore: 100 },
            
            // è¾ƒå¤§çš„é±¼ï¼ˆr: 30-50ï¼‰ï¼Œ300-1000åˆ†é˜¶æ®µ
            { type: 'bad', subtype: 'lightning', r: 15, color: '#FFEB3B', speed: [4, 6], name: 'äº‰åµ', minScore: 300 },
            { type: 'bad', subtype: 'ice', r: 40, color: '#00BCD4', speed: [2, 4], name: 'å†·æˆ˜', minScore: 300 },
            { type: 'bad', subtype: 'goldfish', r: 35, color: '#FF6347', speed: [2, 3], name: 'å¤§å›°æ‰°', minScore: 300 },
            { type: 'bad', subtype: 'tropical', r: 32, color: '#E91E63', speed: [2.5, 3.5], name: 'å¤§æ³¢æŠ˜', minScore: 300 },
            { type: 'bad', subtype: 'angelfish', r: 30, color: '#FF9800', speed: [2.5, 3.5], name: 'å¤§æ’æ›²', minScore: 300 },
            { type: 'bad', subtype: 'clownfish', r: 28, color: '#FF6B35', speed: [3, 4], name: 'å¤§éº»çƒ¦', minScore: 300 },
            { type: 'bad', subtype: 'dolphin', r: 38, color: '#1E90FF', speed: [2, 3], name: 'å¤§å‹åŠ›', minScore: 400 },
            { type: 'bad', subtype: 'tropical', r: 18, color: '#E91E63', speed: [3, 4], name: 'çƒ‚æ¡ƒèŠ±', minScore: 500 },
            { type: 'bad', subtype: 'puffer', r: 22, color: '#9C27B0', speed: [2, 3], name: 'å«‰å¦’', minScore: 800 },
            { type: 'bad', subtype: 'angelfish', r: 20, color: '#FF9800', speed: [2.5, 3.5], name: 'å°çƒ¦æ¼', minScore: 600 },
            { type: 'bad', subtype: 'goldfish', r: 42, color: '#FF4500', speed: [2, 3], name: 'å·¨å¤§å›°æ‰°', minScore: 800 },
            { type: 'bad', subtype: 'dolphin', r: 45, color: '#0000CD', speed: [2.5, 3.5], name: 'å·¨å¤§å‹åŠ›', minScore: 1000 },
            
            // è¶…å¤§å‹é±¼ï¼ˆr: 50+ï¼‰ï¼Œ1500åˆ†ä»¥ä¸Š
            { type: 'bad', subtype: 'whale', r: 100, color: '#37474F', speed: [0.8, 1.2], name: 'ç°å®å‹åŠ›', minScore: 1500 },
            { type: 'bad', subtype: 'shark', r: 50, color: '#D32F2F', speed: [5, 7], name: 'æƒ…æ„Ÿå±æœº', minScore: 2500 },
            { type: 'bad', subtype: 'goldfish', r: 60, color: '#DC143C', speed: [1.5, 2.5], name: 'ç»ˆæå›°æ‰°', minScore: 2000 },
            { type: 'bad', subtype: 'tropical', r: 55, color: '#C71585', speed: [3, 4], name: 'ç»ˆææ³¢æŠ˜', minScore: 2000 },
            { type: 'bad', subtype: 'dolphin', r: 65, color: '#191970', speed: [2, 3], name: 'ç»ˆæå‹åŠ›', minScore: 2000 },
            { type: 'bad', subtype: 'angelfish', r: 58, color: '#FF8C00', speed: [2.5, 3.5], name: 'ç»ˆææ’æ›²', minScore: 2000 },
            { type: 'bad', subtype: 'whale', r: 90, color: '#2F4F4F', speed: [1, 1.5], name: 'æ·±æµ·å‹åŠ›', minScore: 3000 },
            { type: 'bad', subtype: 'shark', r: 70, color: '#8B0000', speed: [6, 8], name: 'ç»ˆæå±æœº', minScore: 3500 }
        ]
    };

    // --- è¾…åŠ©ç»˜å›¾ ---
    if (!CanvasRenderingContext2D.prototype.roundRect) {
        CanvasRenderingContext2D.prototype.roundRect = function (x, y, w, h, r) {
            if (w < 2 * r) r = w / 2; if (h < 2 * r) r = h / 2;
            this.beginPath(); this.moveTo(x + r, y);
            this.arcTo(x + w, y, x + w, y + h, r); this.arcTo(x + w, y + h, x, y + h, r);
            this.arcTo(x, y + h, x, y, r); this.arcTo(x, y, x + w, y, r);
            this.closePath(); return this;
        };
    }

    function drawFishArt(ctx, x, y, r, color, angle, frameCount, type) {
        ctx.save();
        ctx.translate(x, y);
        if (type === 'player' || type === 'guardian') { ctx.rotate(angle); }
        const tailWag = Math.sin(frameCount * 0.2) * 0.2;
        const finWag = Math.cos(frameCount * 0.15) * 5;
        const bodyWave = Math.sin(frameCount * 0.1) * 0.05;
        
        // ç»˜åˆ¶å°¾å·´
        ctx.save(); ctx.translate(-r, 0); ctx.rotate(tailWag); ctx.beginPath(); ctx.moveTo(0, 0);
        if (type === 'shark') { 
            ctx.lineTo(-r * 1.5, -r * 0.8); 
            ctx.quadraticCurveTo(-r * 1.2, 0, -r * 1.5, r * 0.8); 
        }
        else if (type === 'whale') { 
            ctx.lineTo(-r * 1.2, -r * 0.6); 
            ctx.quadraticCurveTo(-r * 1.8, 0, -r * 1.2, r * 0.6); 
        }
        else if (type === 'goldfish') {
            // é‡‘é±¼ï¼šå¤§è€Œé£˜é€¸çš„å°¾å·´
            ctx.lineTo(-r * 1.8, -r * 0.7); 
            ctx.quadraticCurveTo(-r * 1.5, -r * 0.3, -r * 1.2, 0);
            ctx.quadraticCurveTo(-r * 1.5, r * 0.3, -r * 1.8, r * 0.7);
            ctx.lineTo(-r * 1.0, r * 0.4);
        }
        else if (type === 'tropical') {
            // çƒ­å¸¦é±¼ï¼šåˆ†å‰å°¾å·´
            ctx.lineTo(-r * 1.3, -r * 0.5);
            ctx.lineTo(-r * 1.5, -r * 0.8);
            ctx.lineTo(-r * 1.0, 0);
            ctx.lineTo(-r * 1.5, r * 0.8);
            ctx.lineTo(-r * 1.3, r * 0.5);
        }
        else if (type === 'clownfish') {
            // å°ä¸‘é±¼ï¼šåœ†æ¶¦å°¾å·´
            ctx.lineTo(-r * 1.2, -r * 0.5);
            ctx.quadraticCurveTo(-r * 1.4, 0, -r * 1.2, r * 0.5);
        }
        else if (type === 'dolphin') {
            // æµ·è±šï¼šæ°´å¹³å°¾é³
            ctx.lineTo(-r * 1.5, -r * 0.3);
            ctx.lineTo(-r * 1.8, 0);
            ctx.lineTo(-r * 1.5, r * 0.3);
        }
        else if (type === 'angelfish') {
            // å¤©ä½¿é±¼ï¼šä¸‰è§’å½¢å°¾å·´
            ctx.lineTo(-r * 1.4, -r * 0.6);
            ctx.lineTo(-r * 1.6, 0);
            ctx.lineTo(-r * 1.4, r * 0.6);
        }
        else {
            ctx.lineTo(-r * 1.2, -r * 0.6); 
            ctx.lineTo(-r * 1.2, r * 0.6); 
        }
        ctx.lineTo(0, 0); 
        // å°¾å·´æ¸å˜æ•ˆæœï¼Œè®©å°¾å·´è¾¹ç¼˜æ›´é€æ˜
        const tailGrad = ctx.createLinearGradient(0, -r * 0.5, 0, r * 0.5);
        tailGrad.addColorStop(0, color);
        tailGrad.addColorStop(0.5, color);
        tailGrad.addColorStop(1, color);
        ctx.fillStyle = tailGrad; 
        ctx.fill(); 
        // æ·»åŠ å°¾å·´è¾¹ç¼˜é«˜å…‰
        ctx.globalAlpha = 0.3;
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.6)';
        ctx.lineWidth = 1;
        ctx.stroke();
        ctx.globalAlpha = 1.0;
        ctx.restore();
        
        // ç»˜åˆ¶èº«ä½“
        ctx.beginPath();
        if (type === 'shark') {
            ctx.ellipse(0, 0, r * 1.8, r * 0.7, 0, 0, Math.PI * 2);
        }
        else if (type === 'whale') {
            ctx.ellipse(0, 0, r * 1.5, r * 0.9, 0, 0, Math.PI * 2);
        }
        else if (type === 'goldfish') {
            // é‡‘é±¼ï¼šåœ†æ¶¦èº«ä½“
            ctx.ellipse(0, 0, r * 1.4, r * 1.0, 0, 0, Math.PI * 2);
        }
        else if (type === 'tropical') {
            // çƒ­å¸¦é±¼ï¼šæ‰å¹³èº«ä½“
            ctx.ellipse(0, 0, r * 1.3, r * 0.8, 0, 0, Math.PI * 2);
        }
        else if (type === 'clownfish') {
            // å°ä¸‘é±¼ï¼šæ¤­åœ†å½¢
            ctx.ellipse(0, 0, r * 1.2, r * 0.9, 0, 0, Math.PI * 2);
        }
        else if (type === 'dolphin') {
            // æµ·è±šï¼šæµçº¿å‹
            ctx.ellipse(0, 0, r * 1.6, r * 0.6, 0, 0, Math.PI * 2);
        }
        else if (type === 'angelfish') {
            // å¤©ä½¿é±¼ï¼šé«˜è€Œæ‰
            ctx.ellipse(0, 0, r * 1.0, r * 1.3, 0, 0, Math.PI * 2);
        }
        else {
            ctx.ellipse(0, 0, r * 1.3, r * 0.9, 0, 0, Math.PI * 2);
        }
        
        // èº«ä½“æ¸å˜å’Œçº¹ç†
        const bodyGrad = ctx.createRadialGradient(-r*0.3, -r*0.3, r*0.2, 0, 0, r*1.5);
        if (type === 'goldfish') {
            bodyGrad.addColorStop(0, '#FFD700');
            bodyGrad.addColorStop(0.3, '#FFA500');
            bodyGrad.addColorStop(0.7, '#FF8C00');
            bodyGrad.addColorStop(1, '#FF6347');
        }
        else if (type === 'tropical') {
            bodyGrad.addColorStop(0, '#FF69B4');
            bodyGrad.addColorStop(0.4, '#FF1493');
            bodyGrad.addColorStop(0.7, '#DC143C');
            bodyGrad.addColorStop(1, '#8B0000');
        }
        else if (type === 'clownfish') {
            bodyGrad.addColorStop(0, '#FFA500');
            bodyGrad.addColorStop(0.5, '#FF8C00');
            bodyGrad.addColorStop(1, '#FF4500');
        }
        else if (type === 'dolphin') {
            bodyGrad.addColorStop(0, '#87CEEB');
            bodyGrad.addColorStop(0.4, '#4682B4');
            bodyGrad.addColorStop(1, '#191970');
        }
        else if (type === 'angelfish') {
            bodyGrad.addColorStop(0, '#FFD700');
            bodyGrad.addColorStop(0.3, '#FFA500');
            bodyGrad.addColorStop(0.6, '#FF6347');
            bodyGrad.addColorStop(1, '#8B0000');
        }
        else {
            bodyGrad.addColorStop(0, '#ffffff'); 
            bodyGrad.addColorStop(0.3, color); 
            bodyGrad.addColorStop(1, color);
        }
        ctx.fillStyle = bodyGrad; 
        ctx.fill();
        
        // æ·»åŠ çº¹ç†ç»†èŠ‚
        if (type === 'clownfish') {
            // å°ä¸‘é±¼æ¡çº¹
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 1;
            for (let i = 0; i < 3; i++) {
                ctx.beginPath();
                ctx.moveTo(-r * 0.8 + i * r * 0.4, -r * 0.6);
                ctx.lineTo(-r * 0.8 + i * r * 0.4, r * 0.6);
                ctx.stroke();
            }
        }
        else if (type === 'tropical' || type === 'angelfish') {
            // çƒ­å¸¦é±¼å’Œå¤©ä½¿é±¼çš„æ–‘ç‚¹
            ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
            for (let i = 0; i < 3; i++) {
                ctx.beginPath();
                ctx.arc(-r * 0.3 + i * r * 0.3, Math.sin(i) * r * 0.3, r * 0.15, 0, Math.PI * 2);
                ctx.fill();
            }
        }
        
        // ç»˜åˆ¶èƒŒé³
        ctx.beginPath();
        if (type === 'shark') { 
            ctx.moveTo(0, -r * 0.5); 
            ctx.lineTo(r * 0.5, -r * 1.3); 
            ctx.lineTo(r * 0.8, -r * 0.5); 
            ctx.fillStyle = color; 
            ctx.fill(); 
        }
        else if (type === 'dolphin') {
            // æµ·è±šèƒŒé³
            ctx.moveTo(r * 0.3, -r * 0.4);
            ctx.lineTo(r * 0.6, -r * 1.0);
            ctx.lineTo(r * 0.9, -r * 0.3);
            ctx.fillStyle = color;
            ctx.fill();
        }
        else if (type === 'angelfish') {
            // å¤©ä½¿é±¼é«˜èƒŒé³
            ctx.moveTo(0, -r * 0.5);
            ctx.lineTo(r * 0.2, -r * 1.5);
            ctx.lineTo(r * 0.4, -r * 0.3);
            ctx.fillStyle = color;
            ctx.fill();
        }
        
        // ç»˜åˆ¶ä¾§é³ï¼ˆèƒ¸é³ï¼‰
        ctx.beginPath(); 
        ctx.ellipse(0, r*0.4, r*0.4, r*0.2 + Math.abs(finWag)/20, Math.PI/4, 0, Math.PI*2); 
        ctx.fillStyle = color; 
        ctx.fill();
        
        // ç»˜åˆ¶çœ¼ç›
        ctx.fillStyle = 'white'; 
        ctx.beginPath();
        let eyeX = r * 0.5; 
        let eyeY = -r * 0.3; 
        let eyeSize = r * 0.35;
        if (type === 'shark') { 
            eyeX = r * 1.0; 
            eyeY = -r * 0.2; 
            eyeSize = r * 0.2; 
        }
        else if (type === 'whale') { 
            eyeX = r * 0.8; 
            eyeY = -r * 0.1; 
            eyeSize = r * 0.15; 
        }
        else if (type === 'goldfish') {
            eyeX = r * 0.6;
            eyeY = -r * 0.2;
            eyeSize = r * 0.3;
        }
        else if (type === 'dolphin') {
            eyeX = r * 0.7;
            eyeY = -r * 0.1;
            eyeSize = r * 0.25;
        }
        ctx.arc(eyeX, eyeY, eyeSize, 0, Math.PI * 2); 
        ctx.fill();
        
        // ç³å­”
        ctx.fillStyle = '#333'; 
        ctx.beginPath(); 
        ctx.arc(eyeX + 2, eyeY, eyeSize * 0.4, 0, Math.PI * 2); 
        ctx.fill();
        
        // é«˜å…‰
        ctx.fillStyle = 'white'; 
        ctx.beginPath(); 
        ctx.arc(eyeX + 4, eyeY - 3, eyeSize * 0.2, 0, Math.PI * 2); 
        ctx.fill();
        
        // çœ‰æ¯›/è¡¨æƒ…
        ctx.strokeStyle = '#333'; 
        ctx.lineWidth = 1.5; 
        ctx.beginPath();
        if (type === 'guardian') { 
            ctx.moveTo(eyeX - 5, eyeY - 8); 
            ctx.lineTo(eyeX + 5, eyeY - 5); 
        }
        else if (type === 'player') { 
            ctx.moveTo(eyeX + 5, eyeY - 5); 
            ctx.lineTo(eyeX + 8, eyeY - 8); 
        }
        else if (type === 'bad' || type === 'shark') { 
            ctx.moveTo(eyeX - 5, eyeY - 8); 
            ctx.lineTo(eyeX + 5, eyeY - 3); 
        }
        else if (type === 'goldfish' || type === 'tropical' || type === 'clownfish') {
            // å‹å¥½è¡¨æƒ…
            ctx.moveTo(eyeX - 3, eyeY - 5);
            ctx.quadraticCurveTo(eyeX, eyeY - 8, eyeX + 3, eyeY - 5);
        }
        ctx.stroke();
        
        // ç‰¹æ®Šæ ‡è®°
        if (type === 'guardian') { 
            ctx.fillStyle = 'white'; 
            ctx.font = `bold ${r*0.8}px Arial`; 
            ctx.textAlign = 'center'; 
            ctx.fillText("èªä»”", 0, 0); 
        }
        
        // ä¸ºæŸäº›é±¼ç±»æ·»åŠ å…‰æ™•æ•ˆæœ
        if (type === 'goldfish' || type === 'tropical' || type === 'clownfish') {
            ctx.globalAlpha = 0.2;
            ctx.beginPath();
            ctx.arc(0, 0, r * 1.8, 0, Math.PI * 2);
            const glowGrad = ctx.createRadialGradient(0, 0, 0, 0, 0, r * 1.8);
            glowGrad.addColorStop(0, color);
            glowGrad.addColorStop(1, 'transparent');
            ctx.fillStyle = glowGrad;
            ctx.fill();
            ctx.globalAlpha = 1.0;
        }
        
        // ä¸ºæµ·è±šæ·»åŠ æ°´èŠ±æ•ˆæœ
        if (type === 'dolphin' && frameCount % 10 < 3) {
            ctx.globalAlpha = 0.4;
            ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
            for (let i = 0; i < 3; i++) {
                ctx.beginPath();
                ctx.arc(r * 1.2 + i * 5, Math.sin(frameCount * 0.1 + i) * 3, 2 + i, 0, Math.PI * 2);
                ctx.fill();
            }
            ctx.globalAlpha = 1.0;
        }
        
        ctx.restore();
    }

    function drawItemArt(ctx, item) {
        ctx.save(); ctx.translate(item.x, item.y);
        if (item.vx < 0) ctx.scale(-1, 1);
        const r = item.radius; const color = item.color;
        if (item.type === 'heart') {
            if (item.subtype === 'star') drawStar(ctx, 0, 0, 5, r, r/2, color);
            else if (item.subtype === 'diamond') drawDiamond(ctx, r, color);
            else drawHeart(ctx, 0, 0, r, color);
        }
        else if (item.type === 'buff') {
            ctx.beginPath(); ctx.arc(0, 0, r, 0, Math.PI * 2);
            const grad = ctx.createRadialGradient(-5, -5, 0, 0, 0, r);
            grad.addColorStop(0, 'white'); grad.addColorStop(1, 'rgba(255,255,255,0.8)');
            ctx.fillStyle = grad; ctx.fill();
            ctx.strokeStyle = color; ctx.lineWidth = 3; ctx.stroke();
            ctx.scale(item.vx < 0 ? -1 : 1, 1);
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.font = '14px Arial';
            const icons = { 'candy': 'ğŸ¬', 'summon': 'ğŸ›¡ï¸', 'magnet': 'ğŸ§²', 'hunter': 'ğŸ¯' };
            ctx.fillText(icons[item.subtype], 0, 0);
        }
        else if (item.subtype === 'tiny') {
            // ä¿æŒtinyä¸ºç®€å•åœ†å½¢ï¼Œä½†å…¶ä»–æ—©æœŸé±¼ç±»ä½¿ç”¨é±¼ç±»ç»˜åˆ¶
            ctx.fillStyle = color; ctx.beginPath(); ctx.arc(0, 0, r, 0, Math.PI*2); ctx.fill();
            ctx.strokeStyle = 'black'; ctx.lineWidth = 1; ctx.stroke();
            ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(-2, -2, 2, 0, Math.PI*2); ctx.arc(2, -2, 2, 0, Math.PI*2); ctx.fill();
        }
        else if (item.subtype === 'goldfish' || item.subtype === 'clownfish' || item.subtype === 'tropical' || 
                 item.subtype === 'angelfish' || item.subtype === 'dolphin') {
            // æ‰€æœ‰é±¼ç±»ç±»å‹ï¼Œä½¿ç”¨é±¼ç±»ç»˜åˆ¶
            let fishType = item.subtype;
            drawFishArt(ctx, 0, 0, r, color, 0, frameCount, fishType);
        }
        else if (item.subtype === 'lightning') {
            ctx.fillStyle = color; ctx.beginPath(); ctx.moveTo(0, -r); ctx.lineTo(r/1.5, -r*0.2); ctx.lineTo(0, r*0.2); ctx.lineTo(0, r); ctx.lineTo(-r/1.5, 0.2*r); ctx.lineTo(0, -0.2*r); ctx.fill();
            ctx.strokeStyle = 'orange'; ctx.lineWidth = 2; ctx.stroke();
        }
        else if (item.subtype === 'ice') {
            ctx.fillStyle = 'rgba(200, 240, 255, 0.6)'; ctx.fillRect(-r, -r, r*2, r*2);
            ctx.strokeStyle = 'white'; ctx.lineWidth = 2; ctx.strokeRect(-r, -r, r*2, r*2);
            ctx.scale(item.vx < 0 ? -1 : 1, 1); ctx.fillStyle = 'white'; ctx.font = '16px Arial'; ctx.textAlign='center'; ctx.fillText('â„ï¸', 0, 5);
        }
        else if (item.subtype === 'puffer') {
            ctx.fillStyle = color; ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fill();
            for(let i=0; i<8; i++) { const ang = i * Math.PI/4 + frameCount*0.05; ctx.beginPath(); ctx.moveTo(Math.cos(ang)*r*0.8, Math.sin(ang)*r*0.8); ctx.lineTo(Math.cos(ang)*(r+5), Math.sin(ang)*(r+5)); ctx.strokeStyle = '#E65100'; ctx.lineWidth=2; ctx.stroke(); }
            ctx.fillStyle='white'; ctx.beginPath(); ctx.arc(5, -5, 4, 0, Math.PI*2); ctx.fill(); ctx.fillStyle='black'; ctx.beginPath(); ctx.arc(5, -5, 1, 0, Math.PI*2); ctx.fill();
        }
        else if (item.subtype === 'octopus') {
            ctx.fillStyle = color; ctx.beginPath(); ctx.arc(0, -5, r, Math.PI, 0);
            const wave = Math.sin(frameCount * 0.2) * 5;
            ctx.lineTo(r, 10 + wave); ctx.lineTo(r/2, 5 - wave); ctx.lineTo(0, 10 + wave); ctx.lineTo(-r/2, 5 - wave); ctx.lineTo(-r, 10 + wave); ctx.fill();
            ctx.fillStyle='white'; ctx.beginPath(); ctx.arc(6, -5, 5, 0, Math.PI*2); ctx.fill(); ctx.fillStyle='black'; ctx.beginPath(); ctx.arc(6, -5, 2, 0, Math.PI*2); ctx.fill();
        }
        else if (item.subtype === 'shadow') {
            ctx.globalAlpha = 0.8; ctx.beginPath(); ctx.moveTo(r, 0); ctx.lineTo(-r, -10); ctx.lineTo(-r, 10); ctx.fill();
            ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(0, -5, 3, 0, Math.PI*2); ctx.fill(); ctx.globalAlpha = 1.0;
        }
        else {
            let fishType = 'bad';
            if (item.subtype === 'shark') fishType = 'shark';
            else if (item.subtype === 'whale') fishType = 'whale';
            else if (item.subtype === 'tropical') fishType = 'tropical';
            else if (item.subtype === 'angelfish') fishType = 'angelfish';
            else if (item.subtype === 'goldfish') fishType = 'goldfish';
            else if (item.subtype === 'clownfish') fishType = 'clownfish';
            else if (item.subtype === 'dolphin') fishType = 'dolphin';
            drawFishArt(ctx, 0, 0, r, color, 0, frameCount, fishType);
        }
        ctx.restore();
    }

    function drawHeart(ctx, x, y, r, color) {
        ctx.fillStyle = color; ctx.beginPath(); const topCurveHeight = r * 0.8; ctx.moveTo(0, r * 0.6);
        ctx.bezierCurveTo(0, 0, -r, 0, -r, -topCurveHeight); ctx.bezierCurveTo(-r, -r * 1.6, 0, -r * 1.6, 0, -topCurveHeight);
        ctx.bezierCurveTo(0, -r * 1.6, r, -r * 1.6, r, -topCurveHeight); ctx.bezierCurveTo(r, 0, 0, 0, 0, r * 0.6); ctx.fill();
        ctx.fillStyle = 'rgba(255,255,255,0.4)'; ctx.beginPath(); ctx.arc(-r*0.3, -r*0.8, r*0.15, 0, Math.PI*2); ctx.fill();
    }

    function drawStar(ctx, cx, cy, spikes, outerRadius, innerRadius, color) {
        var rot = Math.PI / 2 * 3; var x = cx; var y = cy; var step = Math.PI / spikes;
        ctx.beginPath(); ctx.moveTo(cx, cy - outerRadius);
        for (i = 0; i < spikes; i++) {
            x = cx + Math.cos(rot) * outerRadius; y = cy + Math.sin(rot) * outerRadius; ctx.lineTo(x, y); rot += step;
            x = cx + Math.cos(rot) * innerRadius; y = cy + Math.sin(rot) * innerRadius; ctx.lineTo(x, y); rot += step;
        }
        ctx.lineTo(cx, cy - outerRadius); ctx.closePath(); ctx.fillStyle = color; ctx.fill();
    }

    function drawDiamond(ctx, r, color) {
        ctx.fillStyle = color; ctx.beginPath();
        ctx.moveTo(0, -r); ctx.lineTo(r, 0); ctx.lineTo(0, r); ctx.lineTo(-r, 0);
        ctx.fill(); ctx.strokeStyle = 'white'; ctx.lineWidth = 2; ctx.stroke();
    }

    // --- é¦–é¡µæ°›å›´é±¼ç±» ---
    class AmbientFish {
        constructor() {
            this.reset();
        }
        reset() {
            this.x = Math.random() * canvas.width;
            this.y = Math.random() * canvas.height;
            this.r = Math.random() * 15 + 8;
            this.speed = Math.random() * 0.5 + 0.2;
            this.vx = this.speed * (Math.random() < 0.5 ? 1 : -1);
            
            // éšæœºé€‰æ‹©é±¼ç±»ç±»å‹å’Œé¢œè‰²
            const fishTypes = ['normal', 'goldfish', 'tropical', 'clownfish', 'dolphin', 'angelfish', 'whale'];
            const rand = Math.random();
            if (rand < 0.15) this.type = 'goldfish';
            else if (rand < 0.3) this.type = 'tropical';
            else if (rand < 0.45) this.type = 'clownfish';
            else if (rand < 0.55) this.type = 'dolphin';
            else if (rand < 0.65) this.type = 'angelfish';
            else if (rand < 0.75) this.type = 'whale';
            else this.type = 'normal';
            
            // æ ¹æ®ç±»å‹è®¾ç½®é¢œè‰²
            if (this.type === 'goldfish') {
                this.color = `hsl(${30 + Math.random()*30}, 90%, 60%)`;
            } else if (this.type === 'tropical') {
                this.color = `hsl(${300 + Math.random()*60}, 80%, 70%)`;
            } else if (this.type === 'clownfish') {
                this.color = `hsl(${20 + Math.random()*20}, 90%, 55%)`;
            } else if (this.type === 'dolphin') {
                this.color = `hsl(${200 + Math.random()*20}, 60%, 70%)`;
            } else if (this.type === 'angelfish') {
                this.color = `hsl(${40 + Math.random()*20}, 85%, 65%)`;
            } else if (this.type === 'whale') {
                this.color = `hsl(${200 + Math.random()*30}, 40%, 50%)`;
            } else {
                this.color = `hsl(${Math.random()*360}, 70%, 80%)`;
            }
        }
        update() {
            this.x += this.vx;
            // æ·»åŠ è½»å¾®çš„ä¸Šä¸‹æµ®åŠ¨
            this.y += Math.sin(frameCount * 0.05 + this.x * 0.01) * 0.3;
            if (this.x > canvas.width + 50) this.x = -50;
            if (this.x < -50) this.x = canvas.width + 50;
            if (this.y > canvas.height + 50) this.y = -50;
            if (this.y < -50) this.y = canvas.height + 50;
        }
        draw() {
            ctx.save(); 
            ctx.translate(this.x, this.y);
            if (this.vx < 0) ctx.scale(-1, 1);
            drawFishArt(ctx, 0, 0, this.r, this.color, 0, frameCount, this.type);
            ctx.restore();
        }
    }

    class AmbientBubble {
        constructor() {
            this.reset();
        }
        reset() {
            this.x = Math.random() * canvas.width;
            this.y = canvas.height + Math.random() * 100;
            this.r = Math.random() * 5 + 2;
            this.speed = Math.random() * 1 + 0.5;
        }
        update() {
            this.y -= this.speed;
            if (this.y < -20) this.reset();
        }
        draw() {
            ctx.beginPath(); ctx.fillStyle = 'rgba(255,255,255,0.3)';
            ctx.arc(this.x, this.y, this.r, 0, Math.PI*2); ctx.fill();
        }
    }
    
    // æ¸¸æˆä¸­çš„æ°”æ³¡ç±»
    class GameBubble {
        constructor() {
            this.reset();
        }
        reset() {
            this.x = Math.random() * canvas.width;
            this.y = canvas.height + Math.random() * 50;
            this.r = Math.random() * 8 + 3;
            this.speed = Math.random() * 1.5 + 0.8;
            this.opacity = Math.random() * 0.4 + 0.2;
            this.horizontalDrift = (Math.random() - 0.5) * 0.5; // æ°´å¹³æ¼‚ç§»
        }
        update() {
            this.y -= this.speed;
            this.x += this.horizontalDrift;
            // æ°”æ³¡ä¸Šå‡æ—¶ç¨å¾®å˜å¤§
            this.r += 0.01;
            // æ°”æ³¡ä¸Šå‡æ—¶ç¨å¾®å˜é€æ˜
            this.opacity = Math.max(0.1, this.opacity - 0.002);
            if (this.y < -30 || this.opacity <= 0.1) this.reset();
        }
        draw() {
            ctx.save();
            ctx.globalAlpha = this.opacity;
            // æ°”æ³¡å¤–åœˆï¼ˆæ›´é€æ˜ï¼‰
            ctx.beginPath();
            ctx.fillStyle = 'rgba(255, 255, 255, 0.15)';
            ctx.arc(this.x, this.y, this.r, 0, Math.PI * 2);
            ctx.fill();
            // æ°”æ³¡å†…åœˆï¼ˆé«˜å…‰ï¼‰
            ctx.beginPath();
            ctx.fillStyle = 'rgba(255, 255, 255, 0.4)';
            ctx.arc(this.x - this.r * 0.3, this.y - this.r * 0.3, this.r * 0.5, 0, Math.PI * 2);
            ctx.fill();
            // æ°”æ³¡è¾¹æ¡†
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.r, 0, Math.PI * 2);
            ctx.stroke();
            ctx.restore();
        }
    }
    
    // å…‰æ–‘æ•ˆæœç±»
    class LightRay {
        constructor() {
            this.reset();
        }
        reset() {
            this.x = Math.random() * canvas.width;
            this.y = Math.random() * canvas.height;
            this.size = Math.random() * 100 + 50;
            this.opacity = Math.random() * 0.3 + 0.1;
            this.speed = Math.random() * 0.5 + 0.2;
            this.angle = Math.random() * Math.PI * 2;
        }
        update() {
            this.x += Math.cos(this.angle) * this.speed;
            this.y += Math.sin(this.angle) * this.speed;
            // å…‰æ–‘ç¼“æ…¢é—ªçƒ
            this.opacity += Math.sin(frameCount * 0.05 + this.x * 0.01) * 0.05;
            this.opacity = Math.max(0.05, Math.min(0.4, this.opacity));
            
            // å¦‚æœç¦»å¼€å±å¹•ï¼Œé‡ç½®
            if (this.x < -this.size || this.x > canvas.width + this.size ||
                this.y < -this.size || this.y > canvas.height + this.size) {
                this.reset();
            }
        }
        draw() {
            ctx.save();
            ctx.globalAlpha = this.opacity;
            const grad = ctx.createRadialGradient(this.x, this.y, 0, this.x, this.y, this.size);
            grad.addColorStop(0, 'rgba(255, 255, 255, 0.6)');
            grad.addColorStop(0.5, 'rgba(173, 216, 230, 0.3)');
            grad.addColorStop(1, 'rgba(173, 216, 230, 0)');
            ctx.fillStyle = grad;
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
            ctx.fill();
            ctx.restore();
        }
    }
    
    // ç²’å­ç‰¹æ•ˆç±»
    class Particle {
        constructor(x, y, color, type = 'sparkle') {
            this.x = x;
            this.y = y;
            this.color = color;
            this.type = type;
            this.vx = (Math.random() - 0.5) * 4;
            this.vy = (Math.random() - 0.5) * 4;
            this.life = 1.0;
            this.decay = Math.random() * 0.02 + 0.01;
            this.size = Math.random() * 4 + 2;
            this.angle = Math.random() * Math.PI * 2;
            this.rotationSpeed = (Math.random() - 0.5) * 0.2;
        }
        update() {
            this.x += this.vx;
            this.y += this.vy;
            this.vx *= 0.98;
            this.vy *= 0.98;
            this.life -= this.decay;
            this.angle += this.rotationSpeed;
            return this.life > 0;
        }
        draw() {
            ctx.save();
            ctx.globalAlpha = this.life;
            ctx.fillStyle = this.color;
            ctx.translate(this.x, this.y);
            ctx.rotate(this.angle);
            if (this.type === 'sparkle') {
                // æ˜Ÿæ˜Ÿå½¢çŠ¶
                ctx.beginPath();
                for (let i = 0; i < 5; i++) {
                    const angle = (i * Math.PI * 2) / 5;
                    const x = Math.cos(angle) * this.size;
                    const y = Math.sin(angle) * this.size;
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.closePath();
                ctx.fill();
            } else {
                // åœ†å½¢ç²’å­
                ctx.beginPath();
                ctx.arc(0, 0, this.size, 0, Math.PI * 2);
                ctx.fill();
            }
            ctx.restore();
        }
    }
    
    // åˆ†æ•°åŠ¨ç”»ç±»
    class ScoreAnimation {
        constructor(x, y, points, color) {
            this.x = x;
            this.y = y;
            this.points = points;
            this.color = color;
            this.life = 1.0;
            this.vy = -2;
        }
        update() {
            this.y += this.vy;
            this.vy *= 0.95;
            this.life -= 0.02;
            return this.life > 0;
        }
        draw() {
            ctx.save();
            ctx.globalAlpha = this.life;
            ctx.fillStyle = this.color;
            ctx.font = `bold ${20 + (1 - this.life) * 10}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
            ctx.lineWidth = 2;
            ctx.strokeText(`+${this.points}`, this.x, this.y);
            ctx.fillText(`+${this.points}`, this.x, this.y);
            ctx.restore();
        }
    }
    
    // åˆ›å»ºç²’å­çˆ†ç‚¸æ•ˆæœ
    function createParticleExplosion(x, y, color, count = 15) {
        for (let i = 0; i < count; i++) {
            particles.push(new Particle(x, y, color, Math.random() < 0.5 ? 'sparkle' : 'circle'));
        }
    }

    // --- ç³»ç»Ÿå‡½æ•° ---

    function resizeCanvas() {
        // ä½¿ç”¨å®é™…è§†å£å°ºå¯¸ï¼Œç¡®ä¿å…¨å±
        const width = window.innerWidth || document.documentElement.clientWidth;
        const height = window.innerHeight || document.documentElement.clientHeight;
        canvas.width = width;
        canvas.height = height;
        input.x = canvas.width / 2; 
        input.y = canvas.height / 2;
    }
    window.addEventListener('resize', resizeCanvas);
    function handleInput(x, y) { if(!isPaused && gameRunning) { input.x = x; input.y = y; } }
    window.addEventListener('mousemove', e => {
        // å¦‚æœé¼ æ ‡åœ¨æš‚åœæŒ‰é’®ä¸Šï¼Œä¸æ›´æ–°inputä½ç½®
        const pauseBtn = document.getElementById('pause-btn');
        if (pauseBtn && pauseBtn.style.display !== 'none') {
            const rect = pauseBtn.getBoundingClientRect();
            if (e.clientX >= rect.left && e.clientX <= rect.right && 
                e.clientY >= rect.top && e.clientY <= rect.bottom) {
                return; // é¼ æ ‡åœ¨æš‚åœæŒ‰é’®ä¸Šï¼Œä¸æ›´æ–°ä½ç½®
            }
        }
        handleInput(e.clientX, e.clientY);
    });
    const handleTouch = (e) => { 
        if(e.cancelable) e.preventDefault(); 
        if(e.touches.length > 0) {
            // æ£€æŸ¥è§¦æ‘¸ç‚¹æ˜¯å¦åœ¨æš‚åœæŒ‰é’®ä¸Š
            const pauseBtn = document.getElementById('pause-btn');
            if (pauseBtn && pauseBtn.style.display !== 'none') {
                const rect = pauseBtn.getBoundingClientRect();
                const touch = e.touches[0];
                if (touch.clientX >= rect.left && touch.clientX <= rect.right && 
                    touch.clientY >= rect.top && touch.clientY <= rect.bottom) {
                    return; // è§¦æ‘¸åœ¨æš‚åœæŒ‰é’®ä¸Šï¼Œä¸æ›´æ–°ä½ç½®
                }
            }
            handleInput(e.touches[0].clientX, e.touches[0].clientY);
        }
    };
    canvas.addEventListener('touchstart', handleTouch, {passive:false});
    canvas.addEventListener('touchmove', handleTouch, {passive:false});
    resizeCanvas();

    function spawnFloatingText(text, x, y, color='#ff4081', size=18) {
        const el = document.createElement('div');
        el.className = 'floating-text';
        el.innerText = text;
        el.style.left = x + 'px'; el.style.top = y + 'px';
        el.style.color = color; el.style.fontSize = size + 'px';
        particlesContainer.appendChild(el);
        setTimeout(() => el.remove(), 1500);
    }

    function showUnlockMsg(text) {
        unlockMsg.innerText = text; unlockMsg.style.opacity = 1;
        setTimeout(() => { unlockMsg.style.opacity = 0; }, 3000);
    }

    function updateBuffUI(buffs, guardianActive) {
        buffBar.innerHTML = '';
        if (isFeverMode) buffBar.innerHTML += `<div class="buff-icon" style="background:#FF1493; animation: pulse 0.5s infinite;">ğŸ”¥</div>`;
        if (buffs.slowed > 0) buffBar.innerHTML += `<div class="buff-icon" style="background:#00BCD4">â„ï¸</div>`;
        if (guardianActive) buffBar.innerHTML += `<div class="buff-icon" style="background:#00BFFF">ğŸ›¡ï¸</div>`;
        if (buffs.speed > 0) buffBar.innerHTML += `<div class="buff-icon" style="background:#FFD700">ğŸ¬</div>`;
        if (buffs.magnet > 0) buffBar.innerHTML += `<div class="buff-icon" style="background:#FF6347">ğŸ§²</div>`;
        if (buffs.hunter > 0) buffBar.innerHTML += `<div class="buff-icon" style="background:#00CED1">ğŸ¯</div>`;
    }

    function checkGameEvolution() {
        if (score > 2000) body.style.background = "linear-gradient(to bottom, #000000, #434343)";
        else if (score > 1000) body.style.background = "linear-gradient(to bottom, #0f2027, #203a43, #2c5364)";
        else if (score > 500) body.style.background = "linear-gradient(to bottom, #6a11cb, #2575fc)";
        else body.style.background = "linear-gradient(to bottom, #ff9a9e, #fad0c4)";

        const scoreOffset = currentDifficultyName === 'hard' ? -200 : 0;
        if (!unlockedStages[500] && score >= 500 + scoreOffset) { unlockedStages[500] = true; showUnlockMsg("âš¡ äº‰åµä¸å†·æˆ˜ å‡ºç°äº†!"); }
        if (!unlockedStages[1000] && score >= 1000 + scoreOffset) { unlockedStages[1000] = true; showUnlockMsg("ğŸ¡ å«‰å¦’ å‡ºç°äº†! å°å¿ƒåˆº!"); }
        if (!unlockedStages[2000] && score >= 2000 + scoreOffset) { unlockedStages[2000] = true; showUnlockMsg("ğŸ³ å·¨å¤§çš„ç°å®å‹åŠ› é€¼è¿‘!"); }
        if (!unlockedStages[3000] && score >= 3000 + scoreOffset) { unlockedStages[3000] = true; showUnlockMsg("ğŸ¦ˆ æƒ…æ„Ÿå±æœº è¢­æ¥! å¿«è·‘!"); }
    }

    function triggerEvent(type) {
        currentEvent = type;
        eventTimer = 600;
        items = items.filter(i => i.subtype !== 'lightning' && i.subtype !== 'ice');

        let title = ""; let desc = ""; let bgColor = "";
        if (type === 'fog') {
            title = "ğŸŒ«ï¸ è¿·èŒ«ä¹‹é›¾"; desc = "çœ‹ä¸æ¸…æœªæ¥...ä½†æœ‰ä½ åœ¨"; bgColor = "#555";
        } else if (type === 'current') {
            title = "ğŸŒŠ å‘½è¿æ¿€æµ"; desc = "ç”Ÿæ´»æƒ³æŠŠæˆ‘ä»¬å†²æ•£ï¼ŒåšæŒä½ï¼";
            const angle = Math.random() * Math.PI * 2;
            const strength = 6 + Math.random() * 4;
            currentForce.x = Math.cos(angle) * strength;
            currentForce.y = Math.sin(angle) * strength;
            bgColor = "#0077be";
            flowParticles = [];
            for(let i=0; i<60; i++) {
                flowParticles.push({
                    x: Math.random() * canvas.width, y: Math.random() * canvas.height,
                    len: Math.random() * 30 + 10, speed: Math.random() * 0.5 + 0.5
                });
            }
        } else if (type === 'starfall') {
            title = "ğŸŒ  å¹¸è¿æµæ˜Ÿ"; desc = "å±äºæˆ‘ä»¬çš„é«˜å…‰æ—¶åˆ»ï¼Œå¿«è®¸æ„¿ï¼"; bgColor = "#FFD700";
        }

        eventTitle.innerText = title; eventDesc.innerText = desc; eventTitle.style.color = bgColor;
        eventBanner.style.opacity = 1;
        setTimeout(() => { eventBanner.style.opacity = 0; }, 4000);
    }

    function updateEventLogic() {
        if (currentEvent) {
            eventTimer--;
            if (currentEvent === 'current') {
                player.x += currentForce.x; player.y += currentForce.y;
                if (guardian.active) { guardian.x += currentForce.x * 0.8; guardian.y += currentForce.y * 0.8; }
            }
            if (currentEvent === 'starfall' && frameCount % 45 === 0) {
                const star = new Item(currentDifficulty);
                star.type = 'heart'; star.subtype = 'star';
                star.color = '#FFD700'; star.score = 50; star.fever = 15; star.speed *= 2;
                items.push(star);
            }
            if (eventTimer <= 0) {
                currentEvent = null; spawnFloatingText("é£å¹³æµªé™äº†...", player.x, player.y - 50, '#fff');
            }
        } else {
            nextEventCooldown--;
            if (nextEventCooldown <= 0) {
                const probs = currentDifficulty.eventProb;
                const rand = Math.random();
                if (rand < probs.fog) triggerEvent('fog');
                else if (rand < probs.fog + probs.current) triggerEvent('current');
                else triggerEvent('starfall');
                nextEventCooldown = Math.random() * 1000 + 1000;
            }
        }
    }

    function addFever(baseAmount) {
        if (isFeverMode) return;
        const gain = baseAmount * currentDifficulty.feverFactor;
        feverValue = Math.min(100, feverValue + gain);
        feverBar.style.width = feverValue + "%";
        if (feverValue >= 100) { activateFever(); }
    }

    function activateFever() {
        isFeverMode = true;
        // æ ¹æ®éš¾åº¦æ¨¡å¼è®¾ç½®ä¸åŒçš„æŒç»­æ—¶é—´
        // ç®€å•æ¨¡å¼ï¼š5ç§’ï¼ˆ300å¸§ï¼‰ï¼Œæ™®é€šæ¨¡å¼ï¼š4ç§’ï¼ˆ240å¸§ï¼‰ï¼Œå›°éš¾æ¨¡å¼ï¼š3ç§’ï¼ˆ180å¸§ï¼‰
        if (currentDifficultyName === 'easy') {
            feverTimer = 300;
        } else if (currentDifficultyName === 'normal') {
            feverTimer = 240;
        } else {
            feverTimer = 180; // å›°éš¾æ¨¡å¼ï¼š3ç§’
        }
        spawnFloatingText("ğŸ”¥ æ‹çˆ±çˆ†å‘! æ— æ•Œ! ğŸ”¥", canvas.width/2 - 100, canvas.height/2, '#FF1493', 30);
        body.classList.add('fever-mode-bg');
        if(navigator.vibrate) navigator.vibrate([100,50,100]);
    }

    // ================= è§’è‰²ç±» =================
    class Player {
        constructor() {
            this.x = canvas.width / 2; this.y = canvas.height / 2;
            this.radius = 10; this.angle = 0;
            this.buffs = { speed: 0, magnet: 0, slowed: 0, hunter: 0, guardian: 0 };
        }
        update() {
            const dx = input.x - this.x; const dy = input.y - this.y;
            let speed = 0.08;
            if (this.buffs.speed > 0) speed = 0.12;
            if (this.buffs.slowed > 0) speed = 0.025;
            if (isFeverMode) speed = 0.15;

            if (Math.hypot(dx, dy) > 5) {
                this.angle = Math.atan2(dy, dx);
                this.x += dx * speed; this.y += dy * speed;
            }
            this.x = Math.max(this.radius, Math.min(canvas.width - this.radius, this.x));
            this.y = Math.max(this.radius, Math.min(canvas.height - this.radius, this.y));

            if (this.buffs.speed > 0) this.buffs.speed--;
            if (this.buffs.magnet > 0) this.buffs.magnet--;
            if (this.buffs.slowed > 0) this.buffs.slowed--;
            if (this.buffs.hunter > 0) this.buffs.hunter--;
            if (this.buffs.guardian > 0) {
                this.buffs.guardian--;
                // å®ˆæŠ¤æ—¶é—´åˆ°äº†ï¼Œèªä»”å»æ‰“å·¥äº†ï¼ˆæ ‡è®°ä¸ºç¦»å¼€ï¼Œè®©Guardianè‡ªå·±å¤„ç†æ¸¸èµ°ï¼‰
                if (this.buffs.guardian === 0 && guardian.active && !guardian.isLeaving) {
                    guardian.isLeaving = true;
                    guardian.wasActiveBeforeHunter = false;
                    spawnFloatingText("èªä»”å»æ‰“å·¥äº†~", player.x, player.y - 30, '#00BFFF');
                }
            }

            if (isFeverMode) {
                feverTimer--;
                // æ ¹æ®éš¾åº¦æ¨¡å¼è®¡ç®—è¿›åº¦æ¡ç™¾åˆ†æ¯”
                const maxFeverTime = currentDifficultyName === 'easy' ? 300 : (currentDifficultyName === 'normal' ? 240 : 180);
                feverBar.style.width = (feverTimer / maxFeverTime * 100) + "%";
                if (feverTimer <= 0) {
                    isFeverMode = false; feverValue = 0;
                    body.classList.remove('fever-mode-bg');
                    spawnFloatingText("æ¿€æƒ…é€€å»...", this.x, this.y, '#ccc');
                }
            }
        }
        draw() {
            ctx.save(); ctx.translate(this.x, this.y);
            if (isFeverMode) {
                ctx.beginPath(); const hue = (frameCount * 5) % 360;
                ctx.strokeStyle = `hsla(${hue}, 100%, 50%, 0.8)`; ctx.lineWidth = 4;
                ctx.arc(0, 0, this.radius * 2.5, 0, Math.PI * 2); ctx.stroke();
            }
            if (this.buffs.slowed > 0 && !isFeverMode) {
                ctx.beginPath(); ctx.strokeStyle = '#00BCD4'; ctx.lineWidth = 3;
                ctx.arc(0, 0, this.radius * 2.2, 0, Math.PI * 2); ctx.stroke();
            }
            if (this.buffs.magnet > 0 || isFeverMode) {
                ctx.beginPath(); ctx.strokeStyle = 'rgba(255, 215, 0, 0.3)'; ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]); ctx.arc(0, 0, isFeverMode ? 250 : 150, 0, Math.PI * 2); ctx.stroke();
            }
            ctx.beginPath(); ctx.fillStyle = 'rgba(255, 182, 193, 0.3)';
            ctx.arc(0, 0, this.radius * 2.0 + Math.sin(frameCount * 0.1) * 2, 0, Math.PI * 2); ctx.fill();
            ctx.restore();
            drawFishArt(ctx, this.x, this.y, this.radius, '#FF69B4', this.angle, frameCount, 'player');
        }
    }

    class Guardian {
        constructor() {
            this.active = false; this.x = -100; this.y = -100;
            this.radius = 10; this.angle = 0;
            this.wasActiveBeforeHunter = false; // è®°å½•åœ¨hunterä¹‹å‰æ˜¯å¦å·²ç»æ¿€æ´»
            this.isLeaving = false; // æ ‡è®°æ˜¯å¦æ­£åœ¨æ¸¸èµ°ç¦»å¼€
        }
        update(targetX, targetY) {
            if (!this.active) return;
            
            // å¦‚æœæ­£åœ¨æ¸¸èµ°ç¦»å¼€ï¼ˆå»æ‰“å·¥ï¼‰ï¼Œåˆ™æ¸¸èµ°æ¶ˆå¤±
            if (this.isLeaving) {
                // æ¸¸èµ°æ¶ˆå¤±ï¼šå‘å±å¹•å¤–ç§»åŠ¨
                const dx = (this.x < canvas.width / 2) ? -5 : 5;
                const dy = (this.y < canvas.height / 2) ? -5 : 5;
                this.x += dx;
                this.y += dy;
                this.angle = Math.atan2(dy, dx);
                
                // å¦‚æœç¦»å¼€å±å¹•ï¼Œåˆ™æ¶ˆå¤±
                if (this.x < -100 || this.x > canvas.width + 100 || 
                    this.y < -100 || this.y > canvas.height + 100) {
                    this.active = false;
                    this.isLeaving = false;
                    this.wasActiveBeforeHunter = false;
                }
                return;
            }
            
            // å¦‚æœå¼€å¯äº†hunteræ¨¡å¼ï¼Œè®©èªä»”ä¸»åŠ¨è¿½å‡»å¹¶åƒæ‰å°é±¼
            // ç¡®ä¿hunter buffå­˜åœ¨ä¸”å¤§äº0
            if (player.buffs && player.buffs.hunter > 0) {
                let nearestFish = null;
                let nearestDist = Infinity;
                
                // å¯»æ‰¾æœ€è¿‘çš„å°é±¼ï¼ˆbadç±»å‹ï¼Œæ”¾å®½æ¡ä»¶ï¼šåŠå¾„å°äºèªä»”çš„1.5å€ï¼Œæˆ–è€…å°äº30ï¼‰
                for (let item of items) {
                    if (item.type === 'bad') {
                        // æ”¾å®½æ¡ä»¶ï¼šå¯ä»¥åƒåŠå¾„å°äºèªä»”1.5å€çš„é±¼ï¼Œæˆ–è€…åŠå¾„å°äº30çš„å°é±¼
                        const canEat = item.radius < this.radius * 1.5 || item.radius < 30;
                        if (canEat) {
                            const dist = Math.hypot(this.x - item.x, this.y - item.y);
                            if (dist < nearestDist && dist < 400) { // æ‰©å¤§è¿½å‡»èŒƒå›´åˆ°400
                                nearestDist = dist;
                                nearestFish = item;
                            }
                        }
                    }
                }
                
                // å¦‚æœæ‰¾åˆ°å°é±¼ï¼Œè¿½å‡»å®ƒ
                if (nearestFish) {
                    const dx = nearestFish.x - this.x;
                    const dy = nearestFish.y - this.y;
                    this.angle = Math.atan2(dy, dx);
                    // å‡æ…¢è¿½å‡»é€Ÿåº¦ï¼Œæ ¹æ®è·ç¦»è°ƒæ•´é€Ÿåº¦
                    const chaseSpeed = Math.min(0.08, 0.04 + (400 - nearestDist) / 400 * 0.04);
                    this.x += dx * chaseSpeed;
                    this.y += dy * chaseSpeed;
                    return;
                }
                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°å°é±¼ï¼Œä½†hunteræ¨¡å¼è¿˜åœ¨ï¼Œåˆ™ç»§ç»­å¯»æ‰¾ï¼ˆå‘ç©å®¶æ–¹å‘ç§»åŠ¨ï¼Œå‡†å¤‡å¯»æ‰¾ä¸‹ä¸€ä¸ªç›®æ ‡ï¼‰
                else {
                    // hunteræ¨¡å¼ä¸‹ï¼Œå³ä½¿æ²¡æ‰¾åˆ°å°é±¼ï¼Œä¹Ÿè¦ä¿æŒç§»åŠ¨ï¼Œå‘ç©å®¶æ–¹å‘é è¿‘ä»¥ä¾¿å¯»æ‰¾ç›®æ ‡
                    const targetX_delayed = targetX - Math.cos(player.angle) * 25;
                    const targetY_delayed = targetY - Math.sin(player.angle) * 25;
                    const dx = targetX_delayed - this.x; const dy = targetY_delayed - this.y;
                    this.angle = Math.atan2(dy, dx);
                    this.x += dx * 0.06; // å‡æ…¢ç§»åŠ¨é€Ÿåº¦
                    this.y += dy * 0.06;
                    return;
                }
            }
            
            // hunteræ—¶é—´ç»“æŸï¼Œå¦‚æœåŸæœ¬å°±æ¿€æ´»ï¼ˆåŒ…æ‹¬åƒåˆ°æŠ¤èº«ç¬¦ï¼‰ï¼Œä¸”å®ˆæŠ¤æ—¶é—´è¿˜åœ¨ï¼Œåˆ™å›åˆ°ç²‰é±¼èº«è¾¹ç»§ç»­å®ˆæŠ¤
            if (player.buffs.hunter === 0 && this.wasActiveBeforeHunter && player.buffs.guardian > 0) {
                // ç»§ç»­å®ˆæŠ¤æ¨¡å¼
                const targetX_delayed = targetX - Math.cos(player.angle) * 25;
                const targetY_delayed = targetY - Math.sin(player.angle) * 25;
                const dx = targetX_delayed - this.x; const dy = targetY_delayed - this.y;
                this.angle = Math.atan2(dy, dx);
                this.x += dx * 0.08; this.y += dy * 0.08;
                return; // ç»§ç»­å®ˆæŠ¤ï¼Œä¸æ‰§è¡Œåé¢çš„æ¸¸èµ°é€»è¾‘
            }
            // å®ˆæŠ¤æ—¶é—´åˆ°äº†ï¼Œä½†hunteræ—¶é—´ä¹Ÿç»“æŸäº†ï¼Œèªä»”å»æ‰“å·¥äº†ï¼ˆé€šè¿‡isLeavingæ ‡è®°å¤„ç†ï¼‰
            if (player.buffs.hunter === 0 && this.wasActiveBeforeHunter && player.buffs.guardian === 0 && !this.isLeaving) {
                this.isLeaving = true;
                this.wasActiveBeforeHunter = false;
                spawnFloatingText("èªä»”å»æ‰“å·¥äº†~", player.x, player.y - 30, '#00BFFF');
                // æ¸¸èµ°é€»è¾‘ä¼šåœ¨ä¸‹ä¸€æ¬¡updateä¸­æ‰§è¡Œï¼ˆé€šè¿‡isLeavingæ£€æŸ¥ï¼‰
                return;
            }
            // hunteræ—¶é—´ç»“æŸï¼Œå¦‚æœåŸæœ¬æœªæ¿€æ´»ï¼ˆåªé€šè¿‡hunteræ¿€æ´»ï¼‰ï¼Œåˆ™æ¸¸èµ°æ¶ˆå¤±
            else if (player.buffs.hunter === 0 && !this.wasActiveBeforeHunter) {
                // æ¸¸èµ°æ¶ˆå¤±ï¼šå‘å±å¹•å¤–ç§»åŠ¨
                const dx = (this.x < canvas.width / 2) ? -5 : 5;
                const dy = (this.y < canvas.height / 2) ? -5 : 5;
                this.x += dx;
                this.y += dy;
                this.angle = Math.atan2(dy, dx);
                
                // å¦‚æœç¦»å¼€å±å¹•ï¼Œåˆ™æ¶ˆå¤±
                if (this.x < -100 || this.x > canvas.width + 100 || 
                    this.y < -100 || this.y > canvas.height + 100) {
                    this.active = false;
                    this.wasActiveBeforeHunter = false;
                }
                return;
            }
            // æ­£å¸¸æ¨¡å¼ï¼šè·Ÿéšç©å®¶ï¼ˆæ²¡æœ‰hunter buffæ—¶ï¼Œä¸”å®ˆæŠ¤æ—¶é—´è¿˜åœ¨ï¼‰
            if (player.buffs.guardian > 0 || this.wasActiveBeforeHunter) {
                const targetX_delayed = targetX - Math.cos(player.angle) * 25;
                const targetY_delayed = targetY - Math.sin(player.angle) * 25;
                const dx = targetX_delayed - this.x; const dy = targetY_delayed - this.y;
                this.angle = Math.atan2(dy, dx);
                this.x += dx * 0.08; this.y += dy * 0.08;
            }
        }
        draw() {
            if (!this.active) return;
            ctx.save(); ctx.translate(this.x, this.y);
            ctx.beginPath(); ctx.fillStyle = 'rgba(0, 191, 255, 0.2)';
            ctx.arc(0, 0, this.radius * 2.5, 0, Math.PI * 2); ctx.fill();
            ctx.restore();
            drawFishArt(ctx, this.x, this.y, this.radius, '#00BFFF', this.angle, frameCount, 'guardian');
        }
    }

    class Item {
        constructor(diffSettings) {
            const rand = Math.random(); const w = diffSettings.weights;
            let category = 'bad';
            let sum = 0;
            for(let i=0; i<w.length; i++) { sum += w[i]; if(rand < sum) {
                if (i === 0) category = 'good';
                else if (i === 1) category = 'buff';
                else category = 'bad';
                break;
            }}

            let availableItems = GAME_OBJECTS[category].filter(i => score >= i.minScore);
            if (availableItems.length === 0) availableItems = [GAME_OBJECTS[category][0]];

            // ä¼˜åŒ–é€‰æ‹©é€»è¾‘ï¼Œç¡®ä¿å„é˜¶æ®µéƒ½æœ‰ä¸°å¯Œçš„é±¼ç±»å“ç§
            let c;
            if (category === 'bad') {
                // å›°éš¾æ¨¡å¼ï¼šæ ¹æ®åˆ†æ•°è°ƒæ•´å¤§é±¼å‡ºç°æ¦‚ç‡ï¼Œæ—©æœŸæ›´ç¨€ç–
                if (currentDifficultyName === 'hard') {
                    const bigFish = availableItems.filter(i => i.r >= 20);
                    if (bigFish.length > 0) {
                        // æ ¹æ®åˆ†æ•°åŠ¨æ€è°ƒæ•´å¤§é±¼å‡ºç°æ¦‚ç‡ï¼Œæ—©æœŸå¤§å¹…é™ä½
                        // 0-100åˆ†ï¼š5%æ¦‚ç‡ï¼Œ100-200åˆ†ï¼š10%æ¦‚ç‡ï¼Œ200-500åˆ†ï¼š25%æ¦‚ç‡ï¼Œ500-1000åˆ†ï¼š50%æ¦‚ç‡ï¼Œ1000+åˆ†ï¼š75%æ¦‚ç‡
                        let bigFishProb = 0.05; // æ—©æœŸåªæœ‰5%
                        if (score >= 1000) {
                            bigFishProb = 0.75;
                        } else if (score >= 500) {
                            bigFishProb = 0.5;
                        } else if (score >= 200) {
                            bigFishProb = 0.25;
                        } else if (score >= 100) {
                            bigFishProb = 0.1;
                        }
                        
                        if (Math.random() < bigFishProb) {
                            c = bigFish[Math.floor(Math.random() * bigFish.length)];
                        } else {
                            c = availableItems[Math.floor(Math.random() * availableItems.length)];
                        }
                    } else {
                        c = availableItems[Math.floor(Math.random() * availableItems.length)];
                    }
                }
                // æ—©æœŸé˜¶æ®µï¼ˆscore < 100ï¼‰ï¼Œä¼˜å…ˆé€‰æ‹©æœ‰é¢œè‰²çš„é±¼ç±»
                else if (score < 100 && availableItems.length > 2) {
                    const colorfulFish = availableItems.filter(i => 
                        i.subtype !== 'tiny' && i.subtype !== 'normal' && i.minScore === 0
                    );
                    if (colorfulFish.length > 0 && Math.random() < 0.6) {
                        c = colorfulFish[Math.floor(Math.random() * colorfulFish.length)];
                    } else {
                        c = availableItems[Math.floor(Math.random() * availableItems.length)];
                    }
                }
                // ä¸­æœŸé˜¶æ®µï¼ˆ100-1000ï¼‰ï¼Œä¼˜å…ˆé€‰æ‹©æœ‰é¢œè‰²çš„å¤§é±¼
                else if (score >= 100 && score < 1000) {
                    const colorfulBigFish = availableItems.filter(i => 
                        i.subtype !== 'tiny' && i.subtype !== 'normal' && 
                        i.subtype !== 'lightning' && i.subtype !== 'ice' &&
                        i.r >= 20
                    );
                    if (colorfulBigFish.length > 0 && Math.random() < 0.5) {
                        c = colorfulBigFish[Math.floor(Math.random() * colorfulBigFish.length)];
                    } else {
                        c = availableItems[Math.floor(Math.random() * availableItems.length)];
                    }
                }
                // åæœŸé˜¶æ®µï¼ˆ1000+ï¼‰ï¼Œç¡®ä¿å¤§é±¼å“ç§ä¸°å¯Œ
                else if (score >= 1000) {
                    const bigFish = availableItems.filter(i => i.r >= 30);
                    if (bigFish.length > 0 && Math.random() < 0.4) {
                        // ä¼˜å…ˆé€‰æ‹©æœ‰é¢œè‰²çš„å¤§é±¼ï¼ˆéwhaleå’Œsharkï¼‰
                        const colorfulBig = bigFish.filter(i => 
                            i.subtype !== 'whale' && i.subtype !== 'shark'
                        );
                        if (colorfulBig.length > 0) {
                            c = colorfulBig[Math.floor(Math.random() * colorfulBig.length)];
                        } else {
                            c = bigFish[Math.floor(Math.random() * bigFish.length)];
                        }
                    } else {
                        c = availableItems[Math.floor(Math.random() * availableItems.length)];
                    }
                }
                else {
                    c = availableItems[Math.floor(Math.random() * availableItems.length)];
                }
            } else {
                c = availableItems[Math.floor(Math.random() * availableItems.length)];
            }
            
            if (c.rarity && Math.random() > c.rarity) c = availableItems[0];

            if (currentEvent) {
                if (c.subtype === 'lightning' || c.subtype === 'ice') {
                    c = GAME_OBJECTS['bad'][1];
                }
            }

            if (currentDifficultyName === 'hard' && c.subtype === 'summon') {
                if (Math.random() > 0.1) c = GAME_OBJECTS['good'][0];
            }

            this.config = c;
            this.type = c.type; this.subtype = c.subtype || 'normal';
            this.radius = c.r; this.color = c.color;
            this.score = c.score || 0; this.fever = c.fever || 0; this.name = c.name;

            const scoreFactor = 1 + Math.floor(score / 500) * 0.15;
            const minSpd = c.speed[0]; const maxSpd = c.speed[1];
            this.speed = (Math.random()*(maxSpd - minSpd) + minSpd) * diffSettings.speedMultiplier * scoreFactor;
            this.originalVx = 0; // ä¿å­˜åŸå§‹æ¨ªå‘é€Ÿåº¦ï¼Œç”¨äºæ¢å¤

            const margin = this.radius * 3;
            
            // å›°éš¾æ¨¡å¼ä¸‹ä»å››ä¸ªæ–¹å‘ç”Ÿæˆï¼Œå…¶ä»–æ¨¡å¼åªä»å·¦å³ç”Ÿæˆ
            if (currentDifficultyName === 'hard') {
                const direction = Math.floor(Math.random() * 4); // 0:å·¦, 1:å³, 2:ä¸Š, 3:ä¸‹
                if (direction === 0) {
                    // ä»å·¦ä¾§ç”Ÿæˆ
                    this.x = -margin;
                    this.y = Math.random() * canvas.height;
                    this.vx = this.speed;
                    this.originalVx = this.speed; // ä¿å­˜åŸå§‹é€Ÿåº¦
                    this.vy = (Math.random() - 0.5) * this.speed * 0.3; // æ·»åŠ å‚ç›´é€Ÿåº¦åˆ†é‡
                } else if (direction === 1) {
                    // ä»å³ä¾§ç”Ÿæˆ
                    this.x = canvas.width + margin;
                    this.y = Math.random() * canvas.height;
                    this.vx = -this.speed;
                    this.originalVx = -this.speed; // ä¿å­˜åŸå§‹é€Ÿåº¦
                    this.vy = (Math.random() - 0.5) * this.speed * 0.3;
                } else if (direction === 2) {
                    // ä»ä¸Šæ–¹ç”Ÿæˆ
                    this.x = Math.random() * canvas.width;
                    this.y = -margin;
                    this.vx = (Math.random() - 0.5) * this.speed * 0.3;
                    this.originalVx = this.vx; // ä¿å­˜åŸå§‹é€Ÿåº¦
                    this.vy = this.speed;
                } else {
                    // ä»ä¸‹æ–¹ç”Ÿæˆ
                    this.x = Math.random() * canvas.width;
                    this.y = canvas.height + margin;
                    this.vx = (Math.random() - 0.5) * this.speed * 0.3;
                    this.originalVx = this.vx; // ä¿å­˜åŸå§‹é€Ÿåº¦
                    this.vy = -this.speed;
                }
            } else {
                // æ™®é€šæ¨¡å¼å’Œç®€å•æ¨¡å¼ï¼šåªä»å·¦å³ç”Ÿæˆ
                this.y = Math.random() * canvas.height;
                const side = Math.random() < 0.5 ? 'left' : 'right';
                if (side === 'left') { 
                    this.x = -margin; 
                    this.vx = this.speed; 
                    this.originalVx = this.speed; // ä¿å­˜åŸå§‹é€Ÿåº¦
                    this.vy = 0;
                } else { 
                    this.x = canvas.width + margin; 
                    this.vx = -this.speed; 
                    this.originalVx = -this.speed; // ä¿å­˜åŸå§‹é€Ÿåº¦
                    this.vy = 0;
                }
            }
        }
        update() {
            // å¤§é±¼ä¸»åŠ¨è¿½å‡»ç©å®¶é€»è¾‘ï¼ˆåœ¨ç§»åŠ¨ä¹‹å‰åˆ¤æ–­ï¼‰
            let isChasing = false;
            if (this.type === 'bad' && this.radius >= 20 && !isFeverMode) {
                const distToPlayer = Math.hypot(player.x - this.x, player.y - this.y);
                // å‡å°è¿½å‡»èŒƒå›´ï¼šåªåœ¨ç©å®¶çœŸæ­£é è¿‘æ—¶æ‰è¿½å‡»
                // å¤§é±¼è¿½å‡»èŒƒå›´ï¼šæ ¹æ®é±¼çš„å¤§å°è°ƒæ•´ï¼Œä½†èŒƒå›´æ›´å°
                const chaseRange = this.radius * (this.radius >= 50 ? 5 : 4); // ä»10-12å€å‡å°‘åˆ°4-5å€
                
                // åªåœ¨ç©å®¶è¶³å¤Ÿé è¿‘æ—¶è¿½å‡»ï¼Œå¯ä»¥è¿½å‡»åˆ°ç¢°æ’
                if (distToPlayer < chaseRange && distToPlayer > this.radius + player.radius) {
                    isChasing = true;
                    // è®¡ç®—æœå‘ç©å®¶çš„æ–¹å‘
                    const angle = Math.atan2(player.y - this.y, player.x - this.x);
                    // å¤§é±¼è¶Šå¤§ï¼Œè¿½å‡»é€Ÿåº¦è¶Šå¿«ï¼Œä½†é™ä½é€Ÿåº¦å€æ•°
                    const speedMultiplier = this.radius >= 50 ? 1.8 : (this.radius >= 30 ? 1.5 : 1.3);
                    const baseChaseSpeed = Math.min(this.speed * speedMultiplier, this.radius >= 50 ? 4 : 3.5);
                    
                    // æ ¹æ®éš¾åº¦è°ƒæ•´è¿½å‡»å¼ºåº¦
                    // ç®€å•æ¨¡å¼ï¼šæ›´æ…¢æ›´æ¸©å’Œï¼Œæ™®é€šæ¨¡å¼ï¼šä¸­ç­‰ï¼Œå›°éš¾æ¨¡å¼ï¼šæ›´å¿«æ›´ç§¯æ
                    let chaseIntensity;
                    if (currentDifficultyName === 'easy') {
                        chaseIntensity = 0.15; // ç®€å•æ¨¡å¼ï¼š15%
                    } else if (currentDifficultyName === 'normal') {
                        chaseIntensity = 0.2; // æ™®é€šæ¨¡å¼ï¼š20%
                    } else {
                        chaseIntensity = 0.3; // å›°éš¾æ¨¡å¼ï¼š30%
                    }
                    
                    const chaseX = Math.cos(angle) * baseChaseSpeed * chaseIntensity;
                    const chaseY = Math.sin(angle) * baseChaseSpeed * chaseIntensity;
                    
                    // å¦‚æœæ­£åœ¨è¿½å‡»ï¼Œä¼˜å…ˆä½¿ç”¨è¿½å‡»ç§»åŠ¨ï¼Œå‡å°‘åŸæ¥çš„æ¨ªå‘ç§»åŠ¨
                    this.x += chaseX;
                    this.y += chaseY;
                    
                    // æ›´æ–°vxæ–¹å‘ï¼Œè®©é±¼æœå‘ç©å®¶ï¼Œä½†è¿½å‡»æ—¶å‡å°‘æ¨ªå‘ç§»åŠ¨
                    if (this.x < player.x) {
                        this.vx = Math.abs(this.originalVx) * 0.4; // è¿½å‡»æ—¶å‡å°‘æ¨ªå‘ç§»åŠ¨
                    } else {
                        this.vx = -Math.abs(this.originalVx) * 0.4;
                    }
                } else {
                    // ä¸åœ¨è¿½å‡»èŒƒå›´å†…ï¼Œæ¢å¤åŸå§‹é€Ÿåº¦
                    if (this.originalVx !== 0) {
                        this.vx = this.originalVx;
                    }
                }
            } else {
                // ä¸æ˜¯å¤§é±¼æˆ–æ— æ•Œæ¨¡å¼ï¼Œæ¢å¤åŸå§‹é€Ÿåº¦
                if (this.originalVx !== 0 && this.vx !== this.originalVx) {
                    this.vx = this.originalVx;
                }
            }
            
            // å¦‚æœæ²¡æœ‰åœ¨è¿½å‡»ï¼Œæ‰ä½¿ç”¨åŸæ¥çš„ç§»åŠ¨æ–¹å¼
            if (!isChasing) {
                this.x += this.vx;
                // æ”¯æŒå‚ç›´ç§»åŠ¨ï¼ˆå›°éš¾æ¨¡å¼ä¸‹ä»ä¸Šä¸‹æ–¹å‘ç”Ÿæˆçš„é±¼ï¼‰
                if (this.vy !== undefined) {
                    this.y += this.vy;
                }
            } else {
                // è¿½å‡»æ—¶ä»ç„¶ä¿ç•™å°‘é‡æ¨ªå‘ç§»åŠ¨ï¼Œä½†ä¸»è¦é è¿½å‡»ç§»åŠ¨
                this.x += this.vx * 0.3;
                if (this.vy !== undefined) {
                    this.y += this.vy * 0.3;
                }
            }
            
            if (this.subtype === 'lightning') this.y += Math.sin(this.x * 0.05) * 5;
            
            const magnetActive = player.buffs.magnet > 0 || (isFeverMode && currentDifficultyName !== 'hard');
            const canMagnet = (this.type === 'heart' || this.type === 'buff') || (isFeverMode && currentDifficultyName !== 'hard');
            if (magnetActive && canMagnet) {
                let range = 200;
                let magnetSpeed = 0.05;
                
                if (isFeverMode) {
                    // å®¹æ˜“æ¨¡å¼ï¼šèŒƒå›´300ï¼Œé€Ÿåº¦0.12
                    // æ™®é€šæ¨¡å¼ï¼šèŒƒå›´150ï¼ˆç¼©å°ä¸€åŠï¼‰ï¼Œé€Ÿåº¦0.06ï¼ˆç¼©å°ä¸€åŠï¼‰
                    // å›°éš¾æ¨¡å¼ï¼šä¸å¸å¼•
                    if (currentDifficultyName === 'easy') {
                        range = 300;
                        magnetSpeed = 0.12;
                    } else if (currentDifficultyName === 'normal') {
                        range = 150; // ç¼©å°ä¸€åŠ
                        magnetSpeed = 0.06; // ç¼©å°ä¸€åŠ
                    }
                } else {
                    // æ™®é€šç£é“é“å…·
                    range = 200;
                    magnetSpeed = 0.05;
                }
                
                const dist = Math.hypot(player.x - this.x, player.y - this.y);
                if (dist < range) {
                    this.x += (player.x - this.x) * magnetSpeed;
                    this.y += (player.y - this.y) * magnetSpeed;
                }
            }
        }
        draw() {
            drawItemArt(ctx, this);
        }
    }

    // é¦–é¡µåŠ¨ç”»å¾ªç¯
    function drawStartBackground() {
        if (gameRunning) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // ç»˜åˆ¶é¦–é¡µèƒŒæ™¯é±¼
        ambientFish.forEach(f => { f.update(); f.draw(); });
        ambientBubbles.forEach(b => { b.update(); b.draw(); });

        frameCount++;
        requestAnimationFrame(drawStartBackground);
    }

    function initAmbient() {
        ambientFish = [];
        // å¢åŠ é±¼ç±»æ•°é‡ï¼Œè®©ç”»é¢æ›´ä¸°å¯Œ
        for(let i=0; i<35; i++) ambientFish.push(new AmbientFish());
        ambientBubbles = [];
        for(let i=0; i<40; i++) ambientBubbles.push(new AmbientBubble());
        drawStartBackground();
    }

    // æ ¸å¿ƒé€»è¾‘
    function init(difficultyKey) {
        currentDifficultyName = difficultyKey;
        currentDifficulty = DIFFICULTY_SETTINGS[difficultyKey];
        player = new Player();
        guardian = new Guardian();
        guardian.wasActiveBeforeHunter = false; // é‡ç½®æ ‡è®°
        guardian.isLeaving = false; // é‡ç½®ç¦»å¼€æ ‡è®°
        items = [];
        score = 0;
        feverValue = 0; isFeverMode = false;
        feverBar.style.width = "0%";
        body.style.background = "linear-gradient(to bottom, #ff9a9e, #fad0c4)";
        body.classList.remove('fever-mode-bg');
        scoreEl.innerText = score;
        sizeEl.innerText = 1;
        frameCount = 0;
        isPaused = false;
        unlockedStages = { 500: false, 1000: false, 2000: false, 3000: false };
        currentEvent = null; nextEventCooldown = 600; eventBanner.style.opacity = 0;
        input.x = canvas.width / 2; input.y = canvas.height / 2;
        updateBuffUI(player.buffs, guardian.active);
        startDesc.innerHTML = START_QUOTES[Math.floor(Math.random() * START_QUOTES.length)];
        
        // åˆå§‹åŒ–æ¸¸æˆä¸­çš„æ°”æ³¡å’Œå…‰æ–‘
        gameBubbles = [];
        for(let i = 0; i < 25; i++) {
            gameBubbles.push(new GameBubble());
        }
        lightRays = [];
        for(let i = 0; i < 8; i++) {
            lightRays.push(new LightRay());
        }
        
        // åˆå§‹åŒ–å…¶ä»–æ•ˆæœ
        particles = [];
        comboCount = 0;
        comboTimer = 0;
        screenShake = { x: 0, y: 0, intensity: 0 };
        scoreAnimations = [];
    }

    function gameLoop() {
        if (!gameRunning) return;
        if (isPaused) return;

        // æ›´æ–°å±å¹•éœ‡åŠ¨
        if (screenShake.intensity > 0) {
            screenShake.x = (Math.random() - 0.5) * screenShake.intensity;
            screenShake.y = (Math.random() - 0.5) * screenShake.intensity;
            screenShake.intensity *= 0.9;
            if (screenShake.intensity < 0.1) {
                screenShake.intensity = 0;
                screenShake.x = 0;
                screenShake.y = 0;
            }
        }
        
        // æ›´æ–°è¿å‡»è®¡æ—¶å™¨
        if (comboTimer > 0) {
            comboTimer--;
            if (comboTimer <= 0) {
                comboCount = 0;
            }
        }
        
        ctx.save();
        ctx.translate(screenShake.x, screenShake.y);
        
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // ç»˜åˆ¶èƒŒæ™¯ç¾åŒ–æ•ˆæœï¼šå…‰æ–‘
        lightRays.forEach(ray => {
            ray.update();
            ray.draw();
        });
        
        // ç»˜åˆ¶èƒŒæ™¯ç¾åŒ–æ•ˆæœï¼šæ°”æ³¡
        gameBubbles.forEach(bubble => {
            bubble.update();
            bubble.draw();
        });
        
        // æ›´æ–°å’Œç»˜åˆ¶ç²’å­
        particles = particles.filter(p => {
            p.update();
            p.draw();
            return p.life > 0;
        });
        
        // æ›´æ–°å’Œç»˜åˆ¶åˆ†æ•°åŠ¨ç”»
        scoreAnimations = scoreAnimations.filter(anim => {
            anim.update();
            anim.draw();
            return anim.life > 0;
        });
        
        // ç»˜åˆ¶è¿å‡»æç¤º
        if (comboCount > 1) {
            ctx.save();
            ctx.globalAlpha = Math.min(1, comboTimer / 60);
            ctx.fillStyle = '#FFD700';
            ctx.font = 'bold 28px Arial';
            ctx.textAlign = 'center';
            ctx.strokeStyle = '#FF6347';
            ctx.lineWidth = 3;
            const comboText = `${comboCount} è¿å‡»!`;
            ctx.strokeText(comboText, canvas.width / 2, 100);
            ctx.fillText(comboText, canvas.width / 2, 100);
            ctx.restore();
        }

        player.update();
        updateBuffUI(player.buffs, guardian.active);
        if (guardian.active) { 
            guardian.update(player.x, player.y); 
            guardian.draw();
            
            // å¦‚æœå¼€å¯äº†hunteræ¨¡å¼ï¼Œæ£€æŸ¥èªä»”æ˜¯å¦åƒæ‰äº†å°é±¼
            if (player.buffs && player.buffs.hunter > 0) {
                for (let j = items.length - 1; j >= 0; j--) {
                    let fish = items[j];
                    if (fish.type === 'bad') {
                        // æ”¾å®½æ¡ä»¶ï¼šå¯ä»¥åƒåŠå¾„å°äºèªä»”1.5å€çš„é±¼ï¼Œæˆ–è€…åŠå¾„å°äº30çš„å°é±¼
                        const canEat = fish.radius < guardian.radius * 1.5 || fish.radius < 30;
                        if (canEat) {
                            const dist = Math.hypot(guardian.x - fish.x, guardian.y - fish.y);
                            if (dist < guardian.radius + fish.radius) {
                                // èªä»”åƒæ‰äº†å°é±¼
                                items.splice(j, 1);
                                score += 5;
                                scoreEl.innerText = score;
                                spawnFloatingText("èªä»”å‡ºå‡»!", guardian.x, guardian.y - 30, '#00CED1');
                                if(navigator.vibrate) navigator.vibrate(30);
                            }
                        }
                    }
                }
            }
        }
        player.draw();

        updateEventLogic();

        frameCount++;
        if (frameCount % currentDifficulty.spawnRate === 0) {
            items.push(new Item(currentDifficulty));
        }

        for (let i = items.length - 1; i >= 0; i--) {
            let item = items[i];
            item.update();
            item.draw();

            // è¾¹ç•Œæ£€æµ‹ï¼šä»å››ä¸ªæ–¹å‘ç¦»å¼€å±å¹•æ—¶ç§»é™¤
            const margin = 200;
            if (item.x < -margin || item.x > canvas.width + margin || 
                item.y < -margin || item.y > canvas.height + margin) { 
                items.splice(i, 1); 
                continue; 
            }

            const dist = Math.hypot(player.x - item.x, player.y - item.y);
            if (dist < player.radius + item.radius) {

                if (item.type === 'heart') {
                    items.splice(i, 1);
                    score += item.score;
                    addFever(item.fever || 5);
                    scoreEl.innerText = score;
                    checkGameEvolution();
                    
                    // æ·»åŠ ç²’å­ç‰¹æ•ˆ
                    createParticleExplosion(item.x, item.y, item.color, 12);
                    // æ·»åŠ åˆ†æ•°åŠ¨ç”»
                    scoreAnimations.push(new ScoreAnimation(item.x, item.y, item.score, item.color));
                    // è¿å‡»ç³»ç»Ÿ
                    comboTimer = 120; // 2ç§’å†…å†æ¬¡æ”¶é›†ç®—è¿å‡»
                    comboCount++;

                    // === æ ¸å¿ƒä¿®å¤ï¼šéšæœºæŠ½å–ä¸€å¥æƒ…è¯ ===
                    const sweetWord = LOVE_WORDS[Math.floor(Math.random() * LOVE_WORDS.length)];
                    spawnFloatingText(sweetWord, player.x, player.y - 30, item.color);

                    if (item.subtype === 'diamond') { feverValue = 100; activateFever(); }

                    if (player.radius < 60) {
                        player.radius += 0.15;
                        if (guardian.active) guardian.radius += 0.12;
                        sizeEl.innerText = Math.floor(player.radius - 9);
                    }
                }
                else if (item.type === 'buff') {
                    items.splice(i, 1);
                    // æ·»åŠ ç²’å­ç‰¹æ•ˆ
                    createParticleExplosion(item.x, item.y, item.color, 15);
                    if (item.subtype === 'summon') {
                        // æ ¹æ®éš¾åº¦è®¾ç½®ä¸åŒçš„å®ˆæŠ¤æŒç»­æ—¶é—´
                        // ç®€å•æ¨¡å¼ï¼š15ç§’ï¼ˆ900å¸§ï¼‰ï¼Œæ™®é€šæ¨¡å¼ï¼š12ç§’ï¼ˆ720å¸§ï¼‰ï¼Œå›°éš¾æ¨¡å¼ï¼š8ç§’ï¼ˆ480å¸§ï¼‰
                        let guardianDuration = 900;
                        if (currentDifficultyName === 'easy') {
                            guardianDuration = 900; // ç®€å•æ¨¡å¼ï¼š15ç§’
                        } else if (currentDifficultyName === 'normal') {
                            guardianDuration = 720; // æ™®é€šæ¨¡å¼ï¼š12ç§’
                        } else {
                            guardianDuration = 480; // å›°éš¾æ¨¡å¼ï¼š8ç§’
                        }
                        player.buffs.guardian = guardianDuration;
                        
                        if (guardian.active) {
                            spawnFloatingText("èªä»”åœ¨å‘¢!", player.x, player.y - 30, '#00BFFF');
                            // åƒåˆ°æŠ¤èº«ç¬¦åï¼Œæ— è®ºæ˜¯å¦æœ‰hunterï¼Œéƒ½åº”è¯¥ç»§ç»­å®ˆæŠ¤
                            guardian.wasActiveBeforeHunter = true; // æ ‡è®°ä¸ºåŸæœ¬æ¿€æ´»ï¼Œhunterç»“æŸåç»§ç»­å®ˆæŠ¤
                        } else {
                            guardian.active = true;
                            guardian.x = player.x - 50;
                            guardian.y = player.y;
                            // åƒåˆ°æŠ¤èº«ç¬¦åï¼Œæ— è®ºæ˜¯å¦æœ‰hunterï¼Œéƒ½åº”è¯¥ç»§ç»­å®ˆæŠ¤
                            guardian.wasActiveBeforeHunter = true; // æ ‡è®°ä¸ºåŸæœ¬æ¿€æ´»
                            spawnFloatingText("èªä»”å®ˆæŠ¤!", player.x, player.y - 30, '#00BFFF');
                        }
                    } else {
                        spawnFloatingText(item.name + "!", player.x, player.y - 30, item.color);
                        if (item.subtype === 'candy') player.buffs.speed = 300;
                        if (item.subtype === 'magnet') player.buffs.magnet = 400;
                        if (item.subtype === 'hunter') {
                            // è®°å½•åœ¨hunterä¹‹å‰æ˜¯å¦å·²ç»æ¿€æ´»
                            guardian.wasActiveBeforeHunter = guardian.active;
                            
                            // æ ¹æ®éš¾åº¦è®¾ç½®ä¸åŒçš„æŒç»­æ—¶é—´
                            // ç®€å•æ¨¡å¼ï¼š8ç§’ï¼ˆ480å¸§ï¼‰ï¼Œæ™®é€šæ¨¡å¼ï¼š6ç§’ï¼ˆ360å¸§ï¼‰ï¼Œå›°éš¾æ¨¡å¼ï¼š4ç§’ï¼ˆ240å¸§ï¼‰
                            if (currentDifficultyName === 'easy') {
                                player.buffs.hunter = 480;
                            } else if (currentDifficultyName === 'normal') {
                                player.buffs.hunter = 360;
                            } else {
                                player.buffs.hunter = 240; // å›°éš¾æ¨¡å¼ï¼š4ç§’
                            }
                            if (!guardian.active) {
                                guardian.active = true;
                                guardian.x = player.x - 50;
                                guardian.y = player.y;
                            }
                        }
                    }
                }
                else if (item.type === 'bad') {
                    if (isFeverMode) {
                        items.splice(i, 1);
                        spawnFloatingText("ç²‰ç¢éšœç¢!", player.x, player.y - 30, '#FF1493', 24);
                        score += 10; scoreEl.innerText = score;
                        if(navigator.vibrate) navigator.vibrate(50);
                    }
                    else if (item.subtype === 'ice') {
                        items.splice(i, 1);
                        spawnFloatingText("å†»ç»“! å‡é€Ÿ!", player.x, player.y - 30, '#00BCD4');
                        player.buffs.slowed = 180;
                        player.buffs.speed = 0;
                    }
                    else {
                        if (player.radius > item.radius) {
                            items.splice(i, 1);
                            spawnFloatingText("æ‰“è´¥" + item.name + "!", player.x, player.y - 30);
                            score += 5; scoreEl.innerText = score;
                        } else {
                            if (guardian.active) {
                                items.splice(i, 1);
                                // å¦‚æœhunteræ¨¡å¼æ¿€æ´»ï¼Œèªä»”ä¸ºäº†ä¿æŠ¤ç²‰é±¼è€Œæ¶ˆå¤±
                                if (player.buffs.hunter > 0) {
                                    spawnFloatingText("èªä»”å®ˆæŠ¤!", player.x, player.y - 40, '#ff4444');
                                    player.buffs.hunter = 0; // æ¸…é™¤hunter buff
                                } else {
                                    spawnFloatingText("èªä»”æŒ¡åˆ€!", player.x, player.y - 40, '#ff4444');
                                }
                                guardian.active = false;
                                guardian.wasActiveBeforeHunter = false;
                                if(navigator.vibrate) navigator.vibrate(200);
                                // æ·»åŠ å±å¹•éœ‡åŠ¨
                                screenShake.intensity = 15;
                                // æ·»åŠ ç²’å­ç‰¹æ•ˆ
                                createParticleExplosion(player.x, player.y, '#ff4444', 20);
                            } else {
                                // æ·»åŠ å±å¹•éœ‡åŠ¨
                                screenShake.intensity = 20;
                                // æ·»åŠ ç²’å­ç‰¹æ•ˆ
                                createParticleExplosion(player.x, player.y, '#ff0000', 25);
                                deathReasonEl.innerText = `è¢«"${item.name}"ç»Šå€’äº†...`;
                                endGame();
                            }
                        }
                    }
                }
            }
        }

        if (currentEvent === 'fog') {
            let fogR = currentDifficulty.fogRadius || 100;
            if (!guardian.active) {
                fogR = fogR * 0.4; // æ²¡æœ‰å®ˆæŠ¤è€…æ—¶èƒ½è§åº¦è¿›ä¸€æ­¥ç¼©å‡åˆ°40%
            } else {
                fogR = fogR * 1.5; // æœ‰å®ˆæŠ¤è€…æ—¶èƒ½è§åº¦å¢åŠ åˆ°150%
            }
            fogR = Math.max(10, fogR); // æœ€å°å¯è§èŒƒå›´ä»15ç¼©å‡åˆ°10
            
            // ç»˜åˆ¶ä»¥ç©å®¶ä¸ºä¸­å¿ƒçš„è¿·é›¾
            const grad = ctx.createRadialGradient(player.x, player.y, fogR, player.x, player.y, Math.max(canvas.width, canvas.height)/2);
            grad.addColorStop(0, "rgba(0,0,0,0)");
            grad.addColorStop(0.2, "rgba(0,0,0,0.5)"); // æ›´æ—©å¼€å§‹å˜æš—
            grad.addColorStop(0.5, "rgba(0,0,0,0.85)"); // ä¸­é—´æ›´æš—
            grad.addColorStop(1, "rgba(0,0,0,0.99)"); // è¾¹ç¼˜å‡ ä¹å®Œå…¨é»‘æš—
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // å¦‚æœèªä»”æ¿€æ´»ï¼Œåœ¨èªä»”å‘¨å›´ä¹Ÿåˆ›å»ºä¸€ä¸ªäº®åŒº
            if (guardian.active) {
                const guardianFogR = fogR * 0.6; // èªä»”å‘¨å›´çš„å¯è§èŒƒå›´æ˜¯ç©å®¶çš„60%
                const guardianGrad = ctx.createRadialGradient(guardian.x, guardian.y, guardianFogR, guardian.x, guardian.y, Math.max(canvas.width, canvas.height)/2);
                guardianGrad.addColorStop(0, "rgba(0,0,0,0)");
                guardianGrad.addColorStop(0.3, "rgba(0,0,0,0.3)");
                guardianGrad.addColorStop(0.6, "rgba(0,0,0,0.7)");
                guardianGrad.addColorStop(1, "rgba(0,0,0,0.99)");
                ctx.fillStyle = guardianGrad;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
        }

        if (currentEvent === 'current') {
            ctx.save();
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.15)'; ctx.lineWidth = 2; ctx.beginPath();
            flowParticles.forEach(p => {
                p.x += currentForce.x * 2; p.y += currentForce.y * 2;
                if(p.x > canvas.width) p.x = 0; else if(p.x < 0) p.x = canvas.width;
                if(p.y > canvas.height) p.y = 0; else if(p.y < 0) p.y = canvas.height;
                ctx.moveTo(p.x, p.y); ctx.lineTo(p.x - currentForce.x * 2, p.y - currentForce.y * 2);
            });
            ctx.stroke(); ctx.restore();
        }
        
        ctx.restore(); // ç»“æŸå±å¹•éœ‡åŠ¨å˜æ¢

        animationId = requestAnimationFrame(gameLoop);
    }

    function startGame(difficulty) {
        startScreen.style.display = 'none'; gameOverScreen.style.display = 'none'; pauseScreen.style.display = 'none';
        uiLayer.style.display = 'block'; pauseBtn.style.display = 'flex';
        init(difficulty); gameRunning = true; gameLoop();
    }
    function pauseGame(e) { 
        if (e) {
            e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
            e.preventDefault(); // é˜»æ­¢é»˜è®¤è¡Œä¸º
        }
        if (!gameRunning) return; 
        isPaused = true; 
        cancelAnimationFrame(animationId); 
        pauseScreen.style.display = 'flex'; 
    }
    function resumeGame() { isPaused = false; pauseScreen.style.display = 'none'; gameLoop(); }
    function quitGameFromPause() { pauseScreen.style.display = 'none'; deathReasonEl.innerText = "ä¼‘æ¯å¥½äº†å—ï¼Ÿéšæ—¶éƒ½å¯ä»¥å›æ¥å“¦~"; endGame(); }
    function showStartScreen() {
        startScreen.style.display = 'flex'; gameOverScreen.style.display = 'none'; uiLayer.style.display = 'none';
        pauseBtn.style.display = 'none'; pauseScreen.style.display = 'none'; ctx.clearRect(0, 0, canvas.width, canvas.height);
        startDesc.innerHTML = START_QUOTES[Math.floor(Math.random() * START_QUOTES.length)];
        initAmbient(); // å¯åŠ¨é¦–é¡µèƒŒæ™¯åŠ¨ç”»
    }
    function endGame() {
        gameRunning = false; isPaused = false; cancelAnimationFrame(animationId);
        finalScoreEl.innerText = score; pauseBtn.style.display = 'none'; gameOverScreen.style.display = 'flex';
        body.classList.remove('fever-mode-bg'); body.style.background = "linear-gradient(to bottom, #ff9a9e, #fad0c4)";
    }

    showStartScreen();
</script>
</body>
</html>