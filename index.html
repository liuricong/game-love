<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>çˆ±çš„å®ˆæŠ¤</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: fixed;
            top: 0;
            left: 0;
            background: linear-gradient(rgb(255, 154, 158), rgb(250, 208, 196));
        }

        body {
            background: linear-gradient(rgb(255, 154, 158), rgb(250, 208, 196)); /* é»˜è®¤æ¸å˜èƒŒæ™¯ */
            /* èƒŒæ™¯å›¾ç‰‡ç”± JS åŠ¨æ€åŠ è½½ï¼Œæ‰‹æœº/æ¡Œé¢ç”¨ä¸åŒå¤§å° */
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
            user-select: none;
            touch-action: none;
        }

        #gameCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: block;
            z-index: 1;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            background: transparent; /* é€æ˜èƒŒæ™¯ï¼Œè®©CSSèƒŒæ™¯å›¾æ˜¾ç¤º */
        }

        /* é®ç½©å±‚é€šç”¨ */
        .overlay-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 100;
            transition: opacity 0.3s;
        }

        /* === é¦–é¡µæ ·å¼ä¿®æ”¹ï¼šå˜ä¸ºé€æ˜ï¼Œè®©CanvasèƒŒæ™¯é€å‡ºæ¥ === */
        #start-screen {
            background: rgba(255, 255, 255, 0.1); /* ææ·¡çš„é®ç½©ï¼Œå‡¸æ˜¾èƒŒæ™¯é±¼ */
            backdrop-filter: blur(2px); /* è½»å¾®æ¨¡ç³Šï¼Œè®©æ–‡å­—æ›´æ¸…æ™° */
        }

        /* æ¸¸æˆä¸­çš„é®ç½© (æš‚åœ/ç»“æŸ) ä¿æŒä¸é€æ˜åº¦é«˜ä¸€ç‚¹ */
        .game-overlay {
            background: rgba(255, 255, 255, 0.92);
            color: #d63384;
            backdrop-filter: blur(8px);
        }

        h1 {
            font-size: 40px; margin-bottom: 10px; text-align: center; font-weight: 900;
            color: #fff;
            /* å¼ºåŠ›æ–‡å­—æè¾¹å’Œé˜´å½±ï¼Œç¡®ä¿åœ¨åŠ¨æ€èƒŒæ™¯ä¸Šæ¸…æ™°å¯è§ */
            text-shadow: 0 0 10px rgba(255,105,180, 0.8), 2px 2px 0px rgba(0,0,0,0.2);
            letter-spacing: 2px;
        }

        /* é¦–é¡µæè¿°æ–‡å­—ï¼šåŠ ä¸ªåŠé€æ˜åº•ï¼Œé˜²çœ‹ä¸æ¸… */
        #start-desc {
            font-size: 16px; color: #fff; text-align: center;
            margin-bottom: 30px; line-height: 1.8; max-width: 90%;
            background: rgba(0,0,0,0.2);
            padding: 10px 20px;
            border-radius: 15px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            font-weight: 500;
            min-height: 60px;
            display: flex; align-items: center; justify-content: center;
        }

        .hint { font-size: 14px; color: #ff758c; background: #fff0f5; padding: 5px 10px; border-radius: 10px; margin-bottom: 20px;}

        .btn-group { display: flex; flex-direction: column; gap: 15px; width: 80%; max-width: 300px; padding-bottom: 20px;}

        button {
            padding: 15px 10px; font-size: 18px; border: none; border-radius: 50px;
            cursor: pointer; font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: transform 0.1s;
            color: white; outline: none; -webkit-tap-highlight-color: transparent;
            border: 1px solid rgba(255,255,255,0.4);
        }
        button:active { transform: scale(0.96); }

        .btn-easy { background: linear-gradient(45deg, #a8e063, #56ab2f); }
        .btn-normal { background: linear-gradient(45deg, #ff9a9e, #fecfef); color: #c71585; }
        .btn-hard { background: linear-gradient(45deg, #ff512f, #dd2476); }

        .btn-restart { background: #fff; border: 2px solid #ff758c; color: #ff758c; margin-top: 20px; width: 60%;}
        .btn-resume { background: linear-gradient(45deg, #4facfe, #00f2fe); color: white; }
        .btn-quit { background: #fff; border: 2px solid #999; color: #999; }
        .btn-leaderboard { background: linear-gradient(45deg, #f093fb, #f5576c); }

        /* é¦–é¡µæœ€é«˜åˆ†å¡ç‰‡ */
        .high-score-card {
            display: flex;
            justify-content: space-around;
            width: 90%;
            max-width: 320px;
            margin-bottom: 15px;
            padding: 12px 8px;
            background: rgba(255,255,255,0.25);
            border-radius: 15px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.4);
        }
        .high-score-item {
            text-align: center;
            flex: 1;
        }
        .high-score-item .label {
            font-size: 11px;
            color: rgba(255,255,255,0.9);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            margin-bottom: 4px;
        }
        .high-score-item .value {
            font-size: 18px;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 0 10px rgba(255,105,180,0.8), 1px 1px 2px rgba(0,0,0,0.3);
        }
        .high-score-item.easy .value { color: #a8e063; }
        .high-score-item.normal .value { color: #fecfef; }
        .high-score-item.hard .value { color: #ff512f; }

        /* æ’è¡Œæ¦œç•Œé¢ */
        #leaderboard-screen {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .leaderboard-container {
            width: 90%;
            max-width: 400px;
            padding-bottom: 30px;
        }
        .leaderboard-title {
            font-size: 28px;
            color: #ff758c;
            text-align: center;
            margin-bottom: 20px;
        }
        .leaderboard-card {
            background: linear-gradient(135deg, #fff 0%, #ffeef8 100%);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 5px 20px rgba(255,105,180,0.2);
            border: 2px solid transparent;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .leaderboard-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255,105,180,0.3);
        }
        .leaderboard-card.easy { border-color: #a8e063; background: linear-gradient(135deg, #f0fff0 0%, #e8f5e9 100%); }
        .leaderboard-card.normal { border-color: #ff9a9e; background: linear-gradient(135deg, #fff0f5 0%, #ffe4ec 100%); }
        .leaderboard-card.hard { border-color: #ff512f; background: linear-gradient(135deg, #fff5f5 0%, #ffe0e0 100%); }
        .leaderboard-card-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }
        .leaderboard-card-icon {
            font-size: 32px;
            margin-right: 12px;
        }
        .leaderboard-card-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        .leaderboard-card-subtitle {
            font-size: 12px;
            color: #999;
        }
        .leaderboard-card-score {
            font-size: 36px;
            font-weight: 900;
            text-align: center;
            margin: 10px 0;
        }
        .leaderboard-card.easy .leaderboard-card-score { color: #56ab2f; }
        .leaderboard-card.normal .leaderboard-card-score { color: #ff758c; }
        .leaderboard-card.hard .leaderboard-card-score { color: #dd2476; }
        .leaderboard-card-footer {
            font-size: 12px;
            color: #999;
            text-align: center;
        }
        .btn-back-leaderboard {
            background: #fff;
            border: 2px solid #ff758c;
            color: #ff758c;
            margin-top: 10px;
            padding: 12px 30px;
        }
        
        #leaderboard-close-btn {
            position: fixed;
            top: max(15px, env(safe-area-inset-top));
            right: max(15px, env(safe-area-inset-right));
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #ddd;
            color: #666;
            font-size: 24px;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 201;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: all 0.2s;
        }
        #leaderboard-close-btn:hover {
            background: #f0f0f0;
            transform: scale(1.05);
        }
        #leaderboard-close-btn:active {
            transform: scale(0.95);
        }

        /* ç ´çºªå½•æ’’èŠ±ç‰¹æ•ˆ */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            pointer-events: none;
            z-index: 200;
            animation: confetti-fall 3s ease-out forwards;
        }
        @keyframes confetti-fall {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        /* ç ´çºªå½•æ–‡å­—åŠ¨ç”» */
        .new-record-badge {
            animation: pulse-glow 1s ease-in-out infinite;
        }
        @keyframes pulse-glow {
            0%, 100% { transform: scale(1); text-shadow: 0 0 10px rgba(255,64,129,0.5); }
            50% { transform: scale(1.05); text-shadow: 0 0 20px rgba(255,64,129,0.8), 0 0 30px rgba(255,64,129,0.5); }
        }

        /* çš®è‚¤é€‰æ‹©ç•Œé¢ */
        #skin-screen {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .skin-container {
            width: 90%;
            max-width: 400px;
            padding-bottom: 30px;
        }
        .skin-title {
            font-size: 28px;
            color: #ff758c;
            text-align: center;
            margin-bottom: 10px;
        }
        .skin-subtitle {
            font-size: 14px;
            color: #999;
            text-align: center;
            margin-bottom: 20px;
        }
        .skin-section {
            margin-bottom: 25px;
        }
        .skin-section-title {
            font-size: 16px;
            color: #666;
            margin-bottom: 12px;
            padding-left: 5px;
            border-left: 3px solid #ff758c;
        }
        .skin-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }
        .skin-item {
            background: linear-gradient(135deg, #fff 0%, #ffeef8 100%);
            border-radius: 15px;
            padding: 12px 8px;
            text-align: center;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
            position: relative;
        }
        .skin-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255,105,180,0.2);
        }
        .skin-item.selected {
            border-color: #ff758c;
            background: linear-gradient(135deg, #fff0f5 0%, #ffe4ec 100%);
        }
        .skin-item.locked {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .skin-item.locked::after {
            content: 'ğŸ”’';
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 12px;
        }
        .skin-preview {
            width: 50px;
            height: 50px;
            margin: 0 auto 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }
        .skin-name {
            font-size: 12px;
            color: #333;
            font-weight: bold;
        }
        .skin-condition {
            font-size: 10px;
            color: #999;
            margin-top: 4px;
        }
        .btn-back-skin {
            background: #fff;
            border: 2px solid #ff758c;
            color: #ff758c;
            margin-top: 15px;
            padding: 12px 30px;
        }
        #skin-btn-menu {
            position: absolute;
            top: max(15px, env(safe-area-inset-top)); right: max(135px, calc(env(safe-area-inset-right) + 120px));
            width: 50px; height: 50px; border-radius: 50%;
            background: linear-gradient(135deg, rgba(255, 183, 77, 0.95), rgba(255, 138, 101, 0.95));
            border: 3px solid #fff;
            color: #fff; font-size: 24px;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; pointer-events: auto; z-index: 150;
            box-shadow: 0 4px 15px rgba(255, 138, 101, 0.5), 0 2px 8px rgba(0,0,0,0.2);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        #skin-btn-menu:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(255, 138, 101, 0.7), 0 3px 10px rgba(0,0,0,0.3);
        }
        #skin-btn-menu:active {
            transform: scale(0.95);
        }
        
        #skin-close-btn {
            position: fixed;
            top: max(15px, env(safe-area-inset-top));
            right: max(15px, env(safe-area-inset-right));
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #ddd;
            color: #666;
            font-size: 24px;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 201;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: all 0.2s;
        }
        #skin-close-btn:hover {
            background: #f0f0f0;
            transform: scale(1.05);
        }
        #skin-close-btn:active {
            transform: scale(0.95);
        }

        /* æ¸¸æˆä¸­æœ€é«˜åˆ†æç¤º */
        #high-score-hint {
            position: absolute;
            top: max(85px, calc(env(safe-area-inset-top) + 70px));
            left: max(15px, env(safe-area-inset-left));
            font-size: 12px;
            color: #ff758c;
            background: rgba(255,255,255,0.7);
            padding: 4px 10px;
            border-radius: 10px;
            pointer-events: none;
            z-index: 50;
            transition: all 0.3s;
            backdrop-filter: blur(3px);
        }
        #high-score-hint.surpassed {
            background: linear-gradient(45deg, #ff9a9e, #fecfef);
            color: #fff;
            font-weight: bold;
            animation: pulse-glow 1s ease-in-out infinite;
        }

        #ui-layer {
            position: absolute;
            top: max(15px, env(safe-area-inset-top)); left: max(15px, env(safe-area-inset-left));
            width: calc(100% - 80px); pointer-events: none; z-index: 50;
        }

        .score-text { color: #d63384; font-weight: bold; font-size: 18px; text-shadow: 1px 1px 0px rgba(255,255,255,0.8); }
        .sub-text { font-size: 12px; opacity: 0.8; margin-top:5px; color:#666; }

        #pause-btn {
            position: absolute;
            top: max(15px, env(safe-area-inset-top)); right: max(15px, env(safe-area-inset-right));
            width: 45px; height: 45px; border-radius: 50%;
            background: rgba(255, 255, 255, 0.6); border: 2px solid #fff;
            color: #ff758c; font-size: 20px;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; pointer-events: auto; z-index: 150;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        #collection-btn {
            position: absolute;
            top: max(15px, env(safe-area-inset-top)); right: max(70px, calc(env(safe-area-inset-right) + 55px));
            width: 45px; height: 45px; border-radius: 50%;
            background: rgba(255, 255, 255, 0.6); border: 2px solid #fff;
            color: #ff758c; font-size: 20px;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; pointer-events: auto; z-index: 150;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        #collection-btn-menu {
            position: absolute;
            top: max(15px, env(safe-area-inset-top)); right: max(15px, env(safe-area-inset-right));
            width: 50px; height: 50px; border-radius: 50%;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.95), rgba(118, 75, 162, 0.95));
            border: 3px solid #fff;
            color: #fff; font-size: 24px;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; pointer-events: auto; z-index: 150;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.5), 0 2px 8px rgba(0,0,0,0.2);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        #collection-btn-menu:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.7), 0 3px 10px rgba(0,0,0,0.3);
        }
        
        #collection-btn-menu:active {
            transform: scale(0.95);
        }
        
        #leaderboard-btn-menu {
            position: absolute;
            top: max(15px, env(safe-area-inset-top)); right: max(75px, calc(env(safe-area-inset-right) + 60px));
            width: 50px; height: 50px; border-radius: 50%;
            background: linear-gradient(135deg, rgba(240, 147, 251, 0.95), rgba(245, 87, 108, 0.95));
            border: 3px solid #fff;
            color: #fff; font-size: 24px;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; pointer-events: auto; z-index: 150;
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.5), 0 2px 8px rgba(0,0,0,0.2);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        #leaderboard-btn-menu:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(245, 87, 108, 0.7), 0 3px 10px rgba(0,0,0,0.3);
        }
        
        #leaderboard-btn-menu:active {
            transform: scale(0.95);
        }
        
        /* éŸ³æ•ˆæ§åˆ¶æŒ‰é’® - å·²ç§»é™¤ */
        #audio-btn {
            display: none !important;
        }

        .floating-text {
            position: absolute; font-weight: bold; font-size: 20px;
            pointer-events: none; animation: floatUp 1.5s ease-out forwards;
            text-shadow: 1px 1px 2px white; white-space: nowrap; z-index: 55;
        }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-50px) scale(1.2); } }

        #buff-bar { margin-top: 8px; display: flex; gap: 8px; }
        .buff-icon {
            width: 24px; height: 24px; border-radius: 50%; font-size: 14px;
            display: flex; justify-content: center; align-items: center;
            color: white; box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }

        #fever-container {
            margin-top: 8px; width: 150px; height: 12px;
            background: rgba(255,255,255,0.6); border-radius: 10px;
            overflow: hidden; border: 2px solid #ff758c; position: relative;
        }
        #fever-bar {
            width: 0%; height: 100%; background: linear-gradient(90deg, #ff9a9e, #ff0055); transition: width 0.2s;
        }
        #fever-text { position: absolute; top: -18px; left: 0; font-size: 11px; color: #ff0055; font-weight: bold; text-shadow: 0 0 2px white; }

        .fever-mode-bg { animation: rainbowBorder 1s infinite; }
        @keyframes rainbowBorder {
            0% { box-shadow: inset 0 0 20px #ff0000; } 50% { box-shadow: inset 0 0 20px #00ffff; } 100% { box-shadow: inset 0 0 20px #ff00ff; }
        }

        #unlock-msg {
            position: absolute; top: 20%; width: 100%; text-align: center;
            font-size: 24px; color: #ff4081; font-weight: bold; text-shadow: 2px 2px 0 #fff;
            opacity: 0; pointer-events: none; z-index: 60; transition: opacity 0.5s;
        }

        #event-banner {
            position: absolute; top: 150px; width: 100%; text-align: center;
            pointer-events: none; z-index: 55; opacity: 0; transition: opacity 0.5s;
        }
        .event-title {
            font-size: 42px;
            font-weight: 900;
            color: #fff;
            text-align: center;
            margin-bottom: 15px;
            /* å¼ºåŠ›æ–‡å­—æè¾¹å’Œé˜´å½±ï¼Œç¡®ä¿åœ¨åŠ¨æ€èƒŒæ™¯ä¸Šæ¸…æ™°å¯è§ */
            text-shadow:
                    0 0 15px rgba(255, 105, 180, 0.9),
                    0 0 25px rgba(255, 105, 180, 0.6),
                    2px 2px 4px rgba(0, 0, 0, 0.8),
                    -2px -2px 4px rgba(0, 0, 0, 0.8),
                    2px -2px 4px rgba(0, 0, 0, 0.8),
                    -2px 2px 4px rgba(0, 0, 0, 0.8);
            letter-spacing: 3px;
            display: block;
        }
        .event-desc {
            font-size: 18px;
            color: #fff;
            text-align: center;
            line-height: 1.8;
            max-width: 90%;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.4);
            display: inline-block;
            padding: 12px 20px;
            border-radius: 15px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }

        /* é—¯å…³æ¨¡å¼æ ·å¼ */
        .btn-stage { background: linear-gradient(45deg, #667eea, #764ba2); }
        
        #stage-select-screen {
            background: rgba(255, 255, 255, 0.95);
            justify-content: flex-start; /* ä»é¡¶éƒ¨å¼€å§‹ï¼Œä¸å±…ä¸­ */
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        #stage-select-screen h1 {
            font-size: 32px;
            color: #667eea;
            margin-bottom: 10px;
        }
        
        #stage-select-screen p {
            color: #666;
            margin-bottom: 20px;
        }
        
        .stage-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            width: 100%;
            max-width: 900px;
            margin: 0 auto 20px;
        }
        
        .stage-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 20px;
            color: white;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }
        
        .stage-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }
        
        .stage-card.locked {
            background: linear-gradient(135deg, #999 0%, #666 100%);
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .stage-card.completed {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
        }
        
        .stage-number {
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 5px;
        }
        
        .stage-name {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .stage-desc {
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 10px;
            opacity: 0.9;
        }
        
        .stage-objective {
            background: rgba(255,255,255,0.2);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 13px;
            margin-top: 10px;
        }
        
        .stage-status {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
        }
        
        #stage-objective-display {
            position: absolute;
            top: 70px;
            right: max(15px, env(safe-area-inset-right));
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 12px;
            border-radius: 10px;
            color: #d63384;
            font-weight: bold;
            font-size: 13px;
            z-index: 65;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            display: none;
            text-align: center;
            backdrop-filter: blur(5px);
            min-width: 100px;
        }
        
        .objective-title {
            font-size: 10px;
            opacity: 0.7;
            display: block;
            margin-bottom: 2px;
        }
        
        .objective-progress {
            font-size: 16px;
            color: #d63384;
            display: block;
        }
        
        /* ç§»åŠ¨ç«¯ä¼˜åŒ–å…³å¡ç›®æ ‡æ˜¾ç¤º */
        @media (max-width: 480px) {
            #stage-objective-display {
                padding: 6px 10px;
                font-size: 12px;
                min-width: 90px;
            }
            
            .objective-title {
                font-size: 9px;
                margin-bottom: 2px;
            }
            
            .objective-progress {
                font-size: 14px;
            }
        }
        
        #stage-complete-screen {
            background: rgba(255, 255, 255, 0.95);
        }
        
        .btn-back { 
            background: #fff; 
            border: 2px solid #667eea; 
            color: #667eea; 
            margin-top: 10px;
        }
        
        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            #stage-select-screen {
                padding: 6px 4% 15px;
            }
            
            #stage-select-screen h1 {
                font-size: 24px;
                margin: 3px 0 5px;
            }
            
            #stage-select-screen p {
                font-size: 13px;
                margin-bottom: 10px;
            }
            
            .stage-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .stage-card {
                padding: 15px;
            }
            
            .stage-name {
                font-size: 18px;
            }
            
            .stage-desc {
                font-size: 13px;
            }
            
            .btn-back {
                width: 100%;
                max-width: 400px;
                margin-top: 10px;
            }
        }
        
        @media (max-width: 480px) {
            #stage-select-screen {
                padding: 5px 3% 12px;
            }
            
            #stage-select-screen h1 {
                font-size: 20px;
                margin: 2px 0 4px;
            }
            
            #stage-select-screen p {
                font-size: 12px;
                margin-bottom: 8px;
            }
            
            .stage-grid {
                gap: 10px;
            }
            
            .stage-card {
                padding: 12px;
            }
        }
        
        /* å›¾é‰´æ ·å¼ */
        #collection-screen {
            background: rgba(255, 255, 255, 0.95);
            justify-content: flex-start;
            overflow: hidden; /* å¤–å±‚ä¸æ»šåŠ¨ */
            z-index: 200 !important;
            padding: 0; /* é‡ç½® padding */
            pointer-events: auto !important;
            touch-action: pan-y !important;
        }
        
        /* å›¾é‰´å†…å®¹åŒ…è£…å™¨ - å®é™…æ»šåŠ¨åŒºåŸŸ */
        .collection-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            overflow-y: scroll;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            touch-action: pan-y !important;
            overscroll-behavior: contain;
            padding: 20px;
            padding-bottom: 80px;
            box-sizing: border-box;
            pointer-events: auto !important;
        }
        
        #collection-screen h1 {
            font-size: 32px;
            color: #ff758c;
            margin-bottom: 10px;
        }
        
        .collection-progress {
            font-size: 18px;
            color: #666;
            margin-bottom: 15px;
            font-weight: bold;
        }
        
        /* æ ‡ç­¾é¡µæ ·å¼ */
        .collection-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            justify-content: center;
            touch-action: pan-y !important;
        }
        
        .tab-btn {
            padding: 8px 16px;
            background: #f0f0f0;
            border: 2px solid #ddd;
            border-radius: 20px;
            color: #666;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .tab-btn:hover {
            background: #e0e0e0;
        }
        
        .tab-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: #667eea;
        }
        
        /* å›¾é‰´å…³é—­æŒ‰é’® */
        #collection-close-btn {
            position: fixed;
            top: max(15px, env(safe-area-inset-top));
            right: max(15px, env(safe-area-inset-right));
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #ddd;
            color: #666;
            font-size: 24px;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 201;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: all 0.2s;
        }
        
        #collection-close-btn:hover {
            background: #f0f0f0;
            transform: scale(1.05);
        }
        
        #collection-close-btn:active {
            transform: scale(0.95);
        }
        
        .fish-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 10px;
            width: 100%;
            max-width: 800px;
            margin: 0 auto 20px;
            touch-action: pan-y !important;
        }
        
        .fish-item {
            background: white;
            border-radius: 10px;
            padding: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s;
            position: relative;
            min-height: 85px;
        }
        
        .fish-item:not(.locked) {
            cursor: pointer;
        }
        
        .fish-item:not(.locked):hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .fish-item:not(.locked):active {
            transform: translateY(-1px);
        }
        
        .fish-item.locked {
            background: #e0e0e0;
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .fish-icon {
            font-size: 40px;
            margin-bottom: 8px;
        }
        
        .fish-canvas {
            width: 60px;
            height: 60px;
            margin-bottom: 5px;
        }
        
        .fish-name {
            font-size: 10px;
            color: #666;
            text-align: center;
            word-break: break-all;
            line-height: 1.2;
        }
        
        .fish-item.locked .fish-name {
            color: #999;
        }
        
        /* é±¼ç±»ä»‹ç»å¼¹çª— */
        #fish-detail-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 300;
            padding: 20px;
            box-sizing: border-box;
        }
        
        .fish-detail-content {
            background: white;
            border-radius: 16px;
            padding: 20px;
            max-width: 320px;
            width: 85%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            position: relative;
            text-align: center;
        }
        
        .fish-detail-canvas {
            width: 80px;
            height: 80px;
            margin: 0 auto 10px;
        }
        
        .fish-detail-name {
            font-size: 20px;
            font-weight: bold;
            color: #ff758c;
            margin-bottom: 10px;
        }
        
        .fish-detail-desc {
            font-size: 14px;
            color: #666;
            line-height: 1.6;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .fish-detail-close {
            padding: 10px 24px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .fish-detail-close:hover {
            transform: scale(1.05);
        }
        
        .fish-detail-close:active {
            transform: scale(0.95);
        }
        
        @media (max-width: 768px) {
            .fish-grid {
                grid-template-columns: repeat(auto-fill, minmax(65px, 1fr));
                gap: 8px;
            }
            
            .fish-item {
                padding: 6px;
                min-height: 75px;
            }
            
            .fish-canvas {
                width: 55px;
                height: 55px;
            }
            
            .fish-name {
                font-size: 9px;
            }
            
            .fish-name {
                font-size: 11px;
            }
            
            #collection-screen h1 {
                font-size: 24px;
            }
            
            .collection-progress {
                font-size: 16px;
            }
            
            .tab-btn {
                padding: 6px 12px;
                font-size: 13px;
            }
        }
    </style>
    <!-- èƒŒæ™¯å›¾ Base64ï¼Œé¿å…å›½å†…æ— æ³•åŠ è½½ GitHub å›¾ç‰‡ -->
    <script src="static/bg-base64.js"></script>
</head>
<body>

<div id="particles-container"></div>
<div id="unlock-msg">âš ï¸ æ–°æŒ‘æˆ˜å‡ºç°! âš ï¸</div>

<div id="event-banner">
    <div class="event-title" id="event-title">âš¡ äº‹ä»¶å‘ç”Ÿ âš¡</div>
    <div class="event-desc" id="event-desc">æè¿°æ–‡å­—</div>
</div>

<div id="ui-layer" style="display:none;">
    <div class="score-text">æ‹çˆ±æŒ‡æ•°: <span id="score">0</span> â¤ï¸</div>
    <div class="sub-text">æˆ‘ä»¬åœ¨ä¸€èµ·: <span id="size-display">1</span> å¤©</div>
    <div id="high-score-hint"></div>
    <div style="margin-top:12px; position:relative;">
        <div id="fever-text">å¿ƒåŠ¨å€¼ ğŸ’– (åƒçˆ±å¿ƒå¢åŠ )</div>
        <div id="fever-container"><div id="fever-bar"></div></div>
    </div>
    <div id="buff-bar"></div>
</div>

<!-- å…³å¡ç›®æ ‡æ˜¾ç¤º -->
<div id="stage-objective-display">
    <div class="objective-title">å…³å¡ç›®æ ‡</div>
    <div class="objective-progress" id="objective-progress">0 / 100</div>
</div>

<button id="pause-btn" style="display:none;" onclick="pauseGame(event)">â¸</button>
<button id="collection-btn" style="display:none;" onclick="openCollection(event)">ğŸŸ</button>
<button id="collection-btn-menu" style="display:none;" onclick="openCollectionFromMenu(event)">ğŸŸ</button>
<button id="leaderboard-btn-menu" style="display:none;" onclick="showLeaderboard()">ğŸ†</button>
<button id="skin-btn-menu" style="display:none;" onclick="showSkinScreen()">ğŸ€</button>

<button id="skin-close-btn" onclick="hideSkinScreen()" style="display:none;">Ã—</button>
<button id="leaderboard-close-btn" onclick="hideLeaderboard()" style="display:none;">Ã—</button>
<!-- çš®è‚¤é€‰æ‹©ç•Œé¢ -->
<div id="skin-screen" class="overlay-screen" style="display: none;">
    <div class="skin-container">
        <h2 class="skin-title">ğŸ€ è£…æ‰®å°çª— ğŸ€</h2>
        <p class="skin-subtitle">ä¸ºå°ç²‰å’Œèªä»”æŒ‘é€‰å¯çˆ±çš„è£…é¥°å§ï¼</p>
        
        <div class="skin-section">
            <div class="skin-section-title">ğŸ  å°ç²‰çš„è£…é¥°</div>
            <div class="skin-grid" id="player-skin-grid"></div>
        </div>
        
        <div class="skin-section">
            <div class="skin-section-title">ğŸŸ èªä»”çš„è£…é¥°</div>
            <div class="skin-grid" id="guardian-skin-grid"></div>
        </div>
    </div>
</div>

<!-- å¼€å§‹ç•Œé¢ (èƒŒæ™¯é€æ˜ï¼Œæ˜¾ç¤ºCanvas) -->
<div id="start-screen" class="overlay-screen">
    <h1>ğŸ’– çˆ±çš„å®ˆæŠ¤ ğŸ’–</h1>
    <p id="start-desc">æ­£åœ¨åŠ è½½çˆ±çš„èª“è¨€...</p>
    <!-- é¦–é¡µæœ€é«˜åˆ†å¡ç‰‡ -->
    <div class="high-score-card" id="home-high-scores">
        <div class="high-score-item easy">
            <div class="label">ğŸ° ç”œèœœçº¦ä¼š</div>
            <div class="value" id="home-score-easy">0</div>
        </div>
        <div class="high-score-item normal">
            <div class="label">ğŸ  å¹¸ç¦æ—¥å¸¸</div>
            <div class="value" id="home-score-normal">0</div>
        </div>
        <div class="high-score-item hard">
            <div class="label">ğŸ›¡ï¸ å®ˆæŠ¤ä¸€ç”Ÿ</div>
            <div class="value" id="home-score-hard">0</div>
        </div>
    </div>
    <div class="btn-group">
        <button class="btn-easy" onclick="startGame('easy')">ğŸ° ç”œèœœçº¦ä¼š (ç®€å•)</button>
        <button class="btn-normal" onclick="startGame('normal')">ğŸ  å¹¸ç¦æ—¥å¸¸ (æ™®é€š)</button>
        <button class="btn-hard" onclick="startGame('hard')">ğŸ›¡ï¸ å®ˆæŠ¤ä¸€ç”Ÿ (å›°éš¾)</button>
        <button class="btn-stage" onclick="showStageSelect()">ğŸª é—¯å…³æ¨¡å¼</button>
    </div>
</div>

<!-- å…³å¡é€‰æ‹©ç•Œé¢ -->
<div id="stage-select-screen" class="overlay-screen" style="display: none;">
    <h1>ğŸª é—¯å…³æŒ‘æˆ˜</h1>
    <p>æŒ‘æˆ˜ä¸åŒçš„å…³å¡ç›®æ ‡ï¼Œè¯æ˜ä½ çš„å®åŠ›ï¼</p>
    <div class="stage-grid" id="stage-grid"></div>
    <button class="btn-back" onclick="showStartScreen()">è¿”å›ä¸»èœå•</button>
</div>

<!-- å…³å¡å®Œæˆç•Œé¢ -->
<div id="stage-complete-screen" class="overlay-screen" style="display: none;">
    <h2 style="font-size: 32px; color: #667eea;">ğŸ‰ å…³å¡å®Œæˆï¼</h2>
    <p id="stage-complete-message" style="font-size: 18px; color:#666; margin:20px 0;"></p>
    <div id="stage-rating" style="font-size: 36px; margin: 10px 0;">â­â­â­</div>
    <p style="font-size: 18px; color:#888;">ç”¨æ—¶: <span id="stage-time-used" style="color: #667eea; font-weight:bold;">0ç§’</span></p>
    <p style="font-size: 20px;">è·å¾—åˆ†æ•°: <span id="stage-final-score" style="color: #667eea; font-weight:bold;">0</span></p>
    <div class="btn-group">
        <button class="btn-stage" onclick="nextStage()" id="next-stage-btn">ä¸‹ä¸€å…³</button>
        <button class="btn-back" onclick="showStageSelect()">è¿”å›å…³å¡é€‰æ‹©</button>
    </div>
</div>

<!-- æš‚åœç•Œé¢ -->
<div id="pause-screen" class="overlay-screen game-overlay" style="display: none;">
    <h2 style="color:#ff758c;">æ¸¸æˆæš‚åœ</h2>
    <p style="font-size: 18px; margin: 10px 0;">å½“å‰åˆ†æ•°: <span id="pause-current-score" style="color: #ff4081; font-weight:bold;">0</span></p>
    <p id="pause-high-score-info" style="font-size: 14px; color: #666; margin: 5px 0 15px 0; padding: 8px 15px; background: rgba(255,64,129,0.1); border-radius: 10px;"></p>
    <div class="btn-group">
        <button class="btn-resume" onclick="resumeGame()">â–¶ ç»§ç»­çˆ±</button>
        <button class="btn-quit" onclick="quitGameFromPause()">âœ– ä¼‘æ¯ä¸€ä¸‹ (ç»“æŸ)</button>
    </div>
</div>

<!-- ç»“æŸç•Œé¢ -->
<div id="game-over-screen" class="overlay-screen game-overlay" style="display: none;">
    <h2 style="font-size: 28px; color: #ff5858;">åˆ«æ€•ï¼Œèªä»”åœ¨å‘¢</h2>
    <p id="death-reason" style="font-size: 16px;">å¦‚æœä¸å¼€å¿ƒäº†ï¼Œæˆ‘æ¥å“„ä½ ~</p>
    <p style="font-size: 20px;">æ”¶è·çˆ±å¿ƒ: <span id="final-score" style="color: #ff4081; font-weight:bold;">0</span></p>
    <p id="game-over-high-score-info" style="font-size: 14px; color: #666; margin: 10px 0; padding: 10px 15px; background: rgba(255,64,129,0.1); border-radius: 10px; max-width: 280px;"></p>
    <button class="btn-restart" onclick="showStartScreen()">å†çˆ±ä¸€æ¬¡</button>
</div>

<!-- æ’è¡Œæ¦œç•Œé¢ -->
<div id="leaderboard-screen" class="overlay-screen" style="display: none;">
    <div class="leaderboard-container">
        <h2 class="leaderboard-title">ğŸ† æˆ‘çš„æœ€é«˜åˆ† ğŸ†</h2>
        <div class="leaderboard-card easy">
            <div class="leaderboard-card-header">
                <span class="leaderboard-card-icon">ğŸ°</span>
                <div>
                    <div class="leaderboard-card-title">ç”œèœœçº¦ä¼š</div>
                    <div class="leaderboard-card-subtitle">ç®€å•æ¨¡å¼</div>
                </div>
            </div>
            <div class="leaderboard-card-score" id="lb-score-easy">0</div>
            <div class="leaderboard-card-footer">çˆ±å¿ƒçº¦ä¼šï¼Œç”œèœœæ»¡æº¢</div>
        </div>
        <div class="leaderboard-card normal">
            <div class="leaderboard-card-header">
                <span class="leaderboard-card-icon">ğŸ </span>
                <div>
                    <div class="leaderboard-card-title">å¹¸ç¦æ—¥å¸¸</div>
                    <div class="leaderboard-card-subtitle">æ™®é€šæ¨¡å¼</div>
                </div>
            </div>
            <div class="leaderboard-card-score" id="lb-score-normal">0</div>
            <div class="leaderboard-card-footer">ç®€å•çš„å¹¸ç¦ï¼Œå¹³å‡¡çš„å¿«ä¹</div>
        </div>
        <div class="leaderboard-card hard">
            <div class="leaderboard-card-header">
                <span class="leaderboard-card-icon">ğŸ›¡ï¸</span>
                <div>
                    <div class="leaderboard-card-title">å®ˆæŠ¤ä¸€ç”Ÿ</div>
                    <div class="leaderboard-card-subtitle">å›°éš¾æ¨¡å¼</div>
                </div>
            </div>
            <div class="leaderboard-card-score" id="lb-score-hard">0</div>
            <div class="leaderboard-card-footer">çˆ±çš„å®ˆæŠ¤ï¼Œæ°¸ä¸æ”¾å¼ƒ</div>
        </div>
    </div>
</div>

<!-- å›¾é‰´ç•Œé¢ -->
<div id="collection-screen" class="overlay-screen" style="display: none;">
    <button id="collection-close-btn" onclick="closeCollection()" style="display:none;">Ã—</button>
    <div class="collection-container">
        <h1>ğŸŸ é±¼ç±»å›¾é‰´</h1>
        <p class="collection-progress">æ”¶é›†è¿›åº¦: <span id="collection-progress">0 / 0</span></p>
        <div class="collection-tabs">
            <button class="tab-btn active" onclick="filterFish('all')">å…¨éƒ¨</button>
            <button class="tab-btn" onclick="filterFish('small')">å°é±¼</button>
            <button class="tab-btn" onclick="filterFish('medium')">ä¸­å‹é±¼</button>
            <button class="tab-btn" onclick="filterFish('large')">å¤§é±¼</button>
            <button class="tab-btn" onclick="filterFish('huge')">å·¨å‹é±¼</button>
            <button class="tab-btn" onclick="filterFish('rare')">ç¨€æœ‰é±¼</button>
        </div>
        <div class="fish-grid" id="fish-grid"></div>
    </div>
</div>

<!-- é±¼ç±»è¯¦æƒ…å¼¹çª— -->
<div id="fish-detail-modal">
    <div class="fish-detail-content">
        <canvas id="fish-detail-canvas" class="fish-detail-canvas" width="80" height="80"></canvas>
        <div class="fish-detail-name" id="fish-detail-name"></div>
        <div class="fish-detail-desc" id="fish-detail-desc"></div>
        <button class="fish-detail-close" onclick="closeFishDetail()">å…³é—­</button>
    </div>
</div>

<canvas id="gameCanvas"></canvas>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const uiLayer = document.getElementById('ui-layer');
    const buffBar = document.getElementById('buff-bar');
    const pauseBtn = document.getElementById('pause-btn');
    const startScreen = document.getElementById('start-screen');
    const startDesc = document.getElementById('start-desc');
    const gameOverScreen = document.getElementById('game-over-screen');
    const pauseScreen = document.getElementById('pause-screen');
    const scoreEl = document.getElementById('score');
    const sizeEl = document.getElementById('size-display');
    const finalScoreEl = document.getElementById('final-score');
    const deathReasonEl = document.getElementById('death-reason');
    const particlesContainer = document.getElementById('particles-container');
    const feverBar = document.getElementById('fever-bar');
    const unlockMsg = document.getElementById('unlock-msg');
    const eventBanner = document.getElementById('event-banner');
    const eventTitle = document.getElementById('event-title');
    const eventDesc = document.getElementById('event-desc');
    const body = document.body;

    const input = { x: 0, y: 0 };
    let animationId;
    let score = 0;
    let gameRunning = false;
    let isPaused = false;
    let frameCount = 0;
    let gameTime = 0; // æ¸¸æˆæ—¶é—´ï¼ˆç§’ï¼‰ï¼Œç”¨äºè®¡ç®—å¤©æ•°ï¼ˆ1åˆ†é’Ÿ=1å¤©ï¼‰
    let currentDifficulty = {};
    let currentDifficultyName = '';
    let feverValue = 0;
    let isFeverMode = false;
    let feverTimer = 0;
    let unlockedStages = { 500: false, 1000: false, 2000: false, 3000: false };
    let discoveredRareFish = new Set(); // å·²å‘ç°çš„ç¨€æœ‰é±¼ç§

    // å›¾é‰´ç³»ç»Ÿå˜é‡
    const collectionBtn = document.getElementById('collection-btn');
    const collectionBtnMenu = document.getElementById('collection-btn-menu');
    const collectionScreen = document.getElementById('collection-screen');
    const collectionProgress = document.getElementById('collection-progress');
    const fishGrid = document.getElementById('fish-grid');
    const collectionCloseBtn = document.getElementById('collection-close-btn');
    const fishDetailModal = document.getElementById('fish-detail-modal');
    const fishDetailCanvas = document.getElementById('fish-detail-canvas');
    const fishDetailName = document.getElementById('fish-detail-name');
    const fishDetailDesc = document.getElementById('fish-detail-desc');
    let collectedFish = new Set(); // å·²æ”¶é›†çš„é±¼ç±» subtype
    let isCollectionOpen = false; // å›¾é‰´æ˜¯å¦æ‰“å¼€
    let lastSaveTime = null; // æœ€åä¸€æ¬¡ä¿å­˜æ—¶é—´
    let currentFilter = 'all'; // å½“å‰ç­›é€‰ç±»å‹

    // é—¯å…³æ¨¡å¼å˜é‡
    let isStageMode = false;
    let currentStage = 0;
    let stageProgress = 0;
    let stageObjectiveDisplay = null;
    let stageObjectiveProgress = null;
    let stageSelectScreen = null;
    let stageCompleteScreen = null;
    let stageSurviveStartTime = 0; // ç”Ÿå­˜å…³å¡çš„å¼€å§‹æ—¶é—´
    let stageObstaclesDodged = 0; // èº²é¿çš„éšœç¢æ•°é‡
    let stageStartTime = 0; // å…³å¡å¼€å§‹æ—¶é—´ï¼ˆç”¨äºè®¡æ—¶å’Œå€’è®¡æ—¶ï¼‰
    let stageTimeLimit = 0; // å…³å¡æ—¶é—´é™åˆ¶ï¼ˆç§’ï¼‰

    // å…³å¡é…ç½®
    const STAGES = [
        {
            id: 1,
            name: '"åˆæ¬¡ç›¸é‡"',
            icon: 'ğŸ’•',
            desc: 'æ”¶é›†50ä¸ªçˆ±å¿ƒï¼Œå¼€å§‹ä½ ä»¬çš„çˆ±æƒ…æ•…äº‹',
            difficulty: 'easy',
            type: 'collect_hearts',
            target: 50,
            timeLimit: null,
            objectiveText: 'æ”¶é›†çˆ±å¿ƒ',
            completeMessage: 'ç¬¬ä¸€æ¬¡ç›¸é‡ï¼Œå°±è¢«ä½ å¸å¼•äº†ï¼'
        },
        {
            id: 2,
            name: '"ç”œèœœæ—¶å…‰"',
            icon: 'â±ï¸',
            desc: 'åœ¨60ç§’å†…æ”¶é›†å°½å¯èƒ½å¤šçš„çˆ±å¿ƒ',
            difficulty: 'easy',
            type: 'timed_collect',
            target: 80,
            timeLimit: 60,
            heartSpawnBoost: 2, // çˆ±å¿ƒç”Ÿæˆé¢‘ç‡æå‡2å€
            objectiveText: 'é™æ—¶æ”¶é›†',
            completeMessage: 'å’Œä½ åœ¨ä¸€èµ·çš„æ¯ä¸€ç§’éƒ½å¾ˆç”œèœœï¼'
        },
        {
            id: 3,
            name: '"ç”Ÿå­˜æŒ‘æˆ˜"',
            icon: 'â°',
            desc: 'åœ¨å›°éš¾ä¸­ç”Ÿå­˜90ç§’',
            difficulty: 'normal',
            type: 'survive',
            target: 90,
            timeLimit: null,
            objectiveText: 'ç”Ÿå­˜æ—¶é—´',
            completeMessage: 'æœ‰ä½ åœ¨ï¼Œæˆ‘èƒ½åº¦è¿‡ä»»ä½•å›°éš¾ï¼'
        },
        {
            id: 4,
            name: '"è¿·é›¾ä¸­çš„çˆ±"',
            icon: 'ğŸŒ«ï¸',
            desc: 'åœ¨è¿·é›¾äº‹ä»¶ä¸­æ”¶é›†40ä¸ªçˆ±å¿ƒ',
            difficulty: 'normal',
            type: 'fog_collect',
            target: 40,
            timeLimit: null,
            objectiveText: 'è¿·é›¾ä¸­æ”¶é›†',
            completeMessage: 'è¿·é›¾ä¸­ï¼Œä½ å°±æ˜¯æˆ‘çš„ç¯å¡”ï¼'
        },
        {
            id: 5,
            name: '"èº²é¿å¤§å¸ˆ"',
            icon: 'ğŸ¯',
            desc: 'èº²é¿100æ¡éšœç¢é±¼è€Œä¸å—ä¼¤',
            difficulty: 'normal',
            type: 'dodge_obstacles',
            target: 100,
            timeLimit: null,
            objectiveText: 'èº²é¿éšœç¢',
            completeMessage: 'æˆ‘ä¼šèº²å¼€æ‰€æœ‰ä¼¤å®³ä½ çš„äº‹ç‰©ï¼'
        },
        {
            id: 6,
            name: '"æ¿€æµå‹‡è¿›"',
            icon: 'ğŸŒŠ',
            desc: 'åœ¨æ¿€æµäº‹ä»¶ä¸­æ”¶é›†30ä¸ªçˆ±å¿ƒ',
            difficulty: 'normal',
            type: 'current_collect',
            target: 30,
            timeLimit: null,
            objectiveText: 'æ¿€æµä¸­æ”¶é›†',
            completeMessage: 'é€†é£å‰è¡Œï¼Œå› ä¸ºæœ‰ä½ åœ¨ç­‰æˆ‘ï¼'
        },
        {
            id: 7,
            name: '"ç»ˆæè€ƒéªŒ"',
            icon: 'ğŸ†',
            desc: 'åœ¨å›°éš¾æ¨¡å¼ä¸‹æ”¶é›†50ä¸ªçˆ±å¿ƒ',
            difficulty: 'hard',
            type: 'collect_hearts',
            target: 50,
            timeLimit: null,
            heartSpawnBoost: 1.5, // çˆ±å¿ƒç”Ÿæˆé¢‘ç‡æå‡1.5å€
            objectiveText: 'å›°éš¾æ”¶é›†',
            completeMessage: 'æˆ‘ä»¬ä¸€èµ·ï¼Œæ²¡æœ‰ä»€ä¹ˆä¸å¯èƒ½ï¼'
        },
        {
            id: 8,
            name: '"æ°¸æ’çš„çˆ±"',
            icon: 'ğŸ’–',
            desc: 'åœ¨å›°éš¾æ¨¡å¼ä¸‹ç”Ÿå­˜120ç§’',
            difficulty: 'hard',
            type: 'survive',
            target: 120,
            timeLimit: null,
            objectiveText: 'å›°éš¾ç”Ÿå­˜',
            completeMessage: 'æˆ‘ä»¬çš„çˆ±ï¼Œç»å¾—èµ·ä»»ä½•è€ƒéªŒï¼'
        }
    ];

    // å…³å¡è¿›åº¦ï¼ˆä» localStorage åŠ è½½ï¼‰
    let stageProgress_data = {};
    try {
        const saved = safeLocalStorageGet('love_game_stage_progress');
        if (saved) {
            stageProgress_data = JSON.parse(saved);
        }
    } catch (e) {
        console.warn('åŠ è½½å…³å¡è¿›åº¦å¤±è´¥:', e);
    }

    // ========== æœ€é«˜åˆ†ç³»ç»Ÿ ==========
    let highScores = { easy: 0, normal: 0, hard: 0 };
    
    // åŠ è½½æœ€é«˜åˆ†
    function loadHighScores() {
        try {
            const saved = safeLocalStorageGet('love_game_high_scores');
            if (saved) {
                highScores = JSON.parse(saved);
                console.log('æœ€é«˜åˆ†åŠ è½½æˆåŠŸ:', highScores);
            }
        } catch (e) {
            console.warn('åŠ è½½æœ€é«˜åˆ†å¤±è´¥:', e);
        }
    }
    
    // ä¿å­˜æœ€é«˜åˆ†
    function saveHighScores() {
        try {
            safeLocalStorageSet('love_game_high_scores', JSON.stringify(highScores));
        } catch (e) {
            console.warn('ä¿å­˜æœ€é«˜åˆ†å¤±è´¥:', e);
        }
    }
    
    // æ£€æŸ¥å¹¶æ›´æ–°æœ€é«˜åˆ†ï¼Œè¿”å›æ˜¯å¦ç ´çºªå½•
    function checkAndUpdateHighScore() {
        if (!currentDifficultyName || isStageMode) return false;
        const currentHigh = highScores[currentDifficultyName] || 0;
        if (score > currentHigh) {
            highScores[currentDifficultyName] = score;
            saveHighScores();
            return true;
        }
        return false;
    }
    
    // è·å–é¼“åŠ±è¯­
    function getEncouragementText(isNewRecord, difficultyName) {
        const difficultyLabels = { easy: 'ç”œèœœçº¦ä¼š', normal: 'å¹¸ç¦æ—¥å¸¸', hard: 'å®ˆæŠ¤ä¸€ç”Ÿ' };
        const label = difficultyLabels[difficultyName] || difficultyName;
        
        if (isNewRecord) {
            const newRecordTexts = [
                `ğŸ‰ æ–°çºªå½•ï¼ä½ åœ¨ã€Œ${label}ã€æ¨¡å¼åˆ›é€ äº†æ–°çš„æœ€é«˜åˆ†ï¼`,
                `âœ¨ å¤ªå‰å®³äº†ï¼ã€Œ${label}ã€æ¨¡å¼æœ€é«˜åˆ†è¢«ä½ åˆ·æ–°äº†ï¼`,
                `ğŸ’– å“‡ï¼ä½ æ‰“ç ´äº†ã€Œ${label}ã€æ¨¡å¼çš„è®°å½•ï¼`,
                `ğŸ† æ­å–œï¼ã€Œ${label}ã€æ¨¡å¼æ–°çºªå½•è¯ç”Ÿï¼`,
                `ğŸŒŸ ä½ æ˜¯æœ€æ£’çš„ï¼ã€Œ${label}ã€æœ€é«˜åˆ†å·²æ›´æ–°ï¼`
            ];
            return newRecordTexts[Math.floor(Math.random() * newRecordTexts.length)];
        } else {
            const highScore = highScores[difficultyName] || 0;
            if (score === 0) {
                return `åŠ æ²¹ï¼ã€Œ${label}ã€æœ€é«˜åˆ†: ${highScore}`;
            } else if (score < highScore * 0.5) {
                const texts = [
                    `ç»§ç»­åŠªåŠ›ï¼ç¦»ã€Œ${label}ã€æœ€é«˜åˆ† ${highScore} è¿˜æœ‰ä¸€æ®µè·ç¦»~`,
                    `åˆ«ç°å¿ƒï¼ã€Œ${label}ã€æœ€é«˜åˆ† ${highScore} åœ¨ç­‰ä½ è¶…è¶Šï¼`,
                    `æ…¢æ…¢æ¥ï½ã€Œ${label}ã€æœ€é«˜åˆ†æ˜¯ ${highScore}ï¼Œä½ å¯ä»¥çš„ï¼`
                ];
                return texts[Math.floor(Math.random() * texts.length)];
            } else if (score < highScore) {
                const texts = [
                    `å¾ˆæ¥è¿‘äº†ï¼ã€Œ${label}ã€æœ€é«˜åˆ† ${highScore}ï¼Œå†åŠ æŠŠåŠ²ï¼`,
                    `å°±å·®ä¸€ç‚¹ç‚¹ï¼ã€Œ${label}ã€æœ€é«˜åˆ† ${highScore}ï¼Œä¸‹æ¬¡ä¸€å®šè¡Œï¼`,
                    `å¥½å‰å®³ï¼ç¦»ã€Œ${label}ã€æœ€é«˜åˆ† ${highScore} åªå·® ${highScore - score} åˆ†ï¼`
                ];
                return texts[Math.floor(Math.random() * texts.length)];
            } else {
                return `ã€Œ${label}ã€æœ€é«˜åˆ†: ${highScore}ï¼Œä¿æŒå¾—å¾ˆå¥½ï¼`;
            }
        }
    }
    
    // åˆå§‹åŒ–æ—¶åŠ è½½æœ€é«˜åˆ†
    loadHighScores();
    
    // ========== è£…é¥°çš®è‚¤ç³»ç»Ÿ ==========
    const DECORATIONS = {
        player: [
            { id: 'none', name: 'æ— è£…é¥°', icon: 'âœ¨', unlocked: true },
            { id: 'flower', name: 'å°èŠ±èŠ±', icon: 'ğŸŒ¸', condition: { type: 'score', difficulty: 'easy', value: 200 }, conditionText: 'ç”œèœœçº¦ä¼š200åˆ†' },
            { id: 'bow', name: 'è´è¶ç»“', icon: 'ğŸ€', condition: { type: 'score', difficulty: 'easy', value: 400 }, conditionText: 'ç”œèœœçº¦ä¼š400åˆ†' },
            { id: 'heart', name: 'çˆ±å¿ƒå‘å¡', icon: 'ğŸ’•', condition: { type: 'score', difficulty: 'easy', value: 600 }, conditionText: 'ç”œèœœçº¦ä¼š600åˆ†' },
            { id: 'cherry', name: 'æ¨±æ¡ƒå‘å¤¹', icon: 'ğŸ’', condition: { type: 'score', difficulty: 'normal', value: 300 }, conditionText: 'å¹¸ç¦æ—¥å¸¸300åˆ†' },
            { id: 'tiara', name: 'å…¬ä¸»çš‡å† ', icon: 'ğŸ‘¸', condition: { type: 'score', difficulty: 'normal', value: 600 }, conditionText: 'å¹¸ç¦æ—¥å¸¸600åˆ†' },
            { id: 'crown', name: 'å°çš‡å† ', icon: 'ğŸ‘‘', condition: { type: 'score', difficulty: 'normal', value: 1000 }, conditionText: 'å¹¸ç¦æ—¥å¸¸1000åˆ†' },
            { id: 'star', name: 'æ˜Ÿæ˜Ÿå‘é¥°', icon: 'â­', condition: { type: 'score', difficulty: 'hard', value: 400 }, conditionText: 'å®ˆæŠ¤ä¸€ç”Ÿ400åˆ†' },
            { id: 'butterfly', name: 'è´è¶å‘ç°ª', icon: 'ğŸ¦‹', condition: { type: 'score', difficulty: 'hard', value: 800 }, conditionText: 'å®ˆæŠ¤ä¸€ç”Ÿ800åˆ†' },
            { id: 'halo', name: 'å¤©ä½¿å…‰ç¯', icon: 'ğŸ˜‡', condition: { type: 'score', difficulty: 'hard', value: 1200 }, conditionText: 'å®ˆæŠ¤ä¸€ç”Ÿ1200åˆ†' },
            { id: 'rainbow', name: 'å½©è™¹å…‰è½®', icon: 'ğŸŒˆ', condition: { type: 'score', difficulty: 'hard', value: 2000 }, conditionText: 'å®ˆæŠ¤ä¸€ç”Ÿ2000åˆ†' },
        ],
        guardian: [
            { id: 'none', name: 'æ— è£…é¥°', icon: 'âœ¨', unlocked: true },
            { id: 'glasses', name: 'é…·é…·å¢¨é•œ', icon: 'ğŸ•¶ï¸', condition: { type: 'score', difficulty: 'easy', value: 250 }, conditionText: 'ç”œèœœçº¦ä¼š250åˆ†' },
            { id: 'bowtie', name: 'ç»…å£«é¢†ç»“', icon: 'ğŸ€', condition: { type: 'score', difficulty: 'easy', value: 500 }, conditionText: 'ç”œèœœçº¦ä¼š500åˆ†' },
            { id: 'scarf', name: 'è‹±å‹‡å›´å·¾', icon: 'ğŸ§£', condition: { type: 'score', difficulty: 'easy', value: 800 }, conditionText: 'ç”œèœœçº¦ä¼š800åˆ†' },
            { id: 'cap', name: 'å°å¸½å­', icon: 'ğŸ§¢', condition: { type: 'score', difficulty: 'normal', value: 500 }, conditionText: 'å¹¸ç¦æ—¥å¸¸500åˆ†' },
            { id: 'headband', name: 'è¿åŠ¨å¤´å¸¦', icon: 'ğŸƒ', condition: { type: 'score', difficulty: 'normal', value: 800 }, conditionText: 'å¹¸ç¦æ—¥å¸¸800åˆ†' },
            { id: 'tophat', name: 'é­”æœ¯å¸½', icon: 'ğŸ©', condition: { type: 'score', difficulty: 'normal', value: 1200 }, conditionText: 'å¹¸ç¦æ—¥å¸¸1200åˆ†' },
            { id: 'shield', name: 'å®ˆæŠ¤ä¹‹ç›¾', icon: 'ğŸ›¡ï¸', condition: { type: 'score', difficulty: 'hard', value: 600 }, conditionText: 'å®ˆæŠ¤ä¸€ç”Ÿ600åˆ†' },
            { id: 'sword', name: 'å‹‡è€…ä¹‹å‰‘', icon: 'âš”ï¸', condition: { type: 'score', difficulty: 'hard', value: 1000 }, conditionText: 'å®ˆæŠ¤ä¸€ç”Ÿ1000åˆ†' },
            { id: 'cape', name: 'è‹±é›„æŠ«é£', icon: 'ğŸ¦¸', condition: { type: 'score', difficulty: 'hard', value: 1500 }, conditionText: 'å®ˆæŠ¤ä¸€ç”Ÿ1500åˆ†' },
            { id: 'flame', name: 'çƒˆç„°å…‰ç¯', icon: 'ğŸ”¥', condition: { type: 'score', difficulty: 'hard', value: 2500 }, conditionText: 'å®ˆæŠ¤ä¸€ç”Ÿ2500åˆ†' },
        ]
    };
    
    let currentSkins = { player: 'none', guardian: 'none' };
    let unlockedSkins = { player: ['none'], guardian: ['none'] };
    
    // åŠ è½½çš®è‚¤æ•°æ®
    function loadSkinData() {
        try {
            const saved = safeLocalStorageGet('love_game_skins');
            if (saved) {
                const data = JSON.parse(saved);
                currentSkins = data.current || { player: 'none', guardian: 'none' };
                unlockedSkins = data.unlocked || { player: ['none'], guardian: ['none'] };
            }
        } catch (e) {
            console.warn('åŠ è½½çš®è‚¤æ•°æ®å¤±è´¥:', e);
        }
    }
    
    // ä¿å­˜çš®è‚¤æ•°æ®
    function saveSkinData() {
        try {
            safeLocalStorageSet('love_game_skins', JSON.stringify({
                current: currentSkins,
                unlocked: unlockedSkins
            }));
        } catch (e) {
            console.warn('ä¿å­˜çš®è‚¤æ•°æ®å¤±è´¥:', e);
        }
    }
    
    // æ£€æŸ¥çš®è‚¤è§£é”æ¡ä»¶
    function checkSkinUnlocks() {
        let newUnlocks = false;
        
        ['player', 'guardian'].forEach(role => {
            DECORATIONS[role].forEach(skin => {
                if (skin.unlocked || unlockedSkins[role].includes(skin.id)) return;
                
                if (skin.condition) {
                    const { type, difficulty, value } = skin.condition;
                    if (type === 'score' && highScores[difficulty] >= value) {
                        unlockedSkins[role].push(skin.id);
                        newUnlocks = true;
                    }
                }
            });
        });
        
        if (newUnlocks) saveSkinData();
        return newUnlocks;
    }
    
    // æ˜¾ç¤ºçš®è‚¤ç•Œé¢
    function showSkinScreen() {
        checkSkinUnlocks();
        renderSkinGrid();
        document.getElementById('skin-screen').style.display = 'flex';
        document.getElementById('skin-close-btn').style.display = 'flex';
        startScreen.style.display = 'none';
        collectionBtnMenu.style.display = 'none';
        document.getElementById('leaderboard-btn-menu').style.display = 'none';
        document.getElementById('skin-btn-menu').style.display = 'none';
    }
    
    // éšè—çš®è‚¤ç•Œé¢
    function hideSkinScreen() {
        document.getElementById('skin-screen').style.display = 'none';
        document.getElementById('skin-close-btn').style.display = 'none';
        startScreen.style.display = 'flex';
        collectionBtnMenu.style.display = 'flex';
        document.getElementById('leaderboard-btn-menu').style.display = 'flex';
        document.getElementById('skin-btn-menu').style.display = 'flex';
    }
    
    // æ¸²æŸ“çš®è‚¤é€‰æ‹©ç½‘æ ¼
    function renderSkinGrid() {
        ['player', 'guardian'].forEach(role => {
            const grid = document.getElementById(role + '-skin-grid');
            grid.innerHTML = '';
            
            DECORATIONS[role].forEach(skin => {
                const isUnlocked = skin.unlocked || unlockedSkins[role].includes(skin.id);
                const isSelected = currentSkins[role] === skin.id;
                
                const item = document.createElement('div');
                item.className = 'skin-item' + (isSelected ? ' selected' : '') + (isUnlocked ? '' : ' locked');
                
                item.innerHTML = `
                    <div class="skin-preview">${skin.icon}</div>
                    <div class="skin-name">${skin.name}</div>
                    ${!isUnlocked && skin.conditionText ? `<div class="skin-condition">${skin.conditionText}</div>` : ''}
                `;
                
                if (isUnlocked) {
                    item.onclick = () => selectSkin(role, skin.id);
                }
                
                grid.appendChild(item);
            });
        });
    }
    
    // é€‰æ‹©çš®è‚¤
    function selectSkin(role, skinId) {
        currentSkins[role] = skinId;
        saveSkinData();
        renderSkinGrid();
    }
    
    // ç»˜åˆ¶è£…é¥°
    function drawDecoration(ctx, type, decorationId, r, frameCount) {
        if (!decorationId || decorationId === 'none') return;
        
        ctx.save();
        
        if (type === 'player') {
            // ç²‰ç²‰çš„è£…é¥°ï¼ˆå¤´é¡¶ä½ç½®ï¼‰
            if (decorationId === 'bow') {
                // è´è¶ç»“
                ctx.fillStyle = '#ff69b4';
                ctx.beginPath();
                ctx.ellipse(0, -r * 1.1, r * 0.4, r * 0.25, -0.3, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.ellipse(0, -r * 1.1, r * 0.4, r * 0.25, 0.3, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(0, -r * 1.1, r * 0.12, 0, Math.PI * 2);
                ctx.fillStyle = '#ff1493';
                ctx.fill();
            } else if (decorationId === 'crown') {
                // å°çš‡å† 
                ctx.fillStyle = '#ffd700';
                ctx.beginPath();
                ctx.moveTo(-r * 0.5, -r * 0.9);
                ctx.lineTo(-r * 0.4, -r * 1.4);
                ctx.lineTo(-r * 0.15, -r * 1.1);
                ctx.lineTo(0, -r * 1.5);
                ctx.lineTo(r * 0.15, -r * 1.1);
                ctx.lineTo(r * 0.4, -r * 1.4);
                ctx.lineTo(r * 0.5, -r * 0.9);
                ctx.closePath();
                ctx.fill();
                ctx.fillStyle = '#ff6b6b';
                ctx.beginPath();
                ctx.arc(0, -r * 1.15, r * 0.08, 0, Math.PI * 2);
                ctx.fill();
            } else if (decorationId === 'flower') {
                // å°èŠ±èŠ±
                ctx.fillStyle = '#ffb6c1';
                for (let i = 0; i < 5; i++) {
                    ctx.beginPath();
                    const angle = (i * Math.PI * 2) / 5 - Math.PI / 2;
                    ctx.ellipse(
                        Math.cos(angle) * r * 0.2, 
                        -r * 1.1 + Math.sin(angle) * r * 0.2, 
                        r * 0.15, r * 0.1, angle, 0, Math.PI * 2
                    );
                    ctx.fill();
                }
                ctx.fillStyle = '#ffeb3b';
                ctx.beginPath();
                ctx.arc(0, -r * 1.1, r * 0.1, 0, Math.PI * 2);
                ctx.fill();
            } else if (decorationId === 'heart') {
                // çˆ±å¿ƒå‘å¡
                ctx.fillStyle = '#ff4081';
                ctx.beginPath();
                ctx.moveTo(0, -r * 1.0);
                ctx.bezierCurveTo(-r * 0.3, -r * 1.4, -r * 0.5, -r * 1.1, 0, -r * 0.85);
                ctx.bezierCurveTo(r * 0.5, -r * 1.1, r * 0.3, -r * 1.4, 0, -r * 1.0);
                ctx.fill();
            } else if (decorationId === 'star') {
                // æ˜Ÿæ˜Ÿå‘é¥°
                ctx.fillStyle = '#ffd700';
                ctx.beginPath();
                for (let i = 0; i < 5; i++) {
                    const angle = (i * Math.PI * 2) / 5 - Math.PI / 2;
                    const outerX = Math.cos(angle) * r * 0.3;
                    const outerY = -r * 1.2 + Math.sin(angle) * r * 0.3;
                    const innerAngle = angle + Math.PI / 5;
                    const innerX = Math.cos(innerAngle) * r * 0.12;
                    const innerY = -r * 1.2 + Math.sin(innerAngle) * r * 0.12;
                    if (i === 0) ctx.moveTo(outerX, outerY);
                    else ctx.lineTo(outerX, outerY);
                    ctx.lineTo(innerX, innerY);
                }
                ctx.closePath();
                ctx.fill();
            } else if (decorationId === 'halo') {
                // å¤©ä½¿å…‰ç¯
                ctx.strokeStyle = '#ffd700';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.ellipse(0, -r * 1.3, r * 0.4, r * 0.15, 0, 0, Math.PI * 2);
                ctx.stroke();
                ctx.globalAlpha = 0.3 + Math.sin(frameCount * 0.1) * 0.2;
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 5;
                ctx.stroke();
                ctx.globalAlpha = 1;
            } else if (decorationId === 'cherry') {
                // æ¨±æ¡ƒå‘å¤¹
                ctx.fillStyle = '#dc143c';
                ctx.beginPath();
                ctx.arc(-r * 0.15, -r * 1.1, r * 0.15, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(r * 0.15, -r * 1.0, r * 0.15, 0, Math.PI * 2);
                ctx.fill();
                ctx.strokeStyle = '#228b22';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(-r * 0.15, -r * 1.25);
                ctx.quadraticCurveTo(0, -r * 1.5, r * 0.15, -r * 1.15);
                ctx.stroke();
            } else if (decorationId === 'tiara') {
                // å…¬ä¸»çš‡å† 
                ctx.fillStyle = '#ffc0cb';
                ctx.beginPath();
                ctx.moveTo(-r * 0.4, -r * 0.9);
                ctx.lineTo(-r * 0.3, -r * 1.2);
                ctx.lineTo(-r * 0.1, -r * 1.0);
                ctx.lineTo(0, -r * 1.3);
                ctx.lineTo(r * 0.1, -r * 1.0);
                ctx.lineTo(r * 0.3, -r * 1.2);
                ctx.lineTo(r * 0.4, -r * 0.9);
                ctx.closePath();
                ctx.fill();
                ctx.fillStyle = '#ff69b4';
                ctx.beginPath();
                ctx.arc(0, -r * 1.1, r * 0.06, 0, Math.PI * 2);
                ctx.fill();
            } else if (decorationId === 'butterfly') {
                // è´è¶å‘ç°ª
                const flutter = Math.sin(frameCount * 0.15) * 0.2;
                ctx.fillStyle = '#da70d6';
                ctx.beginPath();
                ctx.ellipse(-r * 0.2, -r * 1.1, r * 0.25, r * 0.15, -0.5 + flutter, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.ellipse(r * 0.2, -r * 1.1, r * 0.25, r * 0.15, 0.5 - flutter, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#4b0082';
                ctx.fillRect(-r * 0.03, -r * 1.2, r * 0.06, r * 0.25);
            } else if (decorationId === 'rainbow') {
                // å½©è™¹å…‰è½®
                const colors = ['#ff0000', '#ff7f00', '#ffff00', '#00ff00', '#0000ff', '#4b0082', '#9400d3'];
                for (let i = 0; i < 7; i++) {
                    ctx.strokeStyle = colors[i];
                    ctx.lineWidth = 2;
                    ctx.globalAlpha = 0.6 + Math.sin(frameCount * 0.1 + i) * 0.3;
                    ctx.beginPath();
                    ctx.arc(0, -r * 0.5, r * 1.0 + i * 3, Math.PI * 1.1, Math.PI * 1.9);
                    ctx.stroke();
                }
                ctx.globalAlpha = 1;
            }
        } else if (type === 'guardian') {
            // èªä»”çš„è£…é¥°
            if (decorationId === 'glasses') {
                // å¢¨é•œ
                ctx.fillStyle = '#333';
                ctx.beginPath();
                ctx.roundRect(r * 0.2, -r * 0.5, r * 0.5, r * 0.35, 5);
                ctx.fill();
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(r * 0.2, -r * 0.35);
                ctx.lineTo(-r * 0.3, -r * 0.35);
                ctx.stroke();
            } else if (decorationId === 'cap') {
                // å°å¸½å­
                ctx.fillStyle = '#4169e1';
                ctx.beginPath();
                ctx.arc(0, -r * 0.8, r * 0.5, Math.PI, 0);
                ctx.fill();
                ctx.fillStyle = '#1e3a8a';
                ctx.beginPath();
                ctx.ellipse(r * 0.3, -r * 0.75, r * 0.4, r * 0.1, 0.2, 0, Math.PI * 2);
                ctx.fill();
            } else if (decorationId === 'bowtie') {
                // é¢†ç»“
                ctx.fillStyle = '#dc143c';
                ctx.beginPath();
                ctx.moveTo(0, r * 0.6);
                ctx.lineTo(-r * 0.35, r * 0.4);
                ctx.lineTo(-r * 0.35, r * 0.8);
                ctx.closePath();
                ctx.fill();
                ctx.beginPath();
                ctx.moveTo(0, r * 0.6);
                ctx.lineTo(r * 0.35, r * 0.4);
                ctx.lineTo(r * 0.35, r * 0.8);
                ctx.closePath();
                ctx.fill();
                ctx.fillStyle = '#8b0000';
                ctx.beginPath();
                ctx.arc(0, r * 0.6, r * 0.1, 0, Math.PI * 2);
                ctx.fill();
            } else if (decorationId === 'shield') {
                // ç›¾ç‰Œ
                ctx.fillStyle = '#4fc3f7';
                ctx.beginPath();
                ctx.moveTo(-r * 0.8, -r * 0.3);
                ctx.lineTo(-r * 0.8, r * 0.2);
                ctx.quadraticCurveTo(-r * 0.8, r * 0.6, -r * 0.5, r * 0.6);
                ctx.lineTo(-r * 0.5, -r * 0.3);
                ctx.closePath();
                ctx.fill();
                ctx.strokeStyle = '#0288d1';
                ctx.lineWidth = 2;
                ctx.stroke();
            } else if (decorationId === 'sword') {
                // å‰‘
                ctx.fillStyle = '#c0c0c0';
                ctx.beginPath();
                ctx.moveTo(r * 1.0, -r * 0.1);
                ctx.lineTo(r * 1.8, 0);
                ctx.lineTo(r * 1.0, r * 0.1);
                ctx.closePath();
                ctx.fill();
                ctx.fillStyle = '#8b4513';
                ctx.fillRect(r * 0.85, -r * 0.15, r * 0.2, r * 0.3);
                ctx.fillStyle = '#ffd700';
                ctx.fillRect(r * 0.8, -r * 0.2, r * 0.1, r * 0.4);
            } else if (decorationId === 'scarf') {
                // è‹±å‹‡å›´å·¾
                ctx.fillStyle = '#1e90ff';
                ctx.beginPath();
                ctx.moveTo(-r * 0.3, r * 0.5);
                ctx.lineTo(-r * 0.5, r * 1.2);
                ctx.lineTo(-r * 0.2, r * 1.1);
                ctx.lineTo(0, r * 0.6);
                ctx.closePath();
                ctx.fill();
                ctx.fillStyle = '#4169e1';
                ctx.fillRect(-r * 0.4, r * 0.9, r * 0.25, r * 0.08);
                ctx.fillRect(-r * 0.4, r * 1.0, r * 0.25, r * 0.08);
            } else if (decorationId === 'headband') {
                // è¿åŠ¨å¤´å¸¦
                ctx.fillStyle = '#ff4500';
                ctx.beginPath();
                ctx.ellipse(0, -r * 0.85, r * 0.55, r * 0.12, 0, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#fff';
                ctx.font = `bold ${r * 0.15}px Arial`;
                ctx.textAlign = 'center';
                ctx.fillText('åŠ æ²¹', 0, -r * 0.82);
            } else if (decorationId === 'tophat') {
                // é­”æœ¯å¸½
                ctx.fillStyle = '#1a1a1a';
                ctx.beginPath();
                ctx.ellipse(0, -r * 0.85, r * 0.5, r * 0.1, 0, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillRect(-r * 0.3, -r * 1.4, r * 0.6, r * 0.55);
                ctx.fillStyle = '#8b0000';
                ctx.fillRect(-r * 0.3, -r * 0.95, r * 0.6, r * 0.1);
            } else if (decorationId === 'cape') {
                // è‹±é›„æŠ«é£
                ctx.fillStyle = '#dc143c';
                ctx.beginPath();
                ctx.moveTo(-r * 0.6, -r * 0.3);
                ctx.quadraticCurveTo(-r * 1.2, r * 0.5, -r * 0.8, r * 1.2);
                ctx.lineTo(-r * 0.3, r * 0.8);
                ctx.lineTo(-r * 0.3, -r * 0.2);
                ctx.closePath();
                ctx.fill();
                ctx.fillStyle = '#ffd700';
                ctx.beginPath();
                ctx.arc(-r * 0.45, -r * 0.1, r * 0.08, 0, Math.PI * 2);
                ctx.fill();
            } else if (decorationId === 'flame') {
                // çƒˆç„°å…‰ç¯
                const flicker = Math.sin(frameCount * 0.2) * 0.3;
                for (let i = 0; i < 8; i++) {
                    const angle = (i * Math.PI * 2) / 8 + frameCount * 0.05;
                    const flameH = r * 0.4 + Math.sin(frameCount * 0.3 + i) * r * 0.1;
                    ctx.fillStyle = i % 2 === 0 ? '#ff4500' : '#ffd700';
                    ctx.globalAlpha = 0.7 + flicker;
                    ctx.beginPath();
                    const fx = Math.cos(angle) * r * 0.9;
                    const fy = Math.sin(angle) * r * 0.9;
                    ctx.moveTo(fx, fy);
                    ctx.lineTo(fx + Math.cos(angle) * flameH, fy + Math.sin(angle) * flameH);
                    ctx.lineTo(fx + Math.cos(angle + 0.3) * flameH * 0.5, fy + Math.sin(angle + 0.3) * flameH * 0.5);
                    ctx.closePath();
                    ctx.fill();
                }
                ctx.globalAlpha = 1;
            }
        }
        
        ctx.restore();
    }
    
    // åˆå§‹åŒ–åŠ è½½çš®è‚¤æ•°æ®
    loadSkinData();

    // æ›´æ–°é¦–é¡µæœ€é«˜åˆ†æ˜¾ç¤º
    function updateHomeHighScores() {
        const easyEl = document.getElementById('home-score-easy');
        const normalEl = document.getElementById('home-score-normal');
        const hardEl = document.getElementById('home-score-hard');
        if (easyEl) easyEl.textContent = highScores.easy || 0;
        if (normalEl) normalEl.textContent = highScores.normal || 0;
        if (hardEl) hardEl.textContent = highScores.hard || 0;
    }
    
    // æ˜¾ç¤ºæ’è¡Œæ¦œ
    function showLeaderboard() {
        document.getElementById('lb-score-easy').textContent = highScores.easy || 0;
        document.getElementById('lb-score-normal').textContent = highScores.normal || 0;
        document.getElementById('lb-score-hard').textContent = highScores.hard || 0;
        document.getElementById('leaderboard-screen').style.display = 'flex';
        document.getElementById('leaderboard-close-btn').style.display = 'flex';
        startScreen.style.display = 'none';
        collectionBtnMenu.style.display = 'none';
        document.getElementById('leaderboard-btn-menu').style.display = 'none';
        document.getElementById('skin-btn-menu').style.display = 'none';
    }
    
    // éšè—æ’è¡Œæ¦œ
    function hideLeaderboard() {
        document.getElementById('leaderboard-screen').style.display = 'none';
        document.getElementById('leaderboard-close-btn').style.display = 'none';
        startScreen.style.display = 'flex';
        collectionBtnMenu.style.display = 'flex';
        document.getElementById('leaderboard-btn-menu').style.display = 'flex';
        document.getElementById('skin-btn-menu').style.display = 'flex';
    }
    
    // æ’’èŠ±ç‰¹æ•ˆ
    function createConfetti() {
        const colors = ['#ff6b6b', '#feca57', '#48dbfb', '#ff9ff3', '#54a0ff', '#5f27cd', '#00d2d3', '#ff9f43', '#ee5a24', '#a8e063'];
        const confettiCount = 50;
        
        for (let i = 0; i < confettiCount; i++) {
            setTimeout(() => {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.top = '-10px';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.width = (Math.random() * 10 + 5) + 'px';
                confetti.style.height = (Math.random() * 10 + 5) + 'px';
                confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
                confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                confetti.style.animationDelay = (Math.random() * 0.5) + 's';
                document.body.appendChild(confetti);
                
                setTimeout(() => confetti.remove(), 4000);
            }, i * 30);
        }
    }
    
    // æ›´æ–°æ¸¸æˆä¸­çš„æœ€é«˜åˆ†æç¤º
    let hasShownSurpassedHint = false;
    function updateHighScoreHint() {
        if (isStageMode || !currentDifficultyName) return;
        
        const hintEl = document.getElementById('high-score-hint');
        if (!hintEl) return;
        
        const currentHigh = highScores[currentDifficultyName] || 0;
        
        if (currentHigh === 0) {
            hintEl.textContent = 'åˆ›é€ ä½ çš„ç¬¬ä¸€ä¸ªçºªå½•å§ï¼';
            hintEl.classList.remove('surpassed');
        } else if (score > currentHigh) {
            if (!hasShownSurpassedHint) {
                hasShownSurpassedHint = true;
            }
            hintEl.innerHTML = 'ğŸŒŸ å·²è¶…è¶Šæœ€é«˜åˆ†ï¼';
            hintEl.classList.add('surpassed');
        } else if (score === currentHigh && score > 0) {
            hintEl.textContent = 'ğŸ† å¹³äº†æœ€é«˜åˆ†ï¼';
            hintEl.classList.remove('surpassed');
        } else {
            const diff = currentHigh - score;
            hintEl.textContent = `è·æœ€é«˜åˆ†è¿˜å·® ${diff} åˆ†`;
            hintEl.classList.remove('surpassed');
        }
    }
    
    // å°è£…åˆ†æ•°æ›´æ–°å‡½æ•°
    function updateScore(newScore) {
        score = newScore;
        scoreEl.innerText = score;
        updateHighScoreHint();
    }
    
    function addScore(amount) {
        score += amount;
        scoreEl.innerText = score;
        updateHighScoreHint();
    }

    // é±¼ç¾¤ç³»ç»Ÿ
    let fishSchools = []; // é±¼ç¾¤æ•°ç»„
    let fishSchoolCooldown = 0; // é±¼ç¾¤ç”Ÿæˆå†·å´æ—¶é—´
    let fishSchoolCooldownMax = 600; // é±¼ç¾¤ç”Ÿæˆå†·å´æ—¶é—´ä¸Šé™ï¼ˆ10ç§’ï¼‰

    // é¦–é¡µæ°›å›´å…ƒç´ 
    let ambientFish = [];
    let ambientBubbles = [];

    let currentEvent = null;
    let eventTimer = 0;
    let nextEventCooldown = 600;
    let currentForce = { x: 0, y: 0 };
    let flowParticles = [];
    
    // æ–°äº‹ä»¶å˜é‡
    let doubleScoreActive = false; // åŒå€åˆ†æ•°æ˜¯å¦æ¿€æ´»
    let gravityReversed = false; // é‡åŠ›æ˜¯å¦åè½¬
    let heartRainActive = false; // çˆ±å¿ƒé›¨æ˜¯å¦æ¿€æ´»

    // æ¸¸æˆä¸­çš„æ°”æ³¡ç³»ç»Ÿ
    let gameBubbles = [];
    let lightRays = []; // å…‰æ–‘æ•ˆæœ
    let particles = []; // ç²’å­ç‰¹æ•ˆ
    let screenShake = { x: 0, y: 0, intensity: 0 }; // å±å¹•éœ‡åŠ¨

    // ========== å®‰å…¨å·¥å…·å‡½æ•° ==========
    
    // localStorage å®‰å…¨åŒ…è£…
    function safeLocalStorageGet(key, defaultValue = null) {
        try {
            if (typeof localStorage === 'undefined') return defaultValue;
            const value = localStorage.getItem(key);
            return value !== null ? value : defaultValue;
        } catch(e) {
            console.warn('localStorage.getItem("' + key + '") å¤±è´¥:', e);
            return defaultValue;
        }
    }
    
    function safeLocalStorageSet(key, value) {
        try {
            if (typeof localStorage === 'undefined') return false;
            localStorage.setItem(key, value);
            return true;
        } catch(e) {
            console.warn('localStorage.setItem("' + key + '") å¤±è´¥:', e);
            // å¦‚æœæ˜¯å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œå°è¯•æ¸…ç†æ—§æ•°æ®
            if (e.name === 'QuotaExceededError') {
                console.warn('localStorageç©ºé—´ä¸è¶³ï¼Œè¯·æ¸…ç†æµè§ˆå™¨ç¼“å­˜');
            }
            return false;
        }
    }
    
    // æ£€æŸ¥localStorageå®¹é‡
    function checkLocalStorageSpace() {
        try {
            const testKey = '_storage_test_';
            const testValue = 'x'.repeat(1024); // 1KB
            let totalSize = 0;
            
            // è®¡ç®—å·²ä½¿ç”¨ç©ºé—´
            for (let key in localStorage) {
                if (localStorage.hasOwnProperty(key)) {
                    totalSize += localStorage[key].length + key.length;
                }
            }
            
            return {
                used: Math.round(totalSize / 1024), // KB
                available: true
            };
        } catch (e) {
            return {
                used: 0,
                available: false
            };
        }
    }
    
    // æµè§ˆå™¨å…¼å®¹æ€§æ£€æŸ¥
    function checkBrowserCompatibility() {
        const warnings = [];
        
        // Canvas æ”¯æŒ
        if (!canvas || !canvas.getContext) {
            warnings.push('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ Canvasï¼Œæ¸¸æˆæ— æ³•è¿è¡Œ');
        }
        
        // Web Audio API æ”¯æŒ
        if (!window.AudioContext && !window.webkitAudioContext) {
            warnings.push('éŸ³é¢‘åŠŸèƒ½ä¸å¯ç”¨ï¼ˆæ¸¸æˆä»å¯æ­£å¸¸è¿è¡Œï¼‰');
        }
        
        // requestAnimationFrame æ”¯æŒ
        if (!window.requestAnimationFrame) {
            warnings.push('åŠ¨ç”»åŠŸèƒ½å¯èƒ½ä¸æµç•…');
        }
        
        if (warnings.length > 0) {
            console.warn('æµè§ˆå™¨å…¼å®¹æ€§è­¦å‘Š:', warnings);
        }
        
        return warnings;
    }
    
    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥
    const browserWarnings = checkBrowserCompatibility();
    if (browserWarnings.length > 0) {
        // ä¸å¼¹çª—ï¼Œåªè®°å½•æ—¥å¿—ï¼Œé¿å…å¹²æ‰°ç”¨æˆ·
    }
    
    // èƒŒæ™¯å›¾ç‰‡ - ä¼˜å…ˆä½¿ç”¨ Base64ï¼Œé¿å…å›½å†…æ— æ³•åŠ è½½ GitHub å›¾ç‰‡
    const bgImage = new Image();
    let bgImageLoaded = false;
    let bgImageLoading = false;
    
    // å»¶è¿ŸåŠ è½½èƒŒæ™¯å›¾ï¼Œè®©æ¸¸æˆå…ˆå¯åŠ¨
    function loadBackgroundImage() {
        if (bgImageLoading || bgImageLoaded) return;
        bgImageLoading = true;
        
        bgImage.onload = function() {
            bgImageLoaded = true;
            bgImageLoading = false;
            console.log('èƒŒæ™¯å›¾ç‰‡åŠ è½½æˆåŠŸ, å°ºå¯¸:', bgImage.naturalWidth, 'x', bgImage.naturalHeight);
            cachedBgCanvas = null; // é‡ç½®ç¼“å­˜ï¼Œä¸‹æ¬¡ç»˜åˆ¶æ—¶é‡æ–°ç”Ÿæˆ
            
            // å¦‚æœåœ¨é¦–é¡µï¼Œé‡ç»˜canvasä»¥æ˜¾ç¤ºèƒŒæ™¯å›¾
            if (startScreen.style.display !== 'none') {
                const bgGradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                bgGradient.addColorStop(0, 'rgb(255, 154, 158)');
                bgGradient.addColorStop(1, 'rgb(250, 208, 196)');
                ctx.fillStyle = bgGradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                if (bgImage.complete && bgImage.naturalWidth > 0) {
                    const scale = Math.max(canvas.width / bgImage.width, canvas.height / bgImage.height);
                    const scaledWidth = bgImage.width * scale;
                    const scaledHeight = bgImage.height * scale;
                    const x = (canvas.width - scaledWidth) / 2;
                    const y = (canvas.height - scaledHeight) / 2;
                    ctx.drawImage(bgImage, x, y, scaledWidth, scaledHeight);
                }
            }
        };
        bgImage.onerror = function(e) {
            bgImageLoading = false;
            console.error('èƒŒæ™¯å›¾ç‰‡åŠ è½½å¤±è´¥:', e);
        };
        
        // ä¼˜å…ˆä½¿ç”¨ Base64ï¼ˆå·²å†…åµŒåœ¨ bg-base64.jsï¼‰ï¼Œé¿å…å›½å†…è®¿é—® GitHub å›¾ç‰‡åŠ è½½å¤±è´¥
        if (typeof BG_IMAGE_BASE64 !== 'undefined') {
            bgImage.src = BG_IMAGE_BASE64;
            console.log('ä½¿ç”¨ Base64 åŠ è½½èƒŒæ™¯å›¾');
        } else {
            // å›é€€åˆ°å¤–éƒ¨æ–‡ä»¶
            const isMobile = window.innerWidth <= 768 || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            bgImage.src = (isMobile ? 'static/images/background-mobile.jpg' : 'static/images/background.jpg') + '?v=1';
            console.log('åŠ è½½èƒŒæ™¯å›¾:', isMobile ? 'æ‰‹æœºç‰ˆ' : 'æ¡Œé¢ç‰ˆ');
        }
    }
    
    // é¡µé¢åŠ è½½å®Œæˆåå†åŠ è½½èƒŒæ™¯å›¾ï¼ˆä½ä¼˜å…ˆçº§ï¼‰
    if (document.readyState === 'complete') {
        setTimeout(loadBackgroundImage, 100);
    } else {
        window.addEventListener('load', function() {
            setTimeout(loadBackgroundImage, 100);
        });
    }
    
    // æ€§èƒ½ä¼˜åŒ–ï¼šç¦»å±Canvasç¼“å­˜èƒŒæ™¯
    let cachedBgCanvas = null;
    let lastCanvasWidth = 0;
    let lastCanvasHeight = 0;
    
    // ç”Ÿæˆç¼“å­˜çš„èƒŒæ™¯
    function generateBackgroundCache() {
        try {
            if (!cachedBgCanvas || lastCanvasWidth !== canvas.width || lastCanvasHeight !== canvas.height) {
                cachedBgCanvas = document.createElement('canvas');
                cachedBgCanvas.width = canvas.width;
                cachedBgCanvas.height = canvas.height;
                const cacheCtx = cachedBgCanvas.getContext('2d');
                
                lastCanvasWidth = canvas.width;
                lastCanvasHeight = canvas.height;
                
                // ç»˜åˆ¶æ¸å˜èƒŒæ™¯
                const bgGradient = cacheCtx.createLinearGradient(0, 0, 0, canvas.height);
                bgGradient.addColorStop(0, 'rgb(255, 154, 158)');
                bgGradient.addColorStop(1, 'rgb(250, 208, 196)');
                cacheCtx.fillStyle = bgGradient;
                cacheCtx.fillRect(0, 0, canvas.width, canvas.height);
                
                // ç»˜åˆ¶èƒŒæ™¯å›¾ç‰‡ï¼ˆå¦‚æœå·²åŠ è½½ï¼‰
                if (bgImageLoaded && bgImage.complete && bgImage.naturalWidth > 0) {
                    const scale = Math.max(canvas.width / bgImage.width, canvas.height / bgImage.height);
                    const scaledWidth = bgImage.width * scale;
                    const scaledHeight = bgImage.height * scale;
                    const x = (canvas.width - scaledWidth) / 2;
                    const y = (canvas.height - scaledHeight) / 2;
                    cacheCtx.drawImage(bgImage, x, y, scaledWidth, scaledHeight);
                }
            }
            return cachedBgCanvas;
        } catch(e) {
            console.error('èƒŒæ™¯ç¼“å­˜ç”Ÿæˆå¤±è´¥:', e);
            return null;
        }
    }

    const LOVE_WORDS = ["çˆ±ä½ ", "æŠ±æŠ±", "æƒ³ä½ ", "äº²äº²", "ä¹–å®", "çœŸæ£’", "å¥½å¯çˆ±", "ç¾ç¾å“’", "è´´è´´", "Love U"];
    
    // éŸ³é¢‘ç³»ç»Ÿå·²å®Œå…¨ç§»é™¤
    function playSound(type) {
        // éŸ³æ•ˆå·²ç§»é™¤
    }
    
    const START_QUOTES = [
        // === â¤ï¸ æ·±æƒ…å‘Šç™½ç¯‡ ===
        "è¿·é›¾ä¸­ï¼Œèªä»”æ˜¯å”¯ä¸€çš„ç¯å¡”ã€‚<br>æ²¡æœ‰ä»–ï¼Œä¸–ç•Œå°†ä¸€ç‰‡æ¼†é»‘ã€‚",
        "è¿™ä¸ä»…ä»…æ˜¯ä¸€ä¸ªæ¸¸æˆã€‚<br>è¿™æ˜¯æˆ‘æƒ³ä¸€ç›´å®ˆæŠ¤ä½ çš„å†³å¿ƒã€‚",
        "ä¸ç®¡ä¸–ç•Œå˜å¾—å¤šå¿«ï¼Œ<br>èªä»”æ°¸è¿œæ¸¸åœ¨ä½ èº«ååŠæ­¥çš„è·ç¦»ã€‚",
        "çˆ±ä¸æ˜¯ä¸å—ä¼¤ï¼Œ<br>è€Œæ˜¯å—ä¼¤æ—¶ï¼Œæœ‰äººæ›¿ä½ æŒ¡åœ¨èº«å‰ã€‚",
        "è™½ç„¶æˆ‘ä»¬åªæ˜¯å°å°çš„é±¼ï¼Œ<br>ä½†æˆ‘ä»¬çš„çˆ±å¯ä»¥å¡«æ»¡æ•´ç‰‡æµ·æ´‹ã€‚",
        "èªä»”å˜å°äº†ä¹Ÿæ²¡å…³ç³»ï¼Œ<br>åªè¦ä½ å¹³å®‰é•¿å¤§ï¼Œä¸€åˆ‡éƒ½å€¼å¾—ã€‚",
        "ä½ æ˜¯ç²‰è‰²çš„æ¢¦ï¼Œ<br>æˆ‘æ˜¯å®ˆæŠ¤è¿™æ¢¦å¢ƒçš„è“è‰²éª‘å£«ã€‚",
        "æ¯ä¸€æ¬¡[é‡æ¥]ï¼Œ<br>éƒ½æ˜¯ä¸ºäº†å†ä¸€æ¬¡ä¸ä½ ç›¸é‡ã€‚",

        // === ğŸŒŠ ç”Ÿå­˜å“²å­¦ç¯‡ ===
        "ç”Ÿæ´»å°±åƒé€†æ°´è¡ŒèˆŸã€‚<br>é‡åˆ°[æ¿€æµ]æ—¶ï¼Œè¦ç”¨åŠ›é€†é£å‰è¡Œå“¦ï¼",
        "[å†·æˆ˜]è™½ç„¶ä¸ä¼šè‡´å‘½ï¼Œ<br>ä½†é‚£ç§å‡å›ºçš„ç©ºæ°”è®©äººå¯¸æ­¥éš¾è¡Œã€‚",
        "é‚£äº›[åæƒ…ç»ª]å°±åƒæ°”æ³¡ï¼Œ<br>ç­‰ä½ é•¿å¤§äº†ï¼Œè½»è½»ä¸€ç¢°å°±ç¢äº†ã€‚",
        "åˆ«è¢«[çƒ‚æ¡ƒèŠ±]å’Œ[å«‰å¦’]ç»Šå€’ã€‚<br>ä½ å€¼å¾—æ‹¥æœ‰æœ€å¥½çš„çˆ±å¿ƒå’Œæ˜Ÿæ˜Ÿï¼",
        "çœŸæ­£çš„å®ˆæŠ¤ï¼Œä¸æ˜¯æŠŠä½ å…³åœ¨æ¸©å®¤ï¼Œ<br>è€Œæ˜¯é™ªä½ ä»æµ…æµ·æ¸¸å‘æ·±æ¸Šã€‚",
        "å½“å·¨å¤§çš„[ç°å®å‹åŠ›]é€¼è¿‘æ—¶ï¼Œ<br>èº²é¿å¹¶ä¸å¯è€»ï¼Œæ˜¯ä¸ºäº†æ›´å¥½åœ°ç”Ÿå­˜ã€‚",
        "æœ‰äº›è·¯åªèƒ½ä¸€ä¸ªäººèµ°ï¼Œ<br>ä½†åœ¨å¿ƒé‡Œï¼Œæˆ‘ä»¬ä»æœªåˆ†å¼€ã€‚",
        "å“ªæ€•è¦åœ¨é»‘æš—çš„[å›°éš¾æ¨¡å¼]é‡Œæ‘¸ç´¢ï¼Œ<br>ä¹Ÿè¦ç›¸ä¿¡å…‰å°±åœ¨å‰æ–¹ã€‚",

        // === ğŸ® ç¡¬æ ¸æ”»ç•¥ç¯‡ ===
        "å¼€å±€å°±èƒ½åƒæ‰ç»¿è‰²çš„[çç¢ğŸ¦ ]å“¦ï¼<br>æ…¢æ…¢é•¿å¤§ï¼Œå†å»æŒ‘æˆ˜æ›´å¤§çš„å›°éš¾ã€‚",
        "å›°éš¾æ¨¡å¼ä¸‹ï¼Œ[æŠ¤èº«ç¬¦ğŸ›¡ï¸]æ˜¯ 1% çš„å¥‡è¿¹ã€‚<br>ä½†åªè¦æœ‰çˆ±ï¼Œæˆ‘ä»¬æ— æ‰€ç•æƒ§ã€‚",
        "å½“[è¿·é›¾]é™ä¸´æ—¶ï¼Œåˆ«å®³æ€•ã€‚<br>ç´§ç´§è·Ÿç€èªä»”ï¼Œåˆ«èµ°ä¸¢äº†ï¼",
        "æƒ³è¦[æ— æ•Œçˆ†å‘]å—ï¼Ÿ<br>åªæœ‰æ”¶é›†ç²‰è‰²çš„çˆ±å¿ƒæ‰èƒ½ç§¯æ”’å¿ƒåŠ¨å€¼ï¼",
        "å¦‚æœä¸å°å¿ƒè¢«[å†°å†»]äº†ï¼Œ<br>è®°å¾—èº²åœ¨èªä»”èº«åï¼Œç­‰æ˜¥æš–èŠ±å¼€ã€‚",
        "[å¹¸è¿æ˜ŸğŸŒŸ]æ˜¯å¯é‡ä¸å¯æ±‚çš„ï¼Œ<br>å°±åƒé‚£ä¸ªå¯¹çš„äººï¼Œé‡åˆ°äº†å°±åˆ«æ”¾æ‰‹ã€‚",
        "åˆ«å¿˜äº†åƒ[ç”œèœœç³–æœğŸ¬]ï¼Œ<br>é‚£æ˜¯ç”Ÿæ´»å¶å°”ç»™ä½ çš„å°ç¡®å¹¸ã€‚",
        "é‡åˆ°[ç£é“ğŸ§²]æ—¶ï¼Œ<br>ä¹Ÿæ˜¯æˆ‘ä»¬åŒå‘å¥”èµ´æœ€å¿«çš„æ—¶å€™ï¼",
        "å°å¿ƒé‚£åªé»‘è‰²çš„[ç„¦è™‘]ï¼Œ<br>å®ƒæ¸¸å¾—å¾ˆå¿«ï¼Œåˆ«è®©å®ƒè¿½ä¸Šä½ ã€‚",
        "[äº‰åµ]æ€»æ˜¯æ¥å¾—å¿«å»å¾—å¿«ï¼Œ<br>ä½†åœ¨é‚£ä¹‹å‰ï¼Œè¯·å…ˆé¿å…¶é”‹èŠ’ã€‚"
    ];

    // ========== æ¸¸æˆæƒé‡é…ç½®ï¼ˆå¯è°ƒæ•´ï¼‰ ==========
    const GAME_WEIGHTS = {
        // ç‰©å“ç”Ÿæˆæƒé‡ [çˆ±å¿ƒ, Buff, åé±¼] - æ€»å’Œåº”ä¸º1.0
        easy: {
            good: 0.3,    // çˆ±å¿ƒ 30%
            buff: 0.1,    // Buff 10%
            bad: 0.6      // åé±¼ 60%
        },
        normal: {
            good: 0.2,    // çˆ±å¿ƒ 20%
            buff: 0.05,   // Buff 5%
            bad: 0.75     // åé±¼ 75%
        },
        hard: {
            good: 0.12,   // çˆ±å¿ƒ 12% (ä»8%æé«˜ï¼Œä¿è¯åŸºæœ¬æ”¶é›†ä½“éªŒ)
            buff: 0.03,   // Buff 3% (ä»2%æé«˜)
            bad: 0.85     // åé±¼ 85% (ä»90%é™ä½)
        }
    };

    // é±¼ç¾¤ç”Ÿæˆæƒé‡é…ç½®ï¼ˆåŸºäºåˆ†æ•°æ®µï¼‰
    const FISH_SCHOOL_WEIGHTS = {
        easy: {
            baseProb: 0.05,    // åŸºç¡€ç”Ÿæˆæ¦‚ç‡ï¼ˆ5%ï¼‰
            scoreMultiplier: 0.00003  // æ¯1000åˆ†å¢åŠ 3%æ¦‚ç‡
        },
        normal: {
            baseProb: 0.04,    // åŸºç¡€ç”Ÿæˆæ¦‚ç‡ï¼ˆ4%ï¼‰
            scoreMultiplier: 0.00002  // æ¯1000åˆ†å¢åŠ 2%æ¦‚ç‡
        },
        hard: {
            baseProb: 0.03,    // åŸºç¡€ç”Ÿæˆæ¦‚ç‡ï¼ˆ3%ï¼‰
            scoreMultiplier: 0.00001  // æ¯1000åˆ†å¢åŠ 1%æ¦‚ç‡
        }
    };

    // äº‹ä»¶è§¦å‘æƒé‡ [è¿·é›¾, æ¿€æµ, æ˜Ÿè½, åŒå€åˆ†æ•°, çˆ±å¿ƒé›¨, é‡åŠ›åè½¬] - æ€»å’Œåº”ä¸º1.0
    const EVENT_WEIGHTS = {
        easy: {
            fog: 0.15,           // è¿·é›¾ 15%
            current: 0.15,       // æ¿€æµ 15%
            starfall: 0.25,      // æ˜Ÿè½ 25%
            doubleScore: 0.25,   // åŒå€åˆ†æ•° 25% (æ­£é¢)
            heartRain: 0.15,     // çˆ±å¿ƒé›¨ 15% (æ­£é¢)
            gravityReverse: 0.05 // é‡åŠ›åè½¬ 5% (è´Ÿé¢)
        },
        normal: {
            fog: 0.2,            // è¿·é›¾ 20%
            current: 0.2,        // æ¿€æµ 20%
            starfall: 0.15,      // æ˜Ÿè½ 15%
            doubleScore: 0.2,    // åŒå€åˆ†æ•° 20% (æ­£é¢)
            heartRain: 0.1,      // çˆ±å¿ƒé›¨ 10% (æ­£é¢)
            gravityReverse: 0.15 // é‡åŠ›åè½¬ 15% (è´Ÿé¢)
        },
        hard: {
            fog: 0.28,           // è¿·é›¾ 28% (ä»25%æé«˜)
            current: 0.28,       // æ¿€æµ 28% (ä»25%æé«˜)
            starfall: 0.08,      // æ˜Ÿè½ 8% (ä»5%æé«˜)
            doubleScore: 0.12,   // åŒå€åˆ†æ•° 12% (ä»10%æé«˜)
            heartRain: 0.06,     // çˆ±å¿ƒé›¨ 6% (ä»5%æé«˜)
            gravityReverse: 0.18 // é‡åŠ›åè½¬ 18% (ä»30%é™ä½ï¼Œå¤ªé«˜ä½“éªŒå·®)
        }
    };

    const DIFFICULTY_SETTINGS = {
        'easy':   {
            spawnRate: 20, speedMultiplier: 0.6, feverFactor: 2.0,
            fogRadius: 80,
            weights: [GAME_WEIGHTS.easy.good, GAME_WEIGHTS.easy.buff, GAME_WEIGHTS.easy.bad],
            eventProb: EVENT_WEIGHTS.easy
        },
        'normal': {
            spawnRate: 20, speedMultiplier: 0.9, feverFactor: 1.0,
            fogRadius: 50,
            weights: [GAME_WEIGHTS.normal.good, GAME_WEIGHTS.normal.buff, GAME_WEIGHTS.normal.bad],
            eventProb: EVENT_WEIGHTS.normal
        },
        'hard':   {
            spawnRate: 25, speedMultiplier: 1.4, feverFactor: 0.3,
            fogRadius: 18,
            weights: [GAME_WEIGHTS.hard.good, GAME_WEIGHTS.hard.buff, GAME_WEIGHTS.hard.bad],
            eventProb: EVENT_WEIGHTS.hard
        }
    };

    const GAME_OBJECTS = {
        good: [
            { type: 'heart', r: 8, color: '#ff4081', score: 10, fever: 2, speed: [1, 2], name: 'å°æƒŠå–œ', minScore: 0 },
            { type: 'heart', r: 15, color: '#ff0055', score: 20, fever: 5, speed: [1.5, 2.5], name: 'å¤§ç¤¼ç‰©', minScore: 100 },
            { type: 'heart', subtype: 'star', r: 12, color: '#FFD700', score: 50, fever: 5, speed: [3, 5], name: 'å¹¸è¿æ˜Ÿ', minScore: 300 },
            { type: 'heart', subtype: 'diamond', r: 20, color: '#E0FFFF', score: 500, fever: 100, speed: [4, 6], name: 'æ°¸æ’é’»æˆ’', minScore: 2500, rarity: 0.01 }
        ],
        buff: [
            { type: 'buff', subtype: 'candy', r: 12, color: '#FFD700', speed: [1, 1.5], name: 'ç”œèœœç³–æœ', minScore: 0 },
            { type: 'buff', subtype: 'summon', r: 14, color: '#00BFFF', speed: [1, 1.5], name: 'æŠ¤èº«ç¬¦', minScore: 0 },
            { type: 'buff', subtype: 'magnet', r: 12, color: '#FF6347', speed: [1, 1.5], name: 'åŒå‘å¥”èµ´', minScore: 100 },
            { type: 'buff', subtype: 'hunter', r: 13, color: '#00CED1', speed: [1, 1.5], name: 'èªä»”å‡ºå‡»', minScore: 200 }
        ],
        bad: [
            // æ—©æœŸå‡ºç°çš„å„ç§å°é±¼ï¼Œä¸°å¯Œé¢œè‰²å’Œç±»å‹
            { type: 'bad', subtype: 'tiny', r: 6, color: '#AED581', speed: [1, 1.5], name: 'çç¢', minScore: 0 },
            { type: 'bad', subtype: 'normal', r: 12, color: '#8BC34A', speed: [2, 3], name: 'å°æ‘©æ“¦', minScore: 0 },
            { type: 'bad', subtype: 'goldfish', r: 10, color: '#FFA500', speed: [1.5, 2.5], name: 'å°å›°æ‰°', minScore: 0 },
            { type: 'bad', subtype: 'clownfish', r: 8, color: '#FF6347', speed: [2, 3], name: 'å°éº»çƒ¦', minScore: 0 },
            { type: 'bad', subtype: 'tropical', r: 9, color: '#FF69B4', speed: [2, 3.5], name: 'å°æ³¢æŠ˜', minScore: 0 },
            { type: 'bad', subtype: 'angelfish', r: 11, color: '#FFD700', speed: [1.8, 2.8], name: 'å°æ’æ›²', minScore: 0 },
            { type: 'bad', subtype: 'seahorse', r: 9, color: '#FFB6C1', speed: [1.5, 2], name: 'å°çƒ¦æ¼', minScore: 0 },
            { type: 'bad', subtype: 'jellyfish', r: 10, color: '#E6E6FA', speed: [1.2, 2.2], name: 'å°å›°æ‰°', minScore: 0 },
            { type: 'bad', subtype: 'flounder', r: 8, color: '#DDA0DD', speed: [1.8, 2.5], name: 'å°æ³¢æŠ˜', minScore: 0 },
            { type: 'bad', subtype: 'sardine', r: 7, color: '#87CEEB', speed: [2, 3], name: 'å°çƒ¦æ¼', minScore: 0 },
            { type: 'bad', subtype: 'anchovy', r: 6, color: '#B0E0E6', speed: [2.2, 3.2], name: 'å°å›°æ‰°', minScore: 0 },
            { type: 'bad', subtype: 'mackerel', r: 9, color: '#4682B4', speed: [2.5, 3.5], name: 'å°æ³¢æŠ˜', minScore: 0 },
            { type: 'bad', subtype: 'trout', r: 10, color: '#FF7F50', speed: [1.8, 2.8], name: 'å°æ’æ›²', minScore: 0 },
            { type: 'bad', subtype: 'perch', r: 8, color: '#20B2AA', speed: [2, 3], name: 'å°éº»çƒ¦', minScore: 0 },
            { type: 'bad', subtype: 'butterflyfish', r: 9, color: '#FFD700', speed: [2, 3], name: 'å°å›°æ‰°', minScore: 0 },
            { type: 'bad', subtype: 'parrotfish', r: 10, color: '#00CED1', speed: [1.8, 2.5], name: 'å°çƒ¦æ¼', minScore: 0 },
            { type: 'bad', subtype: 'lionfish', r: 11, color: '#FF4500', speed: [1.5, 2.2], name: 'å°å±é™©', minScore: 0 },
            { type: 'bad', subtype: 'puffer', r: 8, color: '#FFA500', speed: [1.2, 2], name: 'å°éº»çƒ¦', minScore: 0 },
            { type: 'bad', subtype: 'octopus', r: 12, color: '#9370DB', speed: [1.5, 2.5], name: 'å°å›°æ‰°', minScore: 0 },
            { type: 'bad', subtype: 'crab', r: 7, color: '#FF6347', speed: [2, 3], name: 'å°æ³¢æŠ˜', minScore: 0 },
            { type: 'bad', subtype: 'turtle', r: 10, color: '#20B2AA', speed: [1, 1.8], name: 'å°çƒ¦æ¼', minScore: 0 },

            // ä¸­ç­‰å¤§å°çš„é±¼ï¼ˆr: 20-30ï¼‰ï¼Œ50-200åˆ†é˜¶æ®µ
            { type: 'bad', subtype: 'normal', r: 25, color: '#9E9E9E', speed: [1.5, 2.5], name: 'åæƒ…ç»ª', minScore: 50 },
            { type: 'bad', subtype: 'goldfish', r: 22, color: '#FF8C00', speed: [1.8, 2.8], name: 'ä¸­ç­‰å›°æ‰°', minScore: 50 },
            { type: 'bad', subtype: 'tropical', r: 24, color: '#FF1493', speed: [2, 3], name: 'ä¸­ç­‰æ³¢æŠ˜', minScore: 50 },
            { type: 'bad', subtype: 'clownfish', r: 20, color: '#FF4500', speed: [2.2, 3.2], name: 'ä¸­ç­‰éº»çƒ¦', minScore: 50 },
            { type: 'bad', subtype: 'angelfish', r: 23, color: '#FFA500', speed: [2, 3], name: 'ä¸­ç­‰æ’æ›²', minScore: 50 },
            { type: 'bad', subtype: 'dolphin', r: 28, color: '#4682B4', speed: [1.5, 2.5], name: 'ä¸­ç­‰å‹åŠ›', minScore: 100 },
            { type: 'bad', subtype: 'seahorse', r: 26, color: '#FF69B4', speed: [1.8, 2.5], name: 'ä¸­ç­‰çƒ¦æ¼', minScore: 100 },
            { type: 'bad', subtype: 'jellyfish', r: 27, color: '#9370DB', speed: [1.5, 2.2], name: 'ä¸­ç­‰å›°æ‰°', minScore: 100 },
            { type: 'bad', subtype: 'grouper', r: 25, color: '#8B4513', speed: [1.6, 2.4], name: 'ä¸­ç­‰æ³¢æŠ˜', minScore: 150 },
            { type: 'bad', subtype: 'tuna', r: 24, color: '#4169E1', speed: [2.5, 3.5], name: 'ä¸­ç­‰å‹åŠ›', minScore: 100 },
            { type: 'bad', subtype: 'salmon', r: 23, color: '#FF6347', speed: [2, 3], name: 'ä¸­ç­‰å›°æ‰°', minScore: 100 },
            { type: 'bad', subtype: 'carp', r: 26, color: '#FFA500', speed: [1.8, 2.8], name: 'ä¸­ç­‰æ³¢æŠ˜', minScore: 150 },
            { type: 'bad', subtype: 'bass', r: 22, color: '#32CD32', speed: [2.2, 3.2], name: 'ä¸­ç­‰éº»çƒ¦', minScore: 100 },
            { type: 'bad', subtype: 'catfish', r: 27, color: '#696969', speed: [1.5, 2.5], name: 'ä¸­ç­‰å‹åŠ›', minScore: 150 },
            { type: 'bad', subtype: 'butterflyfish', r: 24, color: '#FFD700', speed: [2, 3], name: 'ä¸­ç­‰å›°æ‰°', minScore: 100 },
            { type: 'bad', subtype: 'parrotfish', r: 25, color: '#00CED1', speed: [1.8, 2.8], name: 'ä¸­ç­‰çƒ¦æ¼', minScore: 120 },
            { type: 'bad', subtype: 'lionfish', r: 26, color: '#FF4500', speed: [2, 3], name: 'ä¸­ç­‰å±é™©', minScore: 150 },
            { type: 'bad', subtype: 'octopus', r: 28, color: '#9370DB', speed: [1.8, 2.8], name: 'ä¸­ç­‰å‹åŠ›', minScore: 150 },
            { type: 'bad', subtype: 'turtle', r: 30, color: '#20B2AA', speed: [1.2, 2], name: 'ä¸­ç­‰å›°æ‰°', minScore: 180 },
            { type: 'bad', subtype: 'moray', r: 27, color: '#4B0082', speed: [2.5, 3.5], name: 'ä¸­ç­‰å¨èƒ', minScore: 150 },

            // è¾ƒå¤§çš„é±¼ï¼ˆr: 30-50ï¼‰ï¼Œ300-1000åˆ†é˜¶æ®µ
            { type: 'bad', subtype: 'lightning', r: 15, color: '#FFEB3B', speed: [4, 6], name: 'äº‰åµ', minScore: 300 },
            { type: 'bad', subtype: 'ice', r: 40, color: '#00BCD4', speed: [2, 4], name: 'å†·æˆ˜', minScore: 300 },
            { type: 'bad', subtype: 'goldfish', r: 35, color: '#FF6347', speed: [2, 3], name: 'å¤§å›°æ‰°', minScore: 300 },
            { type: 'bad', subtype: 'tropical', r: 32, color: '#E91E63', speed: [2.5, 3.5], name: 'å¤§æ³¢æŠ˜', minScore: 300 },
            { type: 'bad', subtype: 'angelfish', r: 30, color: '#FF9800', speed: [2.5, 3.5], name: 'å¤§æ’æ›²', minScore: 300 },
            { type: 'bad', subtype: 'clownfish', r: 28, color: '#FF6B35', speed: [3, 4], name: 'å¤§éº»çƒ¦', minScore: 300 },
            { type: 'bad', subtype: 'dolphin', r: 38, color: '#1E90FF', speed: [2, 3], name: 'å¤§å‹åŠ›', minScore: 400 },
            { type: 'bad', subtype: 'tropical', r: 18, color: '#E91E63', speed: [3, 4], name: 'çƒ‚æ¡ƒèŠ±', minScore: 500 },
            { type: 'bad', subtype: 'puffer', r: 22, color: '#9C27B0', speed: [2, 3], name: 'å«‰å¦’', minScore: 800 },
            { type: 'bad', subtype: 'seahorse', r: 32, color: '#FF1493', speed: [2, 2.8], name: 'å¤§çƒ¦æ¼', minScore: 400 },
            { type: 'bad', subtype: 'butterflyfish', r: 35, color: '#FFD700', speed: [2.5, 3.5], name: 'å¤§å›°æ‰°', minScore: 400 },
            { type: 'bad', subtype: 'parrotfish', r: 38, color: '#00CED1', speed: [2, 3], name: 'å¤§å‹åŠ›', minScore: 500 },
            { type: 'bad', subtype: 'lionfish', r: 36, color: '#FF4500', speed: [2.5, 3.5], name: 'å¤§å±é™©', minScore: 600 },
            { type: 'bad', subtype: 'octopus', r: 42, color: '#9370DB', speed: [2, 3], name: 'å¤§å¨èƒ', minScore: 700 },
            { type: 'bad', subtype: 'turtle', r: 40, color: '#20B2AA', speed: [1.5, 2.5], name: 'å¤§å›°æ‰°', minScore: 600 },
            { type: 'bad', subtype: 'moray', r: 44, color: '#4B0082', speed: [3, 4], name: 'å¤§å¨èƒ', minScore: 700 },
            { type: 'bad', subtype: 'hammerhead', r: 48, color: '#2F4F4F', speed: [3.5, 4.5], name: 'å¤§å±æœº', minScore: 800 },
            { type: 'bad', subtype: 'manta', r: 50, color: '#1C1C1C', speed: [2, 3], name: 'å¤§å‹åŠ›', minScore: 900 },
            { type: 'bad', subtype: 'jellyfish', r: 35, color: '#BA55D3', speed: [1.8, 2.5], name: 'å¤§å›°æ‰°', minScore: 500 },
            { type: 'bad', subtype: 'grouper', r: 40, color: '#654321', speed: [1.5, 2.2], name: 'å¤§æ³¢æŠ˜', minScore: 600 },
            { type: 'bad', subtype: 'flounder', r: 36, color: '#9370DB', speed: [2, 3], name: 'å¤§æ’æ›²', minScore: 500 },
            { type: 'bad', subtype: 'angelfish', r: 20, color: '#FF9800', speed: [2.5, 3.5], name: 'å°çƒ¦æ¼', minScore: 600 },
            { type: 'bad', subtype: 'goldfish', r: 42, color: '#FF4500', speed: [2, 3], name: 'å·¨å¤§å›°æ‰°', minScore: 800 },
            { type: 'bad', subtype: 'dolphin', r: 45, color: '#0000CD', speed: [2.5, 3.5], name: 'å·¨å¤§å‹åŠ›', minScore: 1000 },
            { type: 'bad', subtype: 'tuna', r: 38, color: '#1E90FF', speed: [3, 4], name: 'å¤§å‹åŠ›', minScore: 400 },
            { type: 'bad', subtype: 'salmon', r: 35, color: '#FF69B4', speed: [2.5, 3.5], name: 'å¤§å›°æ‰°', minScore: 400 },
            { type: 'bad', subtype: 'eel', r: 40, color: '#8B7355', speed: [3.5, 4.5], name: 'å¤§éº»çƒ¦', minScore: 500 },
            { type: 'bad', subtype: 'ray', r: 44, color: '#708090', speed: [2, 3], name: 'å¤§å‹åŠ›', minScore: 600 },
            { type: 'bad', subtype: 'swordfish', r: 48, color: '#4682B4', speed: [4, 5], name: 'å¤§å±æœº', minScore: 700 },
            { type: 'bad', subtype: 'barracuda', r: 46, color: '#2F4F4F', speed: [3.5, 4.5], name: 'å¤§å¨èƒ', minScore: 800 },
            { type: 'bad', subtype: 'stingray', r: 42, color: '#556B2F', speed: [2.5, 3.5], name: 'å¤§å±é™©', minScore: 900 },

            // è¶…å¤§å‹é±¼ï¼ˆr: 50+ï¼‰ï¼Œ2000åˆ†ä»¥ä¸Š
            { type: 'bad', subtype: 'whale', r: 100, color: '#37474F', speed: [0.8, 1.2], name: 'ç°å®å‹åŠ›', minScore: 2000 },
            { type: 'bad', subtype: 'shark', r: 50, color: '#D32F2F', speed: [5, 7], name: 'æƒ…æ„Ÿå±æœº', minScore: 3000 },
            { type: 'bad', subtype: 'goldfish', r: 60, color: '#DC143C', speed: [1.5, 2.5], name: 'ç»ˆæå›°æ‰°', minScore: 2000 },
            { type: 'bad', subtype: 'tropical', r: 55, color: '#C71585', speed: [3, 4], name: 'ç»ˆææ³¢æŠ˜', minScore: 2000 },
            { type: 'bad', subtype: 'dolphin', r: 65, color: '#191970', speed: [2, 3], name: 'ç»ˆæå‹åŠ›', minScore: 2000 },
            { type: 'bad', subtype: 'angelfish', r: 58, color: '#FF8C00', speed: [2.5, 3.5], name: 'ç»ˆææ’æ›²', minScore: 2000 },
            { type: 'bad', subtype: 'whale', r: 90, color: '#2F4F4F', speed: [1, 1.5], name: 'æ·±æµ·å‹åŠ›', minScore: 3000 },
            { type: 'bad', subtype: 'shark', r: 70, color: '#8B0000', speed: [6, 8], name: 'ç»ˆæå±æœº', minScore: 3500 },
            { type: 'bad', subtype: 'jellyfish', r: 55, color: '#8A2BE2', speed: [2, 3], name: 'ç»ˆæå›°æ‰°', minScore: 2500 },
            { type: 'bad', subtype: 'grouper', r: 62, color: '#4B0082', speed: [1.8, 2.5], name: 'ç»ˆææ³¢æŠ˜', minScore: 2800 },
            { type: 'bad', subtype: 'tuna', r: 58, color: '#0000FF', speed: [3, 4], name: 'ç»ˆæå‹åŠ›', minScore: 2000 },
            { type: 'bad', subtype: 'salmon', r: 56, color: '#FF1493', speed: [2.5, 3.5], name: 'ç»ˆæå›°æ‰°', minScore: 2200 },
            { type: 'bad', subtype: 'swordfish', r: 68, color: '#1C86EE', speed: [4.5, 5.5], name: 'ç»ˆæå±æœº', minScore: 2500 },
            { type: 'bad', subtype: 'barracuda', r: 64, color: '#2F2F2F', speed: [4, 5], name: 'ç»ˆæå¨èƒ', minScore: 2600 },
            { type: 'bad', subtype: 'stingray', r: 60, color: '#3D5A3D', speed: [3, 4], name: 'ç»ˆæå±é™©', minScore: 2700 },
            { type: 'bad', subtype: 'eel', r: 66, color: '#4B4B4B', speed: [4, 5], name: 'ç»ˆæéº»çƒ¦', minScore: 2400 },
            { type: 'bad', subtype: 'butterflyfish', r: 58, color: '#FFD700', speed: [3, 4], name: 'ç»ˆæå›°æ‰°', minScore: 2500 },
            { type: 'bad', subtype: 'parrotfish', r: 62, color: '#00CED1', speed: [2.5, 3.5], name: 'ç»ˆæå‹åŠ›', minScore: 2600 },
            { type: 'bad', subtype: 'lionfish', r: 60, color: '#FF4500', speed: [3, 4], name: 'ç»ˆæå±é™©', minScore: 2700 },
            { type: 'bad', subtype: 'octopus', r: 68, color: '#9370DB', speed: [2.5, 3.5], name: 'ç»ˆæå¨èƒ', minScore: 2800 },
            { type: 'bad', subtype: 'turtle', r: 65, color: '#20B2AA', speed: [2, 3], name: 'ç»ˆæå›°æ‰°', minScore: 2600 },
            { type: 'bad', subtype: 'moray', r: 70, color: '#4B0082', speed: [4, 5], name: 'ç»ˆæå¨èƒ', minScore: 2900 },
            { type: 'bad', subtype: 'hammerhead', r: 72, color: '#2F4F4F', speed: [4.5, 5.5], name: 'ç»ˆæå±æœº', minScore: 3000 },
            { type: 'bad', subtype: 'manta', r: 75, color: '#1C1C1C', speed: [3, 4], name: 'ç»ˆæå‹åŠ›', minScore: 3100 }
        ]
    };

    // ç¨€æœ‰é±¼ç§é…ç½®ï¼ˆä½æ¦‚ç‡å‡ºç°ï¼Œæœ‰ç‰¹æ®Šå¤–è§‚å’Œå¥–åŠ±ï¼‰
    const RARE_FISH = [
        { baseSubtype: 'goldfish', r: 12, name: 'âœ¨ é»„é‡‘å°é±¼', rarity: 0.02, bonusScore: 30, bonusFever: 10, bonusGrowth: 0.3, color: '#FFD700' },
        { baseSubtype: 'tropical', r: 15, name: 'ğŸ’ é’»çŸ³çƒ­å¸¦é±¼', rarity: 0.015, bonusScore: 50, bonusFever: 15, bonusGrowth: 0.4, color: '#00FFFF' },
        { baseSubtype: 'clownfish', r: 10, name: 'ğŸŒŸ æ˜Ÿå…‰å°ä¸‘é±¼', rarity: 0.02, bonusScore: 40, bonusFever: 12, bonusGrowth: 0.35, color: '#FF69B4' },
        { baseSubtype: 'angelfish', r: 14, name: 'ğŸ’« å¤©ä½¿é‡‘é±¼', rarity: 0.015, bonusScore: 45, bonusFever: 13, bonusGrowth: 0.38, color: '#FFD700' },
        { baseSubtype: 'dolphin', r: 20, name: 'ğŸŒŠ è“å®çŸ³æµ·è±š', rarity: 0.01, bonusScore: 80, bonusFever: 25, bonusGrowth: 0.5, color: '#4169E1' },
        { baseSubtype: 'seahorse', r: 12, name: 'ğŸ’– ç²‰é’»æµ·é©¬', rarity: 0.018, bonusScore: 35, bonusFever: 11, bonusGrowth: 0.32, color: '#FF1493' },
        { baseSubtype: 'jellyfish', r: 13, name: 'ğŸ”® ç´«æ™¶æ°´æ¯', rarity: 0.015, bonusScore: 42, bonusFever: 12, bonusGrowth: 0.36, color: '#9370DB' },
        { baseSubtype: 'grouper', r: 18, name: 'âš¡ é›·å…‰çŸ³æ–‘', rarity: 0.012, bonusScore: 60, bonusFever: 18, bonusGrowth: 0.45, color: '#FFD700' }
    ];

    // å›¾é‰´é±¼ç±»æ•°æ®ï¼šåŒ…å«æ‰€æœ‰é±¼ç§ï¼ˆåŒ…æ‹¬ä¸åŒå¤§å°å’Œç‰¹æ®Šé±¼ï¼‰
    const FISH_COLLECTION = (() => {
        const fishList = [];
        let fishId = 0;
        
        // æ·»åŠ æ‰€æœ‰åé±¼
        GAME_OBJECTS.bad.forEach(fish => {
            const subtype = fish.subtype || 'normal';
            fishList.push({
                id: fishId++,
                subtype: subtype,
                name: fish.name,
                color: fish.color,
                radius: fish.r,
                category: 'æ™®é€šé±¼ç±»'
            });
        });
        
        // æ·»åŠ ç‰¹æ®Šé±¼ï¼ˆlightning å’Œ iceï¼‰
        const specialFish = GAME_OBJECTS.bad.filter(f => f.subtype === 'lightning' || f.subtype === 'ice');
        specialFish.forEach(fish => {
            // ç‰¹æ®Šé±¼å·²ç»åŒ…å«åœ¨ GAME_OBJECTS.bad ä¸­ï¼Œè¿™é‡Œä¸éœ€è¦é‡å¤æ·»åŠ 
        });
        
        // æ·»åŠ ç¨€æœ‰é±¼ç§
        RARE_FISH.forEach(rareFish => {
            fishList.push({
                id: fishId++,
                subtype: rareFish.baseSubtype,
                name: rareFish.name,
                color: rareFish.color,
                radius: rareFish.r,
                category: 'ç¨€æœ‰é±¼ç±»',
                isRare: true
            });
        });
        
        // æŒ‰åç§°æ’åº
        return fishList.sort((a, b) => {
            // å…ˆæŒ‰ç±»åˆ«æ’åºï¼ˆç¨€æœ‰é±¼åœ¨åé¢ï¼‰
            if (a.category !== b.category) {
                return a.category.localeCompare(b.category);
            }
            // å†æŒ‰åç§°æ’åº
            return a.name.localeCompare(b.name);
        });
    })();

    // --- è¾…åŠ©ç»˜å›¾ ---
    if (!CanvasRenderingContext2D.prototype.roundRect) {
        CanvasRenderingContext2D.prototype.roundRect = function (x, y, w, h, r) {
            if (w < 2 * r) r = w / 2; if (h < 2 * r) r = h / 2;
            this.beginPath(); this.moveTo(x + r, y);
            this.arcTo(x + w, y, x + w, y + h, r); this.arcTo(x + w, y + h, x, y + h, r);
            this.arcTo(x, y + h, x, y, r); this.arcTo(x, y, x + w, y, r);
            this.closePath(); return this;
        };
    }

    function drawFishArt(ctx, x, y, r, color, angle, frameCount, type, playerInstance) {
        ctx.save();
        ctx.translate(x, y);
        if (type === 'player' || type === 'guardian') { ctx.rotate(angle); }
        
        // å¢å¼ºçš„æ³¢åŠ¨æ•ˆæœ
        const tailWag = Math.sin(frameCount * 0.2) * 0.25; // å¢å¼ºå°¾å·´æ‘‡æ‘†
        const finWag = Math.cos(frameCount * 0.15) * 6; // å¢å¼ºé±¼é³æ‘‡æ‘†
        const bodyWave = Math.sin(frameCount * 0.12) * 0.08; // å¢å¼ºèº«ä½“æ³¢åŠ¨
        const bodyWave2 = Math.sin(frameCount * 0.12 + Math.PI/3) * 0.06; // ç¬¬äºŒå±‚æ³¢åŠ¨ï¼ˆç›¸ä½å»¶è¿Ÿï¼‰

        // ç»˜åˆ¶å°¾å·´
        ctx.save(); ctx.translate(-r, 0); ctx.rotate(tailWag); ctx.beginPath(); ctx.moveTo(0, 0);
        if (type === 'shark') {
            ctx.lineTo(-r * 1.5, -r * 0.8);
            ctx.quadraticCurveTo(-r * 1.2, 0, -r * 1.5, r * 0.8);
        }
        else if (type === 'whale') {
            ctx.lineTo(-r * 1.2, -r * 0.6);
            ctx.quadraticCurveTo(-r * 1.8, 0, -r * 1.2, r * 0.6);
        }
        else if (type === 'goldfish') {
            // é‡‘é±¼ï¼šå¤§è€Œé£˜é€¸çš„å°¾å·´
            ctx.lineTo(-r * 1.8, -r * 0.7);
            ctx.quadraticCurveTo(-r * 1.5, -r * 0.3, -r * 1.2, 0);
            ctx.quadraticCurveTo(-r * 1.5, r * 0.3, -r * 1.8, r * 0.7);
            ctx.lineTo(-r * 1.0, r * 0.4);
        }
        else if (type === 'tropical') {
            // çƒ­å¸¦é±¼ï¼šåˆ†å‰å°¾å·´
            ctx.lineTo(-r * 1.3, -r * 0.5);
            ctx.lineTo(-r * 1.5, -r * 0.8);
            ctx.lineTo(-r * 1.0, 0);
            ctx.lineTo(-r * 1.5, r * 0.8);
            ctx.lineTo(-r * 1.3, r * 0.5);
        }
        else if (type === 'clownfish') {
            // å°ä¸‘é±¼ï¼šåœ†æ¶¦å°¾å·´
            ctx.lineTo(-r * 1.2, -r * 0.5);
            ctx.quadraticCurveTo(-r * 1.4, 0, -r * 1.2, r * 0.5);
        }
        else if (type === 'dolphin') {
            // æµ·è±šï¼šæ°´å¹³å°¾é³
            ctx.lineTo(-r * 1.5, -r * 0.3);
            ctx.lineTo(-r * 1.8, 0);
            ctx.lineTo(-r * 1.5, r * 0.3);
        }
        else if (type === 'angelfish') {
            // å¤©ä½¿é±¼ï¼šä¸‰è§’å½¢å°¾å·´
            ctx.lineTo(-r * 1.4, -r * 0.6);
            ctx.lineTo(-r * 1.6, 0);
            ctx.lineTo(-r * 1.4, r * 0.6);
        }
        else if (type === 'seahorse') {
            // æµ·é©¬ï¼šå·æ›²å°¾å·´
            ctx.lineTo(-r * 0.8, -r * 0.4);
            ctx.quadraticCurveTo(-r * 1.2, -r * 0.2, -r * 1.4, 0);
            ctx.quadraticCurveTo(-r * 1.2, r * 0.2, -r * 0.8, r * 0.4);
            ctx.quadraticCurveTo(-r * 1.0, r * 0.3, -r * 1.2, r * 0.5);
        }
        else if (type === 'jellyfish') {
            // æ°´æ¯ï¼šä¸ç»˜åˆ¶å°¾å·´ï¼Œæ°´æ¯æ²¡æœ‰å°¾å·´ï¼Œè§¦æ‰‹ä¼šåœ¨èº«ä½“ä¸‹æ–¹ç»˜åˆ¶
            ctx.lineTo(0, 0); // ç›´æ¥è¿æ¥åˆ°èº«ä½“
        }
        else if (type === 'flounder') {
            // æ¯”ç›®é±¼ï¼šæ‰å¹³å°¾å·´
            ctx.lineTo(-r * 1.0, -r * 0.3);
            ctx.lineTo(-r * 1.3, 0);
            ctx.lineTo(-r * 1.0, r * 0.3);
        }
        else if (type === 'grouper') {
            // çŸ³æ–‘é±¼ï¼šåœ†å½¢å°¾å·´
            ctx.arc(-r * 1.3, 0, r * 0.4, 0, Math.PI * 2);
        }
        else if (type === 'tuna') {
            // é‡‘æªé±¼ï¼šæ–°æœˆå½¢å°¾å·´
            ctx.lineTo(-r * 1.6, -r * 0.7);
            ctx.quadraticCurveTo(-r * 1.8, 0, -r * 1.6, r * 0.7);
        }
        else if (type === 'salmon') {
            // ä¸‰æ–‡é±¼ï¼šåˆ†å‰å°¾å·´
            ctx.lineTo(-r * 1.3, -r * 0.6);
            ctx.lineTo(-r * 1.5, -r * 0.9);
            ctx.lineTo(-r * 1.0, 0);
            ctx.lineTo(-r * 1.5, r * 0.9);
            ctx.lineTo(-r * 1.3, r * 0.6);
        }
        else if (type === 'carp') {
            // é²¤é±¼ï¼šé•¿å°¾
            ctx.lineTo(-r * 1.5, -r * 0.5);
            ctx.quadraticCurveTo(-r * 1.7, 0, -r * 1.5, r * 0.5);
        }
        else if (type === 'bass') {
            // é²ˆé±¼ï¼šåœ†å½¢å°¾å·´
            ctx.arc(-r * 1.2, 0, r * 0.5, 0, Math.PI * 2);
        }
        else if (type === 'eel') {
            // é³—é±¼ï¼šç»†é•¿å°¾å·´
            ctx.lineTo(-r * 2.0, -r * 0.2);
            ctx.lineTo(-r * 2.0, r * 0.2);
        }
        else if (type === 'ray') {
            // é³é±¼ï¼šå®½å¤§æ‰‡å½¢
            ctx.lineTo(-r * 1.0, -r * 1.2);
            ctx.quadraticCurveTo(-r * 1.5, 0, -r * 1.0, r * 1.2);
        }
        else if (type === 'swordfish') {
            // å‰‘é±¼ï¼šå°–å°¾
            ctx.lineTo(-r * 1.8, -r * 0.4);
            ctx.lineTo(-r * 2.0, 0);
            ctx.lineTo(-r * 1.8, r * 0.4);
        }
        else if (type === 'mackerel') {
            // é²­é±¼ï¼šåˆ†å‰å°¾
            ctx.lineTo(-r * 1.2, -r * 0.5);
            ctx.lineTo(-r * 1.4, -r * 0.8);
            ctx.lineTo(-r * 1.0, 0);
            ctx.lineTo(-r * 1.4, r * 0.8);
            ctx.lineTo(-r * 1.2, r * 0.5);
        }
        else if (type === 'sardine' || type === 'anchovy') {
            // æ²™ä¸é±¼/å‡¤å°¾é±¼ï¼šå°å°¾å·´
            ctx.lineTo(-r * 1.1, -r * 0.4);
            ctx.lineTo(-r * 1.1, r * 0.4);
        }
        else if (type === 'trout') {
            // é³Ÿé±¼ï¼šåœ†å°¾
            ctx.arc(-r * 1.2, 0, r * 0.4, 0, Math.PI * 2);
        }
        else if (type === 'perch') {
            // é²ˆé±¼ï¼šåˆ†å‰å°¾
            ctx.lineTo(-r * 1.2, -r * 0.5);
            ctx.lineTo(-r * 1.3, -r * 0.7);
            ctx.lineTo(-r * 1.0, 0);
            ctx.lineTo(-r * 1.3, r * 0.7);
            ctx.lineTo(-r * 1.2, r * 0.5);
        }
        else if (type === 'catfish') {
            // é²¶é±¼ï¼šå®½å°¾
            ctx.lineTo(-r * 1.4, -r * 0.6);
            ctx.quadraticCurveTo(-r * 1.6, 0, -r * 1.4, r * 0.6);
        }
        else if (type === 'stingray') {
            // é»„è²‚é±¼ï¼šå®½å¤§æ‰‡å½¢
            ctx.lineTo(-r * 0.8, -r * 1.0);
            ctx.quadraticCurveTo(-r * 1.2, 0, -r * 0.8, r * 1.0);
        }
        else if (type === 'barracuda') {
            // æ¢­é±¼ï¼šé•¿å°–å°¾
            ctx.lineTo(-r * 1.7, -r * 0.5);
            ctx.lineTo(-r * 1.9, 0);
            ctx.lineTo(-r * 1.7, r * 0.5);
        }
        else if (type === 'butterflyfish') {
            // è´è¶é±¼ï¼šåœ†å½¢å°¾å·´
            ctx.arc(-r * 1.3, 0, r * 0.5, 0, Math.PI * 2);
        }
        else if (type === 'parrotfish') {
            // é¹¦é¹‰é±¼ï¼šæ‰‡å½¢å°¾å·´
            ctx.lineTo(-r * 1.4, -r * 0.6);
            ctx.quadraticCurveTo(-r * 1.6, 0, -r * 1.4, r * 0.6);
        }
        else if (type === 'lionfish') {
            // ç‹®å­é±¼ï¼šåˆ†å‰å°¾
            ctx.lineTo(-r * 1.3, -r * 0.5);
            ctx.lineTo(-r * 1.5, -r * 0.8);
            ctx.lineTo(-r * 1.0, 0);
            ctx.lineTo(-r * 1.5, r * 0.8);
            ctx.lineTo(-r * 1.3, r * 0.5);
        }
        else if (type === 'octopus') {
            // ç« é±¼ï¼šä¸ç»˜åˆ¶å°¾å·´ï¼Œè§¦æ‰‹ä¼šåœ¨èº«ä½“ä¸‹æ–¹ç»˜åˆ¶
            ctx.lineTo(0, 0);
        }
        else if (type === 'crab') {
            // èƒèŸ¹ï¼šå°å°¾å·´
            ctx.lineTo(-r * 0.8, -r * 0.3);
            ctx.lineTo(-r * 0.8, r * 0.3);
        }
        else if (type === 'turtle') {
            // æµ·é¾Ÿï¼šçŸ­å°¾
            ctx.lineTo(-r * 1.0, -r * 0.4);
            ctx.quadraticCurveTo(-r * 1.2, 0, -r * 1.0, r * 0.4);
        }
        else if (type === 'moray') {
            // æµ·é³—ï¼šç»†é•¿å°¾
            ctx.lineTo(-r * 2.2, -r * 0.3);
            ctx.lineTo(-r * 2.2, r * 0.3);
        }
        else if (type === 'hammerhead') {
            // é”¤å¤´é²¨ï¼šå®½å°¾
            ctx.lineTo(-r * 1.6, -r * 0.7);
            ctx.quadraticCurveTo(-r * 1.8, 0, -r * 1.6, r * 0.7);
        }
        else if (type === 'manta') {
            // é­”é¬¼é±¼ï¼šå®½å¤§æ‰‡å½¢
            ctx.lineTo(-r * 0.8, -r * 1.5);
            ctx.quadraticCurveTo(-r * 1.5, 0, -r * 0.8, r * 1.5);
        }
        else {
            ctx.lineTo(-r * 1.2, -r * 0.6);
            ctx.lineTo(-r * 1.2, r * 0.6);
        }
        ctx.lineTo(0, 0);
        // å°¾å·´æ¸å˜æ•ˆæœï¼Œè®©å°¾å·´è¾¹ç¼˜æ›´é€æ˜
        const tailGrad = ctx.createLinearGradient(0, -r * 0.5, 0, r * 0.5);
        tailGrad.addColorStop(0, color);
        tailGrad.addColorStop(0.5, color);
        tailGrad.addColorStop(1, color);
        ctx.fillStyle = tailGrad;
        ctx.fill();
        // æ·»åŠ å°¾å·´è¾¹ç¼˜é«˜å…‰
        ctx.globalAlpha = 0.3;
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.6)';
        ctx.lineWidth = 1;
        ctx.stroke();
        ctx.globalAlpha = 1.0;
        ctx.restore();

        // ç»˜åˆ¶èº«ä½“ï¼ˆåº”ç”¨æ³¢åŠ¨å½¢å˜ï¼‰
        ctx.save();
        ctx.rotate(bodyWave); // èº«ä½“æ•´ä½“è½»å¾®æ—‹è½¬
        ctx.beginPath();
        if (type === 'shark') {
            ctx.ellipse(0, 0, r * 1.8, r * 0.7, 0, 0, Math.PI * 2);
        }
        else if (type === 'whale') {
            ctx.ellipse(0, 0, r * 1.5, r * 0.9, 0, 0, Math.PI * 2);
        }
        else if (type === 'goldfish') {
            // é‡‘é±¼ï¼šåœ†æ¶¦èº«ä½“
            ctx.ellipse(0, 0, r * 1.4, r * 1.0, 0, 0, Math.PI * 2);
        }
        else if (type === 'tropical') {
            // çƒ­å¸¦é±¼ï¼šæ‰å¹³èº«ä½“
            ctx.ellipse(0, 0, r * 1.3, r * 0.8, 0, 0, Math.PI * 2);
        }
        else if (type === 'clownfish') {
            // å°ä¸‘é±¼ï¼šæ¤­åœ†å½¢
            ctx.ellipse(0, 0, r * 1.2, r * 0.9, 0, 0, Math.PI * 2);
        }
        else if (type === 'dolphin') {
            // æµ·è±šï¼šæµçº¿å‹
            ctx.ellipse(0, 0, r * 1.6, r * 0.6, 0, 0, Math.PI * 2);
        }
        else if (type === 'angelfish') {
            // å¤©ä½¿é±¼ï¼šé«˜è€Œæ‰
            ctx.ellipse(0, 0, r * 1.0, r * 1.3, 0, 0, Math.PI * 2);
        }
        else if (type === 'seahorse') {
            // æµ·é©¬ï¼šSå½¢èº«ä½“
            ctx.ellipse(0, 0, r * 0.8, r * 1.2, 0, 0, Math.PI * 2);
        }
        else if (type === 'jellyfish') {
            // æ°´æ¯ï¼šä¼çŠ¶èº«ä½“
            ctx.ellipse(0, -r * 0.3, r * 1.2, r * 0.8, 0, 0, Math.PI * 2);
        }
        else if (type === 'flounder') {
            // æ¯”ç›®é±¼ï¼šææ‰å¹³
            ctx.ellipse(0, 0, r * 1.5, r * 0.4, 0, 0, Math.PI * 2);
        }
        else if (type === 'grouper') {
            // çŸ³æ–‘é±¼ï¼šåœ†æ¶¦èº«ä½“
            ctx.ellipse(0, 0, r * 1.3, r * 1.1, 0, 0, Math.PI * 2);
        }
        else if (type === 'butterflyfish') {
            // è´è¶é±¼ï¼šåœ†å½¢èº«ä½“
            ctx.ellipse(0, 0, r * 1.2, r * 1.0, 0, 0, Math.PI * 2);
        }
        else if (type === 'parrotfish') {
            // é¹¦é¹‰é±¼ï¼šæ¤­åœ†å½¢
            ctx.ellipse(0, 0, r * 1.4, r * 0.9, 0, 0, Math.PI * 2);
        }
        else if (type === 'lionfish') {
            // ç‹®å­é±¼ï¼šåœ†å½¢èº«ä½“
            ctx.ellipse(0, 0, r * 1.3, r * 1.1, 0, 0, Math.PI * 2);
        }
        else if (type === 'octopus') {
            // ç« é±¼ï¼šåœ†å½¢èº«ä½“
            ctx.ellipse(0, 0, r * 1.2, r * 1.0, 0, 0, Math.PI * 2);
        }
        else if (type === 'crab') {
            // èƒèŸ¹ï¼šåœ†å½¢èº«ä½“
            ctx.ellipse(0, 0, r * 1.0, r * 0.8, 0, 0, Math.PI * 2);
        }
        else if (type === 'turtle') {
            // æµ·é¾Ÿï¼šæ¤­åœ†å½¢
            ctx.ellipse(0, 0, r * 1.4, r * 1.0, 0, 0, Math.PI * 2);
        }
        else if (type === 'moray') {
            // æµ·é³—ï¼šç»†é•¿èº«ä½“
            ctx.ellipse(0, 0, r * 2.0, r * 0.4, 0, 0, Math.PI * 2);
        }
        else if (type === 'hammerhead') {
            // é”¤å¤´é²¨ï¼šå®½æ‰èº«ä½“
            ctx.ellipse(0, 0, r * 1.8, r * 0.6, 0, 0, Math.PI * 2);
        }
        else if (type === 'manta') {
            // é­”é¬¼é±¼ï¼šå®½å¤§æ‰å¹³
            ctx.ellipse(0, 0, r * 2.0, r * 0.5, 0, 0, Math.PI * 2);
        }
        else {
            ctx.ellipse(0, 0, r * 1.3, r * 0.9, 0, 0, Math.PI * 2);
        }

        // èº«ä½“æ¸å˜å’Œçº¹ç†
        const bodyGrad = ctx.createRadialGradient(-r*0.3, -r*0.3, r*0.2, 0, 0, r*1.5);
        if (type === 'goldfish') {
            bodyGrad.addColorStop(0, '#FFD700');
            bodyGrad.addColorStop(0.3, '#FFA500');
            bodyGrad.addColorStop(0.7, '#FF8C00');
            bodyGrad.addColorStop(1, '#FF6347');
        }
        else if (type === 'tropical') {
            bodyGrad.addColorStop(0, '#FF69B4');
            bodyGrad.addColorStop(0.4, '#FF1493');
            bodyGrad.addColorStop(0.7, '#DC143C');
            bodyGrad.addColorStop(1, '#8B0000');
        }
        else if (type === 'clownfish') {
            bodyGrad.addColorStop(0, '#FFA500');
            bodyGrad.addColorStop(0.5, '#FF8C00');
            bodyGrad.addColorStop(1, '#FF4500');
        }
        else if (type === 'dolphin') {
            bodyGrad.addColorStop(0, '#87CEEB');
            bodyGrad.addColorStop(0.4, '#4682B4');
            bodyGrad.addColorStop(1, '#191970');
        }
        else if (type === 'angelfish') {
            bodyGrad.addColorStop(0, '#FFD700');
            bodyGrad.addColorStop(0.3, '#FFA500');
            bodyGrad.addColorStop(0.6, '#FF6347');
            bodyGrad.addColorStop(1, '#8B0000');
        }
        else if (type === 'seahorse') {
            bodyGrad.addColorStop(0, '#FFB6C1');
            bodyGrad.addColorStop(0.4, '#FF69B4');
            bodyGrad.addColorStop(0.7, '#FF1493');
            bodyGrad.addColorStop(1, '#DC143C');
        }
        else if (type === 'jellyfish') {
            bodyGrad.addColorStop(0, '#E6E6FA');
            bodyGrad.addColorStop(0.3, '#DDA0DD');
            bodyGrad.addColorStop(0.6, '#BA55D3');
            bodyGrad.addColorStop(1, '#9370DB');
        }
        else if (type === 'flounder') {
            bodyGrad.addColorStop(0, '#DDA0DD');
            bodyGrad.addColorStop(0.4, '#BA55D3');
            bodyGrad.addColorStop(0.7, '#9370DB');
            bodyGrad.addColorStop(1, '#8A2BE2');
        }
        else if (type === 'grouper') {
            bodyGrad.addColorStop(0, '#DEB887');
            bodyGrad.addColorStop(0.3, '#8B4513');
            bodyGrad.addColorStop(0.6, '#654321');
            bodyGrad.addColorStop(1, '#4B0082');
        }
        else if (type === 'tuna') {
            bodyGrad.addColorStop(0, '#4169E1');
            bodyGrad.addColorStop(0.4, '#1E90FF');
            bodyGrad.addColorStop(0.7, '#0000CD');
            bodyGrad.addColorStop(1, '#191970');
        }
        else if (type === 'salmon') {
            bodyGrad.addColorStop(0, '#FF6347');
            bodyGrad.addColorStop(0.3, '#FF4500');
            bodyGrad.addColorStop(0.6, '#DC143C');
            bodyGrad.addColorStop(1, '#8B0000');
        }
        else if (type === 'carp') {
            bodyGrad.addColorStop(0, '#FFA500');
            bodyGrad.addColorStop(0.4, '#FF8C00');
            bodyGrad.addColorStop(0.7, '#FF7F50');
            bodyGrad.addColorStop(1, '#FF6347');
        }
        else if (type === 'bass') {
            bodyGrad.addColorStop(0, '#32CD32');
            bodyGrad.addColorStop(0.4, '#228B22');
            bodyGrad.addColorStop(0.7, '#006400');
            bodyGrad.addColorStop(1, '#2F4F2F');
        }
        else if (type === 'eel') {
            bodyGrad.addColorStop(0, '#8B7355');
            bodyGrad.addColorStop(0.4, '#696969');
            bodyGrad.addColorStop(0.7, '#556B2F');
            bodyGrad.addColorStop(1, '#2F4F2F');
        }
        else if (type === 'ray' || type === 'stingray') {
            bodyGrad.addColorStop(0, '#708090');
            bodyGrad.addColorStop(0.4, '#556B2F');
            bodyGrad.addColorStop(0.7, '#2F4F2F');
            bodyGrad.addColorStop(1, '#1C1C1C');
        }
        else if (type === 'swordfish') {
            bodyGrad.addColorStop(0, '#4682B4');
            bodyGrad.addColorStop(0.4, '#1C86EE');
            bodyGrad.addColorStop(0.7, '#0000FF');
            bodyGrad.addColorStop(1, '#000080');
        }
        else if (type === 'mackerel') {
            bodyGrad.addColorStop(0, '#4682B4');
            bodyGrad.addColorStop(0.4, '#4169E1');
            bodyGrad.addColorStop(0.7, '#1E90FF');
            bodyGrad.addColorStop(1, '#0000CD');
        }
        else if (type === 'sardine' || type === 'anchovy') {
            bodyGrad.addColorStop(0, '#87CEEB');
            bodyGrad.addColorStop(0.4, '#B0E0E6');
            bodyGrad.addColorStop(0.7, '#4682B4');
            bodyGrad.addColorStop(1, '#1E90FF');
        }
        else if (type === 'trout') {
            bodyGrad.addColorStop(0, '#FF7F50');
            bodyGrad.addColorStop(0.4, '#FF6347');
            bodyGrad.addColorStop(0.7, '#FF4500');
            bodyGrad.addColorStop(1, '#DC143C');
        }
        else if (type === 'perch') {
            bodyGrad.addColorStop(0, '#20B2AA');
            bodyGrad.addColorStop(0.4, '#48D1CC');
            bodyGrad.addColorStop(0.7, '#008B8B');
            bodyGrad.addColorStop(1, '#2F4F4F');
        }
        else if (type === 'catfish') {
            bodyGrad.addColorStop(0, '#696969');
            bodyGrad.addColorStop(0.4, '#808080');
            bodyGrad.addColorStop(0.7, '#2F2F2F');
            bodyGrad.addColorStop(1, '#1C1C1C');
        }
        else if (type === 'barracuda') {
            bodyGrad.addColorStop(0, '#2F4F4F');
            bodyGrad.addColorStop(0.4, '#2F2F2F');
            bodyGrad.addColorStop(0.7, '#1C1C1C');
            bodyGrad.addColorStop(1, '#000000');
        }
        else if (type === 'butterflyfish') {
            bodyGrad.addColorStop(0, '#FFD700');
            bodyGrad.addColorStop(0.3, '#FFA500');
            bodyGrad.addColorStop(0.6, '#FF8C00');
            bodyGrad.addColorStop(1, '#FF6347');
        }
        else if (type === 'parrotfish') {
            bodyGrad.addColorStop(0, '#00CED1');
            bodyGrad.addColorStop(0.3, '#20B2AA');
            bodyGrad.addColorStop(0.6, '#008B8B');
            bodyGrad.addColorStop(1, '#2F4F4F');
        }
        else if (type === 'lionfish') {
            bodyGrad.addColorStop(0, '#FF4500');
            bodyGrad.addColorStop(0.3, '#FF6347');
            bodyGrad.addColorStop(0.6, '#DC143C');
            bodyGrad.addColorStop(1, '#8B0000');
        }
        else if (type === 'octopus') {
            bodyGrad.addColorStop(0, '#9370DB');
            bodyGrad.addColorStop(0.3, '#8A2BE2');
            bodyGrad.addColorStop(0.6, '#4B0082');
            bodyGrad.addColorStop(1, '#2F1B69');
        }
        else if (type === 'crab') {
            bodyGrad.addColorStop(0, '#FF6347');
            bodyGrad.addColorStop(0.4, '#DC143C');
            bodyGrad.addColorStop(0.7, '#B22222');
            bodyGrad.addColorStop(1, '#8B0000');
        }
        else if (type === 'turtle') {
            bodyGrad.addColorStop(0, '#20B2AA');
            bodyGrad.addColorStop(0.3, '#48D1CC');
            bodyGrad.addColorStop(0.6, '#008B8B');
            bodyGrad.addColorStop(1, '#2F4F4F');
        }
        else if (type === 'moray') {
            bodyGrad.addColorStop(0, '#4B0082');
            bodyGrad.addColorStop(0.3, '#6A5ACD');
            bodyGrad.addColorStop(0.6, '#483D8B');
            bodyGrad.addColorStop(1, '#191970');
        }
        else if (type === 'hammerhead') {
            bodyGrad.addColorStop(0, '#2F4F4F');
            bodyGrad.addColorStop(0.3, '#696969');
            bodyGrad.addColorStop(0.6, '#2F2F2F');
            bodyGrad.addColorStop(1, '#1C1C1C');
        }
        else if (type === 'manta') {
            bodyGrad.addColorStop(0, '#1C1C1C');
            bodyGrad.addColorStop(0.3, '#2F2F2F');
            bodyGrad.addColorStop(0.6, '#000000');
            bodyGrad.addColorStop(1, '#000000');
        }
        else {
            bodyGrad.addColorStop(0, '#ffffff');
            bodyGrad.addColorStop(0.3, color);
            bodyGrad.addColorStop(1, color);
        }
        ctx.fillStyle = bodyGrad;
        ctx.fill();
        ctx.restore(); // ç»“æŸèº«ä½“æ³¢åŠ¨å½¢å˜

        // æ·»åŠ çº¹ç†ç»†èŠ‚
        if (type === 'clownfish') {
            // å°ä¸‘é±¼æ¡çº¹
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 1.5;
            for (let i = 0; i < 3; i++) {
                ctx.beginPath();
                ctx.moveTo(-r * 0.8 + i * r * 0.4, -r * 0.6);
                ctx.lineTo(-r * 0.8 + i * r * 0.4, r * 0.6);
                ctx.stroke();
            }
        }
        else if (type === 'tropical' || type === 'angelfish') {
            // çƒ­å¸¦é±¼å’Œå¤©ä½¿é±¼çš„æ–‘ç‚¹
            ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
            for (let i = 0; i < 4; i++) {
                ctx.beginPath();
                ctx.arc(-r * 0.3 + i * r * 0.25, Math.sin(i) * r * 0.3, r * 0.12, 0, Math.PI * 2);
                ctx.fill();
            }
        }
        else if (type === 'seahorse') {
            // æµ·é©¬ï¼šç¯å½¢çº¹ç†
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
            ctx.lineWidth = 1;
            for (let i = 0; i < 5; i++) {
                ctx.beginPath();
                ctx.arc(0, -r * 0.5 + i * r * 0.25, r * 0.3, 0, Math.PI * 2);
                ctx.stroke();
            }
        }
        else if (type === 'jellyfish') {
            // æ°´æ¯ï¼šä¼çŠ¶çº¹ç†
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.6)';
            ctx.lineWidth = 1.5;
            for (let i = 0; i < 6; i++) {
                const angle = (i * Math.PI * 2) / 6;
                ctx.beginPath();
                ctx.moveTo(0, -r * 0.3);
                ctx.lineTo(Math.cos(angle) * r * 1.0, -r * 0.3 + Math.sin(angle) * r * 0.5);
                ctx.stroke();
            }
        }
        else if (type === 'grouper') {
            // çŸ³æ–‘é±¼ï¼šæ–‘ç‚¹çº¹ç†
            ctx.fillStyle = 'rgba(0, 0, 0, 0.4)';
            for (let i = 0; i < 8; i++) {
                ctx.beginPath();
                ctx.arc((Math.random() - 0.5) * r * 1.0, (Math.random() - 0.5) * r * 0.8, r * 0.1, 0, Math.PI * 2);
                ctx.fill();
            }
        }
        else if (type === 'goldfish') {
            // é‡‘é±¼ï¼šé³ç‰‡çº¹ç†
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.lineWidth = 0.5;
            for (let i = 0; i < 6; i++) {
                for (let j = 0; j < 3; j++) {
                    ctx.beginPath();
                    ctx.arc(-r * 0.5 + i * r * 0.2, -r * 0.4 + j * r * 0.3, r * 0.08, 0, Math.PI * 2);
                    ctx.stroke();
                }
            }
        }
        else if (type === 'seahorse') {
            // æµ·é©¬ï¼šç¯å½¢çº¹ç†
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
            ctx.lineWidth = 1;
            for (let i = 0; i < 5; i++) {
                ctx.beginPath();
                ctx.arc(0, -r * 0.5 + i * r * 0.25, r * 0.3, 0, Math.PI * 2);
                ctx.stroke();
            }
        }
        else if (type === 'jellyfish') {
            // æ°´æ¯ï¼šä¼çŠ¶çº¹ç†
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.6)';
            ctx.lineWidth = 1.5;
            for (let i = 0; i < 6; i++) {
                const angle = (i * Math.PI * 2) / 6;
                ctx.beginPath();
                ctx.moveTo(0, -r * 0.3);
                ctx.lineTo(Math.cos(angle) * r * 1.0, -r * 0.3 + Math.sin(angle) * r * 0.5);
                ctx.stroke();
            }
        }
        else if (type === 'grouper') {
            // çŸ³æ–‘é±¼ï¼šæ–‘ç‚¹çº¹ç†
            ctx.fillStyle = 'rgba(0, 0, 0, 0.4)';
            for (let i = 0; i < 8; i++) {
                ctx.beginPath();
                ctx.arc((Math.random() - 0.5) * r * 1.0, (Math.random() - 0.5) * r * 0.8, r * 0.1, 0, Math.PI * 2);
                ctx.fill();
            }
        }
        else if (type === 'goldfish') {
            // é‡‘é±¼ï¼šé³ç‰‡çº¹ç†
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.lineWidth = 0.5;
            for (let i = 0; i < 6; i++) {
                for (let j = 0; j < 3; j++) {
                    ctx.beginPath();
                    ctx.arc(-r * 0.5 + i * r * 0.2, -r * 0.4 + j * r * 0.3, r * 0.08, 0, Math.PI * 2);
                    ctx.stroke();
                }
            }
        }
        else if (type === 'butterflyfish') {
            // è´è¶é±¼ï¼šæ¡çº¹å’Œæ–‘ç‚¹
            ctx.strokeStyle = 'rgba(0, 0, 0, 0.6)';
            ctx.lineWidth = 1.5;
            for (let i = 0; i < 3; i++) {
                ctx.beginPath();
                ctx.moveTo(-r * 0.6 + i * r * 0.3, -r * 0.5);
                ctx.lineTo(-r * 0.6 + i * r * 0.3, r * 0.5);
                ctx.stroke();
            }
            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            ctx.beginPath();
            ctx.arc(r * 0.3, -r * 0.3, r * 0.15, 0, Math.PI * 2);
            ctx.fill();
        }
        else if (type === 'parrotfish') {
            // é¹¦é¹‰é±¼ï¼šé³ç‰‡çº¹ç†
            ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
            for (let i = 0; i < 6; i++) {
                ctx.beginPath();
                ctx.arc(-r * 0.4 + i * r * 0.2, Math.sin(i) * r * 0.2, r * 0.08, 0, Math.PI * 2);
                ctx.fill();
            }
        }
        else if (type === 'lionfish') {
            // ç‹®å­é±¼ï¼šæ¡çº¹
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.7)';
            ctx.lineWidth = 2;
            for (let i = 0; i < 5; i++) {
                ctx.beginPath();
                ctx.moveTo(-r * 0.5, -r * 0.6 + i * r * 0.3);
                ctx.lineTo(r * 0.5, -r * 0.6 + i * r * 0.3);
                ctx.stroke();
            }
        }
        else if (type === 'octopus') {
            // ç« é±¼ï¼šè§¦æ‰‹ï¼ˆåœ¨èº«ä½“ä¸‹æ–¹ç»˜åˆ¶ï¼‰
            ctx.fillStyle = color;
            for (let i = 0; i < 8; i++) {
                const angle = (i / 8) * Math.PI * 2;
                const tentacleX = Math.cos(angle) * r * 0.8;
                const tentacleY = Math.sin(angle) * r * 0.8 + r * 0.5;
                ctx.beginPath();
                ctx.ellipse(tentacleX, tentacleY, r * 0.15, r * 0.8, angle, 0, Math.PI * 2);
                ctx.fill();
            }
        }
        else if (type === 'crab') {
            // èƒèŸ¹ï¼šé’³å­å’Œè…¿
            ctx.fillStyle = color;
            // å·¦é’³
            ctx.beginPath();
            ctx.ellipse(-r * 0.8, -r * 0.4, r * 0.2, r * 0.3, -0.5, 0, Math.PI * 2);
            ctx.fill();
            // å³é’³
            ctx.beginPath();
            ctx.ellipse(r * 0.8, -r * 0.4, r * 0.2, r * 0.3, 0.5, 0, Math.PI * 2);
            ctx.fill();
            // è…¿
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            for (let i = 0; i < 4; i++) {
                ctx.beginPath();
                ctx.moveTo(-r * 0.5 + i * r * 0.3, r * 0.4);
                ctx.lineTo(-r * 0.5 + i * r * 0.3, r * 0.8);
                ctx.stroke();
            }
        }
        else if (type === 'turtle') {
            // æµ·é¾Ÿï¼šå£³çš„çº¹ç†
            ctx.strokeStyle = 'rgba(0, 0, 0, 0.5)';
            ctx.lineWidth = 2;
            // å…­è¾¹å½¢çº¹ç†
            for (let i = 0; i < 3; i++) {
                ctx.beginPath();
                ctx.moveTo(-r * 0.3 + i * r * 0.3, -r * 0.3);
                ctx.lineTo(-r * 0.2 + i * r * 0.3, -r * 0.5);
                ctx.lineTo(r * 0.2 + i * r * 0.3, -r * 0.5);
                ctx.lineTo(r * 0.3 + i * r * 0.3, -r * 0.3);
                ctx.lineTo(r * 0.2 + i * r * 0.3, -r * 0.1);
                ctx.lineTo(-r * 0.2 + i * r * 0.3, -r * 0.1);
                ctx.closePath();
                ctx.stroke();
            }
        }
        else if (type === 'hammerhead') {
            // é”¤å¤´é²¨ï¼šé”¤å¤´å½¢çŠ¶
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.ellipse(0, 0, r * 0.8, r * 0.3, 0, 0, Math.PI * 2);
            ctx.fill();
        }
        else if (type === 'manta') {
            // é­”é¬¼é±¼ï¼šç¿…è†€çº¹ç†
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.lineWidth = 2;
            for (let i = 0; i < 3; i++) {
                ctx.beginPath();
                ctx.moveTo(-r * 1.5, -r * 0.3 + i * r * 0.3);
                ctx.quadraticCurveTo(0, -r * 0.1 + i * r * 0.3, r * 1.5, -r * 0.3 + i * r * 0.3);
                ctx.stroke();
            }
        }

        // ç»˜åˆ¶èƒŒé³
        ctx.beginPath();
        if (type === 'shark') {
            ctx.moveTo(0, -r * 0.5);
            ctx.lineTo(r * 0.5, -r * 1.3);
            ctx.lineTo(r * 0.8, -r * 0.5);
            ctx.fillStyle = color;
            ctx.fill();
        }
        else if (type === 'dolphin') {
            // æµ·è±šèƒŒé³
            ctx.moveTo(r * 0.3, -r * 0.4);
            ctx.lineTo(r * 0.6, -r * 1.0);
            ctx.lineTo(r * 0.9, -r * 0.3);
            ctx.fillStyle = color;
            ctx.fill();
        }
        else if (type === 'angelfish') {
            // å¤©ä½¿é±¼é«˜èƒŒé³
            ctx.moveTo(0, -r * 0.5);
            ctx.lineTo(r * 0.2, -r * 1.5);
            ctx.lineTo(r * 0.4, -r * 0.3);
            ctx.fillStyle = color;
            ctx.fill();
        }

        // ç»˜åˆ¶ä¾§é³ï¼ˆèƒ¸é³ï¼‰
        ctx.beginPath();
        ctx.ellipse(0, r*0.4, r*0.4, r*0.2 + Math.abs(finWag)/20, Math.PI/4, 0, Math.PI*2);
        ctx.fillStyle = color;
        ctx.fill();

        // ç»˜åˆ¶çœ¼ç›
        ctx.fillStyle = 'white';
        ctx.beginPath();
        let eyeX = r * 0.5;
        let eyeY = -r * 0.3;
        let eyeSize = r * 0.35;
        if (type === 'shark') {
            eyeX = r * 1.0;
            eyeY = -r * 0.2;
            eyeSize = r * 0.2;
        }
        else if (type === 'whale') {
            eyeX = r * 0.8;
            eyeY = -r * 0.1;
            eyeSize = r * 0.15;
        }
        else if (type === 'goldfish') {
            eyeX = r * 0.6;
            eyeY = -r * 0.2;
            eyeSize = r * 0.3;
        }
        else if (type === 'dolphin') {
            eyeX = r * 0.7;
            eyeY = -r * 0.1;
            eyeSize = r * 0.25;
        }
        else if (type === 'seahorse') {
            eyeX = r * 0.5;
            eyeY = -r * 0.3;
            eyeSize = r * 0.2;
        }
        else if (type === 'jellyfish') {
            eyeX = r * 0.4;
            eyeY = -r * 0.5;
            eyeSize = r * 0.15;
        }
        else if (type === 'flounder') {
            eyeX = r * 0.6;
            eyeY = -r * 0.1;
            eyeSize = r * 0.2;
        }
        else if (type === 'grouper') {
            eyeX = r * 0.6;
            eyeY = -r * 0.2;
            eyeSize = r * 0.25;
        }
        ctx.arc(eyeX, eyeY, eyeSize, 0, Math.PI * 2);
        ctx.fill();

        // ç³å­”
        ctx.fillStyle = '#333';
        ctx.beginPath();
        ctx.arc(eyeX + 2, eyeY, eyeSize * 0.4, 0, Math.PI * 2);
        ctx.fill();

        // é«˜å…‰
        ctx.fillStyle = 'white';
        ctx.beginPath();
        ctx.arc(eyeX + 4, eyeY - 3, eyeSize * 0.2, 0, Math.PI * 2);
        ctx.fill();

        // çœ‰æ¯›/è¡¨æƒ…
        ctx.strokeStyle = '#333';
        ctx.lineWidth = 1.5;
        ctx.beginPath();
        if (type === 'guardian') {
            ctx.moveTo(eyeX - 5, eyeY - 8);
            ctx.lineTo(eyeX + 5, eyeY - 5);
        }
        else if (type === 'player') {
            ctx.moveTo(eyeX + 5, eyeY - 5);
            ctx.lineTo(eyeX + 8, eyeY - 8);
        }
        else if (type === 'bad' || type === 'shark') {
            ctx.moveTo(eyeX - 5, eyeY - 8);
            ctx.lineTo(eyeX + 5, eyeY - 3);
        }
        else if (type === 'goldfish' || type === 'tropical' || type === 'clownfish') {
            // å‹å¥½è¡¨æƒ…
            ctx.moveTo(eyeX - 3, eyeY - 5);
            ctx.quadraticCurveTo(eyeX, eyeY - 8, eyeX + 3, eyeY - 5);
        }
        ctx.stroke();

        // ç‰¹æ®Šæ ‡è®°
        if (type === 'guardian') {
            ctx.fillStyle = 'white';
            ctx.font = `bold ${r*0.8}px Arial`;
            ctx.textAlign = 'center';
            ctx.fillText("èªä»”", 0, 0);
        }
        
        // ç»˜åˆ¶è£…é¥°
        if (type === 'player' && currentSkins) {
            drawDecoration(ctx, 'player', currentSkins.player, r, frameCount);
        } else if (type === 'guardian' && currentSkins) {
            drawDecoration(ctx, 'guardian', currentSkins.guardian, r, frameCount);
        }

        // å¢å¼ºå…‰æ™•æ•ˆæœï¼ˆæ‰€æœ‰é±¼ç±»éƒ½æœ‰ï¼Œä½†å¼ºåº¦ä¸åŒï¼‰
        let glowIntensity = 0.15;
        let glowRadius = r * 1.5;
        
        // ç‰¹å®šé±¼ç±»å¢å¼ºå…‰æ™•
        if (type === 'goldfish' || type === 'tropical' || type === 'clownfish' || type === 'seahorse' || type === 'jellyfish') {
            glowIntensity = 0.3;
            glowRadius = r * 2.0;
        } else if (type === 'angelfish' || type === 'butterflyfish' || type === 'parrotfish') {
            glowIntensity = 0.25;
            glowRadius = r * 1.8;
        }
        
        // ç»˜åˆ¶å¤šå±‚å…‰æ™•ï¼ˆå¤–å±‚ï¼‰
        ctx.globalAlpha = glowIntensity * 0.6;
        ctx.beginPath();
        ctx.arc(0, 0, glowRadius, 0, Math.PI * 2);
        const glowGrad1 = ctx.createRadialGradient(0, 0, 0, 0, 0, glowRadius);
        glowGrad1.addColorStop(0, color);
        glowGrad1.addColorStop(0.3, color);
        glowGrad1.addColorStop(1, 'transparent');
        ctx.fillStyle = glowGrad1;
        ctx.fill();
        
        // å†…å±‚å…‰æ™•ï¼ˆæ›´äº®ï¼‰
        ctx.globalAlpha = glowIntensity;
        ctx.beginPath();
        ctx.arc(0, 0, glowRadius * 0.6, 0, Math.PI * 2);
        const glowGrad2 = ctx.createRadialGradient(0, 0, 0, 0, 0, glowRadius * 0.6);
        glowGrad2.addColorStop(0, 'rgba(255, 255, 255, 0.8)');
        glowGrad2.addColorStop(0.5, color);
        glowGrad2.addColorStop(1, 'transparent');
        ctx.fillStyle = glowGrad2;
        ctx.fill();
        
        ctx.globalAlpha = 1.0;

        // ä¸ºæµ·è±šæ·»åŠ æ°´èŠ±æ•ˆæœ
        if (type === 'dolphin' && frameCount % 10 < 3) {
            ctx.globalAlpha = 0.4;
            ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
            for (let i = 0; i < 3; i++) {
                ctx.beginPath();
                ctx.arc(r * 1.2 + i * 5, Math.sin(frameCount * 0.1 + i) * 3, 2 + i, 0, Math.PI * 2);
                ctx.fill();
            }
            ctx.globalAlpha = 1.0;
        }

        // ä¸ºæ°´æ¯æ·»åŠ è§¦æ‰‹æ•ˆæœ
        if (type === 'jellyfish') {
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.6)';
            ctx.lineWidth = 1.5;
            ctx.globalAlpha = 0.7;
            for (let i = 0; i < 6; i++) {
                const angle = (i * Math.PI * 2) / 6;
                const wave = Math.sin(frameCount * 0.15 + i) * 3;
                ctx.beginPath();
                ctx.moveTo(Math.cos(angle) * r * 0.8, r * 0.3);
                ctx.quadraticCurveTo(
                    Math.cos(angle) * r * 1.0 + wave, r * 0.8,
                    Math.cos(angle) * r * 0.9 + wave * 0.5, r * 1.5
                );
                ctx.stroke();
            }
            ctx.globalAlpha = 1.0;
        }

        // ä¸ºæµ·é©¬æ·»åŠ æ‘†åŠ¨åŠ¨ç”»
        if (type === 'seahorse') {
            ctx.save();
            ctx.translate(0, Math.sin(frameCount * 0.12) * 2);
            ctx.globalAlpha = 0.3;
            ctx.beginPath();
            ctx.arc(0, 0, r * 1.2, 0, Math.PI * 2);
            ctx.fillStyle = color;
            ctx.fill();
            ctx.globalAlpha = 1.0;
            ctx.restore();
        }

        // ä¸ºæ¯”ç›®é±¼æ·»åŠ ä¾§è¾¹çœ¼ç›
        if (type === 'flounder') {
            // æ¯”ç›®é±¼æœ‰ä¸¤åªçœ¼ç›åœ¨åŒä¸€ä¾§
            ctx.fillStyle = 'white';
            ctx.beginPath();
            ctx.arc(r * 0.4, -r * 0.2, r * 0.15, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#333';
            ctx.beginPath();
            ctx.arc(r * 0.4 + 2, -r * 0.2, r * 0.06, 0, Math.PI * 2);
            ctx.fill();

            ctx.fillStyle = 'white';
            ctx.beginPath();
            ctx.arc(r * 0.6, -r * 0.15, r * 0.12, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#333';
            ctx.beginPath();
            ctx.arc(r * 0.6 + 2, -r * 0.15, r * 0.05, 0, Math.PI * 2);
            ctx.fill();
        }
        
        // ä¸ºæ²³è±šæ·»åŠ è†¨èƒ€åŠ¨ç”»
        if (type === 'puffer') {
            const puffScale = 1 + Math.sin(frameCount * 0.1) * 0.15; // å‘¨æœŸæ€§è†¨èƒ€
            ctx.save();
            ctx.scale(puffScale, puffScale);
            // ç»˜åˆ¶åˆºï¼ˆåœ¨è†¨èƒ€æ—¶å˜é•¿ï¼‰
            ctx.globalAlpha = 0.8;
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            for (let i = 0; i < 12; i++) {
                const angle = (i * Math.PI * 2) / 12;
                const spikeLength = r * 0.4 * puffScale;
                ctx.beginPath();
                ctx.moveTo(Math.cos(angle) * r * 0.8, Math.sin(angle) * r * 0.8);
                ctx.lineTo(Math.cos(angle) * (r * 0.8 + spikeLength), Math.sin(angle) * (r * 0.8 + spikeLength));
                ctx.stroke();
            }
            ctx.globalAlpha = 1.0;
            ctx.restore();
        }
        
        // ä¸ºé²¨é±¼/ç”µé³—æ·»åŠ ç”µæµæ•ˆæœ
        if (type === 'eel' || type === 'moray') {
            if (frameCount % 60 < 10) { // æ¯60å¸§é—ªç€1æ¬¡ï¼ŒæŒç»­10å¸§
                ctx.save();
                ctx.globalAlpha = 0.6 + Math.random() * 0.3;
                ctx.strokeStyle = '#FFEB3B';
                ctx.lineWidth = 2;
                // ç»˜åˆ¶é—ªç”µçº¿æ¡
                for (let i = 0; i < 3; i++) {
                    ctx.beginPath();
                    const startX = -r + Math.random() * r * 2;
                    const startY = -r + Math.random() * r * 2;
                    ctx.moveTo(startX, startY);
                    for (let j = 0; j < 3; j++) {
                        ctx.lineTo(
                            startX + (Math.random() - 0.5) * r * 0.5,
                            startY + (Math.random() - 0.5) * r * 0.5
                        );
                    }
                    ctx.stroke();
                }
                ctx.globalAlpha = 1.0;
                ctx.restore();
            }
        }
        
        // ä¸ºé²¨é±¼/é­”é¬¼é±¼æ·»åŠ æ»¤é£ŸæµåŠ¨æ•ˆæœ
        if (type === 'manta' || type === 'ray' || type === 'stingray') {
            ctx.save();
            ctx.globalAlpha = 0.3;
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
            ctx.lineWidth = 1;
            // ç»˜åˆ¶æµçº¿ï¼ˆä»å˜´éƒ¨å¾€åæµåŠ¨ï¼‰
            for (let i = 0; i < 5; i++) {
                const offset = (frameCount * 0.3 + i * 15) % (r * 3);
                ctx.beginPath();
                ctx.moveTo(r * 0.5, -r * 0.3 + i * r * 0.15);
                ctx.lineTo(r * 0.5 - offset * 0.5, -r * 0.3 + i * r * 0.15);
                ctx.stroke();
            }
            ctx.globalAlpha = 1.0;
            ctx.restore();
        }
        
        // ä¸ºé²¨é±¼/æ¢­é±¼æ·»åŠ é€Ÿåº¦çº¿ï¼ˆå¿«é€Ÿæ•é£Ÿè€…ï¼‰
        if (type === 'barracuda' || type === 'swordfish') {
            ctx.save();
            ctx.globalAlpha = 0.4;
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.6)';
            ctx.lineWidth = 2;
            // ç»˜åˆ¶é€Ÿåº¦çº¿
            for (let i = 0; i < 3; i++) {
                const length = r * (0.8 + i * 0.2);
                const offset = (frameCount * 0.5 + i * 10) % 30;
                ctx.beginPath();
                ctx.moveTo(-r - offset, -r * 0.3 + i * r * 0.3);
                ctx.lineTo(-r - offset - length, -r * 0.3 + i * r * 0.3);
                ctx.stroke();
            }
            ctx.globalAlpha = 1.0;
            ctx.restore();
        }
        
        // ä¸ºé²¨é±¼æ·»åŠ å–‚æ°´æ•ˆæœ
        if (type === 'whale') {
            if (frameCount % 120 < 20) { // æ¯120å¸§å–·ä¸€æ¬¡æ°´
                ctx.save();
                ctx.globalAlpha = 0.6;
                ctx.fillStyle = 'rgba(135, 206, 235, 0.7)';
                // ç»˜åˆ¶å–·æ°´æŸ±
                for (let i = 0; i < 5; i++) {
                    const t = (frameCount % 120) / 20;
                    const height = r * 1.5 * t;
                    const spread = i * 3;
                    ctx.beginPath();
                    ctx.arc(0, -r - height, 2 + i, 0, Math.PI * 2);
                    ctx.fill();
                }
                ctx.globalAlpha = 1.0;
                ctx.restore();
            }
        }
        
        // ä¸ºé²¨é±¼æ·»åŠ å¨èƒåŠ¨ç”»ï¼ˆçœ¼ç›å‘çº¢å…‰ï¼‰
        if (type === 'shark') {
            if (frameCount % 90 < 30) { // å‘¨æœŸæ€§å‘çº¢å…‰
                ctx.save();
                ctx.globalAlpha = 0.5 + Math.sin(frameCount * 0.3) * 0.3;
                const eyeGlow = ctx.createRadialGradient(eyeX, eyeY, 0, eyeX, eyeY, eyeSize * 2);
                eyeGlow.addColorStop(0, '#FF0000');
                eyeGlow.addColorStop(1, 'transparent');
                ctx.fillStyle = eyeGlow;
                ctx.beginPath();
                ctx.arc(eyeX, eyeY, eyeSize * 2, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1.0;
                ctx.restore();
            }
        }
        
        // ä¸ºç« é±¼æ·»åŠ å¢¨æ±æ•ˆæœï¼ˆå—æƒŠæ—¶ï¼‰
        if (type === 'octopus') {
            if (frameCount % 180 < 15) { // å¶å°”é‡Šæ”¾å¢¨æ±
                ctx.save();
                ctx.globalAlpha = 0.7 - (frameCount % 180) / 15 * 0.7; // æ¸æ·¡
                const inkSize = r * 1.5 * ((frameCount % 180) / 15);
                ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                ctx.beginPath();
                ctx.arc(-r * 1.5, 0, inkSize, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1.0;
                ctx.restore();
            }
        }
        
        // ä¸ºé²¤å¤´é²¨æ·»åŠ æ‰«æåŠ¨ç”»ï¼ˆå¤´éƒ¨æ‘‡æ‘†ï¼‰
        if (type === 'hammerhead') {
            ctx.save();
            const hammerSwing = Math.sin(frameCount * 0.15) * 0.15;
            ctx.rotate(hammerSwing);
            // ç»˜åˆ¶æ‰«ææ³¢çº¹
            ctx.globalAlpha = 0.3;
            ctx.strokeStyle = 'rgba(100, 200, 255, 0.5)';
            ctx.lineWidth = 1;
            for (let i = 0; i < 3; i++) {
                ctx.beginPath();
                ctx.arc(r * 0.5, 0, r * 0.5 + i * 5, -Math.PI / 4, Math.PI / 4);
                ctx.stroke();
            }
            ctx.globalAlpha = 1.0;
            ctx.restore();
        }

        ctx.restore();
    }

    function drawItemArt(ctx, item) {
        ctx.save(); ctx.translate(item.x, item.y);
        if (item.vx < 0) ctx.scale(-1, 1);
        const r = item.radius; const color = item.color;
        if (item.type === 'heart') {
            if (item.subtype === 'star') drawStar(ctx, 0, 0, 5, r, r/2, color);
            else if (item.subtype === 'diamond') drawDiamond(ctx, r, color);
            else drawHeart(ctx, 0, 0, r, color);
        }
        else if (item.type === 'buff') {
            // ç»˜åˆ¶buffé“å…·èƒŒæ™¯
            ctx.beginPath();
            ctx.arc(0, 0, r, 0, Math.PI * 2);
            const grad = ctx.createRadialGradient(-r*0.3, -r*0.3, 0, 0, 0, r);
            grad.addColorStop(0, 'rgba(255,255,255,0.9)');
            grad.addColorStop(0.5, 'rgba(255,255,255,0.6)');
            grad.addColorStop(1, color);
            ctx.fillStyle = grad;
            ctx.fill();
            ctx.strokeStyle = color;
            ctx.lineWidth = 3;
            ctx.stroke();

            // ç›´æ¥ä½¿ç”¨å›¾å½¢ç»˜åˆ¶å›¾æ ‡ï¼Œä¸ä¾èµ–emojiï¼ˆiOSå…¼å®¹æ€§ï¼‰
            ctx.save();
            ctx.fillStyle = color;
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;

            if (item.subtype === 'candy') {
                // ç»˜åˆ¶ç³–æœï¼šåœ†å½¢å¸¦æ¡çº¹
                ctx.beginPath();
                ctx.arc(0, 0, r * 0.5, 0, Math.PI * 2);
                ctx.fill();
                // æ·»åŠ æ¡çº¹
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 1.5;
                for (let i = 0; i < 3; i++) {
                    ctx.beginPath();
                    ctx.arc(0, 0, r * 0.5, (i * Math.PI * 2 / 3) - Math.PI/6, (i * Math.PI * 2 / 3) + Math.PI/6);
                    ctx.stroke();
                }
            } else if (item.subtype === 'summon') {
                // ç»˜åˆ¶ç›¾ç‰Œ
                ctx.beginPath();
                ctx.moveTo(0, -r * 0.6);
                ctx.quadraticCurveTo(-r * 0.4, -r * 0.3, -r * 0.4, 0);
                ctx.quadraticCurveTo(-r * 0.4, r * 0.3, 0, r * 0.5);
                ctx.quadraticCurveTo(r * 0.4, r * 0.3, r * 0.4, 0);
                ctx.quadraticCurveTo(r * 0.4, -r * 0.3, 0, -r * 0.6);
                ctx.closePath();
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.stroke();
                // å†…éƒ¨åå­—
                ctx.strokeStyle = '#fff';
                ctx.beginPath();
                ctx.moveTo(0, -r * 0.2);
                ctx.lineTo(0, r * 0.2);
                ctx.moveTo(-r * 0.2, 0);
                ctx.lineTo(r * 0.2, 0);
                ctx.stroke();
            } else if (item.subtype === 'magnet') {
                // ç»˜åˆ¶ç£é“ï¼šUå½¢
                ctx.beginPath();
                ctx.arc(0, 0, r * 0.35, 0, Math.PI);
                ctx.lineTo(-r * 0.5, 0);
                ctx.lineTo(-r * 0.5, -r * 0.35);
                ctx.lineTo(r * 0.5, -r * 0.35);
                ctx.lineTo(r * 0.5, 0);
                ctx.closePath();
                ctx.fill();
                // æ·»åŠ Nå’ŒSæ ‡è®°
                ctx.fillStyle = '#fff';
                ctx.font = 'bold ' + (r * 0.4) + 'px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('N', -r * 0.25, -r * 0.15);
                ctx.fillText('S', r * 0.25, -r * 0.15);
            } else if (item.subtype === 'hunter') {
                // ç»˜åˆ¶é¶å¿ƒï¼šåŒå¿ƒåœ†
                ctx.beginPath();
                ctx.arc(0, 0, r * 0.5, 0, Math.PI * 2);
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.stroke();
                // å†…åœ†
                ctx.beginPath();
                ctx.arc(0, 0, r * 0.3, 0, Math.PI * 2);
                ctx.stroke();
                // ä¸­å¿ƒç‚¹
                ctx.beginPath();
                ctx.arc(0, 0, r * 0.15, 0, Math.PI * 2);
                ctx.fillStyle = '#fff';
                ctx.fill();
                // åå­—çº¿
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 1.5;
                ctx.beginPath();
                ctx.moveTo(0, -r * 0.5);
                ctx.lineTo(0, r * 0.5);
                ctx.moveTo(-r * 0.5, 0);
                ctx.lineTo(r * 0.5, 0);
                ctx.stroke();
            } else {
                // æœªçŸ¥ç±»å‹ï¼šç»˜åˆ¶é—®å·
                ctx.fillStyle = color;
                ctx.font = 'bold ' + (r * 0.8) + 'px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('?', 0, 0);
            }
            ctx.restore();
        }
        else if (item.subtype === 'tiny') {
            // ä¿æŒtinyä¸ºç®€å•åœ†å½¢ï¼Œä½†å…¶ä»–æ—©æœŸé±¼ç±»ä½¿ç”¨é±¼ç±»ç»˜åˆ¶
            ctx.fillStyle = color; ctx.beginPath(); ctx.arc(0, 0, r, 0, Math.PI*2); ctx.fill();
            ctx.strokeStyle = 'black'; ctx.lineWidth = 1; ctx.stroke();
            ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(-2, -2, 2, 0, Math.PI*2); ctx.arc(2, -2, 2, 0, Math.PI*2); ctx.fill();
        }
        else if (item.subtype === 'goldfish' || item.subtype === 'clownfish' || item.subtype === 'tropical' ||
            item.subtype === 'angelfish' || item.subtype === 'dolphin' || item.subtype === 'seahorse' ||
            item.subtype === 'jellyfish' || item.subtype === 'flounder' || item.subtype === 'grouper' ||
            item.subtype === 'tuna' || item.subtype === 'salmon' || item.subtype === 'carp' ||
            item.subtype === 'bass' || item.subtype === 'eel' || item.subtype === 'ray' ||
            item.subtype === 'swordfish' || item.subtype === 'mackerel' || item.subtype === 'sardine' ||
            item.subtype === 'anchovy' || item.subtype === 'trout' || item.subtype === 'perch' ||
            item.subtype === 'catfish' || item.subtype === 'stingray' || item.subtype === 'barracuda') {
            // æ‰€æœ‰é±¼ç±»ç±»å‹ï¼Œä½¿ç”¨é±¼ç±»ç»˜åˆ¶
            let fishType = item.subtype;

            // å¦‚æœæ˜¯ç¨€æœ‰é±¼ç§ï¼Œæ·»åŠ ç‰¹æ®Šæ•ˆæœ
            if (item.isRare) {
                // ç»˜åˆ¶é—ªå…‰æ•ˆæœ
                ctx.save();
                const glowSize = r * 2.5;
                const glowAlpha = 0.3 + Math.sin(frameCount * 0.3) * 0.2;
                ctx.globalAlpha = glowAlpha;
                const glowGrad = ctx.createRadialGradient(0, 0, 0, 0, 0, glowSize);
                glowGrad.addColorStop(0, item.color);
                glowGrad.addColorStop(0.5, item.color + '80');
                glowGrad.addColorStop(1, 'transparent');
                ctx.fillStyle = glowGrad;
                ctx.beginPath();
                ctx.arc(0, 0, glowSize, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1.0;
                ctx.restore();

                // ç»˜åˆ¶æ˜Ÿæ˜Ÿç‰¹æ•ˆï¼ˆå†…åœˆï¼‰
                ctx.save();
                ctx.globalAlpha = 0.8;
                ctx.fillStyle = '#FFD700';
                for (let i = 0; i < 6; i++) {
                    const angle = (i * Math.PI * 2 / 6) + frameCount * 0.1;
                    const dist = r * 1.5;
                    const starX = Math.cos(angle) * dist;
                    const starY = Math.sin(angle) * dist;
                    const starSize = 3 + Math.sin(frameCount * 0.2 + i) * 2;
                    ctx.beginPath();
                    ctx.arc(starX, starY, starSize, 0, Math.PI * 2);
                    ctx.fill();
                }
                ctx.globalAlpha = 1.0;
                ctx.restore();
                
                // ç»˜åˆ¶ç²’å­ç‰¹æ•ˆï¼ˆå¤–åœˆï¼Œåå‘æ—‹è½¬ï¼‰
                ctx.save();
                for (let i = 0; i < 12; i++) {
                    const angle = (i * Math.PI * 2 / 12) - frameCount * 0.08;
                    const dist = r * 2.2 + Math.sin(frameCount * 0.15 + i * 0.5) * 8;
                    const particleX = Math.cos(angle) * dist;
                    const particleY = Math.sin(angle) * dist;
                    const particleSize = 2 + Math.sin(frameCount * 0.25 + i) * 1;
                    const particleAlpha = 0.4 + Math.sin(frameCount * 0.2 + i * 0.3) * 0.3;
                    
                    ctx.globalAlpha = particleAlpha;
                    ctx.fillStyle = '#FFFFFF';
                    ctx.beginPath();
                    ctx.arc(particleX, particleY, particleSize, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // å°å…‰æ™•
                    ctx.globalAlpha = particleAlpha * 0.3;
                    const particleGlow = ctx.createRadialGradient(particleX, particleY, 0, particleX, particleY, particleSize * 3);
                    particleGlow.addColorStop(0, '#FFFFFF');
                    particleGlow.addColorStop(1, 'transparent');
                    ctx.fillStyle = particleGlow;
                    ctx.beginPath();
                    ctx.arc(particleX, particleY, particleSize * 3, 0, Math.PI * 2);
                    ctx.fill();
                }
                ctx.globalAlpha = 1.0;
                ctx.restore();
            }

            drawFishArt(ctx, 0, 0, r, color, 0, frameCount, fishType);
        }
        else if (item.subtype === 'lightning') {
            ctx.fillStyle = color; ctx.beginPath(); ctx.moveTo(0, -r); ctx.lineTo(r/1.5, -r*0.2); ctx.lineTo(0, r*0.2); ctx.lineTo(0, r); ctx.lineTo(-r/1.5, 0.2*r); ctx.lineTo(0, -0.2*r); ctx.fill();
            ctx.strokeStyle = 'orange'; ctx.lineWidth = 2; ctx.stroke();
        }
        else if (item.subtype === 'ice') {
            // ç›´æ¥ç»˜åˆ¶æ”¾å¤§çš„é›ªèŠ±emojiï¼Œä¸ç»˜åˆ¶æ–¹å—èƒŒæ™¯
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.font = 'bold ' + (r * 2) + 'px Arial, "Apple Color Emoji", "Segoe UI Emoji", sans-serif';
            ctx.fillStyle = '#00BCD4';
            ctx.fillText('â„ï¸', 0, 0);
        }
        else if (item.subtype === 'puffer') {
            ctx.fillStyle = color; ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fill();
            for(let i=0; i<8; i++) { const ang = i * Math.PI/4 + frameCount*0.05; ctx.beginPath(); ctx.moveTo(Math.cos(ang)*r*0.8, Math.sin(ang)*r*0.8); ctx.lineTo(Math.cos(ang)*(r+5), Math.sin(ang)*(r+5)); ctx.strokeStyle = '#E65100'; ctx.lineWidth=2; ctx.stroke(); }
            ctx.fillStyle='white'; ctx.beginPath(); ctx.arc(5, -5, 4, 0, Math.PI*2); ctx.fill(); ctx.fillStyle='black'; ctx.beginPath(); ctx.arc(5, -5, 1, 0, Math.PI*2); ctx.fill();
        }
        else if (item.subtype === 'octopus') {
            ctx.fillStyle = color; ctx.beginPath(); ctx.arc(0, -5, r, Math.PI, 0);
            const wave = Math.sin(frameCount * 0.2) * 5;
            ctx.lineTo(r, 10 + wave); ctx.lineTo(r/2, 5 - wave); ctx.lineTo(0, 10 + wave); ctx.lineTo(-r/2, 5 - wave); ctx.lineTo(-r, 10 + wave); ctx.fill();
            ctx.fillStyle='white'; ctx.beginPath(); ctx.arc(6, -5, 5, 0, Math.PI*2); ctx.fill(); ctx.fillStyle='black'; ctx.beginPath(); ctx.arc(6, -5, 2, 0, Math.PI*2); ctx.fill();
        }
        else if (item.subtype === 'shadow') {
            ctx.globalAlpha = 0.8; ctx.beginPath(); ctx.moveTo(r, 0); ctx.lineTo(-r, -10); ctx.lineTo(-r, 10); ctx.fill();
            ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(0, -5, 3, 0, Math.PI*2); ctx.fill(); ctx.globalAlpha = 1.0;
        }
        else {
            let fishType = 'bad';
            if (item.subtype === 'shark') fishType = 'shark';
            else if (item.subtype === 'whale') fishType = 'whale';
            else if (item.subtype === 'tropical') fishType = 'tropical';
            else if (item.subtype === 'tuna') fishType = 'tuna';
            else if (item.subtype === 'salmon') fishType = 'salmon';
            else if (item.subtype === 'carp') fishType = 'carp';
            else if (item.subtype === 'bass') fishType = 'bass';
            else if (item.subtype === 'eel') fishType = 'eel';
            else if (item.subtype === 'ray') fishType = 'ray';
            else if (item.subtype === 'swordfish') fishType = 'swordfish';
            else if (item.subtype === 'mackerel') fishType = 'mackerel';
            else if (item.subtype === 'sardine') fishType = 'sardine';
            else if (item.subtype === 'anchovy') fishType = 'anchovy';
            else if (item.subtype === 'trout') fishType = 'trout';
            else if (item.subtype === 'perch') fishType = 'perch';
            else if (item.subtype === 'catfish') fishType = 'catfish';
            else if (item.subtype === 'stingray') fishType = 'stingray';
            else if (item.subtype === 'barracuda') fishType = 'barracuda';
            else if (item.subtype === 'angelfish') fishType = 'angelfish';
            else if (item.subtype === 'goldfish') fishType = 'goldfish';
            else if (item.subtype === 'clownfish') fishType = 'clownfish';
            else if (item.subtype === 'dolphin') fishType = 'dolphin';
            drawFishArt(ctx, 0, 0, r, color, 0, frameCount, fishType);
        }
        ctx.restore();
    }

    function drawHeart(ctx, x, y, r, color) {
        ctx.fillStyle = color; ctx.beginPath(); const topCurveHeight = r * 0.8; ctx.moveTo(0, r * 0.6);
        ctx.bezierCurveTo(0, 0, -r, 0, -r, -topCurveHeight); ctx.bezierCurveTo(-r, -r * 1.6, 0, -r * 1.6, 0, -topCurveHeight);
        ctx.bezierCurveTo(0, -r * 1.6, r, -r * 1.6, r, -topCurveHeight); ctx.bezierCurveTo(r, 0, 0, 0, 0, r * 0.6); ctx.fill();
        ctx.fillStyle = 'rgba(255,255,255,0.4)'; ctx.beginPath(); ctx.arc(-r*0.3, -r*0.8, r*0.15, 0, Math.PI*2); ctx.fill();
    }

    function drawStar(ctx, cx, cy, spikes, outerRadius, innerRadius, color) {
        var rot = Math.PI / 2 * 3; var x = cx; var y = cy; var step = Math.PI / spikes;
        ctx.beginPath(); ctx.moveTo(cx, cy - outerRadius);
        for (i = 0; i < spikes; i++) {
            x = cx + Math.cos(rot) * outerRadius; y = cy + Math.sin(rot) * outerRadius; ctx.lineTo(x, y); rot += step;
            x = cx + Math.cos(rot) * innerRadius; y = cy + Math.sin(rot) * innerRadius; ctx.lineTo(x, y); rot += step;
        }
        ctx.lineTo(cx, cy - outerRadius); ctx.closePath(); ctx.fillStyle = color; ctx.fill();
    }

    function drawDiamond(ctx, r, color) {
        ctx.fillStyle = color; ctx.beginPath();
        ctx.moveTo(0, -r); ctx.lineTo(r, 0); ctx.lineTo(0, r); ctx.lineTo(-r, 0);
        ctx.fill(); ctx.strokeStyle = 'white'; ctx.lineWidth = 2; ctx.stroke();
    }

    // --- é¦–é¡µæ°›å›´é±¼ç±» ---
    class AmbientFish {
        constructor() {
            this.reset();
        }
        reset() {
            this.x = Math.random() * canvas.width;
            this.y = Math.random() * canvas.height;
            this.r = Math.random() * 15 + 8;
            this.speed = Math.random() * 0.5 + 0.2;
            this.vx = this.speed * (Math.random() < 0.5 ? 1 : -1);

            // éšæœºé€‰æ‹©é±¼ç±»ç±»å‹å’Œé¢œè‰²
            const fishTypes = ['normal', 'goldfish', 'tropical', 'clownfish', 'dolphin', 'angelfish', 'whale'];
            const rand = Math.random();
            if (rand < 0.15) this.type = 'goldfish';
            else if (rand < 0.3) this.type = 'tropical';
            else if (rand < 0.45) this.type = 'clownfish';
            else if (rand < 0.55) this.type = 'dolphin';
            else if (rand < 0.65) this.type = 'angelfish';
            else if (rand < 0.75) this.type = 'whale';
            else this.type = 'normal';

            // æ ¹æ®ç±»å‹è®¾ç½®é¢œè‰²
            if (this.type === 'goldfish') {
                this.color = `hsl(${30 + Math.random()*30}, 90%, 60%)`;
            } else if (this.type === 'tropical') {
                this.color = `hsl(${300 + Math.random()*60}, 80%, 70%)`;
            } else if (this.type === 'clownfish') {
                this.color = `hsl(${20 + Math.random()*20}, 90%, 55%)`;
            } else if (this.type === 'dolphin') {
                this.color = `hsl(${200 + Math.random()*20}, 60%, 70%)`;
            } else if (this.type === 'angelfish') {
                this.color = `hsl(${40 + Math.random()*20}, 85%, 65%)`;
            } else if (this.type === 'seahorse') {
                this.color = `hsl(${320 + Math.random()*40}, 70%, 75%)`;
            } else if (this.type === 'jellyfish') {
                this.color = `hsl(${260 + Math.random()*40}, 60%, 80%)`;
            } else if (this.type === 'flounder') {
                this.color = `hsl(${280 + Math.random()*30}, 50%, 70%)`;
            } else if (this.type === 'grouper') {
                this.color = `hsl(${30 + Math.random()*30}, 40%, 45%)`;
            } else if (this.type === 'whale') {
                this.color = `hsl(${200 + Math.random()*30}, 40%, 50%)`;
            } else {
                this.color = `hsl(${Math.random()*360}, 70%, 80%)`;
            }
        }
        update() {
            this.x += this.vx;
            // æ·»åŠ è½»å¾®çš„ä¸Šä¸‹æµ®åŠ¨
            this.y += Math.sin(frameCount * 0.05 + this.x * 0.01) * 0.3;
            if (this.x > canvas.width + 50) this.x = -50;
            if (this.x < -50) this.x = canvas.width + 50;
            if (this.y > canvas.height + 50) this.y = -50;
            if (this.y < -50) this.y = canvas.height + 50;
        }
        draw() {
            ctx.save();
            ctx.translate(this.x, this.y);
            if (this.vx < 0) ctx.scale(-1, 1);
            drawFishArt(ctx, 0, 0, this.r, this.color, 0, frameCount, this.type);
            ctx.restore();
        }
    }

    class AmbientBubble {
        constructor() {
            this.reset();
        }
        reset() {
            this.x = Math.random() * canvas.width;
            this.y = canvas.height + Math.random() * 100;
            this.r = Math.random() * 5 + 2;
            this.speed = Math.random() * 1 + 0.5;
        }
        update() {
            this.y -= this.speed;
            if (this.y < -20) this.reset();
        }
        draw() {
            ctx.beginPath(); ctx.fillStyle = 'rgba(255,255,255,0.3)';
            ctx.arc(this.x, this.y, this.r, 0, Math.PI*2); ctx.fill();
        }
    }

    // æ¸¸æˆä¸­çš„æ°”æ³¡ç±»
    class GameBubble {
        constructor() {
            this.reset();
        }
        reset() {
            this.x = Math.random() * canvas.width;
            this.y = canvas.height + Math.random() * 50;
            this.r = Math.random() * 8 + 3;
            this.speed = Math.random() * 1.5 + 0.8;
            this.opacity = Math.random() * 0.4 + 0.2;
            this.horizontalDrift = (Math.random() - 0.5) * 0.5; // æ°´å¹³æ¼‚ç§»
        }
        update() {
            this.y -= this.speed;
            this.x += this.horizontalDrift;
            // æ°”æ³¡ä¸Šå‡æ—¶ç¨å¾®å˜å¤§
            this.r += 0.01;
            // æ°”æ³¡ä¸Šå‡æ—¶ç¨å¾®å˜é€æ˜
            this.opacity = Math.max(0.1, this.opacity - 0.002);
            if (this.y < -30 || this.opacity <= 0.1) this.reset();
        }
        draw() {
            ctx.save();
            ctx.globalAlpha = this.opacity;
            // æ°”æ³¡å¤–åœˆï¼ˆæ›´é€æ˜ï¼‰
            ctx.beginPath();
            ctx.fillStyle = 'rgba(255, 255, 255, 0.15)';
            ctx.arc(this.x, this.y, this.r, 0, Math.PI * 2);
            ctx.fill();
            // æ°”æ³¡å†…åœˆï¼ˆé«˜å…‰ï¼‰
            ctx.beginPath();
            ctx.fillStyle = 'rgba(255, 255, 255, 0.4)';
            ctx.arc(this.x - this.r * 0.3, this.y - this.r * 0.3, this.r * 0.5, 0, Math.PI * 2);
            ctx.fill();
            // æ°”æ³¡è¾¹æ¡†
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.r, 0, Math.PI * 2);
            ctx.stroke();
            ctx.restore();
        }
    }

    // å…‰æ–‘æ•ˆæœç±»
    class LightRay {
        constructor() {
            this.reset();
        }
        reset() {
            this.x = Math.random() * canvas.width;
            this.y = Math.random() * canvas.height;
            this.size = Math.random() * 100 + 50;
            this.opacity = Math.random() * 0.3 + 0.1;
            this.speed = Math.random() * 0.5 + 0.2;
            this.angle = Math.random() * Math.PI * 2;
        }
        update() {
            this.x += Math.cos(this.angle) * this.speed;
            this.y += Math.sin(this.angle) * this.speed;
            // å…‰æ–‘ç¼“æ…¢é—ªçƒ
            this.opacity += Math.sin(frameCount * 0.05 + this.x * 0.01) * 0.05;
            this.opacity = Math.max(0.05, Math.min(0.4, this.opacity));

            // å¦‚æœç¦»å¼€å±å¹•ï¼Œé‡ç½®
            if (this.x < -this.size || this.x > canvas.width + this.size ||
                this.y < -this.size || this.y > canvas.height + this.size) {
                this.reset();
            }
        }
        draw() {
            ctx.save();
            ctx.globalAlpha = this.opacity;
            const grad = ctx.createRadialGradient(this.x, this.y, 0, this.x, this.y, this.size);
            grad.addColorStop(0, 'rgba(255, 255, 255, 0.6)');
            grad.addColorStop(0.5, 'rgba(173, 216, 230, 0.3)');
            grad.addColorStop(1, 'rgba(173, 216, 230, 0)');
            ctx.fillStyle = grad;
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
            ctx.fill();
            ctx.restore();
        }
    }

    // ç²’å­ç‰¹æ•ˆç±»
    class Particle {
        constructor(x, y, color, type = 'sparkle') {
            this.reset(x, y, color, type);
        }
        
        // é‡ç½®ç²’å­çŠ¶æ€ï¼ˆç”¨äºå¯¹è±¡æ± ï¼‰
        reset(x, y, color, type = 'sparkle') {
            this.x = x;
            this.y = y;
            this.color = color;
            this.type = type;
            this.vx = (Math.random() - 0.5) * 4;
            this.vy = (Math.random() - 0.5) * 4;
            this.life = 1.0;
            this.decay = Math.random() * 0.02 + 0.01;
            this.size = Math.random() * 4 + 2;
            this.angle = Math.random() * Math.PI * 2;
            this.rotationSpeed = (Math.random() - 0.5) * 0.2;
        }
        update() {
            this.x += this.vx;
            this.y += this.vy;
            this.vx *= 0.98;
            this.vy *= 0.98;
            this.life -= this.decay;
            this.angle += this.rotationSpeed;
            return this.life > 0;
        }
        draw() {
            ctx.save();
            ctx.globalAlpha = this.life;
            ctx.fillStyle = this.color;
            ctx.translate(this.x, this.y);
            ctx.rotate(this.angle);
            if (this.type === 'sparkle') {
                // æ˜Ÿæ˜Ÿå½¢çŠ¶
                ctx.beginPath();
                for (let i = 0; i < 5; i++) {
                    const angle = (i * Math.PI * 2) / 5;
                    const x = Math.cos(angle) * this.size;
                    const y = Math.sin(angle) * this.size;
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.closePath();
                ctx.fill();
            } else {
                // åœ†å½¢ç²’å­
                ctx.beginPath();
                ctx.arc(0, 0, this.size, 0, Math.PI * 2);
                ctx.fill();
            }
            ctx.restore();
        }
    }

    // ç²’å­å¯¹è±¡æ± ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
    const particlePool = [];
    const PARTICLE_POOL_SIZE = 100;
    
    // é¢„åˆ›å»ºç²’å­å¯¹è±¡æ± 
    for (let i = 0; i < PARTICLE_POOL_SIZE; i++) {
        particlePool.push(new Particle(0, 0, '#fff', 'sparkle'));
    }
    
    // ä»å¯¹è±¡æ± è·å–ç²’å­
    function getParticle(x, y, color, type) {
        if (particlePool.length > 0) {
            const particle = particlePool.pop();
            particle.reset(x, y, color, type);
            return particle;
        }
        return new Particle(x, y, color, type);
    }
    
    // å›æ”¶ç²’å­åˆ°å¯¹è±¡æ± 
    function recycleParticle(particle) {
        if (particlePool.length < PARTICLE_POOL_SIZE) {
            particlePool.push(particle);
        }
    }
    
    // åˆ›å»ºç²’å­çˆ†ç‚¸æ•ˆæœ
    function createParticleExplosion(x, y, color, count = 15) {
        for (let i = 0; i < count; i++) {
            const type = Math.random() < 0.5 ? 'sparkle' : 'circle';
            particles.push(getParticle(x, y, color, type));
        }
    }

    // --- ç³»ç»Ÿå‡½æ•° ---

    function resizeCanvas() {
        // iOS Safariå…¼å®¹æ€§å¤„ç†
        const width = window.innerWidth || document.documentElement.clientWidth || screen.width;
        const height = window.innerHeight || document.documentElement.clientHeight || screen.height;

        // iOS Safariç‰¹æ®Šå¤„ç†ï¼šä½¿ç”¨å®é™…åƒç´ å°ºå¯¸ï¼Œä¸ç¼©æ”¾
        // ç›´æ¥ä½¿ç”¨é€»è¾‘åƒç´ ï¼Œé¿å…é«˜DPIè®¾å¤‡ä¸Šçš„ç¼©æ”¾é—®é¢˜
        canvas.width = width;
        canvas.height = height;

        // ç¡®ä¿canvasæ ·å¼æ­£ç¡®
        canvas.style.width = width + 'px';
        canvas.style.height = height + 'px';

        input.x = width / 2;
        input.y = height / 2;
        
        // æ€§èƒ½ä¼˜åŒ–ï¼šé‡ç½®èƒŒæ™¯ç¼“å­˜ï¼Œä¸‹æ¬¡ç»˜åˆ¶æ—¶é‡æ–°ç”Ÿæˆ
        cachedBgCanvas = null;
    }

    // iOS Safariç‰¹æ®Šå¤„ç†ï¼šç›‘å¬orientationchangeå’Œresize
    window.addEventListener('resize', resizeCanvas);
    window.addEventListener('orientationchange', function() {
        setTimeout(resizeCanvas, 100); // å»¶è¿Ÿæ‰§è¡Œï¼Œç­‰å¾…orientationchangeå®Œæˆ
    });
    function handleInput(x, y) { 
        if(!isPaused && gameRunning) { 
            // ä¸–ç•Œé¢ å€’ï¼šä¸Šä¸‹å·¦å³å®Œå…¨é•œåƒåè½¬
            if (gravityReversed) {
                input.x = canvas.width - x;  // å·¦å³åè½¬
                input.y = canvas.height - y; // ä¸Šä¸‹åè½¬
            } else {
                input.x = x;
                input.y = y;
            }
        } 
    }
    window.addEventListener('mousemove', e => {
        // å¦‚æœé¼ æ ‡åœ¨æš‚åœæŒ‰é’®æˆ–å›¾é‰´æŒ‰é’®ä¸Šï¼Œä¸æ›´æ–°inputä½ç½®
        const pauseBtn = document.getElementById('pause-btn');
        if (pauseBtn && pauseBtn.style.display !== 'none') {
            const rect = pauseBtn.getBoundingClientRect();
            if (e.clientX >= rect.left && e.clientX <= rect.right &&
                e.clientY >= rect.top && e.clientY <= rect.bottom) {
                return; // é¼ æ ‡åœ¨æš‚åœæŒ‰é’®ä¸Šï¼Œä¸æ›´æ–°ä½ç½®
            }
        }
        
        const collectionBtn = document.getElementById('collection-btn');
        if (collectionBtn && collectionBtn.style.display !== 'none') {
            const rect = collectionBtn.getBoundingClientRect();
            if (e.clientX >= rect.left && e.clientX <= rect.right &&
                e.clientY >= rect.top && e.clientY <= rect.bottom) {
                return; // é¼ æ ‡åœ¨å›¾é‰´æŒ‰é’®ä¸Šï¼Œä¸æ›´æ–°ä½ç½®
            }
        }
        
        const collectionBtnMenu = document.getElementById('collection-btn-menu');
        if (collectionBtnMenu && collectionBtnMenu.style.display !== 'none') {
            const rect = collectionBtnMenu.getBoundingClientRect();
            if (e.clientX >= rect.left && e.clientX <= rect.right &&
                e.clientY >= rect.top && e.clientY <= rect.bottom) {
                return; // é¼ æ ‡åœ¨å›¾é‰´æŒ‰é’®ä¸Šï¼Œä¸æ›´æ–°ä½ç½®
            }
        }
        
        handleInput(e.clientX, e.clientY);
    });
    const handleTouch = (e) => {
        // å¦‚æœå›¾é‰´ç•Œé¢æ‰“å¼€ï¼Œä¸é˜»æ­¢é»˜è®¤äº‹ä»¶ï¼Œå…è®¸æ»šåŠ¨
        const collectionScreen = document.getElementById('collection-screen');
        if (collectionScreen && collectionScreen.style.display === 'flex') {
            return; // å›¾é‰´æ‰“å¼€æ—¶ä¸å¤„ç†è§¦æ‘¸äº‹ä»¶
        }
        
        if(e.cancelable) e.preventDefault();
        if(e.touches.length > 0) {
            // æ£€æŸ¥è§¦æ‘¸ç‚¹æ˜¯å¦åœ¨æš‚åœæŒ‰é’®ä¸Š
            const pauseBtn = document.getElementById('pause-btn');
            if (pauseBtn && pauseBtn.style.display !== 'none') {
                const rect = pauseBtn.getBoundingClientRect();
                const touch = e.touches[0];
                if (touch.clientX >= rect.left && touch.clientX <= rect.right &&
                    touch.clientY >= rect.top && touch.clientY <= rect.bottom) {
                    return; // è§¦æ‘¸åœ¨æš‚åœæŒ‰é’®ä¸Šï¼Œä¸æ›´æ–°ä½ç½®
                }
            }
            
            // æ£€æŸ¥è§¦æ‘¸ç‚¹æ˜¯å¦åœ¨å›¾é‰´æŒ‰é’®ä¸Š
            const collectionBtn = document.getElementById('collection-btn');
            if (collectionBtn && collectionBtn.style.display !== 'none') {
                const rect = collectionBtn.getBoundingClientRect();
                const touch = e.touches[0];
                if (touch.clientX >= rect.left && touch.clientX <= rect.right &&
                    touch.clientY >= rect.top && touch.clientY <= rect.bottom) {
                    return; // è§¦æ‘¸åœ¨å›¾é‰´æŒ‰é’®ä¸Šï¼Œä¸æ›´æ–°ä½ç½®
                }
            }
            
            // æ£€æŸ¥è§¦æ‘¸ç‚¹æ˜¯å¦åœ¨é¦–é¡µå›¾é‰´æŒ‰é’®ä¸Š
            const collectionBtnMenu = document.getElementById('collection-btn-menu');
            if (collectionBtnMenu && collectionBtnMenu.style.display !== 'none') {
                const rect = collectionBtnMenu.getBoundingClientRect();
                const touch = e.touches[0];
                if (touch.clientX >= rect.left && touch.clientX <= rect.right &&
                    touch.clientY >= rect.top && touch.clientY <= rect.bottom) {
                    return; // è§¦æ‘¸åœ¨å›¾é‰´æŒ‰é’®ä¸Šï¼Œä¸æ›´æ–°ä½ç½®
                }
            }
            
            handleInput(e.touches[0].clientX, e.touches[0].clientY);
        }
    };
    canvas.addEventListener('touchstart', handleTouch, {passive:false});
    canvas.addEventListener('touchmove', handleTouch, {passive:false});
    resizeCanvas();

    // iOS Safariç‰¹æ®Šå¤„ç†ï¼šé¡µé¢åŠ è½½åç«‹å³ç»˜åˆ¶åˆå§‹èƒŒæ™¯
    function drawInitialBackground() {
        if (canvas.width > 0 && canvas.height > 0) {
            const bgGradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            bgGradient.addColorStop(0, 'rgb(255, 154, 158)');
            bgGradient.addColorStop(1, 'rgb(250, 208, 196)');
            ctx.fillStyle = bgGradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // ç»˜åˆ¶èƒŒæ™¯å›¾ç‰‡ï¼ˆå¦‚æœå·²åŠ è½½ï¼‰
            if (bgImageLoaded && bgImage.complete && bgImage.naturalWidth > 0) {
                const scale = Math.max(canvas.width / bgImage.width, canvas.height / bgImage.height);
                const scaledWidth = bgImage.width * scale;
                const scaledHeight = bgImage.height * scale;
                const x = (canvas.width - scaledWidth) / 2;
                const y = (canvas.height - scaledHeight) / 2;
                ctx.drawImage(bgImage, x, y, scaledWidth, scaledHeight);
            }
        }
    }

    // ç¡®ä¿åœ¨é¡µé¢åŠ è½½å®Œæˆåç»˜åˆ¶åˆå§‹èƒŒæ™¯
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', drawInitialBackground);
    } else {
        drawInitialBackground();
    }

    // iOS Safariç‰¹æ®Šå¤„ç†ï¼šå»¶è¿Ÿç»˜åˆ¶ï¼Œç¡®ä¿canvaså°ºå¯¸å·²è®¾ç½®
    setTimeout(drawInitialBackground, 100);

    function spawnFloatingText(text, x, y, color='#ff4081', size=18) {
        const el = document.createElement('div');
        el.className = 'floating-text';
        el.innerText = text;
        el.style.left = x + 'px'; el.style.top = y + 'px';
        el.style.color = color; el.style.fontSize = size + 'px';
        particlesContainer.appendChild(el);
        setTimeout(() => el.remove(), 1500);
    }

    function showUnlockMsg(text) {
        unlockMsg.innerText = text; unlockMsg.style.opacity = 1;
        setTimeout(() => { unlockMsg.style.opacity = 0; }, 3000);
    }

    function updateBuffUI(buffs, guardianActive) {
        buffBar.innerHTML = '';
        if (isFeverMode) buffBar.innerHTML += `<div class="buff-icon" style="background:#FF1493; animation: pulse 0.5s infinite;">ğŸ”¥</div>`;
        if (buffs.slowed > 0) buffBar.innerHTML += `<div class="buff-icon" style="background:#00BCD4">â„ï¸</div>`;
        if (guardianActive) buffBar.innerHTML += `<div class="buff-icon" style="background:#00BFFF">ğŸ›¡ï¸</div>`;
        if (buffs.speed > 0) buffBar.innerHTML += `<div class="buff-icon" style="background:#FFD700">ğŸ¬</div>`;
        if (buffs.magnet > 0) buffBar.innerHTML += `<div class="buff-icon" style="background:#FF6347">ğŸ§²</div>`;
        if (buffs.hunter > 0) buffBar.innerHTML += `<div class="buff-icon" style="background:#00CED1">ğŸ¯</div>`;
        
        // æ–°äº‹ä»¶çŠ¶æ€æ˜¾ç¤º
        if (doubleScoreActive) buffBar.innerHTML += `<div class="buff-icon" style="background:#FFD700; animation: pulse 0.5s infinite;">ğŸ’¯</div>`;
        if (heartRainActive) buffBar.innerHTML += `<div class="buff-icon" style="background:#FF69B4">ğŸ’–</div>`;
        if (gravityReversed) buffBar.innerHTML += `<div class="buff-icon" style="background:#9C27B0">ğŸ”„</div>`;
    }

    function checkGameEvolution() {
        const scoreOffset = currentDifficultyName === 'hard' ? -200 : 0;
        if (!unlockedStages[2000] && score >= 2000 + scoreOffset) { unlockedStages[2000] = true; showUnlockMsg("ğŸ³ å·¨å¤§çš„ç°å®å‹åŠ› é€¼è¿‘!"); }
        if (!unlockedStages[3000] && score >= 3000 + scoreOffset) { unlockedStages[3000] = true; showUnlockMsg("ğŸ¦ˆ æƒ…æ„Ÿå±æœº è¢­æ¥! å¿«è·‘!"); }
    }

    function triggerEvent(type) {
        currentEvent = type;
        eventTimer = 600; // 10ç§’é»˜è®¤æ—¶é•¿
        items = items.filter(i => i.subtype !== 'lightning' && i.subtype !== 'ice');

        let title = ""; let desc = ""; let bgColor = "";
        
        // é‡ç½®äº‹ä»¶çŠ¶æ€
        doubleScoreActive = false;
        gravityReversed = false;
        heartRainActive = false;
        
        if (type === 'fog') {
            title = "ğŸŒ«ï¸ è¿·èŒƒä¹‹é›¾";
            if (guardian.active) {
                desc = "çœ‹ä¸æ¸…æœªæ¥...ä½†æœ‰ä½ åœ¨";
            } else {
                desc = "æœªæ¥ä¸­ï¼Œæˆ‘åœ¨å¯»æ‰¾ä½ çš„èº«å½±";
            }
            bgColor = "#555";
        } else if (type === 'current') {
            title = "ğŸŒŠ å‘½è¿æ¿€æµ"; desc = "ç”Ÿæ´»æƒ³æŠŠæˆ‘ä»¬å†²æ•£ï¼ŒåšæŒä½ï¼";
            const angle = Math.random() * Math.PI * 2;
            const strength = 6 + Math.random() * 4;
            currentForce.x = Math.cos(angle) * strength;
            currentForce.y = Math.sin(angle) * strength;
            bgColor = "#0077be";
            flowParticles = [];
            for(let i=0; i<60; i++) {
                flowParticles.push({
                    x: Math.random() * canvas.width, y: Math.random() * canvas.height,
                    len: Math.random() * 30 + 10, speed: Math.random() * 0.5 + 0.5
                });
            }
        } else if (type === 'starfall') {
            title = "ğŸŒ  å¹¸è¿æµæ˜Ÿ"; desc = "å±äºæˆ‘ä»¬çš„é«˜å…‰æ—¶åˆ»ï¼Œå¿«è®¸æ„¿ï¼"; bgColor = "#FFD700";
        } else if (type === 'doubleScore') {
            // æ–°äº‹ä»¶ï¼šåŒå€åˆ†æ•°
            title = "ğŸ’¯ çˆ±æ„çˆ†æ£š"; desc = "æ‰€æœ‰å¾—åˆ†ç¿»å€ï¼æŠŠæ¡æœºä¼šï¼"; bgColor = "#FFD700";
            doubleScoreActive = true;
        } else if (type === 'heartRain') {
            // æ–°äº‹ä»¶ï¼šçˆ±å¿ƒé›¨
            title = "ğŸ’– çˆ±å¿ƒé›¨"; desc = "çˆ±åœ¨ç©ºä¸­é£˜æ´’ï¼Œå°½æƒ…æ”¶é›†å§ï¼"; bgColor = "#FF69B4";
            heartRainActive = true;
        } else if (type === 'gravityReverse') {
            // æ–°äº‹ä»¶ï¼šé‡åŠ›åè½¬
            title = "ğŸ”„ ä¸–ç•Œé¢ å€’"; desc = "ä¸Šä¸‹å·¦å³åè½¬ï¼Œå°å¿ƒæ§åˆ¶ï¼"; bgColor = "#9C27B0";
            gravityReversed = true;
        }

        eventTitle.innerText = title;
        eventDesc.innerText = desc;
        eventBanner.style.opacity = 1;
        setTimeout(() => { eventBanner.style.opacity = 0; }, 4000);
    }

    function updateEventLogic() {
        if (currentEvent) {
            eventTimer--;
            
            // åŸæœ‰äº‹ä»¶é€»è¾‘
            if (currentEvent === 'current') {
                player.x += currentForce.x; player.y += currentForce.y;
                if (guardian.active) { guardian.x += currentForce.x * 0.8; guardian.y += currentForce.y * 0.8; }
            }
            if (currentEvent === 'starfall' && frameCount % 45 === 0) {
                const star = new Item(currentDifficulty);
                star.type = 'heart'; star.subtype = 'star';
                star.color = '#FFD700'; star.score = 50; star.fever = 15; star.speed *= 4; // æµæ˜Ÿé€Ÿåº¦åŠ å¿«ï¼ˆ4å€ï¼‰
                items.push(star);
            }
            
            // æ–°äº‹ä»¶é€»è¾‘ï¼šçˆ±å¿ƒé›¨
            if (currentEvent === 'heartRain' && frameCount % 20 === 0) {
                const heart = new Item(currentDifficulty);
                heart.type = 'heart';
                heart.x = Math.random() * canvas.width;
                heart.y = -50;
                heart.vx = 0;
                heart.vy = 2 + Math.random() * 2; // å‚ç›´ä¸‹è½
                items.push(heart);
            }
            
            // äº‹ä»¶ç»“æŸ
            if (eventTimer <= 0) {
                // é—¯å…³æ¨¡å¼ä¸‹ï¼Œè¿·é›¾/æ¿€æµå…³å¡ä¿æŒäº‹ä»¶æ°¸ä¹…ç”Ÿæ•ˆ
                if (isStageMode) {
                    const stage = STAGES.find(s => s.id === currentStage);
                    if (stage && (stage.type === 'fog_collect' || stage.type === 'current_collect')) {
                        eventTimer = 600; // ç»§ç»­ä¿æŒäº‹ä»¶
                        return;
                    }
                }
                currentEvent = null;
                doubleScoreActive = false;
                gravityReversed = false;
                heartRainActive = false;
                spawnFloatingText("é£å¹³æµªé™äº†...", player.x, player.y - 50, '#fff');
            }
        } else {
            // é—¯å…³æ¨¡å¼ä¸‹ï¼Œè¿·é›¾/æ¿€æµå…³å¡ä¸è§¦å‘æ–°äº‹ä»¶
            if (isStageMode) {
                const stage = STAGES.find(s => s.id === currentStage);
                if (stage && (stage.type === 'fog_collect' || stage.type === 'current_collect')) {
                    return;
                }
            }
            nextEventCooldown--;
            if (nextEventCooldown <= 0) {
                const probs = currentDifficulty.eventProb;
                const rand = Math.random();
                let cumulative = 0;
                
                // æ ¹æ®æƒé‡é€‰æ‹©äº‹ä»¶
                cumulative += probs.fog;
                if (rand < cumulative) { triggerEvent('fog'); }
                else {
                    cumulative += probs.current;
                    if (rand < cumulative) { triggerEvent('current'); }
                    else {
                        cumulative += probs.starfall;
                        if (rand < cumulative) { triggerEvent('starfall'); }
                        else {
                            cumulative += probs.doubleScore;
                            if (rand < cumulative) { triggerEvent('doubleScore'); }
                            else {
                                cumulative += probs.heartRain;
                                if (rand < cumulative) { triggerEvent('heartRain'); }
                                else { triggerEvent('gravityReverse'); }
                            }
                        }
                    }
                }
                
                nextEventCooldown = Math.random() * 1000 + 1000;
            }
        }
    }

    // é±¼ç¾¤ç³»ç»Ÿæ›´æ–°å‡½æ•°
    function updateFishSchools() {
        // å›°éš¾æ¨¡å¼ä¸ç”Ÿæˆé±¼ç¾¤
        if (currentDifficultyName === 'hard') {
            return;
        }

        // æ›´æ–°å†·å´æ—¶é—´
        if (fishSchoolCooldown > 0) {
            fishSchoolCooldown--;
        }

        // å°è¯•ç”Ÿæˆæ–°é±¼ç¾¤
        if (fishSchoolCooldown <= 0) {
            const weights = FISH_SCHOOL_WEIGHTS[currentDifficultyName];
            // è®¡ç®—ç”Ÿæˆæ¦‚ç‡ï¼šåŸºç¡€æ¦‚ç‡ + åˆ†æ•°åŠ æˆ
            const prob = Math.min(0.5, weights.baseProb + score * weights.scoreMultiplier);

            if (Math.random() < prob) {
                fishSchools.push(new FishSchool());
                // é‡ç½®å†·å´æ—¶é—´ï¼ˆ600-1200å¸§ï¼Œå³10-20ç§’ï¼‰
                fishSchoolCooldown = 600 + Math.random() * 600;
            } else {
                // å³ä½¿ä¸ç”Ÿæˆï¼Œä¹Ÿè®¾ç½®ä¸€ä¸ªè¾ƒé•¿çš„å†·å´æ—¶é—´
                fishSchoolCooldown = 180; // 3ç§’
            }
        }

        // æ›´æ–°æ‰€æœ‰é±¼ç¾¤
        for (let i = fishSchools.length - 1; i >= 0; i--) {
            const school = fishSchools[i];
            school.update();

            // æ£€æŸ¥ç©å®¶ä¸é±¼ç¾¤çš„ç¢°æ’
            const collectedCount = school.checkCollision(player.x, player.y, player.radius);
            if (collectedCount > 0) {
                // æ¯æ¡å°é±¼ç»™äºˆ2åˆ†
                const bonusScore = collectedCount * 2;
                score += bonusScore;
                scoreEl.innerText = score;
                checkGameEvolution();
            }

            // ç§»é™¤ç¦»å¼€å±å¹•çš„é±¼ç¾¤
            if (school.isOffScreen()) {
                fishSchools.splice(i, 1);
            }
        }
    }

    function addFever(baseAmount) {
        if (isFeverMode) return;
        const gain = baseAmount * currentDifficulty.feverFactor;
        feverValue = Math.min(100, feverValue + gain);
        feverBar.style.width = feverValue + "%";
        if (feverValue >= 100) { activateFever(); }
    }

    function activateFever() {
        isFeverMode = true;
        // æ ¹æ®éš¾åº¦æ¨¡å¼è®¾ç½®ä¸åŒçš„æŒç»­æ—¶é—´
        // ç®€å•æ¨¡å¼ï¼š5ç§’ï¼ˆ300å¸§ï¼‰ï¼Œæ™®é€šæ¨¡å¼ï¼š4ç§’ï¼ˆ240å¸§ï¼‰ï¼Œå›°éš¾æ¨¡å¼ï¼š3ç§’ï¼ˆ180å¸§ï¼‰
        if (currentDifficultyName === 'easy') {
            feverTimer = 300;
        } else if (currentDifficultyName === 'normal') {
            feverTimer = 240;
        } else {
            feverTimer = 180; // å›°éš¾æ¨¡å¼ï¼š3ç§’
        }
        spawnFloatingText("ğŸ”¥ æ‹çˆ±çˆ†å‘! æ— æ•Œ! ğŸ”¥", canvas.width/2 - 100, canvas.height/2, '#FF1493', 30);
        body.classList.add('fever-mode-bg');
        if(navigator.vibrate) navigator.vibrate([100,50,100]);
        
        // æ’­æ”¾å¿ƒåŠ¨çˆ†å‘éŸ³æ•ˆ
        playSound('fever');
    }

    // ================= è§’è‰²ç±» =================
    class Player {
        constructor() {
            this.x = canvas.width / 2; this.y = canvas.height / 2;
            this.radius = 10; this.angle = 0;
            this.buffs = { speed: 0, magnet: 0, slowed: 0, hunter: 0, guardian: 0 };
            this.mouthAnimationTimer = 0; // å˜´å·´åŠ¨ç”»è®¡æ—¶å™¨
        }
        update() {
            const dx = input.x - this.x; const dy = input.y - this.y;
            let speed = 0.08;
            if (this.buffs.speed > 0) speed = 0.12;
            if (this.buffs.slowed > 0) speed = 0.025;
            if (isFeverMode) speed = 0.15;

            if (Math.hypot(dx, dy) > 5) {
                this.angle = Math.atan2(dy, dx);
                this.x += dx * speed; this.y += dy * speed;
            }
            this.x = Math.max(this.radius, Math.min(canvas.width - this.radius, this.x));
            this.y = Math.max(this.radius, Math.min(canvas.height - this.radius, this.y));

            if (this.buffs.speed > 0) this.buffs.speed--;
            if (this.buffs.magnet > 0) this.buffs.magnet--;
            if (this.buffs.slowed > 0) this.buffs.slowed--;
            if (this.buffs.hunter > 0) this.buffs.hunter--;
            if (this.mouthAnimationTimer > 0) this.mouthAnimationTimer--;
            if (this.buffs.guardian > 0) {
                this.buffs.guardian--;
                // å®ˆæŠ¤æ—¶é—´åˆ°äº†ï¼Œèªä»”å»æ‰“å·¥äº†ï¼ˆæ ‡è®°ä¸ºç¦»å¼€ï¼Œè®©Guardianè‡ªå·±å¤„ç†æ¸¸èµ°ï¼‰
                if (this.buffs.guardian === 0 && guardian.active && !guardian.isLeaving) {
                    guardian.isLeaving = true;
                    guardian.wasActiveBeforeHunter = false;
                    spawnFloatingText("èªä»”å»æ‰“å·¥äº†~", player.x, player.y - 30, '#00BFFF');
                }
            }

            if (isFeverMode) {
                feverTimer--;
                // æ ¹æ®éš¾åº¦æ¨¡å¼è®¡ç®—è¿›åº¦æ¡ç™¾åˆ†æ¯”
                const maxFeverTime = currentDifficultyName === 'easy' ? 300 : (currentDifficultyName === 'normal' ? 240 : 180);
                feverBar.style.width = (feverTimer / maxFeverTime * 100) + "%";
                if (feverTimer <= 0) {
                    isFeverMode = false; feverValue = 0;
                    body.classList.remove('fever-mode-bg');
                    spawnFloatingText("æ¿€æƒ…é€€å»...", this.x, this.y, '#ccc');
                }
            }
        }
        draw() {
            ctx.save(); ctx.translate(this.x, this.y);
            if (isFeverMode) {
                ctx.beginPath(); const hue = (frameCount * 5) % 360;
                ctx.strokeStyle = `hsla(${hue}, 100%, 50%, 0.8)`; ctx.lineWidth = 4;
                ctx.arc(0, 0, this.radius * 2.5, 0, Math.PI * 2); ctx.stroke();
            }
            if (this.buffs.slowed > 0 && !isFeverMode) {
                ctx.beginPath(); ctx.strokeStyle = '#00BCD4'; ctx.lineWidth = 3;
                ctx.arc(0, 0, this.radius * 2.2, 0, Math.PI * 2); ctx.stroke();
            }
            if (this.buffs.magnet > 0 || isFeverMode) {
                ctx.beginPath(); ctx.strokeStyle = 'rgba(255, 215, 0, 0.3)'; ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]); ctx.arc(0, 0, isFeverMode ? 250 : 150, 0, Math.PI * 2); ctx.stroke();
            }
            ctx.beginPath(); ctx.fillStyle = 'rgba(255, 182, 193, 0.3)';
            ctx.arc(0, 0, this.radius * 2.0 + Math.sin(frameCount * 0.1) * 2, 0, Math.PI * 2); ctx.fill();
            ctx.restore();
            drawFishArt(ctx, this.x, this.y, this.radius, '#FF69B4', this.angle, frameCount, 'player', this);
        }
    }

    // é±¼ç¾¤ç±»
    class FishSchool {
        constructor() {
            // éšæœºé€‰æ‹©ç”Ÿæˆä½ç½®ï¼ˆä»å±å¹•ä¸€ä¾§è¿›å…¥ï¼‰
            const side = Math.floor(Math.random() * 4); // 0:å·¦, 1:å³, 2:ä¸Š, 3:ä¸‹
            const margin = 50;

            // é±¼ç¾¤ä¸­çš„é±¼æ•°é‡ï¼ˆ10-20æ¡ï¼‰
            this.fishCount = 10 + Math.floor(Math.random() * 11);
            this.fishes = [];

            // é±¼ç¾¤çš„ç§»åŠ¨æ–¹å‘
            let angle, startX, startY;
            if (side === 0) { // ä»å·¦ä¾§è¿›å…¥
                startX = -margin;
                startY = Math.random() * canvas.height;
                angle = 0; // å‘å³ç§»åŠ¨
            } else if (side === 1) { // ä»å³ä¾§è¿›å…¥
                startX = canvas.width + margin;
                startY = Math.random() * canvas.height;
                angle = Math.PI; // å‘å·¦ç§»åŠ¨
            } else if (side === 2) { // ä»ä¸Šæ–¹è¿›å…¥
                startX = Math.random() * canvas.width;
                startY = -margin;
                angle = Math.PI / 2; // å‘ä¸‹ç§»åŠ¨
            } else { // ä»ä¸‹æ–¹è¿›å…¥
                startX = Math.random() * canvas.width;
                startY = canvas.height + margin;
                angle = -Math.PI / 2; // å‘ä¸Šç§»åŠ¨
            }

            // é±¼ç¾¤çš„é€Ÿåº¦
            this.speed = 1.5 + Math.random() * 1.0; // 1.5-2.5
            this.vx = Math.cos(angle) * this.speed;
            this.vy = Math.sin(angle) * this.speed;

            // åˆ›å»ºé±¼ç¾¤ä¸­çš„å°é±¼ï¼ˆé›†ä¸­åˆ†å¸ƒï¼Œè€Œä¸æ˜¯ç«–æ’ï¼‰
            const clusterRadius = 70; // é±¼ç¾¤èšé›†åŠå¾„ï¼ˆå¢å¤§ä»¥åˆ†æ•£é±¼ç¾¤ï¼‰

            for (let i = 0; i < this.fishCount; i++) {
                // åœ¨ä¸­å¿ƒç‚¹å‘¨å›´éšæœºåˆ†å¸ƒï¼Œå½¢æˆé›†ä¸­çš„é±¼ç¾¤
                const angleOffset = Math.random() * Math.PI * 2; // éšæœºè§’åº¦
                const distance = Math.random() * clusterRadius; // éšæœºè·ç¦»ï¼ˆ0åˆ°clusterRadiusï¼‰
                const offsetX = Math.cos(angleOffset) * distance;
                const offsetY = Math.sin(angleOffset) * distance;

                this.fishes.push({
                    x: startX + offsetX,
                    y: startY + offsetY,
                    radius: 6 + Math.random() * 4, // 6-10
                    color: ['#FFD700', '#FFA500', '#FF6347', '#00CED1', '#9370DB'][Math.floor(Math.random() * 5)],
                    collected: false // æ˜¯å¦å·²è¢«æ”¶é›†
                });
            }

            this.angle = angle;
        }

        update() {
            // æ›´æ–°æ‰€æœ‰é±¼çš„ä½ç½®
            for (let fish of this.fishes) {
                if (!fish.collected) {
                    fish.x += this.vx;
                    fish.y += this.vy;
                }
            }
        }

        draw() {
            ctx.save();
            for (let fish of this.fishes) {
                if (!fish.collected) {
                    const r = fish.radius;
                    const fishPhase = fish.x * 0.1 + fish.y * 0.1; // æ¯æ¡é±¼ç‹¬ç‰¹çš„ç›¸ä½
                    const tailWag = Math.sin(frameCount * 0.15 + fishPhase) * 0.2; // å°¾å·´æ‘†åŠ¨
                    const finWag = Math.cos(frameCount * 0.2 + fishPhase) * 0.3; // é±¼é³æ‘†åŠ¨
                    const bodyWave = Math.sin(frameCount * 0.1 + fishPhase) * 0.05; // èº«ä½“æ³¢åŠ¨

                    // å‘å…‰æ•ˆæœï¼ˆå¤–åœˆå…‰æ™•ï¼‰
                    ctx.save();
                    ctx.translate(fish.x, fish.y);
                    ctx.globalAlpha = 0.2;
                    const glowGradient = ctx.createRadialGradient(0, 0, 0, 0, 0, r * 2);
                    glowGradient.addColorStop(0, fish.color);
                    glowGradient.addColorStop(1, fish.color + '00');
                    ctx.fillStyle = glowGradient;
                    ctx.beginPath();
                    ctx.arc(0, 0, r * 2, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.globalAlpha = 1;
                    ctx.restore();

                    // ç»˜åˆ¶å°¾å·´ï¼ˆæ›´æµç•…çš„æ›²çº¿ï¼Œå¸¦åŠ¨æ€æ•ˆæœï¼‰
                    ctx.save();
                    ctx.translate(fish.x, fish.y);
                    ctx.rotate(this.angle + tailWag);

                    // å°¾å·´æ¸å˜ï¼ˆæ›´ä¸°å¯Œï¼‰
                    const tailGradient = ctx.createLinearGradient(-r * 1.8, 0, -r * 0.5, 0);
                    tailGradient.addColorStop(0, fish.color);
                    tailGradient.addColorStop(0.5, fish.color + 'CC');
                    tailGradient.addColorStop(1, fish.color + '60');

                    // å°¾å·´çº¹ç†çº¿æ¡
                    ctx.beginPath();
                    ctx.moveTo(-r * 0.3, 0);
                    ctx.quadraticCurveTo(-r * 1.2, -r * 0.6, -r * 1.6, -r * 0.3);
                    ctx.quadraticCurveTo(-r * 1.8, 0, -r * 1.6, r * 0.3);
                    ctx.quadraticCurveTo(-r * 1.2, r * 0.6, -r * 0.3, 0);
                    ctx.closePath();
                    ctx.fillStyle = tailGradient;
                    ctx.fill();

                    // å°¾å·´çº¹ç†çº¿æ¡
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.4)';
                    ctx.lineWidth = 0.8;
                    ctx.stroke();

                    // å°¾å·´å†…éƒ¨çº¹ç†
                    for (let i = 0; i < 3; i++) {
                        const t = (i + 1) / 4;
                        ctx.beginPath();
                        ctx.moveTo(-r * 0.3 - r * 1.2 * t, -r * 0.3 * (1 - t));
                        ctx.quadraticCurveTo(-r * 1.2 * t, 0, -r * 0.3 - r * 1.2 * t, r * 0.3 * (1 - t));
                        ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
                        ctx.lineWidth = 0.5;
                        ctx.stroke();
                    }

                    ctx.restore();

                    // ç»˜åˆ¶èº«ä½“ï¼ˆæ¤­åœ†å½¢ï¼Œå¸¦æ³¢åŠ¨æ•ˆæœï¼‰
                    ctx.save();
                    ctx.translate(fish.x, fish.y);
                    ctx.rotate(this.angle + bodyWave);

                    // èº«ä½“æ¸å˜ï¼ˆæ›´ä¸°å¯Œçš„å±‚æ¬¡ï¼‰
                    const bodyGradient = ctx.createRadialGradient(0, -r * 0.3, 0, 0, 0, r * 1.2);
                    bodyGradient.addColorStop(0, fish.color + 'FF');
                    bodyGradient.addColorStop(0.3, fish.color);
                    bodyGradient.addColorStop(0.7, fish.color + 'DD');
                    bodyGradient.addColorStop(1, fish.color + 'AA');

                    ctx.beginPath();
                    ctx.ellipse(0, 0, r * 1.1, r * 0.8, 0, 0, Math.PI * 2);
                    ctx.fillStyle = bodyGradient;
                    ctx.fill();

                    // èº«ä½“è½®å»“ï¼ˆæ›´æ˜æ˜¾ï¼‰
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
                    ctx.lineWidth = 1.2;
                    ctx.stroke();

                    // é³ç‰‡çº¹ç†ï¼ˆå¢åŠ ç»†èŠ‚ï¼‰
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.15)';
                    ctx.lineWidth = 0.5;
                    for (let i = -2; i <= 2; i++) {
                        for (let j = -1; j <= 1; j++) {
                            const scaleX = r * 0.3;
                            const scaleY = r * 0.2;
                            ctx.beginPath();
                            ctx.ellipse(i * scaleX * 0.6, j * scaleY * 0.8, scaleX * 0.3, scaleY * 0.3, 0, 0, Math.PI * 2);
                            ctx.stroke();
                        }
                    }

                    // é«˜å…‰æ•ˆæœï¼ˆæ›´ç«‹ä½“ï¼‰
                    const highlightGradient = ctx.createRadialGradient(-r * 0.3, -r * 0.4, 0, -r * 0.3, -r * 0.4, r * 0.5);
                    highlightGradient.addColorStop(0, 'rgba(255, 255, 255, 0.5)');
                    highlightGradient.addColorStop(1, 'rgba(255, 255, 255, 0)');
                    ctx.beginPath();
                    ctx.ellipse(-r * 0.3, -r * 0.4, r * 0.4, r * 0.3, 0, 0, Math.PI * 2);
                    ctx.fillStyle = highlightGradient;
                    ctx.fill();

                    // ä¾§è¾¹é«˜å…‰
                    ctx.beginPath();
                    ctx.ellipse(r * 0.4, 0, r * 0.3, r * 0.5, 0, 0, Math.PI * 2);
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.15)';
                    ctx.fill();

                    // ç»˜åˆ¶çœ¼ç›ï¼ˆæ›´ç”ŸåŠ¨ï¼‰
                    ctx.save();
                    ctx.translate(r * 0.3, -r * 0.2);

                    // çœ¼ç›å¤–åœˆï¼ˆå¸¦é«˜å…‰ï¼‰
                    const eyeGradient = ctx.createRadialGradient(0, 0, 0, 0, 0, r * 0.2);
                    eyeGradient.addColorStop(0, '#FFF');
                    eyeGradient.addColorStop(0.3, '#AAA');
                    eyeGradient.addColorStop(1, '#000');
                    ctx.beginPath();
                    ctx.arc(0, 0, r * 0.18, 0, Math.PI * 2);
                    ctx.fillStyle = eyeGradient;
                    ctx.fill();

                    // çœ¼ç 
                    ctx.fillStyle = '#000';
                    ctx.beginPath();
                    ctx.arc(0, 0, r * 0.12, 0, Math.PI * 2);
                    ctx.fill();

                    // çœ¼ç›é«˜å…‰ï¼ˆæ›´æ˜æ˜¾ï¼‰
                    ctx.fillStyle = '#FFF';
                    ctx.beginPath();
                    ctx.arc(r * 0.04, -r * 0.04, r * 0.05, 0, Math.PI * 2);
                    ctx.fill();

                    // çœ¼ç›åå…‰
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
                    ctx.beginPath();
                    ctx.arc(-r * 0.03, r * 0.03, r * 0.03, 0, Math.PI * 2);
                    ctx.fill();

                    ctx.restore();

                    // é±¼é³ï¼ˆåŠ¨æ€æ‘†åŠ¨ï¼Œæ›´ç”ŸåŠ¨ï¼‰
                    ctx.save();
                    ctx.translate(r * 0.2, 0);
                    ctx.rotate(finWag);

                    // ä¸Šé±¼é³ï¼ˆå¸¦æ¸å˜å’Œçº¹ç†ï¼‰
                    const finGradient1 = ctx.createLinearGradient(0, -r * 0.5, 0, -r * 0.8);
                    finGradient1.addColorStop(0, fish.color + 'FF');
                    finGradient1.addColorStop(1, fish.color + '80');
                    ctx.beginPath();
                    ctx.moveTo(0, -r * 0.5);
                    ctx.quadraticCurveTo(r * 0.4, -r * 0.7, r * 0.6, -r * 0.4);
                    ctx.lineTo(r * 0.4, -r * 0.5);
                    ctx.closePath();
                    ctx.fillStyle = finGradient1;
                    ctx.fill();
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.4)';
                    ctx.lineWidth = 1;
                    ctx.stroke();

                    // ä¸Šé±¼é³çº¹ç†
                    ctx.beginPath();
                    ctx.moveTo(r * 0.2, -r * 0.6);
                    ctx.lineTo(r * 0.35, -r * 0.55);
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                    ctx.lineWidth = 0.5;
                    ctx.stroke();

                    ctx.restore();

                    ctx.save();
                    ctx.translate(r * 0.2, 0);
                    ctx.rotate(-finWag);

                    // ä¸‹é±¼é³
                    const finGradient2 = ctx.createLinearGradient(0, r * 0.5, 0, r * 0.8);
                    finGradient2.addColorStop(0, fish.color + 'FF');
                    finGradient2.addColorStop(1, fish.color + '80');
                    ctx.beginPath();
                    ctx.moveTo(0, r * 0.5);
                    ctx.quadraticCurveTo(r * 0.4, r * 0.7, r * 0.6, r * 0.4);
                    ctx.lineTo(r * 0.4, r * 0.5);
                    ctx.closePath();
                    ctx.fillStyle = finGradient2;
                    ctx.fill();
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.4)';
                    ctx.lineWidth = 1;
                    ctx.stroke();

                    // ä¸‹é±¼é³çº¹ç†
                    ctx.beginPath();
                    ctx.moveTo(r * 0.2, r * 0.6);
                    ctx.lineTo(r * 0.35, r * 0.55);
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                    ctx.lineWidth = 0.5;
                    ctx.stroke();

                    ctx.restore();

                    // èƒ¸é³ï¼ˆå°ç»†èŠ‚ï¼‰
                    ctx.save();
                    ctx.translate(r * 0.1, 0);
                    ctx.rotate(Math.sin(frameCount * 0.25 + fishPhase) * 0.2);
                    ctx.beginPath();
                    ctx.ellipse(0, -r * 0.3, r * 0.15, r * 0.08, 0, 0, Math.PI * 2);
                    ctx.fillStyle = fish.color + 'CC';
                    ctx.fill();
                    ctx.beginPath();
                    ctx.ellipse(0, r * 0.3, r * 0.15, r * 0.08, 0, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.restore();

                    ctx.restore();
                }
            }
            ctx.restore();
        }

        // æ£€æŸ¥æ˜¯å¦ç¦»å¼€å±å¹•
        isOffScreen() {
            const margin = 100;
            return this.fishes.every(fish =>
                fish.collected ||
                (fish.x < -margin || fish.x > canvas.width + margin ||
                    fish.y < -margin || fish.y > canvas.height + margin)
            );
        }

        // æ£€æŸ¥ç©å®¶æ˜¯å¦ç©¿è¿‡é±¼ç¾¤ä¸­çš„æŸæ¡é±¼
        checkCollision(playerX, playerY, playerRadius) {
            let collectedCount = 0;
            for (let fish of this.fishes) {
                if (!fish.collected) {
                    const dist = Math.hypot(playerX - fish.x, playerY - fish.y);
                    if (dist < playerRadius + fish.radius) {
                        fish.collected = true;
                        collectedCount++;
                    }
                }
            }
            return collectedCount;
        }
    }

    class Guardian {
        constructor() {
            this.active = false; this.x = -100; this.y = -100;
            this.radius = 10; this.angle = 0;
            this.wasActiveBeforeHunter = false; // è®°å½•åœ¨hunterä¹‹å‰æ˜¯å¦å·²ç»æ¿€æ´»
            this.isLeaving = false; // æ ‡è®°æ˜¯å¦æ­£åœ¨æ¸¸èµ°ç¦»å¼€
        }
        update(targetX, targetY) {
            if (!this.active) return;

            // å¦‚æœæ­£åœ¨æ¸¸èµ°ç¦»å¼€ï¼ˆå»æ‰“å·¥ï¼‰ï¼Œåˆ™æ¸¸èµ°æ¶ˆå¤±
            if (this.isLeaving) {
                // æ¸¸èµ°æ¶ˆå¤±ï¼šå‘å±å¹•å¤–ç§»åŠ¨
                const dx = (this.x < canvas.width / 2) ? -5 : 5;
                const dy = (this.y < canvas.height / 2) ? -5 : 5;
                this.x += dx;
                this.y += dy;
                this.angle = Math.atan2(dy, dx);

                // å¦‚æœç¦»å¼€å±å¹•ï¼Œåˆ™æ¶ˆå¤±
                if (this.x < -100 || this.x > canvas.width + 100 ||
                    this.y < -100 || this.y > canvas.height + 100) {
                    this.active = false;
                    this.isLeaving = false;
                    this.wasActiveBeforeHunter = false;
                }
                return;
            }

            // å¦‚æœå¼€å¯äº†hunteræ¨¡å¼ï¼Œè®©èªä»”ä¸»åŠ¨è¿½å‡»å¹¶åƒæ‰å°é±¼
            // ç¡®ä¿hunter buffå­˜åœ¨ä¸”å¤§äº0
            if (player.buffs && player.buffs.hunter > 0) {
                let nearestFish = null;
                let nearestDist = Infinity;

                // å¯»æ‰¾æœ€è¿‘çš„å°é±¼ï¼ˆbadç±»å‹ï¼Œæ”¾å®½æ¡ä»¶ï¼šåŠå¾„å°äºèªä»”çš„1.5å€ï¼Œæˆ–è€…å°äº30ï¼‰
                for (let item of items) {
                    if (item.type === 'bad') {
                        // æ”¾å®½æ¡ä»¶ï¼šå¯ä»¥åƒåŠå¾„å°äºèªä»”1.5å€çš„é±¼ï¼Œæˆ–è€…åŠå¾„å°äº30çš„å°é±¼
                        const canEat = item.radius < this.radius * 1.5 || item.radius < 30;
                        if (canEat) {
                            const dist = Math.hypot(this.x - item.x, this.y - item.y);
                            if (dist < nearestDist && dist < 400) { // æ‰©å¤§è¿½å‡»èŒƒå›´åˆ°400
                                nearestDist = dist;
                                nearestFish = item;
                            }
                        }
                    }
                }

                // å¦‚æœæ‰¾åˆ°å°é±¼ï¼Œè¿½å‡»å®ƒ
                if (nearestFish) {
                    const dx = nearestFish.x - this.x;
                    const dy = nearestFish.y - this.y;
                    this.angle = Math.atan2(dy, dx);
                    // å‡æ…¢è¿½å‡»é€Ÿåº¦ï¼Œæ ¹æ®è·ç¦»è°ƒæ•´é€Ÿåº¦
                    const chaseSpeed = Math.min(0.08, 0.04 + (400 - nearestDist) / 400 * 0.04);
                    this.x += dx * chaseSpeed;
                    this.y += dy * chaseSpeed;
                    return;
                }
                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°å°é±¼ï¼Œä½†hunteræ¨¡å¼è¿˜åœ¨ï¼Œåˆ™ç»§ç»­å¯»æ‰¾ï¼ˆå‘ç©å®¶æ–¹å‘ç§»åŠ¨ï¼Œå‡†å¤‡å¯»æ‰¾ä¸‹ä¸€ä¸ªç›®æ ‡ï¼‰
                else {
                    // hunteræ¨¡å¼ä¸‹ï¼Œå³ä½¿æ²¡æ‰¾åˆ°å°é±¼ï¼Œä¹Ÿè¦ä¿æŒç§»åŠ¨ï¼Œå‘ç©å®¶æ–¹å‘é è¿‘ä»¥ä¾¿å¯»æ‰¾ç›®æ ‡
                    const targetX_delayed = targetX - Math.cos(player.angle) * 25;
                    const targetY_delayed = targetY - Math.sin(player.angle) * 25;
                    const dx = targetX_delayed - this.x; const dy = targetY_delayed - this.y;
                    this.angle = Math.atan2(dy, dx);
                    this.x += dx * 0.06; // å‡æ…¢ç§»åŠ¨é€Ÿåº¦
                    this.y += dy * 0.06;
                    return;
                }
            }

            // hunteræ—¶é—´ç»“æŸï¼Œå¦‚æœåŸæœ¬å°±æ¿€æ´»ï¼ˆåŒ…æ‹¬åƒåˆ°æŠ¤èº«ç¬¦ï¼‰ï¼Œä¸”å®ˆæŠ¤æ—¶é—´è¿˜åœ¨ï¼Œåˆ™å›åˆ°ç²‰é±¼èº«è¾¹ç»§ç»­å®ˆæŠ¤
            if (player.buffs.hunter === 0 && this.wasActiveBeforeHunter && player.buffs.guardian > 0) {
                // ç»§ç»­å®ˆæŠ¤æ¨¡å¼
                const targetX_delayed = targetX - Math.cos(player.angle) * 25;
                const targetY_delayed = targetY - Math.sin(player.angle) * 25;
                const dx = targetX_delayed - this.x; const dy = targetY_delayed - this.y;
                this.angle = Math.atan2(dy, dx);
                this.x += dx * 0.08; this.y += dy * 0.08;
                return; // ç»§ç»­å®ˆæŠ¤ï¼Œä¸æ‰§è¡Œåé¢çš„æ¸¸èµ°é€»è¾‘
            }
            // å®ˆæŠ¤æ—¶é—´åˆ°äº†ï¼Œä½†hunteræ—¶é—´ä¹Ÿç»“æŸäº†ï¼Œèªä»”å»æ‰“å·¥äº†ï¼ˆé€šè¿‡isLeavingæ ‡è®°å¤„ç†ï¼‰
            if (player.buffs.hunter === 0 && this.wasActiveBeforeHunter && player.buffs.guardian === 0 && !this.isLeaving) {
                this.isLeaving = true;
                this.wasActiveBeforeHunter = false;
                spawnFloatingText("èªä»”å»æ‰“å·¥äº†~", player.x, player.y - 30, '#00BFFF');
                // æ¸¸èµ°é€»è¾‘ä¼šåœ¨ä¸‹ä¸€æ¬¡updateä¸­æ‰§è¡Œï¼ˆé€šè¿‡isLeavingæ£€æŸ¥ï¼‰
                return;
            }
            // hunteræ—¶é—´ç»“æŸï¼Œå¦‚æœåŸæœ¬æœªæ¿€æ´»ï¼ˆåªé€šè¿‡hunteræ¿€æ´»ï¼‰ï¼Œåˆ™æ¸¸èµ°æ¶ˆå¤±
            else if (player.buffs.hunter === 0 && !this.wasActiveBeforeHunter) {
                // æ¸¸èµ°æ¶ˆå¤±ï¼šå‘å±å¹•å¤–ç§»åŠ¨
                const dx = (this.x < canvas.width / 2) ? -5 : 5;
                const dy = (this.y < canvas.height / 2) ? -5 : 5;
                this.x += dx;
                this.y += dy;
                this.angle = Math.atan2(dy, dx);

                // å¦‚æœç¦»å¼€å±å¹•ï¼Œåˆ™æ¶ˆå¤±
                if (this.x < -100 || this.x > canvas.width + 100 ||
                    this.y < -100 || this.y > canvas.height + 100) {
                    this.active = false;
                    this.wasActiveBeforeHunter = false;
                }
                return;
            }
            // æ­£å¸¸æ¨¡å¼ï¼šè·Ÿéšç©å®¶ï¼ˆæ²¡æœ‰hunter buffæ—¶ï¼Œä¸”å®ˆæŠ¤æ—¶é—´è¿˜åœ¨ï¼‰
            if (player.buffs.guardian > 0 || this.wasActiveBeforeHunter) {
                const targetX_delayed = targetX - Math.cos(player.angle) * 25;
                const targetY_delayed = targetY - Math.sin(player.angle) * 25;
                const dx = targetX_delayed - this.x; const dy = targetY_delayed - this.y;
                this.angle = Math.atan2(dy, dx);
                this.x += dx * 0.08; this.y += dy * 0.08;
            }
        }
        draw() {
            if (!this.active) return;
            ctx.save(); ctx.translate(this.x, this.y);
            ctx.beginPath(); ctx.fillStyle = 'rgba(0, 191, 255, 0.2)';
            ctx.arc(0, 0, this.radius * 2.5, 0, Math.PI * 2); ctx.fill();
            ctx.restore();
            drawFishArt(ctx, this.x, this.y, this.radius, '#00BFFF', this.angle, frameCount, 'guardian');
        }
    }

    class Item {
        constructor(diffSettings) {
            const rand = Math.random(); const w = diffSettings.weights;
            let category = 'bad';
            let sum = 0;
            for(let i=0; i<w.length; i++) { sum += w[i]; if(rand < sum) {
                if (i === 0) category = 'good';
                else if (i === 1) category = 'buff';
                else category = 'bad';
                break;
            }}

            let availableItems = GAME_OBJECTS[category].filter(i => score >= i.minScore);
            if (availableItems.length === 0) availableItems = [GAME_OBJECTS[category][0]];

            // åŸºäºé±¼ç§å¤§å°ç±»åˆ«çš„æƒé‡é€‰æ‹©ç³»ç»Ÿï¼ˆæŒ‰åˆ†æ•°æ®µè®¾è®¡ï¼‰
            let c;
            if (category === 'bad') {
                // å°†å¯ç”¨é±¼ç§æŒ‰å¤§å°åˆ†ç±»
                const earlyFish = availableItems.filter(i => i.r < 15);      // æ—©æœŸé±¼ç§ï¼ˆå°é±¼ï¼‰
                const mediumFish = availableItems.filter(i => i.r >= 15 && i.r < 30);  // ä¸­ç­‰é±¼ç§
                const largeFish = availableItems.filter(i => i.r >= 30 && i.r < 50);   // è¾ƒå¤§é±¼ç§
                const hugeFish = availableItems.filter(i => i.r >= 50);     // è¶…å¤§å‹é±¼ç§

                // æ ¹æ®åˆ†æ•°æ®µè®¾ç½®æƒé‡ï¼ˆä¼˜åŒ–åï¼šé™ä½è¶…å¤§é±¼ï¼Œä¿ç•™å°é±¼ä½“éªŒï¼‰
                let earlyWeight, mediumWeight, largeWeight, hugeWeight;

                if (score < 1000) {
                    // 0-1000åˆ†ï¼šæ—©æœŸé±¼ç§ä¸ºä¸»ï¼Œæ¸è¿›å¼å‡çº§
                    earlyWeight = 0.5;    // 50%
                    mediumWeight = 0.3;   // 30%
                    largeWeight = 0.15;   // 15%
                    hugeWeight = 0.05;    // 5%
                } else if (score < 2000) {
                    // 1000-2000åˆ†ï¼šä¸­ç­‰é±¼ä¸ºä¸»ï¼Œé™ä½è¶…å¤§é±¼å‡ºç°ç‡
                    earlyWeight = 0.3;    // 30% (ä»25%æé«˜ï¼Œä¿ç•™å¯åƒå°é±¼)
                    mediumWeight = 0.35;  // 35%
                    largeWeight = 0.3;    // 30%
                    hugeWeight = 0.05;    // 5% (ä»10%é™ä½ï¼Œé¿å…è¿‡æ—©é‡åˆ°é²¸é±¼)
                } else if (score < 3000) {
                    // 2000-3000åˆ†ï¼šè¾ƒå¤§é±¼ä¸ºä¸»ï¼Œé€‚é‡è¶…å¤§é±¼
                    earlyWeight = 0.2;    // 20% (ä»15%æé«˜)
                    mediumWeight = 0.25;  // 25%
                    largeWeight = 0.4;    // 40% (ä»35%æé«˜)
                    hugeWeight = 0.15;    // 15% (ä»25%é™ä½)
                } else {
                    // 3000+åˆ†ï¼šé«˜éš¾åº¦ï¼Œä½†ä¿ç•™å°é±¼ä½“éªŒ
                    earlyWeight = 0.15;   // 15% (ä»10%æé«˜)
                    mediumWeight = 0.2;   // 20%
                    largeWeight = 0.4;    // 40% (ä»35%æé«˜)
                    hugeWeight = 0.25;    // 25% (ä»35%é™ä½)
                }

                // å¦‚æœæŸä¸ªç±»åˆ«æ²¡æœ‰å¯ç”¨é±¼ç§ï¼Œå°†å…¶æƒé‡è®¾ä¸º0
                const weights = [
                    earlyFish.length > 0 ? earlyWeight : 0,
                    mediumFish.length > 0 ? mediumWeight : 0,
                    largeFish.length > 0 ? largeWeight : 0,
                    hugeFish.length > 0 ? hugeWeight : 0
                ];

                // å½’ä¸€åŒ–æƒé‡ï¼ˆç¡®ä¿æ€»å’Œä¸º1ï¼‰
                const totalWeight = weights.reduce((sum, w) => sum + w, 0);
                if (totalWeight > 0) {
                    const normalizedWeights = weights.map(w => w / totalWeight);

                    // æ ¹æ®æƒé‡éšæœºé€‰æ‹©ç±»åˆ«
                    const rand = Math.random();
                    let selectedCategory = 0;
                    let cumulativeWeight = 0;

                    for (let i = 0; i < normalizedWeights.length; i++) {
                        cumulativeWeight += normalizedWeights[i];
                        if (rand < cumulativeWeight) {
                            selectedCategory = i;
                            break;
                        }
                    }

                    // ä»é€‰ä¸­çš„ç±»åˆ«ä¸­éšæœºé€‰æ‹©ä¸€æ¡é±¼
                    const categoryPools = [earlyFish, mediumFish, largeFish, hugeFish];
                    const selectedPool = categoryPools[selectedCategory];

                    if (selectedPool && selectedPool.length > 0) {
                        c = selectedPool[Math.floor(Math.random() * selectedPool.length)];
                    } else {
                        // å¦‚æœé€‰ä¸­çš„ç±»åˆ«ä¸ºç©ºï¼Œä»æ‰€æœ‰å¯ç”¨é±¼ç§ä¸­éšæœºé€‰æ‹©
                        c = availableItems[Math.floor(Math.random() * availableItems.length)];
                    }
                } else {
                    // å¦‚æœæ‰€æœ‰æƒé‡éƒ½ä¸º0ï¼Œä»æ‰€æœ‰å¯ç”¨é±¼ç§ä¸­éšæœºé€‰æ‹©
                    c = availableItems[Math.floor(Math.random() * availableItems.length)];
                }
            } else {
                c = availableItems[Math.floor(Math.random() * availableItems.length)];
            }

            if (c.rarity && Math.random() > c.rarity) c = availableItems[0];

            if (currentEvent) {
                if (c.subtype === 'lightning' || c.subtype === 'ice') {
                    c = GAME_OBJECTS['bad'][1];
                }
            }

            if (currentDifficultyName === 'hard' && c.subtype === 'summon') {
                if (Math.random() > 0.1) c = GAME_OBJECTS['good'][0];
            }

            // æ£€æŸ¥æ˜¯å¦ç”Ÿæˆç¨€æœ‰é±¼ç§ï¼ˆåªå¯¹åé±¼ç”Ÿæ•ˆï¼‰
            this.isRare = false;
            this.rareType = null;
            if (category === 'bad' && Math.random() < 0.03) { // 3%æ¦‚ç‡ç”Ÿæˆç¨€æœ‰é±¼ç§
                const availableRare = RARE_FISH.filter(rf => score >= 0); // æ‰€æœ‰ç¨€æœ‰é±¼éƒ½å¯ä»¥å‡ºç°
                if (availableRare.length > 0) {
                    const rareFish = availableRare[Math.floor(Math.random() * availableRare.length)];
                    // æ£€æŸ¥ç¨€æœ‰åº¦
                    if (Math.random() < rareFish.rarity) {
                        this.isRare = true;
                        this.rareType = rareFish;
                        this.subtype = rareFish.baseSubtype;
                        this.radius = rareFish.r;
                        this.color = rareFish.color;
                        this.name = rareFish.name;
                        this.rareBonusScore = rareFish.bonusScore;
                        this.rareBonusFever = rareFish.bonusFever;
                        this.rareBonusGrowth = rareFish.bonusGrowth;
                        // è®°å½•å‘ç°çš„ç¨€æœ‰é±¼ç§
                        discoveredRareFish.add(rareFish.name);
                        // ç¨€æœ‰é±¼çš„å›¾é‰´IDï¼šæ™®é€šé±¼æ•°é‡ + ç¨€æœ‰é±¼ç´¢å¼•
                        this.collectionId = GAME_OBJECTS.bad.length + RARE_FISH.indexOf(rareFish);
                    }
                }
            }

            this.config = c;
            // è®°å½•å›¾é‰´IDï¼šåœ¨GAME_OBJECTS.badä¸­çš„ç´¢å¼•
            if (category === 'bad') {
                this.collectionId = GAME_OBJECTS.bad.indexOf(c);
            } else {
                this.collectionId = null;
            }
            
            if (!this.isRare) {
                this.type = c.type; this.subtype = c.subtype || 'normal';
                this.radius = c.r; this.color = c.color;
                this.score = c.score || 0; this.fever = c.fever || 0; this.name = c.name;
            }

            const scoreFactor = 1 + Math.floor(score / 500) * 0.15;
            const minSpd = c.speed[0]; const maxSpd = c.speed[1];
            this.speed = (Math.random()*(maxSpd - minSpd) + minSpd) * diffSettings.speedMultiplier * scoreFactor;
            this.originalVx = 0; // ä¿å­˜åŸå§‹æ¨ªå‘é€Ÿåº¦ï¼Œç”¨äºæ¢å¤

            const margin = this.radius * 3;

            // å›°éš¾æ¨¡å¼ä¸‹ä»å››ä¸ªæ–¹å‘ç”Ÿæˆï¼Œå…¶ä»–æ¨¡å¼åªä»å·¦å³ç”Ÿæˆ
            if (currentDifficultyName === 'hard') {
                const direction = Math.floor(Math.random() * 4); // 0:å·¦, 1:å³, 2:ä¸Š, 3:ä¸‹
                if (direction === 0) {
                    // ä»å·¦ä¾§ç”Ÿæˆ
                    this.x = -margin;
                    this.y = Math.random() * canvas.height;
                    this.vx = this.speed;
                    this.originalVx = this.speed; // ä¿å­˜åŸå§‹é€Ÿåº¦
                    this.vy = (Math.random() - 0.5) * this.speed * 0.3; // æ·»åŠ å‚ç›´é€Ÿåº¦åˆ†é‡
                } else if (direction === 1) {
                    // ä»å³ä¾§ç”Ÿæˆ
                    this.x = canvas.width + margin;
                    this.y = Math.random() * canvas.height;
                    this.vx = -this.speed;
                    this.originalVx = -this.speed; // ä¿å­˜åŸå§‹é€Ÿåº¦
                    this.vy = (Math.random() - 0.5) * this.speed * 0.3;
                } else if (direction === 2) {
                    // ä»ä¸Šæ–¹ç”Ÿæˆ
                    this.x = Math.random() * canvas.width;
                    this.y = -margin;
                    this.vx = (Math.random() - 0.5) * this.speed * 0.3;
                    this.originalVx = this.vx; // ä¿å­˜åŸå§‹é€Ÿåº¦
                    this.vy = this.speed;
                } else {
                    // ä»ä¸‹æ–¹ç”Ÿæˆ
                    this.x = Math.random() * canvas.width;
                    this.y = canvas.height + margin;
                    this.vx = (Math.random() - 0.5) * this.speed * 0.3;
                    this.originalVx = this.vx; // ä¿å­˜åŸå§‹é€Ÿåº¦
                    this.vy = -this.speed;
                }
            } else {
                // æ™®é€šæ¨¡å¼å’Œç®€å•æ¨¡å¼ï¼šåªä»å·¦å³ç”Ÿæˆ
                this.y = Math.random() * canvas.height;
                const side = Math.random() < 0.5 ? 'left' : 'right';
                if (side === 'left') {
                    this.x = -margin;
                    this.vx = this.speed;
                    this.originalVx = this.speed; // ä¿å­˜åŸå§‹é€Ÿåº¦
                    this.vy = 0;
                } else {
                    this.x = canvas.width + margin;
                    this.vx = -this.speed;
                    this.originalVx = -this.speed; // ä¿å­˜åŸå§‹é€Ÿåº¦
                    this.vy = 0;
                }
            }
        }
        update() {
            // å¤§é±¼ä¸»åŠ¨è¿½å‡»ç©å®¶é€»è¾‘ï¼ˆåœ¨ç§»åŠ¨ä¹‹å‰åˆ¤æ–­ï¼‰
            let isChasing = false;
            if (this.type === 'bad' && this.radius >= 20 && !isFeverMode) {
                const distToPlayer = Math.hypot(player.x - this.x, player.y - this.y);
                // å‡å°è¿½å‡»èŒƒå›´ï¼šåªåœ¨ç©å®¶çœŸæ­£é è¿‘æ—¶æ‰è¿½å‡»
                // å¤§é±¼è¿½å‡»èŒƒå›´ï¼šæ ¹æ®é±¼çš„å¤§å°è°ƒæ•´ï¼Œä½†èŒƒå›´æ›´å°
                const chaseRange = this.radius * (this.radius >= 50 ? 3 : 2.5); // ä»10-12å€å‡å°‘åˆ°4-5å€

                // åªåœ¨ç©å®¶è¶³å¤Ÿé è¿‘æ—¶è¿½å‡»ï¼Œå¯ä»¥è¿½å‡»åˆ°ç¢°æ’
                if (distToPlayer < chaseRange && distToPlayer > this.radius + player.radius) {
                    isChasing = true;
                    // è®¡ç®—æœå‘ç©å®¶çš„æ–¹å‘
                    const angle = Math.atan2(player.y - this.y, player.x - this.x);

                    // è®¡ç®—æ­£å¸¸æ¸¸åŠ¨çš„é€Ÿåº¦ï¼ˆæ¨ªå‘é€Ÿåº¦çš„ç»å¯¹å€¼ï¼‰
                    const normalSpeed = Math.abs(this.originalVx || this.vx || this.speed);

                    // å¤§é±¼è¶Šå¤§ï¼Œè¿½å‡»é€Ÿåº¦è¶Šå¿«
                    const speedMultiplier = this.radius >= 50 ? 1.5 : (this.radius >= 30 ? 1.3 : 1.2);

                    // æ ¹æ®éš¾åº¦è°ƒæ•´è¿½å‡»å¼ºåº¦ï¼Œç¡®ä¿è¿½å‡»é€Ÿåº¦è‡³å°‘ç­‰äºæ­£å¸¸é€Ÿåº¦
                    let chaseIntensity;
                    if (currentDifficultyName === 'easy') {
                        chaseIntensity = 1.0; // ç®€å•æ¨¡å¼ï¼šä¸æ­£å¸¸é€Ÿåº¦ç›¸åŒ
                    } else if (currentDifficultyName === 'normal') {
                        chaseIntensity = 1.2; // æ™®é€šæ¨¡å¼ï¼šæ¯”æ­£å¸¸é€Ÿåº¦å¿«20%
                    } else {
                        chaseIntensity = 1.5; // å›°éš¾æ¨¡å¼ï¼šæ¯”æ­£å¸¸é€Ÿåº¦å¿«50%
                    }

                    // è®¡ç®—è¿½å‡»é€Ÿåº¦ï¼Œç¡®ä¿è‡³å°‘ç­‰äºæ­£å¸¸é€Ÿåº¦
                    const baseChaseSpeed = Math.max(normalSpeed * speedMultiplier, normalSpeed);
                    const finalChaseSpeed = baseChaseSpeed * chaseIntensity;

                    const chaseX = Math.cos(angle) * finalChaseSpeed;
                    const chaseY = Math.sin(angle) * finalChaseSpeed;

                    // å¦‚æœæ­£åœ¨è¿½å‡»ï¼Œä¼˜å…ˆä½¿ç”¨è¿½å‡»ç§»åŠ¨ï¼Œå‡å°‘åŸæ¥çš„æ¨ªå‘ç§»åŠ¨
                    this.x += chaseX;
                    this.y += chaseY;

                    // æ›´æ–°vxæ–¹å‘ï¼Œè®©é±¼æœå‘ç©å®¶ï¼Œä½†è¿½å‡»æ—¶å‡å°‘æ¨ªå‘ç§»åŠ¨
                    if (this.x < player.x) {
                        this.vx = Math.abs(this.originalVx) * 0.4; // è¿½å‡»æ—¶å‡å°‘æ¨ªå‘ç§»åŠ¨
                    } else {
                        this.vx = -Math.abs(this.originalVx) * 0.4;
                    }
                } else {
                    // ä¸åœ¨è¿½å‡»èŒƒå›´å†…ï¼Œæ¢å¤åŸå§‹é€Ÿåº¦
                    if (this.originalVx !== 0) {
                        this.vx = this.originalVx;
                    }
                }
            } else {
                // ä¸æ˜¯å¤§é±¼æˆ–æ— æ•Œæ¨¡å¼ï¼Œæ¢å¤åŸå§‹é€Ÿåº¦
                if (this.originalVx !== 0 && this.vx !== this.originalVx) {
                    this.vx = this.originalVx;
                }
            }

            // å¦‚æœæ²¡æœ‰åœ¨è¿½å‡»ï¼Œæ‰ä½¿ç”¨åŸæ¥çš„ç§»åŠ¨æ–¹å¼
            if (!isChasing) {
                this.x += this.vx;
                // æ”¯æŒå‚ç›´ç§»åŠ¨ï¼ˆå›°éš¾æ¨¡å¼ä¸‹ä»ä¸Šä¸‹æ–¹å‘ç”Ÿæˆçš„é±¼ï¼‰
                if (this.vy !== undefined) {
                    this.y += this.vy;
                }
            } else {
                // è¿½å‡»æ—¶ä»ç„¶ä¿ç•™å°‘é‡æ¨ªå‘ç§»åŠ¨ï¼Œä½†ä¸»è¦é è¿½å‡»ç§»åŠ¨
                this.x += this.vx * 0.3;
                if (this.vy !== undefined) {
                    this.y += this.vy * 0.3;
                }
            }

            if (this.subtype === 'lightning') this.y += Math.sin(this.x * 0.05) * 5;

            const magnetActive = player.buffs.magnet > 0 || (isFeverMode && currentDifficultyName !== 'hard');
            const canMagnet = (this.type === 'heart' || this.type === 'buff') || (isFeverMode && currentDifficultyName !== 'hard');
            if (magnetActive && canMagnet) {
                let range = 200;
                let magnetSpeed = 0.05;

                if (isFeverMode) {
                    // å®¹æ˜“æ¨¡å¼ï¼šèŒƒå›´300ï¼Œé€Ÿåº¦0.12
                    // æ™®é€šæ¨¡å¼ï¼šèŒƒå›´150ï¼ˆç¼©å°ä¸€åŠï¼‰ï¼Œé€Ÿåº¦0.06ï¼ˆç¼©å°ä¸€åŠï¼‰
                    // å›°éš¾æ¨¡å¼ï¼šä¸å¸å¼•
                    if (currentDifficultyName === 'easy') {
                        range = 300;
                        magnetSpeed = 0.12;
                    } else if (currentDifficultyName === 'normal') {
                        range = 150; // ç¼©å°ä¸€åŠ
                        magnetSpeed = 0.06; // ç¼©å°ä¸€åŠ
                    }
                } else {
                    // æ™®é€šç£é“é“å…·
                    range = 200;
                    magnetSpeed = 0.05;
                }

                const dist = Math.hypot(player.x - this.x, player.y - this.y);
                if (dist < range) {
                    this.x += (player.x - this.x) * magnetSpeed;
                    this.y += (player.y - this.y) * magnetSpeed;
                }
            }
        }
        draw() {
            drawItemArt(ctx, this);
        }
    }

    // é¦–é¡µåŠ¨ç”»å¾ªç¯
    function drawStartBackground() {
        if (gameRunning) return;

        // å¦‚æœèƒŒæ™¯å›¾æœªåŠ è½½ï¼Œè®©canvasåŠé€æ˜ä»¥æ˜¾ç¤ºCSSèƒŒæ™¯
        if (!bgImageLoaded) {
            ctx.globalAlpha = 0.3; // åŠé€æ˜ï¼Œè®©CSSèƒŒæ™¯æ˜¾ç¤º
        } else {
            ctx.globalAlpha = 1.0;
        }

        // å…ˆç»˜åˆ¶èƒŒæ™¯æ¸å˜ï¼Œç¡®ä¿åœ¨iOSä¸Šæ­£ç¡®æ˜¾ç¤º
        const bgGradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
        bgGradient.addColorStop(0, 'rgb(255, 154, 158)');
        bgGradient.addColorStop(1, 'rgb(250, 208, 196)');
        ctx.fillStyle = bgGradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // ç»˜åˆ¶èƒŒæ™¯å›¾ç‰‡ï¼ˆå¦‚æœå·²åŠ è½½ï¼‰
        if (bgImageLoaded && bgImage.complete && bgImage.naturalWidth > 0) {
            ctx.globalAlpha = 1.0; // æ¢å¤å®Œå…¨ä¸é€æ˜
            const scale = Math.max(canvas.width / bgImage.width, canvas.height / bgImage.height);
            const scaledWidth = bgImage.width * scale;
            const scaledHeight = bgImage.height * scale;
            const x = (canvas.width - scaledWidth) / 2;
            const y = (canvas.height - scaledHeight) / 2;
            ctx.drawImage(bgImage, x, y, scaledWidth, scaledHeight);
        }

        // ç»˜åˆ¶é¦–é¡µèƒŒæ™¯é±¼
        ambientFish.forEach(f => { f.update(); f.draw(); });
        ambientBubbles.forEach(b => { b.update(); b.draw(); });

        frameCount++;
        requestAnimationFrame(drawStartBackground);
    }

    function initAmbient() {
        ambientFish = [];
        // å¢åŠ é±¼ç±»æ•°é‡ï¼Œè®©ç”»é¢æ›´ä¸°å¯Œ
        for(let i=0; i<35; i++) ambientFish.push(new AmbientFish());
        ambientBubbles = [];
        for(let i=0; i<40; i++) ambientBubbles.push(new AmbientBubble());
        drawStartBackground();
    }

    // æ ¸å¿ƒé€»è¾‘
    function init(difficultyKey) {
        currentDifficultyName = difficultyKey;
        currentDifficulty = DIFFICULTY_SETTINGS[difficultyKey];
        player = new Player();
        guardian = new Guardian();
        guardian.wasActiveBeforeHunter = false; // é‡ç½®æ ‡è®°
        guardian.isLeaving = false; // é‡ç½®ç¦»å¼€æ ‡è®°
        items = [];
        score = 0;
        feverValue = 0; isFeverMode = false;
        feverBar.style.width = "0%";
        body.classList.remove('fever-mode-bg');
        scoreEl.innerText = score;
        gameTime = 0; // é‡ç½®æ¸¸æˆæ—¶é—´
        sizeEl.innerText = 1; // åˆå§‹ä¸º1å¤©
        frameCount = 0;
        isPaused = false;
        unlockedStages = { 500: false, 1000: false, 2000: false, 3000: false };
        currentEvent = null; nextEventCooldown = 600; eventBanner.style.opacity = 0;
        discoveredRareFish = new Set(); // é‡ç½®ç¨€æœ‰é±¼ç§å‘ç°è®°å½•
        fishSchools = []; // é‡ç½®é±¼ç¾¤
        fishSchoolCooldown = 0; // é‡ç½®é±¼ç¾¤å†·å´
        input.x = canvas.width / 2; input.y = canvas.height / 2;
        updateBuffUI(player.buffs, guardian.active);
        startDesc.innerHTML = START_QUOTES[Math.floor(Math.random() * START_QUOTES.length)];

        // åˆå§‹åŒ–æ¸¸æˆä¸­çš„æ°”æ³¡å’Œå…‰æ–‘
        gameBubbles = [];
        for(let i = 0; i < 25; i++) {
            gameBubbles.push(new GameBubble());
        }
        lightRays = [];
        for(let i = 0; i < 8; i++) {
            lightRays.push(new LightRay());
        }

        // åˆå§‹åŒ–å…¶ä»–æ•ˆæœ
        particles = [];
        screenShake = { x: 0, y: 0, intensity: 0 };
    }

    function gameLoop() {
        try {
            if (!gameRunning) return;
            if (isPaused) return;

            // æ›´æ–°æ¸¸æˆæ—¶é—´ï¼ˆæ¯ç§’60å¸§ï¼Œæ¯å¸§å¢åŠ 1/60ç§’ï¼‰
            gameTime += 1 / 60;
            // æ›´æ–°å¤©æ•°æ˜¾ç¤ºï¼ˆ1åˆ†é’Ÿ=1å¤©ï¼‰
            sizeEl.innerText = Math.floor(gameTime / 60) + 1;

        // æ›´æ–°å±å¹•éœ‡åŠ¨
        if (screenShake.intensity > 0) {
            screenShake.x = (Math.random() - 0.5) * screenShake.intensity;
            screenShake.y = (Math.random() - 0.5) * screenShake.intensity;
            screenShake.intensity *= 0.9;
            if (screenShake.intensity < 0.1) {
                screenShake.intensity = 0;
                screenShake.x = 0;
                screenShake.y = 0;
            }
        }

        ctx.save();
        ctx.translate(screenShake.x, screenShake.y);

        // æ€§èƒ½ä¼˜åŒ–ï¼šä½¿ç”¨ç¼“å­˜çš„èƒŒæ™¯
        const bgCache = generateBackgroundCache();
        if (bgCache) {
            ctx.drawImage(bgCache, 0, 0);
        } else {
            // Fallback: ç›´æ¥ç»˜åˆ¶
            if (!bgImageLoaded) {
                const bgGradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                bgGradient.addColorStop(0, 'rgb(255, 154, 158)');
                bgGradient.addColorStop(1, 'rgb(250, 208, 196)');
                ctx.globalAlpha = 1.0;
                ctx.fillStyle = bgGradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
            if (bgImageLoaded && bgImage.complete && bgImage.naturalWidth > 0) {
                ctx.globalAlpha = 1.0;
                const scale = Math.max(canvas.width / bgImage.width, canvas.height / bgImage.height);
                const scaledWidth = bgImage.width * scale;
                const scaledHeight = bgImage.height * scale;
                const x = (canvas.width - scaledWidth) / 2;
                const y = (canvas.height - scaledHeight) / 2;
                ctx.drawImage(bgImage, x, y, scaledWidth, scaledHeight);
            }
        }

        // æ¢å¤é€æ˜åº¦ï¼Œç¡®ä¿åç»­ç»˜åˆ¶æ­£å¸¸
        ctx.globalAlpha = 1.0;

        // æ€§èƒ½ä¼˜åŒ–ï¼šç”¨forå¾ªç¯æ›¿æ¢forEach
        for (let i = 0; i < lightRays.length; i++) {
            lightRays[i].update();
            lightRays[i].draw();
        }

        // æ€§èƒ½ä¼˜åŒ–ï¼šç”¨forå¾ªç¯æ›¿æ¢forEach
        for (let i = 0; i < gameBubbles.length; i++) {
            gameBubbles[i].update();
            gameBubbles[i].draw();
        }

        // æ›´æ–°å’Œç»˜åˆ¶ç²’å­ï¼ˆä½¿ç”¨å¯¹è±¡æ± å›æ”¶ï¼‰
        for (let i = particles.length - 1; i >= 0; i--) {
            const p = particles[i];
            if (!p.update()) {
                // ç²’å­ç”Ÿå‘½ç»“æŸï¼Œå›æ”¶åˆ°å¯¹è±¡æ± 
                recycleParticle(p);
                particles.splice(i, 1);
            } else {
                p.draw();
            }
        }

        player.update();
        updateBuffUI(player.buffs, guardian.active);
        if (guardian.active) {
            guardian.update(player.x, player.y);
            guardian.draw();

            // å¦‚æœå¼€å¯äº†hunteræ¨¡å¼ï¼Œæ£€æŸ¥èªä»”æ˜¯å¦åƒæ‰äº†å°é±¼
            if (player.buffs && player.buffs.hunter > 0) {
                for (let j = items.length - 1; j >= 0; j--) {
                    let fish = items[j];
                    if (fish.type === 'bad') {
                        // æ”¾å®½æ¡ä»¶ï¼šå¯ä»¥åƒåŠå¾„å°äºèªä»”1.5å€çš„é±¼ï¼Œæˆ–è€…åŠå¾„å°äº30çš„å°é±¼
                        const canEat = fish.radius < guardian.radius * 1.5 || fish.radius < 30;
                        if (canEat) {
                            const dist = Math.hypot(guardian.x - fish.x, guardian.y - fish.y);
                            if (dist < guardian.radius + fish.radius) {
                                // èªä»”åƒæ‰äº†å°é±¼
                                items.splice(j, 1);
                                score += 5;
                                scoreEl.innerText = score;
                                spawnFloatingText("èªä»”å‡ºå‡»!", guardian.x, guardian.y - 30, '#00CED1');
                                if(navigator.vibrate) navigator.vibrate(30);
                            }
                        }
                    }
                }
            }
        }

        // æ€§èƒ½ä¼˜åŒ–ï¼šç”¨forå¾ªç¯æ›¿æ¢forEach
        for (let i = 0; i < fishSchools.length; i++) {
            fishSchools[i].draw();
        }

        player.draw();

        updateEventLogic();

        // é±¼ç¾¤ç³»ç»Ÿï¼šæ›´æ–°å’Œç”Ÿæˆ
        updateFishSchools();

        frameCount++;
        // è®¡ç®—å®é™…ç”Ÿæˆé¢‘ç‡ï¼ˆé—¯å…³æ¨¡å¼å¯èƒ½æœ‰åŠ æˆï¼‰
        let actualSpawnRate = currentDifficulty.spawnRate;
        if (isStageMode) {
            const stage = STAGES.find(s => s.id === currentStage);
            if (stage && stage.heartSpawnBoost) {
                actualSpawnRate = Math.floor(actualSpawnRate / stage.heartSpawnBoost);
            }
        }
        if (frameCount % actualSpawnRate === 0) {
            items.push(new Item(currentDifficulty));
        }

        for (let i = items.length - 1; i >= 0; i--) {
            let item = items[i];
            item.update();
            item.draw();

            // è¾¹ç•Œæ£€æµ‹ï¼šä»å››ä¸ªæ–¹å‘ç¦»å¼€å±å¹•æ—¶ç§»é™¤
            const margin = 200;
            if (item.x < -margin || item.x > canvas.width + margin ||
                item.y < -margin || item.y > canvas.height + margin) {
                // å…³å¡5ï¼šèº²é¿å¤§å¸ˆ - åé±¼ç¦»å¼€å±å¹•æ—¶è®¡ä¸ºæˆåŠŸèº²é¿
                if (isStageMode && item.type === 'bad') {
                    const stage = STAGES.find(s => s.id === currentStage);
                    if (stage && stage.type === 'dodge_obstacles') {
                        stageObstaclesDodged++;
                        updateStageObjective();
                    }
                }
                items.splice(i, 1);
                continue;
            }

            const dist = Math.hypot(player.x - item.x, player.y - item.y);
            if (dist < player.radius + item.radius) {

                if (item.type === 'heart') {
                    items.splice(i, 1);
                    // åŒå€åˆ†æ•°æ•ˆæœ
                    const scoreGain = doubleScoreActive ? item.score * 2 : item.score;
                    addScore(scoreGain);
                    addFever(item.fever || 5);
                    checkGameEvolution();
                    
                    // æ’­æ”¾éŸ³æ•ˆ
                    playSound('collect');
                    
                    // åŒå€æ—¶æ˜¾ç¤ºç‰¹æ®Šæç¤º
                    if (doubleScoreActive) {
                        spawnFloatingText(`+${scoreGain} (x2!)`, item.x, item.y - 50, '#FFD700', 20);
                    }

                    // é—¯å…³æ¨¡å¼ï¼šæ›´æ–°å…³å¡è¿›åº¦
                    if (isStageMode) {
                        const stage = STAGES.find(s => s.id === currentStage);
                        if (stage && (stage.type === 'collect_hearts' || stage.type === 'fog_collect' || 
                                      stage.type === 'current_collect' || stage.type === 'timed_collect')) {
                            stageProgress++;
                            updateStageObjective();
                        }
                    }

                    // è§¦å‘å˜´å·´åŠ¨ç”»
                    player.mouthAnimationTimer = 15;

                    // æ·»åŠ ç²’å­ç‰¹æ•ˆ
                    createParticleExplosion(item.x, item.y, item.color, 12);

                    // === æ ¸å¿ƒä¿®å¤ï¼šéšæœºæŠ½å–ä¸€å¥æƒ…è¯ ===
                    const sweetWord = LOVE_WORDS[Math.floor(Math.random() * LOVE_WORDS.length)];
                    spawnFloatingText(sweetWord, player.x, player.y - 30, item.color);

                    if (item.subtype === 'diamond') { 
                        feverValue = 100; 
                        activateFever();
                        playSound('rare'); // é’»æˆ’ç‰¹æ®ŠéŸ³æ•ˆ
                    }

                    if (player.radius < 60) {
                        // æ ¹æ®ç‰©å“å¤§å°è®¡ç®—æˆé•¿å€¼
                        // åŸºç¡€æˆé•¿ï¼š0.1ï¼Œæ ¹æ®ç‰©å“åŠå¾„å¢åŠ æˆé•¿å€¼
                        // å°ç‰©å“ï¼ˆr < 10ï¼‰ï¼š0.08-0.12
                        // ä¸­ç‰©å“ï¼ˆr 10-20ï¼‰ï¼š0.15-0.25
                        // å¤§ç‰©å“ï¼ˆr 20-30ï¼‰ï¼š0.25-0.4
                        // è¶…å¤§ç‰©å“ï¼ˆr > 30ï¼‰ï¼š0.4-0.6
                        let growth = 0.1;
                        if (item.radius < 10) {
                            growth = 0.08 + (item.radius / 10) * 0.04; // 0.08-0.12
                        } else if (item.radius < 20) {
                            growth = 0.15 + ((item.radius - 10) / 10) * 0.1; // 0.15-0.25
                        } else if (item.radius < 30) {
                            growth = 0.25 + ((item.radius - 20) / 10) * 0.15; // 0.25-0.4
                        } else {
                            growth = 0.4 + Math.min((item.radius - 30) / 30, 1) * 0.2; // 0.4-0.6
                        }

                        // æ ¹æ®åˆ†æ•°ä¹Ÿç»™äºˆé¢å¤–æˆé•¿ï¼ˆå¤§ç¤¼ç‰©ã€å¹¸è¿æ˜Ÿã€é’»æˆ’ç­‰ï¼‰
                        if (item.score >= 500) {
                            growth *= 1.5; // é’»æˆ’ç­‰è¶…é«˜ä»·å€¼ç‰©å“é¢å¤–æˆé•¿
                        } else if (item.score >= 50) {
                            growth *= 1.3; // å¹¸è¿æ˜Ÿç­‰é«˜ä»·å€¼ç‰©å“é¢å¤–æˆé•¿
                        } else if (item.score >= 20) {
                            growth *= 1.1; // å¤§ç¤¼ç‰©ç­‰ä¸­ç­‰ä»·å€¼ç‰©å“é¢å¤–æˆé•¿
                        }

                        player.radius += growth;
                        if (guardian.active) guardian.radius += growth * 0.8; // å®ˆæŠ¤è€…æˆé•¿ç¨æ…¢
                        // å¤©æ•°å·²æ”¹ä¸ºåŸºäºæ¸¸æˆæ—¶é—´ï¼Œä¸å†åŸºäºåŠå¾„
                    }
                }
                else if (item.type === 'buff') {
                    items.splice(i, 1);
                    // è§¦å‘å˜´å·´åŠ¨ç”»
                    player.mouthAnimationTimer = 15;
                    // æ·»åŠ ç²’å­ç‰¹æ•ˆ
                    createParticleExplosion(item.x, item.y, item.color, 15);
                    // æ’­æ”¾bufféŸ³æ•ˆ
                    playSound('buff');
                    if (item.subtype === 'summon') {
                        // æ ¹æ®éš¾åº¦è®¾ç½®ä¸åŒçš„å®ˆæŠ¤æŒç»­æ—¶é—´
                        // ç®€å•æ¨¡å¼ï¼š15ç§’ï¼ˆ900å¸§ï¼‰ï¼Œæ™®é€šæ¨¡å¼ï¼š12ç§’ï¼ˆ720å¸§ï¼‰ï¼Œå›°éš¾æ¨¡å¼ï¼š8ç§’ï¼ˆ480å¸§ï¼‰
                        let guardianDuration = 900;
                        if (currentDifficultyName === 'easy') {
                            guardianDuration = 900; // ç®€å•æ¨¡å¼ï¼š15ç§’
                        } else if (currentDifficultyName === 'normal') {
                            guardianDuration = 720; // æ™®é€šæ¨¡å¼ï¼š12ç§’
                        } else {
                            guardianDuration = 480; // å›°éš¾æ¨¡å¼ï¼š8ç§’
                        }
                        player.buffs.guardian = guardianDuration;

                        if (guardian.active) {
                            spawnFloatingText("èªä»”åœ¨å‘¢!", player.x, player.y - 30, '#00BFFF');
                            // åƒåˆ°æŠ¤èº«ç¬¦åï¼Œæ— è®ºæ˜¯å¦æœ‰hunterï¼Œéƒ½åº”è¯¥ç»§ç»­å®ˆæŠ¤
                            guardian.wasActiveBeforeHunter = true; // æ ‡è®°ä¸ºåŸæœ¬æ¿€æ´»ï¼Œhunterç»“æŸåç»§ç»­å®ˆæŠ¤
                        } else {
                            guardian.active = true;
                            guardian.x = player.x - 50;
                            guardian.y = player.y;
                            // åƒåˆ°æŠ¤èº«ç¬¦åï¼Œæ— è®ºæ˜¯å¦æœ‰hunterï¼Œéƒ½åº”è¯¥ç»§ç»­å®ˆæŠ¤
                            guardian.wasActiveBeforeHunter = true; // æ ‡è®°ä¸ºåŸæœ¬æ¿€æ´»
                            spawnFloatingText("èªä»”å®ˆæŠ¤!", player.x, player.y - 30, '#00BFFF');
                        }
                    } else {
                        spawnFloatingText(item.name + "!", player.x, player.y - 30, item.color);
                        if (item.subtype === 'candy') player.buffs.speed = 300;
                        if (item.subtype === 'magnet') player.buffs.magnet = 400;
                        if (item.subtype === 'hunter') {
                            // è®°å½•åœ¨hunterä¹‹å‰æ˜¯å¦å·²ç»æ¿€æ´»
                            guardian.wasActiveBeforeHunter = guardian.active;

                            // æ ¹æ®éš¾åº¦è®¾ç½®ä¸åŒçš„æŒç»­æ—¶é—´
                            // ç®€å•æ¨¡å¼ï¼š8ç§’ï¼ˆ480å¸§ï¼‰ï¼Œæ™®é€šæ¨¡å¼ï¼š6ç§’ï¼ˆ360å¸§ï¼‰ï¼Œå›°éš¾æ¨¡å¼ï¼š4ç§’ï¼ˆ240å¸§ï¼‰
                            if (currentDifficultyName === 'easy') {
                                player.buffs.hunter = 480;
                            } else if (currentDifficultyName === 'normal') {
                                player.buffs.hunter = 360;
                            } else {
                                player.buffs.hunter = 240; // å›°éš¾æ¨¡å¼ï¼š4ç§’
                            }
                            if (!guardian.active) {
                                guardian.active = true;
                                guardian.x = player.x - 50;
                                guardian.y = player.y;
                            }
                        }
                    }
                }
                else if (item.type === 'bad') {
                    if (isFeverMode) {
                        items.splice(i, 1);
                        // è§¦å‘å˜´å·´åŠ¨ç”»
                        player.mouthAnimationTimer = 15;
                        
                        // æ”¶é›†é±¼ç±»åˆ°å›¾é‰´
                        if (item.collectionId !== null && item.collectionId !== undefined) {
                            collectFish(item.collectionId);
                        }

                        // æ£€æŸ¥æ˜¯å¦æ˜¯ç¨€æœ‰é±¼ç§
                        if (item.isRare) {
                            const bonusScore = item.rareBonusScore || 30;
                            const bonusFever = item.rareBonusFever || 10;
                            const bonusGrowth = item.rareBonusGrowth || 0.3;

                            score += 10 + bonusScore; // åŸºç¡€ 10åˆ† + ç¨€æœ‰å¥–åŠ±
                            scoreEl.innerText = score;
                            addFever(bonusFever);
                            
                            // ç¨€æœ‰é±¼ç‰¹æ®ŠéŸ³æ•ˆ
                            playSound('rare');

                            spawnFloatingText("âœ¨ " + item.name + " âœ¨", player.x, player.y - 30, item.color, 24);
                            spawnFloatingText("+ " + bonusScore + " åˆ†!", player.x, player.y - 50, '#FFD700', 20);

                            createParticleExplosion(item.x, item.y, item.color, 30);
                            createParticleExplosion(item.x, item.y, '#FFD700', 20);

                            if (player.radius < 60) {
                                let growth = 0.1;
                                if (item.radius < 10) {
                                    growth = 0.08 + (item.radius / 10) * 0.04;
                                } else if (item.radius < 20) {
                                    growth = 0.15 + ((item.radius - 10) / 10) * 0.1;
                                } else if (item.radius < 30) {
                                    growth = 0.25 + ((item.radius - 20) / 10) * 0.15;
                                } else {
                                    growth = 0.4 + Math.min((item.radius - 30) / 30, 1) * 0.2;
                                }

                                player.radius += growth + bonusGrowth; // åŸºç¡€æˆé•¿ + ç¨€æœ‰å¥–åŠ±æˆé•¿
                                if (guardian.active) guardian.radius += (growth + bonusGrowth) * 0.8;
                                // å¤©æ•°å·²æ”¹ä¸ºåŸºäºæ¸¸æˆæ—¶é—´ï¼Œä¸å†åŸºäºåŠå¾„
                            }

                            if(navigator.vibrate) navigator.vibrate([50, 30, 50, 30, 100]);
                        } else {
                            spawnFloatingText("ç²‰ç¢éšœç¢!", player.x, player.y - 30, '#FF1493', 24);
                            addScore(10);
                            playSound('defeat'); // æ‰“è´¥éšœç¢éŸ³æ•ˆ
                            if(navigator.vibrate) navigator.vibrate(50);

                            // æ— æ•Œæ¨¡å¼ä¸‹åƒåé±¼ä¹Ÿæœ‰æˆé•¿
                            if (player.radius < 60) {
                                // æ ¹æ®åé±¼å¤§å°è®¡ç®—æˆé•¿å€¼
                                let growth = 0.1;
                                if (item.radius < 10) {
                                    growth = 0.08 + (item.radius / 10) * 0.04; // 0.08-0.12
                                } else if (item.radius < 20) {
                                    growth = 0.15 + ((item.radius - 10) / 10) * 0.1; // 0.15-0.25
                                } else if (item.radius < 30) {
                                    growth = 0.25 + ((item.radius - 20) / 10) * 0.15; // 0.25-0.4
                                } else {
                                    growth = 0.4 + Math.min((item.radius - 30) / 30, 1) * 0.2; // 0.4-0.6
                                }

                                // æ— æ•Œæ¨¡å¼ä¸‹åƒåé±¼æˆé•¿å’Œåƒçˆ±å¿ƒä¸€æ ·
                                player.radius += growth;
                                if (guardian.active) guardian.radius += growth * 0.8;
                                // å¤©æ•°å·²æ”¹ä¸ºåŸºäºæ¸¸æˆæ—¶é—´ï¼Œä¸å†åŸºäºåŠå¾„
                            }
                        }
                    }
                    else if (item.subtype === 'ice') {
                        items.splice(i, 1);
                        spawnFloatingText("å†»ç»“! å‡é€Ÿ!", player.x, player.y - 30, '#00BCD4');
                        player.buffs.slowed = 180;
                        player.buffs.speed = 0;
                    }
                    else {
                        if (player.radius > item.radius) {
                            items.splice(i, 1);
                            // è§¦å‘å˜´å·´åŠ¨ç”»
                            player.mouthAnimationTimer = 15;
                            
                            // æ”¶é›†é±¼ç±»åˆ°å›¾é‰´
                            if (item.collectionId !== null && item.collectionId !== undefined) {
                                collectFish(item.collectionId);
                            }

                            // æ£€æŸ¥æ˜¯å¦æ˜¯ç¨€æœ‰é±¼ç§
                            if (item.isRare) {
                                // ç¨€æœ‰é±¼ç§é¢å¤–å¥–åŠ±
                                const bonusScore = item.rareBonusScore || 30;
                                const bonusFever = item.rareBonusFever || 10;
                                const bonusGrowth = item.rareBonusGrowth || 0.3;

                                addScore(5 + bonusScore); // åŸºç¡€5åˆ† + ç¨€æœ‰å¥–åŠ±
                                addFever(bonusFever);

                                spawnFloatingText("âœ¨ " + item.name + " âœ¨", player.x, player.y - 30, item.color, 24);
                                spawnFloatingText("+ " + bonusScore + " åˆ†!", player.x, player.y - 50, '#FFD700', 20);

                                // å¤§é‡ç²’å­ç‰¹æ•ˆ
                                createParticleExplosion(item.x, item.y, item.color, 30);
                                createParticleExplosion(item.x, item.y, '#FFD700', 20);

                                // é¢å¤–æˆé•¿
                                if (player.radius < 60) {
                                    player.radius += bonusGrowth;
                                    if (guardian.active) guardian.radius += bonusGrowth * 0.8;
                                    // å¤©æ•°å·²æ”¹ä¸ºåŸºäºæ¸¸æˆæ—¶é—´ï¼Œä¸å†åŸºäºåŠå¾„
                                }

                                if(navigator.vibrate) navigator.vibrate([50, 30, 50, 30, 100]);
                            } else {
                                spawnFloatingText("æ‰“è´¥" + item.name + "!", player.x, player.y - 30);
                                addScore(5);

                                // æ·»åŠ ç²’å­ç‰¹æ•ˆ
                                createParticleExplosion(item.x, item.y, item.color, 10);

                                // åƒåé±¼ä¹Ÿæœ‰æˆé•¿ï¼Œä½†æ¯”åƒçˆ±å¿ƒæˆé•¿å°‘ä¸€äº›
                                if (player.radius < 60) {
                                    // æ ¹æ®åé±¼å¤§å°è®¡ç®—æˆé•¿å€¼ï¼ˆæ¯”çˆ±å¿ƒæˆé•¿å°‘30%ï¼‰
                                    let growth = 0.1;
                                    if (item.radius < 10) {
                                        growth = 0.06 + (item.radius / 10) * 0.03; // 0.06-0.09
                                    } else if (item.radius < 20) {
                                        growth = 0.10 + ((item.radius - 10) / 10) * 0.07; // 0.10-0.17
                                    } else if (item.radius < 30) {
                                        growth = 0.17 + ((item.radius - 20) / 10) * 0.10; // 0.17-0.27
                                    } else {
                                        growth = 0.27 + Math.min((item.radius - 30) / 30, 1) * 0.15; // 0.27-0.42
                                    }

                                    // åé±¼æˆé•¿æ¯”çˆ±å¿ƒå°‘30%
                                    growth *= 0.7;

                                    player.radius += growth;
                                    if (guardian.active) guardian.radius += growth * 0.8;
                                    // å¤©æ•°å·²æ”¹ä¸ºåŸºäºæ¸¸æˆæ—¶é—´ï¼Œä¸å†åŸºäºåŠå¾„
                                }
                            }
                        } else {
                            if (guardian.active) {
                                items.splice(i, 1);
                                // å¦‚æœhunteræ¨¡å¼æ¿€æ´»ï¼Œèªä»”ä¸ºäº†ä¿æŠ¤ç²‰é±¼è€Œæ¶ˆå¤±
                                if (player.buffs.hunter > 0) {
                                    spawnFloatingText("èªä»”å®ˆæŠ¤!", player.x, player.y - 40, '#ff4444');
                                    player.buffs.hunter = 0; // æ¸…é™¤hunter buff
                                } else {
                                    spawnFloatingText("èªä»”æŒ¡åˆ€!", player.x, player.y - 40, '#ff4444');
                                }
                                guardian.active = false;
                                guardian.wasActiveBeforeHunter = false;
                                if(navigator.vibrate) navigator.vibrate(200);
                                // æ·»åŠ å±å¹•éœ‡åŠ¨
                                screenShake.intensity = 15;
                                // æ·»åŠ ç²’å­ç‰¹æ•ˆ
                                createParticleExplosion(player.x, player.y, '#ff4444', 20);
                            } else {
                                // æ·»åŠ å±å¹•éœ‡åŠ¨
                                screenShake.intensity = 20;
                                // æ·»åŠ ç²’å­ç‰¹æ•ˆ
                                createParticleExplosion(player.x, player.y, '#ff0000', 25);
                                // æ’­æ”¾å—ä¼¤éŸ³æ•ˆ
                                playSound('damage');
                                deathReasonEl.innerText = `è¢«"${item.name}"ç»Šå€’äº†...`;
                                endGame();
                            }
                        }
                    }
                }
            }
        }

        if (currentEvent === 'fog') {
            // è®¡ç®—åŸºç¡€å¯è§èŒƒå›´
            let fogR = currentDifficulty.fogRadius || 100;
            if (!guardian.active || guardian.isLeaving) {
                fogR = fogR * 0.4; // æ²¡æœ‰å®ˆæŠ¤è€…æ—¶èƒ½è§åº¦è¿›ä¸€æ­¥ç¼©å‡åˆ°40%
            } else {
                fogR = fogR * 0.6; // æœ‰å®ˆæŠ¤è€…æ—¶èƒ½è§åº¦å¢åŠ åˆ°60%
            }
            fogR = Math.max(10, fogR); // æœ€å°å¯è§èŒƒå›´

            // ç»˜åˆ¶ä»¥ç©å®¶ä¸ºä¸­å¿ƒçš„è¿·é›¾ï¼ˆä»é€æ˜åˆ°é»‘æš—ï¼‰
            const grad = ctx.createRadialGradient(player.x, player.y, fogR, player.x, player.y, Math.max(canvas.width, canvas.height)/2);
            grad.addColorStop(0, "rgba(0,0,0,0)");
            grad.addColorStop(0.2, "rgba(0,0,0,0.5)");
            grad.addColorStop(0.5, "rgba(0,0,0,0.85)");
            grad.addColorStop(1, "rgba(0,0,0,0.99)");
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        if (currentEvent === 'current') {
            ctx.save();
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.15)'; ctx.lineWidth = 2; ctx.beginPath();
            // æ€§èƒ½ä¼˜åŒ–ï¼šç”¨forå¾ªç¯æ›¿æ¢forEach
            for (let i = 0; i < flowParticles.length; i++) {
                const p = flowParticles[i];
                p.x += currentForce.x * 2; p.y += currentForce.y * 2;
                if(p.x > canvas.width) p.x = 0; else if(p.x < 0) p.x = canvas.width;
                if(p.y > canvas.height) p.y = 0; else if(p.y < 0) p.y = canvas.height;
                ctx.moveTo(p.x, p.y); ctx.lineTo(p.x - currentForce.x * 2, p.y - currentForce.y * 2);
            }
            ctx.stroke(); ctx.restore();
        }

        ctx.restore(); // ç»“æŸå±å¹•éœ‡åŠ¨å˜æ¢

        // é—¯å…³æ¨¡å¼ï¼šæ›´æ–°ç”Ÿå­˜å…³å¡è¿›åº¦
        if (isStageMode) {
            const stage = STAGES.find(s => s.id === currentStage);
            if (stage && stage.type === 'survive') {
                updateStageObjective();
            }
        }

            animationId = requestAnimationFrame(gameLoop);
        } catch(e) {
            console.error('æ¸¸æˆå¾ªç¯å‡ºé”™:', e);
            // é”™è¯¯æ—¶å°è¯•ç»§ç»­è¿è¡Œï¼Œé¿å…æ¸¸æˆå®Œå…¨å´©æºƒ
            if (gameRunning && !isPaused) {
                animationId = requestAnimationFrame(gameLoop);
            }
        }
    }

    function startGame(difficulty) {
        isStageMode = false;
        hasShownSurpassedHint = false; // é‡ç½®è¶…è¶Šæœ€é«˜åˆ†æç¤ºçŠ¶æ€
        startScreen.style.display = 'none'; gameOverScreen.style.display = 'none'; pauseScreen.style.display = 'none';
        if (stageSelectScreen) stageSelectScreen.style.display = 'none';
        if (stageCompleteScreen) stageCompleteScreen.style.display = 'none';
        if (stageObjectiveDisplay) stageObjectiveDisplay.style.display = 'none';
        collectionScreen.style.display = 'none';
        collectionBtnMenu.style.display = 'none';
        document.getElementById('leaderboard-btn-menu').style.display = 'none';
        document.getElementById('skin-btn-menu').style.display = 'none';
        uiLayer.style.display = 'block';
        pauseBtn.style.display = 'flex';
        collectionBtn.style.display = 'flex';
        init(difficulty); gameRunning = true;
        
        // åˆå§‹åŒ–æœ€é«˜åˆ†æç¤º
        updateHighScoreHint();
        
        gameLoop();
    }

    // ========== é—¯å…³æ¨¡å¼å‡½æ•° ==========

    function showStageSelect() {
        startScreen.style.display = 'none';
        collectionBtnMenu.style.display = 'none';
        document.getElementById('leaderboard-btn-menu').style.display = 'none';
        document.getElementById('skin-btn-menu').style.display = 'none';
        if (!stageSelectScreen) {
            stageSelectScreen = document.getElementById('stage-select-screen');
        }
        stageSelectScreen.style.display = 'flex';
        // é‡ç½®æ»šåŠ¨ä½ç½®åˆ°é¡¶éƒ¨
        stageSelectScreen.scrollTop = 0;
        renderStageGrid();
    }

    function renderStageGrid() {
        const grid = document.getElementById('stage-grid');
        if (!grid) {
            console.error('å…³å¡ç½‘æ ¼å…ƒç´ æœªæ‰¾åˆ°');
            return;
        }
        
        grid.innerHTML = '';
        
        STAGES.forEach((stage, index) => {
            const isUnlocked = index === 0 || (stageProgress_data[STAGES[index - 1].id]?.completed === true);
            const isCompleted = stageProgress_data[stage.id]?.completed === true;
            
            const card = document.createElement('div');
            card.className = 'stage-card';
            if (!isUnlocked) card.classList.add('locked');
            if (isCompleted) card.classList.add('completed');
            
            const statusIcon = isCompleted ? 'âœ…' : (isUnlocked ? 'ğŸ”“' : 'ğŸ”’');
            
            // æ„å»ºå¡ç‰‡HTML
            let cardHTML = `
                <div class="stage-status">${statusIcon}</div>
                <div class="stage-number">å…³å¡ ${stage.id}</div>
                <div class="stage-name">${stage.icon} ${stage.name}</div>
                <div class="stage-desc">${stage.desc}</div>
                <div class="stage-objective">ğŸ¯ ${stage.objectiveText}: ${stage.target}${stage.type === 'survive' ? 'ç§’' : ''}</div>
            `;
            
            // å¦‚æœå·²å®Œæˆï¼Œæ˜¾ç¤ºæœ€ä½³æˆç»©
            if (isCompleted && stageProgress_data[stage.id]) {
                const best = stageProgress_data[stage.id];
                const rating = 'â­'.repeat(best.rating || 3);
                cardHTML += `
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.3); font-size: 12px;">
                        <div>${rating}</div>
                        <div style="opacity: 0.9; margin-top: 4px;">ğŸ† æœ€ä½³: ${best.score}åˆ† | â±ï¸ ${best.timeUsed || '?'}ç§’</div>
                    </div>
                `;
            }
            
            card.innerHTML = cardHTML;
            
            if (isUnlocked) {
                card.onclick = () => startStage(stage.id);
            }
            
            grid.appendChild(card);
        });
    }

    function startStage(stageId) {
        const stage = STAGES.find(s => s.id === stageId);
        if (!stage) return;
        
        isStageMode = true;
        currentStage = stageId;
        stageProgress = 0;
        stageObstaclesDodged = 0;
        stageSurviveStartTime = 0;
        stageStartTime = Date.now();
        stageTimeLimit = stage.timeLimit || 0;
        
        // éšè—å…³å¡é€‰æ‹©ç•Œé¢
        if (stageSelectScreen) stageSelectScreen.style.display = 'none';
        startScreen.style.display = 'none';
        gameOverScreen.style.display = 'none';
        if (stageCompleteScreen) stageCompleteScreen.style.display = 'none';
        
        // æ˜¾ç¤ºæ¸¸æˆUI
        uiLayer.style.display = 'block';
        pauseBtn.style.display = 'flex';
        collectionBtn.style.display = 'flex';
        if (stageObjectiveDisplay) stageObjectiveDisplay.style.display = 'block';
        // æ˜¾ç¤ºå…³å¡ç›®æ ‡
        if (!stageObjectiveDisplay) {
            stageObjectiveDisplay = document.getElementById('stage-objective-display');
            stageObjectiveProgress = document.getElementById('objective-progress');
        }
        stageObjectiveDisplay.style.display = 'block';
        updateStageObjective();
        
        // åˆå§‹åŒ–æ¸¸æˆ
        init(stage.difficulty);
        
        // ç‰¹æ®Šå…³å¡è®¾ç½®
        if (stage.type === 'fog_collect') {
            // å¼ºåˆ¶è¿›å…¥è¿·é›¾äº‹ä»¶
            triggerEvent('fog');
        } else if (stage.type === 'current_collect') {
            // å¼ºåˆ¶è¿›å…¥æ¿€æµäº‹ä»¶
            triggerEvent('current');
        } else if (stage.type === 'survive') {
            stageSurviveStartTime = Date.now();
        }
        
        gameRunning = true;
        gameLoop();
    }

    function updateStageObjective() {
        if (!isStageMode || !stageObjectiveProgress) return;
        
        const stage = STAGES.find(s => s.id === currentStage);
        if (!stage) return;
        
        let current = 0;
        
        // é™æ—¶å…³å¡ï¼šæ£€æŸ¥å€’è®¡æ—¶
        if (stageTimeLimit > 0) {
            const elapsed = Math.floor((Date.now() - stageStartTime) / 1000);
            const remaining = stageTimeLimit - elapsed;
            
            if (remaining <= 0) {
                // æ—¶é—´åˆ°ï¼Œæ£€æŸ¥æ˜¯å¦è¾¾æ ‡
                if (stageProgress >= stage.target) {
                    completeStage();
                } else {
                    deathReasonEl.innerText = `æ—¶é—´åˆ°ï¼åªæ”¶é›†äº† ${stageProgress}/${stage.target} çˆ±å¿ƒ`;
                    endGame();
                }
                return;
            }
            
            // æ˜¾ç¤ºå€’è®¡æ—¶
            stageObjectiveProgress.textContent = `${stageProgress}/${stage.target} (å‰©ä½™${remaining}ç§’)`;
        } else if (stage.type === 'collect_hearts' || stage.type === 'fog_collect' || 
                   stage.type === 'current_collect' || stage.type === 'timed_collect') {
            current = stageProgress;
            stageObjectiveProgress.textContent = `${current} / ${stage.target}`;
        } else if (stage.type === 'survive') {
            current = Math.floor((Date.now() - stageSurviveStartTime) / 1000);
            stageObjectiveProgress.textContent = `${current} / ${stage.target}`;
        } else if (stage.type === 'dodge_obstacles') {
            current = stageObstaclesDodged;
            stageObjectiveProgress.textContent = `${current} / ${stage.target}`;
        }
        
        // æ£€æŸ¥æ˜¯å¦å®Œæˆï¼ˆé™¤äº†é™æ—¶å…³å¡ï¼‰
        if (!stageTimeLimit && current >= stage.target) {
            completeStage();
        } else if (stageTimeLimit && stageProgress >= stage.target) {
            completeStage();
        }
    }

    function completeStage() {
        if (!isStageMode) return;
        
        const stage = STAGES.find(s => s.id === currentStage);
        if (!stage) return;
        
        gameRunning = false;
        cancelAnimationFrame(animationId);
        
        // è®¡ç®—ç”¨æ—¶
        const timeUsed = Math.floor((Date.now() - stageStartTime) / 1000);
        
        // è®¡ç®—è¯„çº§ï¼ˆæ ¹æ®ç”¨æ—¶å’Œåˆ†æ•°ï¼‰
        let rating = 3; // é»˜è®¤3æ˜Ÿ
        
        // åŸºäºå…³å¡ç±»å‹è¯„åˆ†
        if (stage.type === 'survive') {
            // ç”Ÿå­˜å…³å¡ï¼šåŸºäºåˆ†æ•°
            if (score >= stage.target * 3) rating = 3;
            else if (score >= stage.target * 2) rating = 2;
            else rating = 1;
        } else if (stage.type === 'timed_collect') {
            // é™æ—¶å…³å¡ï¼šåŸºäºå®Œæˆåº¦
            const completion = stageProgress / stage.target;
            if (completion >= 1.5) rating = 3;
            else if (completion >= 1.2) rating = 2;
            else rating = 1;
        } else {
            // æ™®é€šå…³å¡ï¼šåŸºäºç”¨æ—¶
            const avgTime = stage.target * 2; // å‡è®¾å¹³å‡æ¯ä¸ªç›®æ ‡èŠ±2ç§’
            if (timeUsed <= avgTime * 0.7) rating = 3;
            else if (timeUsed <= avgTime * 1.2) rating = 2;
            else rating = 1;
        }
        
        // ä¿å­˜å…³å¡è¿›åº¦ï¼ˆåŒ…æ‹¬ç”¨æ—¶å’Œè¯„çº§ï¼‰
        const currentBest = stageProgress_data[stage.id];
        const shouldUpdate = !currentBest || 
                             score > (currentBest.score || 0) ||
                             (score === currentBest.score && timeUsed < (currentBest.timeUsed || Infinity));
        
        if (shouldUpdate) {
            stageProgress_data[stage.id] = {
                completed: true,
                score: score,
                timeUsed: timeUsed,
                rating: rating,
                date: new Date().toISOString()
            };
            const saved = safeLocalStorageSet('love_game_stage_progress', JSON.stringify(stageProgress_data));
            if (!saved) {
                console.warn('ä¿å­˜å…³å¡è¿›åº¦å¤±è´¥ï¼Œå¯èƒ½æ˜¯å­˜å‚¨ç©ºé—´å·²æ»¡');
            }
        }
        
        // éšè—UI
        uiLayer.style.display = 'none';
        pauseBtn.style.display = 'none';
        if (stageObjectiveDisplay) stageObjectiveDisplay.style.display = 'none';
        
        // æ˜¾ç¤ºå®Œæˆç•Œé¢
        if (!stageCompleteScreen) {
            stageCompleteScreen = document.getElementById('stage-complete-screen');
        }
        stageCompleteScreen.style.display = 'flex';
        
        document.getElementById('stage-complete-message').textContent = stage.completeMessage;
        document.getElementById('stage-final-score').textContent = score;
        document.getElementById('stage-time-used').textContent = timeUsed + 'ç§’';
        
        // æ˜¾ç¤ºè¯„çº§
        const ratingEl = document.getElementById('stage-rating');
        ratingEl.textContent = 'â­'.repeat(rating);
        
        // æ£€æŸ¥æ˜¯å¦æœ‰ä¸‹ä¸€å…³
        const nextStageBtn = document.getElementById('next-stage-btn');
        if (currentStage < STAGES.length) {
            nextStageBtn.style.display = 'block';
        } else {
            nextStageBtn.style.display = 'none';
        }
    }

    function nextStage() {
        if (currentStage < STAGES.length) {
            startStage(currentStage + 1);
        }
    }
    // ========== å›¾é‰´åŠŸèƒ½ ==========
    
    // åŠ è½½å›¾é‰´æ•°æ®
    function loadCollectionData() {
        try {
            const saved = safeLocalStorageGet('love_game_fish_collection');
            if (saved) {
                const data = JSON.parse(saved);
                collectedFish = new Set(data);
                console.log('å›¾é‰´æ•°æ®åŠ è½½æˆåŠŸ, å·²æ”¶é›†', collectedFish.size, 'ç§é±¼ç±»');
            } else {
                collectedFish = new Set();
                console.log('æœªå‘ç°å­˜å‚¨çš„å›¾é‰´æ•°æ®, åˆå§‹åŒ–ç©ºå›¾é‰´');
            }
        } catch (e) {
            console.error('åŠ è½½å›¾é‰´æ•°æ®å¤±è´¥:', e);
            collectedFish = new Set();
        }
    }
    
    // ä¿å­˜å›¾é‰´æ•°æ®
    function saveCollectionData() {
        try {
            const data = Array.from(collectedFish);
            const jsonData = JSON.stringify(data);
            const success = safeLocalStorageSet('love_game_fish_collection', jsonData);
            if (success) {
                lastSaveTime = new Date();
                console.log('å›¾é‰´æ•°æ®ä¿å­˜æˆåŠŸ, å½“å‰å·²æ”¶é›†', collectedFish.size, 'ç§é±¼ç±»');
            } else {
                console.warn('å›¾é‰´æ•°æ®ä¿å­˜å¤±è´¥, å¯èƒ½æ˜¯localStorageç©ºé—´ä¸è¶³');
                // æ£€æŸ¥å­˜å‚¨ç©ºé—´
                const spaceInfo = checkLocalStorageSpace();
                console.log('localStorageå·²ä½¿ç”¨:', spaceInfo.used, 'KB');
            }
            return success;
        } catch (e) {
            console.error('ä¿å­˜å›¾é‰´æ•°æ®å¤±è´¥:', e);
            return false;
        }
    }
    
    // æ”¶é›†é±¼ç±»ï¼ˆè®°å½•é±¼çš„IDï¼‰
    function collectFish(fishId) {
        if (fishId === undefined || fishId === null) {
            console.warn('æ— æ•ˆçš„é±¼ç±»ID:', fishId);
            return;
        }
        
        const fishIdStr = String(fishId);
        if (!collectedFish.has(fishIdStr)) {
            collectedFish.add(fishIdStr);
            const success = saveCollectionData();
            
            // æ˜¾ç¤ºæ”¶é›†æç¤º
            if (success) {
                const fishInfo = FISH_COLLECTION.find(f => f.id === fishId);
                if (fishInfo) {
                    console.log('âœ¨ æ–°é±¼ç±»æ”¶é›†:', fishInfo.name);
                }
            }
        }
    }
    
    // ç­›é€‰é±¼ç±»
    function filterFish(type) {
        currentFilter = type;
        
        // æ›´æ–°æ ‡ç­¾æŒ‰é’®çŠ¶æ€
        const tabs = document.querySelectorAll('.tab-btn');
        tabs.forEach(tab => tab.classList.remove('active'));
        event.target.classList.add('active');
        
        renderCollection();
    }
    
    // æ ¹æ®å¤§å°åˆ†ç±»é±¼
    function getFishCategory(radius) {
        if (radius < 15) return 'small';
        if (radius < 30) return 'medium';
        if (radius < 50) return 'large';
        return 'huge';
    }
    
    // æ¸²æŸ“å›¾é‰´
    function renderCollection() {
        fishGrid.innerHTML = '';
        
        // æ ¹æ®å½“å‰ç­›é€‰æ¡ä»¶è¿‡æ»¤é±¼ç±»
        let filteredFish = FISH_COLLECTION;
        if (currentFilter !== 'all') {
            filteredFish = FISH_COLLECTION.filter(fish => {
                if (currentFilter === 'rare') {
                    return fish.isRare === true;
                } else {
                    return !fish.isRare && getFishCategory(fish.radius) === currentFilter;
                }
            });
        }
        
        const collected = collectedFish.size;
        const total = FISH_COLLECTION.length;
        const filteredCollected = filteredFish.filter(f => collectedFish.has(String(f.id))).length;
        
        // æ˜¾ç¤ºå½“å‰ç­›é€‰çš„æ”¶é›†è¿›åº¦
        if (currentFilter === 'all') {
            collectionProgress.textContent = `${collected} / ${total}`;
        } else {
            collectionProgress.textContent = `${filteredCollected} / ${filteredFish.length} (æ€»: ${collected} / ${total})`;
        }
        
        filteredFish.forEach(fish => {
            const isCollected = collectedFish.has(String(fish.id));
            
            const fishItem = document.createElement('div');
            fishItem.className = 'fish-item';
            if (!isCollected) fishItem.classList.add('locked');
            
            // åˆ›å»ºç”»å¸ƒæ¥ç»˜åˆ¶é±¼ç±»
            const fishCanvas = document.createElement('canvas');
            fishCanvas.className = 'fish-canvas';
            fishCanvas.width = 60;
            fishCanvas.height = 60;
            
            const fishCtx = fishCanvas.getContext('2d');
            
            // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ï¼Œè®©é±¼å®Œæ•´æ˜¾ç¤ºåœ¨ç”»å¸ƒä¸­
            // é±¼çš„å®é™…æ˜¾ç¤ºåŒºåŸŸåŒ…æ‹¬å°¾å·´ã€èº«ä½“ã€é±¼é¢›ï¼Œå¤§çº¦æ˜¯åŠå¾„çš„4å€
            const maxSize = 25; // æœ€å¤§æ˜¾ç¤ºå¤§å°ï¼ˆè€ƒè™‘å°¾å·´ç­‰ï¼‰
            const fishTotalSize = fish.radius * 3.5; // é±¼çš„æ€»å®½åº¦ï¼ˆåŒ…æ‹¬å°¾å·´ï¼‰
            const scale = Math.min(1, maxSize / fishTotalSize);
            const displayRadius = fish.radius * scale;
            
            if (isCollected) {
                // å·²è§£é”ï¼šç»˜åˆ¶å½©è‰²é±¼ç±»
                fishCtx.save();
                fishCtx.translate(30, 30);
                drawFishArt(fishCtx, 0, 0, displayRadius, fish.color, 0, 0, fish.subtype);
                fishCtx.restore();
            } else {
                // æœªè§£é”ï¼šç»˜åˆ¶ç°è‰²å‰ªå½±
                fishCtx.save();
                fishCtx.translate(30, 30);
                fishCtx.globalAlpha = 0.3;
                drawFishArt(fishCtx, 0, 0, displayRadius, '#999999', 0, 0, fish.subtype);
                fishCtx.restore();
            }
            
            const fishName = document.createElement('div');
            fishName.className = 'fish-name';
            fishName.textContent = isCollected ? fish.name : '???';
            
            fishItem.appendChild(fishCanvas);
            fishItem.appendChild(fishName);
            
            // å·²æ”¶é›†çš„é±¼å¯ä»¥ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…
            if (isCollected) {
                fishItem.addEventListener('click', () => {
                    showFishDetail(fish);
                });
            }
            
            fishGrid.appendChild(fishItem);
        });
    }
    
    // ç”Ÿæˆé±¼ç±»ä»‹ç»
    function getFishDescription(fish) {
        const name = fish.name;
        
        // ç¨€æœ‰é±¼ç‰¹æ®Šä»‹ç»
        if (fish.isRare) {
            const rareDescs = {
                'âœ¨ é»„é‡‘å°é±¼': 'å¹¸è¿æ€»ä¼šå…‰é¡¾ç›¸ä¿¡å¥‡è¿¹çš„äººã€‚',
                'ğŸ’ é’»çŸ³çƒ­å¸¦é±¼': 'çœŸçˆ±åƒé’»çŸ³ï¼Œç»è¿‡æ‰“ç£¨æ‰æ›´è€€çœ¼ã€‚',
                'ğŸŒŸ æ˜Ÿå…‰å°ä¸‘é±¼': 'æ¯ä¸ªäººéƒ½æ˜¯å½¼æ­¤ç”Ÿå‘½ä¸­çš„æ˜Ÿå…‰ã€‚',
                'ğŸ’« å¤©ä½¿é‡‘é±¼': 'å®ˆæŠ¤ä½ çš„äººï¼Œå°±åƒå¤©ä½¿åœ¨èº«è¾¹ã€‚',
                'ğŸŒŠ è“å®çŸ³æµ·è±š': 'çœŸå¿ƒçè´µï¼Œåƒæµ·ä¸€æ ·æ·±æ²‰ã€‚',
                'ğŸ’– ç²‰é’»æµ·é©¬': 'æ¸©æŸ”æ˜¯æœ€å¼ºå¤§çš„åŠ›é‡ã€‚',
                'ğŸ”® ç´«æ™¶æ°´æ¯': 'åŒ…å®¹å½¼æ­¤ï¼Œåƒæ°´ä¸€æ ·æµåŠ¨ã€‚',
                'âš¡ é›·å…‰çŸ³æ–‘': 'çˆ±æ˜¯ç”µå…‰ç«çŸ³ï¼Œç„¦ç°ä¹Ÿæ˜¯ç¾å¥½ã€‚'
            };
            return rareDescs[name] || 'çè´µçš„ç›¸é‡ï¼Œå€¼å¾—çæƒœã€‚';
        }
        
        // ç²¾ç¡®åŒ¹é…æ¯ç§é±¼çš„ä»‹ç»
        const descriptions = {
            'çç¢': 'ç”Ÿæ´»é‡Œçš„å°çç¢ï¼Œä¸€ç¬‘è€Œè¿‡å°±å¥½ã€‚',
            'å°æ‘©æ“¦': 'å°æ‘©æ“¦æ˜¯è°ƒå‘³å‰‚ï¼Œè®©æ„Ÿæƒ…æ›´çœŸå®ã€‚',
            'å°å›°æ‰°': 'å›°æ‰°ä¼šæ¶ˆæ•£ï¼Œé™ªä¼´å´é•¿ä¹…ã€‚',
            'å°éº»çƒ¦': 'å°éº»çƒ¦ä¸ç®—ä»€ä¹ˆï¼Œæœ‰ä½ å°±å¤Ÿäº†ã€‚',
            'å°æ³¢æŠ˜': 'æ³¢æŠ˜è®©æˆ‘ä»¬å­¦ä¼šçæƒœå¹³æ·¡ã€‚',
            'å°æ’æ›²': 'æ¯ä¸ªæ’æ›²éƒ½æ˜¯çˆ±çš„æ³¨è„šã€‚',
            'å°çƒ¦æ¼': 'çƒ¦æ¼ä¸è¿‡äº‘çƒŸï¼Œä½ æ‰æ˜¯å½’å®¿ã€‚',
            'å°å±é™©': 'æœ‰ä½ åœ¨ï¼Œå†å°çš„å±é™©ä¹Ÿèƒ½åŒ–è§£ã€‚',
            'åæƒ…ç»ª': 'åæƒ…ç»ªä¼šè¿‡å»ï¼Œå¥½å¿ƒæƒ…ä¼šå›æ¥ã€‚',
            'ä¸­ç­‰å›°æ‰°': 'å›°æ‰°ä¸ç®—å¤§ï¼Œä¸€èµ·é¢å¯¹å°±å¥½ã€‚',
            'ä¸­ç­‰æ³¢æŠ˜': 'æ³¢æŠ˜æ˜¯æˆé•¿çš„é˜¶æ¢¯ã€‚',
            'ä¸­ç­‰éº»çƒ¦': 'éº»çƒ¦è™½å¤šï¼Œä½†çˆ±æ›´å¤šã€‚',
            'ä¸­ç­‰æ’æ›²': 'æ’æ›²ä¸°å¯Œäº†æˆ‘ä»¬çš„æ•…äº‹ã€‚',
            'ä¸­ç­‰å‹åŠ›': 'å‹åŠ›æ˜¯æš‚æ—¶çš„ï¼Œçˆ±æ˜¯æ°¸æ’çš„ã€‚',
            'ä¸­ç­‰çƒ¦æ¼': 'çƒ¦æ¼ç»ˆä¼šæ•£å»ï¼Œæ¸©æš–é•¿å­˜ã€‚',
            'ä¸­ç­‰å¨èƒ': 'å¨èƒé¢å‰ï¼Œæ›´æ˜¾çœŸå¿ƒã€‚',
            'å¤§å›°æ‰°': 'å¤§å›°æ‰°éœ€è¦å¤§å‹‡æ°”å»é¢å¯¹ã€‚',
            'å¤§æ³¢æŠ˜': 'ç»å†æ³¢æŠ˜ï¼Œæ„Ÿæƒ…æ‰æ›´æ·±åšã€‚',
            'å¤§éº»çƒ¦': 'å†å¤§çš„éº»çƒ¦ï¼Œä¸¤äººåˆ†æ‹…å°±å°äº†ã€‚',
            'å¤§æ’æ›²': 'æˆå‰§æ€§çš„æ’æ›²è®©çˆ±æ›´åŠ¨äººã€‚',
            'å¤§å‹åŠ›': 'æ‰›è¿‡å‹åŠ›ï¼Œå°±æ˜¯æˆé•¿ã€‚',
            'å¤§çƒ¦æ¼': 'çƒ¦æ¼å¾ˆå¤§ï¼Œä½†ä¿¡ä»»æ›´å¤§ã€‚',
            'å¤§å±é™©': 'å±é™©æ—¶åˆ»è§çœŸæƒ…ã€‚',
            'å¤§å¨èƒ': 'å¨èƒè€ƒéªŒçš„æ˜¯æˆ‘ä»¬çš„å†³å¿ƒã€‚',
            'å¤§å±æœº': 'å±æœºè¿‡åï¼Œå…³ç³»æ›´ç‰¢å›ºã€‚',
            'äº‰åµ': 'äº‰åµæ˜¯æ²Ÿé€šä¸ç•…çš„ä¿¡å·ã€‚',
            'å†·æˆ˜': 'å†·æˆ˜æœ€ä¼¤äººï¼Œä¸»åŠ¨å’Œå¥½éœ€è¦å‹‡æ°”ã€‚',
            'çƒ‚æ¡ƒèŠ±': 'å¿ è¯šæ˜¯çˆ±æƒ…çš„åº•çº¿ã€‚',
            'å«‰å¦’': 'é€‚åº¦å«‰å¦’æ˜¯åœ¨ä¹ï¼Œè¿‡åº¦å°±æ˜¯æŸç¼šã€‚',
            'ç°å®å‹åŠ›': 'çˆ±ä¸æ˜¯é€ƒé¿ç°å®ï¼Œè€Œæ˜¯å¹¶è‚©ä½œæˆ˜ã€‚',
            'æƒ…æ„Ÿå±æœº': 'å±æœºæ˜¯è­¦é’Ÿï¼Œä¹Ÿæ˜¯å¥‘æœºã€‚',
            'ç»ˆæå›°æ‰°': 'èµ°è¿‡æœ€éš¾çš„è·¯ï¼Œçˆ±æ›´åšå®šã€‚',
            'ç»ˆææ³¢æŠ˜': 'æœ€å¤§çš„æ³¢æŠ˜åæ˜¯æœ€ç¾çš„å½©è™¹ã€‚',
            'ç»ˆæå‹åŠ›': 'å‹åŠ›æ˜¯ç‚¼é‡‘çŸ³ï¼Œç‚¼å‡ºçœŸçˆ±ã€‚',
            'ç»ˆæå±æœº': 'ç†¬è¿‡å±æœºï¼Œå°±æ˜¯æ°¸æ’ã€‚',
            'ç»ˆæå¨èƒ': 'æœ€å¤§çš„å¨èƒç£¨ç»ƒæœ€æ·±çš„æ„Ÿæƒ…ã€‚',
            'ç»ˆæå±é™©': 'å±é™©è¿‡åï¼Œæ›´æ‡‚å¾—çæƒœã€‚',
            'ç»ˆæéº»çƒ¦': 'éº»çƒ¦å†å¤šï¼Œä¹Ÿè¦æ‰‹ç‰µæ‰‹èµ°ä¸‹å»ã€‚',
            'å·¨å¤§å›°æ‰°': 'å›°æ‰°å†å¤§ï¼Œæœ‰çˆ±å°±ä¸æ€•ã€‚',
            'å·¨å¤§å‹åŠ›': 'å·¨å¤§å‹åŠ›ä¸‹çš„åšæŒæ›´å¯è´µã€‚',
            'æ·±æµ·å‹åŠ›': 'æ·±æµ·èˆ¬çš„å‹åŠ›éœ€è¦æ·±æµ·èˆ¬çš„å‹‡æ°”ã€‚'
        };
        
        return descriptions[name] || 'æ¯æ®µæ„Ÿæƒ…éƒ½ä¼šé‡åˆ°è€ƒéªŒï¼Œé‡è¦çš„æ˜¯ä¸€èµ·é¢å¯¹ã€‚';
    }
    
    // æ˜¾ç¤ºé±¼ç±»è¯¦æƒ…
    function showFishDetail(fish) {
        // ç»˜åˆ¶é±¼ç±»å›¾åƒ
        const detailCtx = fishDetailCanvas.getContext('2d');
        detailCtx.clearRect(0, 0, 80, 80);
        
        const maxSize = 35;
        const fishTotalSize = fish.radius * 3.5;
        const scale = Math.min(1, maxSize / fishTotalSize);
        const displayRadius = fish.radius * scale;
        
        detailCtx.save();
        detailCtx.translate(40, 40);
        drawFishArt(detailCtx, 0, 0, displayRadius, fish.color, 0, 0, fish.subtype);
        detailCtx.restore();
        
        // è®¾ç½®åç§°å’Œä»‹ç»
        fishDetailName.textContent = fish.name;
        fishDetailDesc.textContent = getFishDescription(fish);
        
        // æ˜¾ç¤ºå¼¹çª—
        fishDetailModal.style.display = 'flex';
    }
    
    // å…³é—­é±¼ç±»è¯¦æƒ…
    function closeFishDetail() {
        fishDetailModal.style.display = 'none';
    }
    
    // ä»èœå•æ‰“å¼€å›¾é‰´ï¼ˆéæ¸¸æˆä¸­ï¼‰
    function openCollectionFromMenu(e) {
        if (e) {
            e.stopPropagation();
            e.preventDefault();
        }
        
        collectionScreen.style.display = 'flex';
        startScreen.style.display = 'none';
        collectionBtnMenu.style.display = 'none';
        document.getElementById('leaderboard-btn-menu').style.display = 'none';
        collectionCloseBtn.style.display = 'flex';
        // ç¦ç”¨canvasè§¦æ‘¸äº‹ä»¶ï¼Œå…è®¸å›¾é‰´æ»šåŠ¨
        canvas.style.pointerEvents = 'none';
        renderCollection();
    }
    
    // æ‰“å¼€å›¾é‰´ï¼ˆæ¸¸æˆä¸­ï¼‰
    function openCollection(e) {
        if (e) {
            e.stopPropagation();
            e.preventDefault();
        }
        if (!gameRunning) return;
        
        isCollectionOpen = true;
        isPaused = true;
        cancelAnimationFrame(animationId);
        
        collectionScreen.style.display = 'flex';
        collectionCloseBtn.style.display = 'flex';
        // ç¦ç”¨canvasè§¦æ‘¸äº‹ä»¶ï¼Œå…è®¸å›¾é‰´æ»šåŠ¨
        canvas.style.pointerEvents = 'none';
        renderCollection();
    }
    
    // å…³é—­å›¾é‰´
    function closeCollection() {
        isCollectionOpen = false;
        collectionScreen.style.display = 'none';
        collectionCloseBtn.style.display = 'none';
        // æ¢å¤canvasè§¦æ‘¸äº‹ä»¶
        canvas.style.pointerEvents = 'auto';
        
        if (gameRunning) {
            // æ¸¸æˆä¸­ï¼Œæ¢å¤æ¸¸æˆ
            isPaused = false;
            gameLoop();
        } else {
            // éæ¸¸æˆä¸­ï¼Œè¿”å›ä¸»èœå•
            startScreen.style.display = 'flex';
            collectionBtnMenu.style.display = 'flex';
            document.getElementById('leaderboard-btn-menu').style.display = 'flex';
        }
    }

    function pauseGame(e) {
        if (e) {
            e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
            e.preventDefault(); // é˜»æ­¢é»˜è®¤è¡Œä¸º
        }
        if (!gameRunning) return;
        isPaused = true;
        cancelAnimationFrame(animationId);
        
        // æ›´æ–°æš‚åœç•Œé¢çš„åˆ†æ•°å’Œæœ€é«˜åˆ†ä¿¡æ¯
        document.getElementById('pause-current-score').innerText = score;
        const highScore = highScores[currentDifficultyName] || 0;
        const pauseHighScoreInfo = document.getElementById('pause-high-score-info');
        if (pauseHighScoreInfo && !isStageMode) {
            const difficultyLabels = { easy: 'ç”œèœœçº¦ä¼š', normal: 'å¹¸ç¦æ—¥å¸¸', hard: 'å®ˆæŠ¤ä¸€ç”Ÿ' };
            const label = difficultyLabels[currentDifficultyName] || currentDifficultyName;
            if (score > highScore) {
                pauseHighScoreInfo.innerHTML = `ğŸŒŸ <span style="color:#ff4081;">å·²è¶…è¶Šæœ€é«˜åˆ†ï¼</span>ã€Œ${label}ã€åŸçºªå½•: ${highScore}`;
            } else if (score === highScore && score > 0) {
                pauseHighScoreInfo.innerHTML = `ğŸ† å¹³äº†ã€Œ${label}ã€æœ€é«˜åˆ†çºªå½•ï¼`;
            } else {
                pauseHighScoreInfo.innerHTML = `ã€Œ${label}ã€æœ€é«˜åˆ†: ${highScore}ï¼Œè¿˜å·® ${highScore - score} åˆ†~`;
            }
            pauseHighScoreInfo.style.display = 'block';
        } else if (pauseHighScoreInfo) {
            pauseHighScoreInfo.style.display = 'none';
        }
        
        pauseScreen.style.display = 'flex';
        // æš‚åœæ—¶éšè—æŒ‰é’®
        pauseBtn.style.display = 'none';
        collectionBtn.style.display = 'none';
    }
    function resumeGame() { 
        isPaused = false; 
        pauseScreen.style.display = 'none'; 
        // æ¢å¤æ¸¸æˆæ—¶æ˜¾ç¤ºæŒ‰é’®
        pauseBtn.style.display = 'flex';
        collectionBtn.style.display = 'flex';
        gameLoop(); 
    }
    function quitGameFromPause() { pauseScreen.style.display = 'none'; deathReasonEl.innerText = "ä¼‘æ¯å¥½äº†å—ï¼Ÿéšæ—¶éƒ½å¯ä»¥å›æ¥å“¦~"; endGame(); }
    function showStartScreen() {
        // ç«‹å³éšè—äº‹ä»¶æ ‡é¢˜ï¼Œé¿å…ä¸é¦–é¡µé‡å 
        eventBanner.style.opacity = 0;
        eventBanner.style.transition = 'none';
        setTimeout(() => {
            eventBanner.style.transition = 'opacity 0.5s';
        }, 100);
        startScreen.style.display = 'flex'; gameOverScreen.style.display = 'none'; uiLayer.style.display = 'none';
        pauseBtn.style.display = 'none';
        collectionBtn.style.display = 'none';
        collectionBtnMenu.style.display = 'flex';
        document.getElementById('leaderboard-btn-menu').style.display = 'flex';
        document.getElementById('skin-btn-menu').style.display = 'flex';
        pauseScreen.style.display = 'none';
        collectionScreen.style.display = 'none';
        document.getElementById('leaderboard-screen').style.display = 'none';
        
        // éšè—é—¯å…³æ¨¡å¼ç•Œé¢
        if (stageSelectScreen) stageSelectScreen.style.display = 'none';
        if (stageCompleteScreen) stageCompleteScreen.style.display = 'none';
        if (stageObjectiveDisplay) stageObjectiveDisplay.style.display = 'none';

        // å…ˆç»˜åˆ¶èƒŒæ™¯ï¼Œå†æ¸…é™¤ï¼ˆiOSéœ€è¦ç«‹å³æ˜¾ç¤ºèƒŒæ™¯ï¼‰
        const bgGradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
        bgGradient.addColorStop(0, 'rgb(255, 154, 158)');
        bgGradient.addColorStop(1, 'rgb(250, 208, 196)');
        ctx.fillStyle = bgGradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // ç»˜åˆ¶èƒŒæ™¯å›¾ç‰‡ï¼ˆå¦‚æœå·²åŠ è½½ï¼‰
        if (bgImageLoaded && bgImage.complete && bgImage.naturalWidth > 0) {
            const scale = Math.max(canvas.width / bgImage.width, canvas.height / bgImage.height);
            const scaledWidth = bgImage.width * scale;
            const scaledHeight = bgImage.height * scale;
            const x = (canvas.width - scaledWidth) / 2;
            const y = (canvas.height - scaledHeight) / 2;
            ctx.drawImage(bgImage, x, y, scaledWidth, scaledHeight);
        }

        startDesc.innerHTML = START_QUOTES[Math.floor(Math.random() * START_QUOTES.length)];
        updateHomeHighScores(); // æ›´æ–°é¦–é¡µæœ€é«˜åˆ†æ˜¾ç¤º
        initAmbient(); // å¯åŠ¨é¦–é¡µèƒŒæ™¯åŠ¨ç”»
    }
    function endGame() {
        gameRunning = false; isPaused = false; cancelAnimationFrame(animationId);
        
        // ç«‹å³éšè—äº‹ä»¶æ ‡é¢˜ï¼Œé¿å…ä¸é¦–é¡µé‡å 
        eventBanner.style.opacity = 0;
        eventBanner.style.transition = 'none'; // ç¦ç”¨è¿‡æ¸¡åŠ¨ç”»ï¼Œç«‹å³éšè—
        setTimeout(() => {
            eventBanner.style.transition = 'opacity 0.5s'; // æ¢å¤è¿‡æ¹¡åŠ¨ç”»
        }, 100);
        
        // é—¯å…³æ¨¡å¼ä¸‹çš„å¤±è´¥å¤„ç†
        if (isStageMode) {
            const stage = STAGES.find(s => s.id === currentStage);
            if (stage) {
                let progressInfo = '';
                
                // æ ¹æ®å…³å¡ç±»å‹æ˜¾ç¤ºè¿›åº¦
                if (stage.type === 'collect_hearts' || stage.type === 'fog_collect' || 
                    stage.type === 'current_collect' || stage.type === 'timed_collect') {
                    progressInfo = `å·²æ”¶é›† ${stageProgress}/${stage.target} çˆ±å¿ƒ`;
                } else if (stage.type === 'survive') {
                    const survived = Math.floor((Date.now() - stageSurviveStartTime) / 1000);
                    progressInfo = `å·²ç”Ÿå­˜ ${survived}/${stage.target} ç§’`;
                } else if (stage.type === 'dodge_obstacles') {
                    progressInfo = `å·²èº²é¿ ${stageObstaclesDodged}/${stage.target} ä¸ªéšœç¢`;
                }
                
                // å¦‚æœdeathReasonElå·²ç»æœ‰å†…å®¹ï¼ˆä¾‹å¦‚é™æ—¶å…³å¡ï¼‰ï¼Œåˆ™è¿½åŠ è¿›åº¦ä¿¡æ¯
                if (!deathReasonEl.innerText || deathReasonEl.innerText.includes('å…³å¡å¤±è´¥')) {
                    deathReasonEl.innerText = `å…³å¡å¤±è´¥ï¼${progressInfo}`;
                } else {
                    // å·²ç»æœ‰å…·ä½“å¤±è´¥åŸå› ï¼Œè¿½åŠ è¿›åº¦
                    deathReasonEl.innerText += `\n${progressInfo}`;
                }
            }
            if (stageObjectiveDisplay) stageObjectiveDisplay.style.display = 'none';
        }
        
        finalScoreEl.innerText = score;
        
        // æ£€æŸ¥å¹¶æ›´æ–°æœ€é«˜åˆ†ï¼Œæ˜¾ç¤ºé¼“åŠ±è¯­
        const gameOverHighScoreInfo = document.getElementById('game-over-high-score-info');
        if (gameOverHighScoreInfo && !isStageMode && currentDifficultyName) {
            const isNewRecord = checkAndUpdateHighScore();
            gameOverHighScoreInfo.innerHTML = getEncouragementText(isNewRecord, currentDifficultyName);
            gameOverHighScoreInfo.style.display = 'block';
            
            // ç ´çºªå½•æ—¶æ’­æ”¾æ’’èŠ±ç‰¹æ•ˆ
            if (isNewRecord) {
                gameOverHighScoreInfo.classList.add('new-record-badge');
                createConfetti();
            } else {
                gameOverHighScoreInfo.classList.remove('new-record-badge');
            }
        } else if (gameOverHighScoreInfo) {
            gameOverHighScoreInfo.style.display = 'none';
        }
        
        pauseBtn.style.display = 'none';
        collectionBtn.style.display = 'none';
        gameOverScreen.style.display = 'flex';
        body.classList.remove('fever-mode-bg'); body.style.background = "linear-gradient(to bottom, #ff9a9e, #fad0c4)";
    }

    // åˆå§‹åŒ–å›¾é‰´æ•°æ®
    loadCollectionData();
    
    // é¦–é¡µæ˜¾ç¤ºå›¾é‰´æŒ‰é’®
    if (collectionBtnMenu) {
        collectionBtnMenu.style.display = 'flex';
    }
    
    // é¡µé¢å¸è½½å‰ä¿å­˜å›¾é‰´æ•°æ®
    window.addEventListener('beforeunload', function() {
        if (collectedFish.size > 0) {
            saveCollectionData();
        }
    });
    
    // é¡µé¢éšè—æ—¶ä¿å­˜æ•°æ®ï¼ˆç§»åŠ¨è®¾å¤‡å…¼å®¹ï¼‰
    document.addEventListener('visibilitychange', function() {
        if (document.hidden && collectedFish.size > 0) {
            saveCollectionData();
        }
    });
    
    // å®šæœŸå¤‡ä»½å›¾é‰´æ•°æ®ï¼ˆæ¯30ç§’ï¼‰
    setInterval(function() {
        if (collectedFish.size > 0) {
            saveCollectionData();
        }
    }, 30000);
    
    showStartScreen();
</script>
</body>
</html>