<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>çˆ±å¿ƒå¤§ä½œæˆ˜ â¤ï¸</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #ffeff5;
            overflow: hidden;
            font-family: "Microsoft YaHei", sans-serif;
            touch-action: none; /* ç¦æ­¢é¡µé¢å›å¼¹ */
            user-select: none;
        }

        canvas {
            display: block;
        }

        /* UIå±‚ */
        #ui-layer {
            position: absolute;
            top: 15px;
            left: 20px;
            right: 20px;
            pointer-events: none;
            z-index: 10;
        }

        #score-bar-bg {
            width: 100%;
            height: 15px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid #ff69b4;
        }

        #score-bar-fill {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #ff9a9e 0%, #ff69b4 100%);
            transition: width 0.1s linear; /* æ›´æµç•…çš„è¿‡æ¸¡ */
        }

        #score-text {
            text-align: center;
            color: #ff69b4;
            font-weight: bold;
            font-size: 14px;
            margin-top: 5px;
            text-shadow: 1px 1px 0 #fff;
        }

        /* é®ç½©å±‚é€šç”¨æ ·å¼ */
        .mask {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            transition: opacity 0.3s;
        }

        .btn {
            background: #ff69b4;
            padding: 12px 35px;
            border-radius: 30px;
            font-size: 1.2rem;
            cursor: pointer;
            border: 3px solid #fff;
            margin-top: 20px;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* èƒœåˆ©å¼¹çª— */
        #win-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 85%;
            max-width: 350px;
            background: #fff;
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 0 30px rgba(255, 105, 180, 0.6);
            z-index: 1000;
            border: 4px solid #ff69b4;
        }

        #win-modal h2 {
            color: #ff69b4;
            margin: 0 0 15px 0;
        }

        #win-modal p {
            color: #555;
            line-height: 1.6;
            font-size: 1rem;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>

<!-- éŸ³ä¹èµ„æº (å»ºè®®ä½¿ç”¨è¾ƒå°çš„æ–‡ä»¶æˆ–ç¨³å®šå¤–é“¾) -->
<audio id="bgm" loop>
    <source src="https://music.163.com/song/media/outer/url?id=5264842.mp3" type="audio/mpeg">
</audio>

<div id="ui-layer">
    <div id="score-bar-bg">
        <div id="score-bar-fill"></div>
    </div>
    <div id="score-text">çˆ±æ„æ”¶é›†: 0%</div>
</div>

<!-- å¼€å§‹ç•Œé¢ -->
<div id="start-screen" class="mask">
    <h1 style="font-size: 2rem; margin-bottom: 10px;">â¤ï¸ çˆ±å¿ƒå¤§ä½œæˆ˜</h1>
    <p style="color: #ddd; font-size: 0.9rem;">å·¦å³æ»‘åŠ¨è§’è‰²ï¼Œæ¥ä½çˆ±å¿ƒï¼Œèº²é¿ç‚¸å¼¹</p>
    <div class="btn" id="start-btn">å¼€å§‹æŒ‘æˆ˜</div>
</div>

<!-- èƒœåˆ©å¼¹çª— -->
<div id="win-modal">
    <h2>ğŸ‰ æŒ‘æˆ˜æˆåŠŸï¼</h2>
    <p>äº²çˆ±çš„ï¼š<br>æ­å–œä½ æ”’æ»¡äº†æˆ‘å¯¹ä½ çš„çˆ±æ„ï¼<br>ä»¥åçš„æ—¥å­é‡Œï¼Œ<br>æ‰€æœ‰çš„å¿«ä¹éƒ½ç»™ä½ ï¼Œ<br>æ‰€æœ‰çš„é£é›¨æˆ‘æ¥æŒ¡ã€‚<br>çˆ±ä½ å“Ÿï¼â¤ï¸</p>
    <div class="btn" style="font-size: 1rem; padding: 8px 20px;" onclick="location.reload()">å†ç©ä¸€æ¬¡</div>
</div>

<canvas id="gameCanvas"></canvas>

<script>
    // === æ€§èƒ½ä¼˜åŒ–é…ç½® ===
    const CONFIG = {
        spawnInterval: 600, // ç”Ÿæˆç‰©å“é—´éš”(æ¯«ç§’)
        gravity: 4,         // ç‰©å“ä¸‹è½åŸºç¡€é€Ÿåº¦
        maxItems: 20,       // å±å¹•ä¸Šæœ€å¤šåŒæ—¶å­˜åœ¨çš„ç‰©å“æ•° (é˜²æ­¢å¡æ­»)
        winScore: 100       // èƒœåˆ©åˆ†æ•°
    };

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreFill = document.getElementById('score-bar-fill');
    const scoreText = document.getElementById('score-text');

    let width, height;
    let lastTime = 0;
    let spawnTimer = 0;
    let gameRunning = false;
    let score = 0;

    // å¯¹è±¡æ± 
    let items = [];
    let particles = [];
    let fireworksInterval = null;

    // ç©å®¶å›¾ç‰‡
    const playerImage = new Image();
    playerImage.src = 'img/1.jpg';
    let playerImageLoaded = false;
    playerImage.onload = () => {
        playerImageLoaded = true;
        // æ ¹æ®å›¾ç‰‡å®é™…å°ºå¯¸è°ƒæ•´ç©å®¶å¤§å°
        const aspectRatio = playerImage.width / playerImage.height;
        player.w = 50;  // å‡å°å°ºå¯¸
        player.h = 50 / aspectRatio;
    };

    const player = { x: 0, y: 0, w: 50, h: 50 };

    // ç‰©å“å®šä¹‰
    const itemTypes = [
        { emoji: "â¤ï¸", val: 10, speedFix: 0 },
        { emoji: "ğŸ¬", val: 5, speedFix: 1 },
        { emoji: "ğŸŒ¹", val: 8, speedFix: 0.5 },
        { emoji: "ğŸ’£", val: -20, speedFix: 2 }, // ç‚¸å¼¹å¿«ä¸€ç‚¹
        { emoji: "ğŸ¥¦", val: -5, speedFix: 1 }
    ];

    function initWindow() {
        width = window.innerWidth;
        height = window.innerHeight;
        canvas.width = width;
        canvas.height = height;
        player.y = height - 80;
        player.x = width / 2;
    }
    initWindow();
    window.addEventListener('resize', initWindow);

    // ç©å®¶ç§»åŠ¨
    function setPlayerX(x) {
        player.x = x;
        if (player.x < player.w / 2) player.x = player.w / 2;
        if (player.x > width - player.w / 2) player.x = width - player.w / 2;
    }

    canvas.addEventListener('touchmove', e => {
        e.preventDefault();
        setPlayerX(e.touches[0].clientX);
    }, { passive: false });

    canvas.addEventListener('mousemove', e => {
        setPlayerX(e.clientX);
    });

    // æ ¸å¿ƒæ¸¸æˆå¾ªç¯ (å¸¦æ—¶é—´æˆ³ï¼Œé˜²æ­¢åå°åŠ é€Ÿ)
    function loop(timestamp) {
        if (!lastTime) lastTime = timestamp;
        const deltaTime = timestamp - lastTime;
        lastTime = timestamp;

        // æ¸…ç©ºç”»å¸ƒ
        ctx.clearRect(0, 0, width, height);

        // 1. ç»˜åˆ¶ç©å®¶ï¼ˆåœ†å½¢è£å‰ªï¼‰
        if (playerImageLoaded) {
            ctx.save();
            // åˆ›å»ºåœ†å½¢è£å‰ªè·¯å¾„
            ctx.beginPath();
            const radius = Math.min(player.w, player.h) / 2;
            ctx.arc(player.x, player.y, radius, 0, Math.PI * 2);
            ctx.clip();
            // ç»˜åˆ¶å›¾ç‰‡
            ctx.drawImage(playerImage, player.x - player.w / 2, player.y - player.h / 2, player.w, player.h);
            ctx.restore();
        } else {
            // å¦‚æœå›¾ç‰‡è¿˜æ²¡åŠ è½½ï¼Œæ˜¾ç¤ºå ä½ç¬¦
            ctx.font = "50px Arial";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText("ğŸ»", player.x, player.y);
        }

        // 2. æ¸¸æˆé€»è¾‘
        if (gameRunning) {
            // ç”Ÿæˆç‰©å“ (åŸºäºæ—¶é—´å·®ï¼Œè€Œä¸æ˜¯setTimeout)
            spawnTimer += deltaTime;
            if (spawnTimer > CONFIG.spawnInterval) {
                spawnItem();
                spawnTimer = 0;
            }

            // æ›´æ–°ç‰©å“ä½ç½®
            for (let i = items.length - 1; i >= 0; i--) {
                let item = items[i];
                item.y += item.speed;

                // ç»˜åˆ¶
                ctx.font = "30px Arial";
                ctx.fillText(item.emoji, item.x, item.y);

                // ç¢°æ’æ£€æµ‹
                let dist = Math.abs(player.x - item.x) + Math.abs(player.y - item.y);
                let collisionRadius = Math.max(player.w, player.h) / 2 + 15;
                if (dist < collisionRadius) { // æ ¹æ®ç©å®¶å¤§å°è°ƒæ•´ç¢°æ’èŒƒå›´
                    handleScore(item.val, item.x, item.y);
                    items.splice(i, 1);
                    continue;
                }

                // è¶Šç•Œç§»é™¤
                if (item.y > height + 50) {
                    items.splice(i, 1);
                }
            }
        }

        // 3. ç²’å­ç‰¹æ•ˆ (é£˜å­— + çƒŸèŠ±)
        updateParticles();

        requestAnimationFrame(loop);
    }

    function spawnItem() {
        // é™åˆ¶æœ€å¤§æ•°é‡ï¼Œé˜²æ­¢å¡é¡¿
        if (items.length >= CONFIG.maxItems) return;

        const type = itemTypes[Math.floor(Math.random() * itemTypes.length)];
        items.push({
            x: Math.random() * (width - 60) + 30,
            y: -40,
            emoji: type.emoji,
            val: type.val,
            speed: CONFIG.gravity + type.speedFix + Math.random()
        });
    }

    function handleScore(val, x, y) {
        score += val;
        if (score < 0) score = 0;
        if (score > CONFIG.winScore) score = CONFIG.winScore;

        // æ›´æ–°UI
        let pct = (score / CONFIG.winScore) * 100;
        scoreFill.style.width = pct + "%";
        scoreText.innerText = `çˆ±æ„æ”¶é›†: ${Math.floor(pct)}%`;

        // é£˜å­—
        createFloatText(val > 0 ? "+" + val : val, x, y, val > 0 ? "#ff69b4" : "#888");

        // èƒœåˆ©
        if (score >= CONFIG.winScore && gameRunning) {
            winGame();
        }
    }

    // === ç®€æ˜“ç²’å­ç³»ç»Ÿ (ä¼˜åŒ–æ€§èƒ½) ===
    function createFloatText(txt, x, y, color) {
        particles.push({ type: 'text', txt, x, y, color, life: 1.0 });
    }

    function createFirework() {
        // é™åˆ¶å±å¹•ä¸Šæ€»ç²’å­æ•°
        if (particles.length > 300) return;

        const cx = Math.random() * width;
        const cy = Math.random() * (height / 2);
        const color = `hsl(${Math.random() * 360}, 100%, 60%)`;

        for (let i = 0; i < 40; i++) { // å‡å°‘æ¯ä¸ªçƒŸèŠ±çš„ç²’å­æ•°ï¼Œæé«˜æµç•…åº¦
            const angle = (Math.PI * 2 * i) / 40;
            const speed = Math.random() * 3 + 2;
            particles.push({
                type: 'spark',
                x: cx, y: cy,
                vx: Math.cos(angle) * speed,
                vy: Math.sin(angle) * speed,
                color: color,
                life: 1.0,
                decay: 0.01 + Math.random() * 0.02
            });
        }
    }

    function updateParticles() {
        for (let i = particles.length - 1; i >= 0; i--) {
            let p = particles[i];

            if (p.type === 'text') {
                p.y -= 1.5;
                p.life -= 0.02;
                ctx.globalAlpha = Math.max(0, p.life);
                ctx.fillStyle = p.color;
                ctx.font = "bold 24px Arial";
                ctx.fillText(p.txt, p.x, p.y);
            } else if (p.type === 'spark') {
                p.x += p.vx;
                p.y += p.vy;
                p.vy += 0.05; // é‡åŠ›
                p.life -= p.decay;
                ctx.globalAlpha = Math.max(0, p.life);
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x, p.y, 3, 3); // ç”¨fillRectä»£æ›¿arcï¼Œæ€§èƒ½æ›´å¥½
            }

            if (p.life <= 0) particles.splice(i, 1);
        }
        ctx.globalAlpha = 1.0;
    }

    function winGame() {
        gameRunning = false;
        document.getElementById('bgm').pause();

        // æ˜¾ç¤ºèƒœåˆ©UI
        setTimeout(() => {
            document.getElementById('win-modal').style.display = 'block';
        }, 500);

        // æ”¾çƒŸèŠ±
        fireworksInterval = setInterval(createFirework, 500);

        // 5ç§’ååœæ­¢æ”¾çƒŸèŠ±ï¼Œé˜²æ­¢æ‰‹æœºå‘çƒ«
        setTimeout(() => {
            if(fireworksInterval) clearInterval(fireworksInterval);
        }, 8000);
    }

    // å¯åŠ¨é€»è¾‘
    const startBtn = document.getElementById('start-btn');
    const startScreen = document.getElementById('start-screen');
    const bgm = document.getElementById('bgm');

    startBtn.addEventListener('click', () => {
        startScreen.style.opacity = 0;
        setTimeout(() => startScreen.style.display = 'none', 300);

        gameRunning = true;
        bgm.play().catch(e => console.log('BGMéœ€äº¤äº’'));

        lastTime = performance.now();
        requestAnimationFrame(loop);
    });

</script>
</body>
</html>