<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>çˆ±çš„å®ˆæŠ¤ - æé™å‹è¿«ç‰ˆ</title>
    <style>
        body {
            margin: 0; padding: 0;
            background: linear-gradient(to bottom, #ff9a9e, #fad0c4);
            overflow: hidden;
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
            user-select: none; touch-action: none;
            transition: background 3s ease;
        }

        .overlay-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 100; color: #d63384; padding: 20px; box-sizing: border-box;
            transition: opacity 0.3s;
        }

        h1 { font-size: 32px; margin-bottom: 10px; text-align: center; font-weight: 800;
            background: linear-gradient(to right, #ff758c, #ff7eb3); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        p { font-size: 16px; color: #666; text-align: center; margin-bottom: 20px; line-height: 1.6; max-width: 90%; }
        .hint { font-size: 14px; color: #ff758c; background: #fff0f5; padding: 5px 10px; border-radius: 10px; margin-bottom: 20px;}

        .btn-group { display: flex; flex-direction: column; gap: 15px; width: 80%; max-width: 300px; padding-bottom: 20px;}
        button {
            padding: 15px 10px; font-size: 18px; border: none; border-radius: 25px;
            cursor: pointer; font-weight: bold; box-shadow: 0 4px 15px rgba(255, 105, 180, 0.2);
            transition: transform 0.1s; color: white; outline: none; -webkit-tap-highlight-color: transparent;
        }
        button:active { transform: scale(0.96); }
        .btn-easy { background: linear-gradient(45deg, #ff9a9e, #fecfef); color: #c71585; }
        .btn-normal { background: linear-gradient(45deg, #a18cd1, #fbc2eb); color: white; }
        .btn-hard { background: linear-gradient(45deg, #ff5858, #f09819); color: white; }
        .btn-restart { background: #fff; border: 2px solid #ff758c; color: #ff758c; margin-top: 20px; width: 60%;}
        .btn-resume { background: linear-gradient(45deg, #4facfe, #00f2fe); color: white; }
        .btn-quit { background: #fff; border: 2px solid #999; color: #999; }

        #ui-layer {
            position: absolute;
            top: max(15px, env(safe-area-inset-top)); left: max(15px, env(safe-area-inset-left));
            width: calc(100% - 80px); pointer-events: none; z-index: 50;
        }

        .score-text { color: #d63384; font-weight: bold; font-size: 18px; text-shadow: 1px 1px 0px rgba(255,255,255,0.8); }
        .sub-text { font-size: 12px; opacity: 0.8; margin-top:5px; color:#666; }

        #pause-btn {
            position: absolute;
            top: max(15px, env(safe-area-inset-top)); right: max(15px, env(safe-area-inset-right));
            width: 45px; height: 45px; border-radius: 50%;
            background: rgba(255, 255, 255, 0.6); border: 2px solid #fff;
            color: #ff758c; font-size: 20px;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; pointer-events: auto; z-index: 60;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .floating-text {
            position: absolute; font-weight: bold; font-size: 20px;
            pointer-events: none; animation: floatUp 1.5s ease-out forwards;
            text-shadow: 1px 1px 2px white; white-space: nowrap; z-index: 55;
        }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-50px) scale(1.2); } }

        #buff-bar { margin-top: 8px; display: flex; gap: 8px; }
        .buff-icon {
            width: 24px; height: 24px; border-radius: 50%; font-size: 14px;
            display: flex; justify-content: center; align-items: center;
            color: white; box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }

        #fever-container {
            margin-top: 8px; width: 150px; height: 12px;
            background: rgba(255,255,255,0.6); border-radius: 10px;
            overflow: hidden; border: 2px solid #ff758c; position: relative;
        }
        #fever-bar {
            width: 0%; height: 100%; background: linear-gradient(90deg, #ff9a9e, #ff0055); transition: width 0.2s;
        }
        #fever-text { position: absolute; top: -18px; left: 0; font-size: 11px; color: #ff0055; font-weight: bold; text-shadow: 0 0 2px white; }

        .fever-mode-bg { animation: rainbowBorder 1s infinite; }
        @keyframes rainbowBorder {
            0% { box-shadow: inset 0 0 20px #ff0000; } 50% { box-shadow: inset 0 0 20px #00ffff; } 100% { box-shadow: inset 0 0 20px #ff00ff; }
        }

        #unlock-msg {
            position: absolute; top: 20%; width: 100%; text-align: center;
            font-size: 24px; color: #ff4081; font-weight: bold; text-shadow: 2px 2px 0 #fff;
            opacity: 0; pointer-events: none; z-index: 60; transition: opacity 0.5s;
        }

        #event-banner {
            position: absolute; top: 150px; width: 100%; text-align: center;
            pointer-events: none; z-index: 55; opacity: 0; transition: opacity 0.5s;
        }
        .event-title { font-size: 28px; font-weight: 900; color: #fff; text-shadow: 0 0 10px #ff0055; margin-bottom: 5px; }
        .event-desc { font-size: 16px; color: #fff; text-shadow: 1px 1px 2px #000; background: rgba(0,0,0,0.4); display: inline-block; padding: 5px 15px; border-radius: 20px;}
    </style>
</head>
<body>

<div id="particles-container"></div>
<div id="unlock-msg">âš ï¸ æ–°æŒ‘æˆ˜å‡ºç°! âš ï¸</div>

<div id="event-banner">
    <div class="event-title" id="event-title">âš¡ äº‹ä»¶å‘ç”Ÿ âš¡</div>
    <div class="event-desc" id="event-desc">æè¿°æ–‡å­—</div>
</div>

<div id="ui-layer" style="display:none;">
    <div class="score-text">æ‹çˆ±æŒ‡æ•°: <span id="score">0</span> â¤ï¸</div>
    <div class="sub-text">æˆ‘ä»¬åœ¨ä¸€èµ·: <span id="size-display">1</span> å¤©</div>
    <div style="margin-top:12px; position:relative;">
        <div id="fever-text">å¿ƒåŠ¨å€¼ ğŸ’– (åƒçˆ±å¿ƒå¢åŠ )</div>
        <div id="fever-container"><div id="fever-bar"></div></div>
    </div>
    <div id="buff-bar"></div>
</div>

<button id="pause-btn" style="display:none;" onclick="pauseGame()">â¸</button>

<!-- å¼€å§‹ç•Œé¢ -->
<div id="start-screen" class="overlay-screen">
    <h1>ğŸ’– çˆ±çš„å®ˆæŠ¤ ğŸ’–</h1>
    <p><b>æˆé•¿å¾ˆæ…¢ï¼Œéœ€è¦è€å¿ƒç§¯ç´¯</b><br><b>å›°éš¾æ¨¡å¼è¿·é›¾æé‡ï¼Œè¯·å°å¿ƒï¼</b><br>æ— è®ºå‘ç”Ÿä»€ä¹ˆï¼Œè®°å¾—æŠ“ç´§èªä»”ï¼</p>
    <div class="hint">æç¤ºï¼šè¢«å†°å†»åé€Ÿåº¦ä¼šå˜å¾—ææ…¢ï¼</div>
    <div class="btn-group">
        <button class="btn-easy" onclick="startGame('easy')">ğŸ° ç”œèœœçº¦ä¼š (ç®€å•)</button>
        <button class="btn-normal" onclick="startGame('normal')">ğŸ  å¹¸ç¦æ—¥å¸¸ (æ™®é€š)</button>
        <button class="btn-hard" onclick="startGame('hard')">ğŸ›¡ï¸ å®ˆæŠ¤ä¸€ç”Ÿ (å›°éš¾)</button>
    </div>
</div>

<!-- æš‚åœç•Œé¢ -->
<div id="pause-screen" class="overlay-screen" style="display: none;">
    <h2>æ¸¸æˆæš‚åœ</h2>
    <div class="btn-group">
        <button class="btn-resume" onclick="resumeGame()">â–¶ ç»§ç»­çˆ±</button>
        <button class="btn-quit" onclick="quitGameFromPause()">âœ– ä¼‘æ¯ä¸€ä¸‹ (ç»“æŸ)</button>
    </div>
</div>

<!-- ç»“æŸç•Œé¢ -->
<div id="game-over-screen" class="overlay-screen" style="display: none;">
    <h2 style="font-size: 28px; color: #ff5858;">åˆ«æ€•ï¼Œèªä»”åœ¨å‘¢</h2>
    <p id="death-reason" style="font-size: 16px;">å¦‚æœä¸å¼€å¿ƒäº†ï¼Œæˆ‘æ¥å“„ä½ ~</p>
    <p style="font-size: 20px;">æ”¶è·çˆ±å¿ƒ: <span id="final-score" style="color: #ff4081; font-weight:bold;">0</span></p>
    <button class="btn-restart" onclick="showStartScreen()">å†çˆ±ä¸€æ¬¡</button>
</div>

<canvas id="gameCanvas"></canvas>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const uiLayer = document.getElementById('ui-layer');
    const buffBar = document.getElementById('buff-bar');
    const pauseBtn = document.getElementById('pause-btn');
    const startScreen = document.getElementById('start-screen');
    const gameOverScreen = document.getElementById('game-over-screen');
    const pauseScreen = document.getElementById('pause-screen');
    const scoreEl = document.getElementById('score');
    const sizeEl = document.getElementById('size-display');
    const finalScoreEl = document.getElementById('final-score');
    const deathReasonEl = document.getElementById('death-reason');
    const particlesContainer = document.getElementById('particles-container');
    const feverBar = document.getElementById('fever-bar');
    const unlockMsg = document.getElementById('unlock-msg');
    const eventBanner = document.getElementById('event-banner');
    const eventTitle = document.getElementById('event-title');
    const eventDesc = document.getElementById('event-desc');
    const body = document.body;

    const input = { x: 0, y: 0 };
    let animationId;
    let score = 0;
    let gameRunning = false;
    let isPaused = false;
    let frameCount = 0;
    let currentDifficulty = {};
    let feverValue = 0;
    let isFeverMode = false;
    let feverTimer = 0;
    let unlockedStages = { 500: false, 1000: false, 2000: false, 3000: false };

    let currentEvent = null;
    let eventTimer = 0;
    let nextEventCooldown = 600;
    let currentForce = { x: 0, y: 0 };
    let flowParticles = [];

    const LOVE_WORDS = ["çˆ±ä½ ", "æŠ±æŠ±", "æƒ³ä½ ", "äº²äº²", "ä¹–å®", "çœŸæ£’", "å¥½å¯çˆ±", "ç¾ç¾å“’", "è´´è´´", "Love U"];

    const DIFFICULTY_SETTINGS = {
        'easy':   {
            spawnRate: 40, speedMultiplier: 0.6, feverFactor: 2.0,
            fogRadius: 180, weights: [0.6, 0.3, 0.1],
            eventProb: { fog: 0.3, current: 0.3, starfall: 0.4 }
        },
        'normal': {
            spawnRate: 45, speedMultiplier: 0.9, feverFactor: 1.0,
            fogRadius: 120, weights: [0.4, 0.2, 0.4],
            eventProb: { fog: 0.4, current: 0.4, starfall: 0.2 }
        },
        'hard':   {
            spawnRate: 30, speedMultiplier: 1.3, feverFactor: 0.4,
            fogRadius: 35, // æ ¸å¿ƒä¿®æ”¹ï¼šèƒ½è§åº¦æä½ï¼ŒåŠå¾„ä»…35
            weights: [0.25, 0.1, 0.65],
            eventProb: { fog: 0.5, current: 0.45, starfall: 0.05 }
        }
    };

    const GAME_OBJECTS = {
        good: [
            { type: 'heart', r: 8, color: '#ff4081', score: 10, fever: 2, speed: [1, 2], name: 'å°æƒŠå–œ', minScore: 0 },
            { type: 'heart', r: 15, color: '#ff0055', score: 20, fever: 5, speed: [1.5, 2.5], name: 'å¤§ç¤¼ç‰©', minScore: 100 },
            { type: 'heart', subtype: 'star', r: 12, color: '#FFD700', score: 50, fever: 15, speed: [3, 5], name: 'å¹¸è¿æ˜Ÿ', minScore: 300 },
            { type: 'heart', subtype: 'diamond', r: 20, color: '#E0FFFF', score: 500, fever: 100, speed: [4, 6], name: 'æ°¸æ’é’»æˆ’', minScore: 2500, rarity: 0.01 }
        ],
        buff: [
            { type: 'buff', subtype: 'candy', r: 12, color: '#FFD700', speed: [1, 1.5], name: 'ç”œèœœç³–æœ', minScore: 0 },
            { type: 'buff', subtype: 'summon', r: 14, color: '#00BFFF', speed: [1, 1.5], name: 'æŠ¤èº«ç¬¦', minScore: 0 },
            { type: 'buff', subtype: 'magnet', r: 12, color: '#FF6347', speed: [1, 1.5], name: 'åŒå‘å¥”èµ´', minScore: 100 }
        ],
        bad: [
            { type: 'bad', subtype: 'normal', r: 12, color: '#8BC34A', speed: [2, 3], name: 'å°æ‘©æ“¦', minScore: 0 },
            { type: 'bad', subtype: 'normal', r: 25, color: '#9E9E9E', speed: [1.5, 2.5], name: 'åæƒ…ç»ª', minScore: 100 },
            { type: 'bad', subtype: 'lightning', r: 15, color: '#FFEB3B', speed: [4, 6], name: 'äº‰åµ', minScore: 500 },
            { type: 'bad', subtype: 'ice', r: 40, color: '#00BCD4', speed: [2, 4], name: 'å†·æˆ˜', minScore: 500 },
            { type: 'bad', subtype: 'puffer', r: 22, color: '#9C27B0', speed: [2, 3], name: 'å«‰å¦’', minScore: 1000 },
            { type: 'bad', subtype: 'whale', r: 100, color: '#37474F', speed: [0.8, 1.2], name: 'ç°å®å‹åŠ›', minScore: 2000 },
            { type: 'bad', subtype: 'shark', r: 50, color: '#D32F2F', speed: [5, 7], name: 'æƒ…æ„Ÿå±æœº', minScore: 3000 }
        ]
    };

    // --- è¾…åŠ©ç»˜å›¾å‡½æ•° ---

    if (!CanvasRenderingContext2D.prototype.roundRect) {
        CanvasRenderingContext2D.prototype.roundRect = function (x, y, w, h, r) {
            if (w < 2 * r) r = w / 2; if (h < 2 * r) r = h / 2;
            this.beginPath(); this.moveTo(x + r, y);
            this.arcTo(x + w, y, x + w, y + h, r); this.arcTo(x + w, y + h, x, y + h, r);
            this.arcTo(x, y + h, x, y, r); this.arcTo(x, y, x + w, y, r);
            this.closePath(); return this;
        };
    }

    function drawCuteFish(ctx, x, y, r, angle, color, hasEyelashes, text) {
        ctx.save(); ctx.translate(x, y); ctx.rotate(angle);
        ctx.fillStyle = color; ctx.beginPath(); ctx.ellipse(0, 0, r * 1.5, r, 0, 0, Math.PI * 2); ctx.fill();
        ctx.beginPath(); const tailX = -r * 1.2; ctx.moveTo(tailX, 0); ctx.quadraticCurveTo(tailX - r, -r, tailX - r, 0); ctx.quadraticCurveTo(tailX - r, r, tailX, 0); ctx.fill();
        ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(r * 0.6, -r * 0.3, r * 0.35, 0, Math.PI * 2); ctx.fill();
        ctx.fillStyle = '#333'; ctx.beginPath(); ctx.arc(r * 0.7, -r * 0.3, r * 0.15, 0, Math.PI * 2); ctx.fill();
        if (hasEyelashes) {
            ctx.strokeStyle = '#333'; ctx.lineWidth = 1; ctx.beginPath();
            ctx.moveTo(r*0.6, -r*0.6); ctx.lineTo(r*0.5, -r*0.8);
            ctx.moveTo(r*0.7, -r*0.65); ctx.lineTo(r*0.7, -r*0.9);
            ctx.moveTo(r*0.8, -r*0.6); ctx.lineTo(r*0.9, -r*0.8); ctx.stroke();
        }
        if (text) {
            ctx.fillStyle = 'white'; const fontSize = text.length > 1 ? r * 0.6 : r * 0.8;
            ctx.font = `bold ${fontSize}px "Microsoft YaHei", sans-serif`; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText(text, -r * 0.1, 0);
        }
        ctx.fillStyle = 'rgba(255,0,0,0.2)'; ctx.beginPath(); ctx.arc(r * 0.6, r * 0.1, r * 0.2, 0, Math.PI * 2); ctx.fill();
        ctx.restore();
    }

    function drawHeart(ctx, x, y, r, color) {
        ctx.fillStyle = color; ctx.beginPath(); const topCurveHeight = r * 0.8; ctx.moveTo(0, r * 0.6);
        ctx.bezierCurveTo(0, 0, -r, 0, -r, -topCurveHeight); ctx.bezierCurveTo(-r, -r * 1.6, 0, -r * 1.6, 0, -topCurveHeight);
        ctx.bezierCurveTo(0, -r * 1.6, r, -r * 1.6, r, -topCurveHeight); ctx.bezierCurveTo(r, 0, 0, 0, 0, r * 0.6); ctx.fill();
        ctx.fillStyle = 'rgba(255,255,255,0.4)'; ctx.beginPath(); ctx.arc(-r*0.3, -r*0.8, r*0.15, 0, Math.PI*2); ctx.fill();
    }

    function drawStar(ctx, cx, cy, spikes, outerRadius, innerRadius, color) {
        var rot = Math.PI / 2 * 3; var x = cx; var y = cy; var step = Math.PI / spikes;
        ctx.beginPath(); ctx.moveTo(cx, cy - outerRadius);
        for (i = 0; i < spikes; i++) {
            x = cx + Math.cos(rot) * outerRadius; y = cy + Math.sin(rot) * outerRadius; ctx.lineTo(x, y); rot += step;
            x = cx + Math.cos(rot) * innerRadius; y = cy + Math.sin(rot) * innerRadius; ctx.lineTo(x, y); rot += step;
        }
        ctx.lineTo(cx, cy - outerRadius); ctx.closePath(); ctx.fillStyle = color; ctx.fill();
    }

    function drawDiamond(ctx, r, color) {
        ctx.fillStyle = color; ctx.beginPath();
        ctx.moveTo(0, -r); ctx.lineTo(r, 0); ctx.lineTo(0, r); ctx.lineTo(-r, 0);
        ctx.fill(); ctx.strokeStyle = 'white'; ctx.lineWidth = 2; ctx.stroke();
    }

    // --- ç³»ç»Ÿå‡½æ•° ---

    function resizeCanvas() {
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        input.x = canvas.width / 2; input.y = canvas.height / 2;
    }
    window.addEventListener('resize', resizeCanvas);
    function handleInput(x, y) { if(!isPaused && gameRunning) { input.x = x; input.y = y; } }
    window.addEventListener('mousemove', e => handleInput(e.clientX, e.clientY));
    const handleTouch = (e) => { if(e.cancelable) e.preventDefault(); if(e.touches.length > 0) handleInput(e.touches[0].clientX, e.touches[0].clientY); };
    canvas.addEventListener('touchstart', handleTouch, {passive:false});
    canvas.addEventListener('touchmove', handleTouch, {passive:false});
    resizeCanvas();

    function spawnFloatingText(text, x, y, color='#ff4081', size=18) {
        const el = document.createElement('div');
        el.className = 'floating-text';
        el.innerText = text;
        el.style.left = x + 'px'; el.style.top = y + 'px';
        el.style.color = color; el.style.fontSize = size + 'px';
        particlesContainer.appendChild(el);
        setTimeout(() => el.remove(), 1500);
    }

    function showUnlockMsg(text) {
        unlockMsg.innerText = text; unlockMsg.style.opacity = 1;
        setTimeout(() => { unlockMsg.style.opacity = 0; }, 3000);
    }

    function updateBuffUI(buffs, guardianActive) {
        buffBar.innerHTML = '';
        if (isFeverMode) buffBar.innerHTML += `<div class="buff-icon" style="background:#FF1493; animation: pulse 0.5s infinite;">ğŸ”¥</div>`;
        // å†°å†»çŠ¶æ€æ˜¾ç¤ºè“è‰²é›ªèŠ±
        if (buffs.slowed > 0) buffBar.innerHTML += `<div class="buff-icon" style="background:#00BCD4">â„ï¸</div>`;
        if (guardianActive) buffBar.innerHTML += `<div class="buff-icon" style="background:#00BFFF">ğŸ›¡ï¸</div>`;
        if (buffs.speed > 0) buffBar.innerHTML += `<div class="buff-icon" style="background:#FFD700">ğŸ¬</div>`;
        if (buffs.magnet > 0) buffBar.innerHTML += `<div class="buff-icon" style="background:#FF6347">ğŸ§²</div>`;
    }

    function checkGameEvolution() {
        if (score > 2000) body.style.background = "linear-gradient(to bottom, #000000, #434343)";
        else if (score > 1000) body.style.background = "linear-gradient(to bottom, #0f2027, #203a43, #2c5364)";
        else if (score > 500) body.style.background = "linear-gradient(to bottom, #6a11cb, #2575fc)";
        else body.style.background = "linear-gradient(to bottom, #ff9a9e, #fad0c4)";

        if (!unlockedStages[500] && score >= 500) { unlockedStages[500] = true; showUnlockMsg("âš¡ äº‰åµä¸å†·æˆ˜ å‡ºç°äº†!"); }
        if (!unlockedStages[1000] && score >= 1000) { unlockedStages[1000] = true; showUnlockMsg("ğŸ¡ å«‰å¦’ å‡ºç°äº†! å°å¿ƒåˆº!"); }
        if (!unlockedStages[2000] && score >= 2000) { unlockedStages[2000] = true; showUnlockMsg("ğŸ³ å·¨å¤§çš„ç°å®å‹åŠ› é€¼è¿‘!"); }
        if (!unlockedStages[3000] && score >= 3000) { unlockedStages[3000] = true; showUnlockMsg("ğŸ¦ˆ æƒ…æ„Ÿå±æœº è¢­æ¥! å¿«è·‘!"); }
    }

    // === äº‹ä»¶ç³»ç»Ÿé€»è¾‘ ===
    function triggerEvent(type) {
        currentEvent = type;
        eventTimer = 600; // 10ç§’æŒç»­æ—¶é—´

        items = items.filter(i => i.subtype !== 'lightning' && i.subtype !== 'ice');

        let title = "";
        let desc = "";
        let bgColor = "";

        if (type === 'fog') {
            title = "ğŸŒ«ï¸ è¿·èŒ«ä¹‹é›¾";
            desc = "çœ‹ä¸æ¸…æœªæ¥...ä½†æœ‰ä½ åœ¨";
            bgColor = "#555";
        } else if (type === 'current') {
            title = "ğŸŒŠ å‘½è¿æ¿€æµ";
            desc = "ç”Ÿæ´»æƒ³æŠŠæˆ‘ä»¬å†²æ•£ï¼ŒåšæŒä½ï¼";
            // æ¿€æµåŠ›åº¦å¢å¼º
            const angle = Math.random() * Math.PI * 2;
            const strength = 6 + Math.random() * 4;
            currentForce.x = Math.cos(angle) * strength;
            currentForce.y = Math.sin(angle) * strength;
            bgColor = "#0077be";

            flowParticles = [];
            for(let i=0; i<60; i++) {
                flowParticles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    len: Math.random() * 30 + 10,
                    speed: Math.random() * 0.5 + 0.5
                });
            }

        } else if (type === 'starfall') {
            title = "ğŸŒ  å¹¸è¿æµæ˜Ÿ";
            desc = "å±äºæˆ‘ä»¬çš„é«˜å…‰æ—¶åˆ»ï¼Œå¿«è®¸æ„¿ï¼";
            bgColor = "#FFD700";
        }

        eventTitle.innerText = title;
        eventDesc.innerText = desc;
        eventTitle.style.color = bgColor;
        eventBanner.style.opacity = 1;

        setTimeout(() => { eventBanner.style.opacity = 0; }, 4000);
    }

    function updateEventLogic() {
        if (currentEvent) {
            eventTimer--;

            if (currentEvent === 'current') {
                player.x += currentForce.x;
                player.y += currentForce.y;
                if (guardian.active) {
                    guardian.x += currentForce.x * 0.8;
                    guardian.y += currentForce.y * 0.8;
                }
            }

            if (currentEvent === 'starfall' && frameCount % 45 === 0) {
                const star = new Item(currentDifficulty);
                star.type = 'heart'; star.subtype = 'star';
                star.color = '#FFD700'; star.score = 50; star.fever = 15;
                star.speed *= 2;
                items.push(star);
            }

            if (eventTimer <= 0) {
                currentEvent = null;
                spawnFloatingText("é£å¹³æµªé™äº†...", player.x, player.y - 50, '#fff');
            }
        } else {
            nextEventCooldown--;
            if (nextEventCooldown <= 0) {
                const probs = currentDifficulty.eventProb;
                const rand = Math.random();
                if (rand < probs.fog) triggerEvent('fog');
                else if (rand < probs.fog + probs.current) triggerEvent('current');
                else triggerEvent('starfall');

                nextEventCooldown = Math.random() * 1000 + 1000;
            }
        }
    }

    function addFever(baseAmount) {
        if (isFeverMode) return;
        const gain = baseAmount * currentDifficulty.feverFactor;
        feverValue = Math.min(100, feverValue + gain);
        feverBar.style.width = feverValue + "%";
        if (feverValue >= 100) { activateFever(); }
    }

    function activateFever() {
        isFeverMode = true; feverTimer = 300;
        spawnFloatingText("ğŸ”¥ æ‹çˆ±çˆ†å‘! æ— æ•Œ! ğŸ”¥", canvas.width/2 - 100, canvas.height/2, '#FF1493', 30);
        body.classList.add('fever-mode-bg');
        if(navigator.vibrate) navigator.vibrate([100,50,100]);
    }

    // ================= è§’è‰²ç±» =================
    class Player {
        constructor() {
            this.x = canvas.width / 2; this.y = canvas.height / 2;
            this.radius = 10; this.angle = 0;
            this.buffs = { speed: 0, magnet: 0, slowed: 0 }; // æ–°å¢ slowed
        }
        update() {
            const dx = input.x - this.x; const dy = input.y - this.y;

            let speed = 0.08;
            if (this.buffs.speed > 0) speed = 0.12;
            // æ ¸å¿ƒä¿®æ”¹ï¼šå†°å†»çŠ¶æ€é€Ÿåº¦ææ…¢
            if (this.buffs.slowed > 0) speed = 0.025;
            // Fever ä¼˜å…ˆçº§æœ€é«˜ï¼Œå…ç–«å‡é€Ÿ
            if (isFeverMode) speed = 0.15;

            if (Math.hypot(dx, dy) > 5) {
                this.angle = Math.atan2(dy, dx);
                this.x += dx * speed; this.y += dy * speed;
            }
            this.x = Math.max(this.radius, Math.min(canvas.width - this.radius, this.x));
            this.y = Math.max(this.radius, Math.min(canvas.height - this.radius, this.y));

            if (this.buffs.speed > 0) this.buffs.speed--;
            if (this.buffs.magnet > 0) this.buffs.magnet--;
            if (this.buffs.slowed > 0) this.buffs.slowed--; // å‡é€Ÿå€’è®¡æ—¶

            if (isFeverMode) {
                feverTimer--; feverBar.style.width = (feverTimer / 300 * 100) + "%";
                if (feverTimer <= 0) {
                    isFeverMode = false; feverValue = 0;
                    body.classList.remove('fever-mode-bg');
                    spawnFloatingText("æ¿€æƒ…é€€å»...", this.x, this.y, '#ccc');
                }
            }
        }
        draw() {
            ctx.save(); ctx.translate(this.x, this.y);
            if (isFeverMode) {
                ctx.beginPath(); const hue = (frameCount * 5) % 360;
                ctx.strokeStyle = `hsla(${hue}, 100%, 50%, 0.8)`; ctx.lineWidth = 4;
                ctx.arc(0, 0, this.radius * 2.5, 0, Math.PI * 2); ctx.stroke();
            }
            // å†°å†»çŠ¶æ€å…‰ç¯
            if (this.buffs.slowed > 0 && !isFeverMode) {
                ctx.beginPath(); ctx.strokeStyle = '#00BCD4'; ctx.lineWidth = 3;
                ctx.arc(0, 0, this.radius * 2.2, 0, Math.PI * 2); ctx.stroke();
            }
            if (this.buffs.magnet > 0 || isFeverMode) {
                ctx.beginPath(); ctx.strokeStyle = 'rgba(255, 215, 0, 0.3)'; ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]); ctx.arc(0, 0, isFeverMode ? 250 : 150, 0, Math.PI * 2); ctx.stroke();
            }
            ctx.beginPath(); ctx.fillStyle = 'rgba(255, 182, 193, 0.3)';
            ctx.arc(0, 0, this.radius * 2.0 + Math.sin(frameCount * 0.1) * 2, 0, Math.PI * 2); ctx.fill();
            ctx.restore();
            drawCuteFish(ctx, this.x, this.y, this.radius, this.angle, '#FF69B4', true, null);
        }
    }

    class Guardian {
        constructor() {
            this.active = false; this.x = -100; this.y = -100;
            this.radius = 10; this.angle = 0;
        }
        update(targetX, targetY) {
            if (!this.active) return;
            const targetX_delayed = targetX - Math.cos(player.angle) * 25;
            const targetY_delayed = targetY - Math.sin(player.angle) * 25;
            const dx = targetX_delayed - this.x; const dy = targetY_delayed - this.y;
            this.angle = Math.atan2(dy, dx);
            this.x += dx * 0.08; this.y += dy * 0.08;
        }
        draw() {
            if (!this.active) return;
            ctx.save(); ctx.translate(this.x, this.y);
            ctx.beginPath(); ctx.fillStyle = 'rgba(0, 191, 255, 0.2)';
            ctx.arc(0, 0, this.radius * 2.5, 0, Math.PI * 2); ctx.fill();
            ctx.restore();
            drawCuteFish(ctx, this.x, this.y, this.radius, this.angle, '#00BFFF', false, 'èªä»”');
        }
    }

    class Item {
        constructor(diffSettings) {
            const rand = Math.random(); const w = diffSettings.weights;
            let category = 'bad';
            if (rand < w[0]) category = 'good';
            else if (rand < w[0] + w[1]) category = 'buff';
            else category = 'bad';

            let availableItems = GAME_OBJECTS[category].filter(i => score >= i.minScore);
            if (availableItems.length === 0) availableItems = [GAME_OBJECTS[category][0]];

            let c = availableItems[Math.floor(Math.random() * availableItems.length)];
            if (c.rarity && Math.random() > c.rarity) c = availableItems[0];

            if (currentEvent) {
                if (c.subtype === 'lightning' || c.subtype === 'ice') {
                    c = GAME_OBJECTS['bad'][1];
                }
            }

            this.config = c;
            this.type = c.type; this.subtype = c.subtype || 'normal';
            this.radius = c.r; this.color = c.color;
            this.score = c.score || 0; this.fever = c.fever || 0; this.name = c.name;

            this.y = Math.random() * canvas.height;
            const minSpd = c.speed[0]; const maxSpd = c.speed[1];
            this.speed = (Math.random()*(maxSpd - minSpd) + minSpd) * diffSettings.speedMultiplier;

            const side = Math.random() < 0.5 ? 'left' : 'right';
            const margin = this.radius * 3;
            if (side === 'left') { this.x = -margin; this.vx = this.speed; }
            else { this.x = canvas.width + margin; this.vx = -this.speed; }
        }
        update() {
            this.x += this.vx;
            if (this.subtype === 'lightning') this.y += Math.sin(this.x * 0.05) * 5;

            const magnetActive = player.buffs.magnet > 0 || isFeverMode;
            const canMagnet = (this.type === 'heart' || this.type === 'buff') || isFeverMode;

            if (magnetActive && canMagnet) {
                const range = isFeverMode ? 300 : 200;
                const dist = Math.hypot(player.x - this.x, player.y - this.y);
                if (dist < range) {
                    this.x += (player.x - this.x) * (isFeverMode ? 0.12 : 0.05);
                    this.y += (player.y - this.y) * (isFeverMode ? 0.12 : 0.05);
                }
            }
        }
        draw() {
            ctx.save(); ctx.translate(this.x, this.y);
            if (this.type === 'heart') {
                if (this.subtype === 'star') drawStar(ctx, 0, 0, 5, this.radius, this.radius/2, this.color);
                else if (this.subtype === 'diamond') drawDiamond(ctx, this.radius, this.color);
                else drawHeart(ctx, 0, 0, this.radius, this.color);
            }
            else if (this.type === 'buff') {
                ctx.beginPath(); ctx.arc(0, 0, this.radius, 0, Math.PI * 2); ctx.fillStyle = 'white'; ctx.fill();
                ctx.strokeStyle = this.color; ctx.lineWidth = 3; ctx.stroke();
                ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.font = '14px Arial';
                if (this.subtype === 'candy') ctx.fillText('ğŸ¬', 0, 0);
                else if (this.subtype === 'summon') ctx.fillText('ğŸ›¡ï¸', 0, 0);
                else if (this.subtype === 'magnet') ctx.fillText('ğŸ§²', 0, 0);
            }
            else {
                if (this.vx < 0) ctx.scale(-1, 1);
                ctx.fillStyle = this.color;
                if (this.subtype === 'lightning') {
                    ctx.beginPath(); ctx.moveTo(0, -this.radius); ctx.lineTo(this.radius/2, 0); ctx.lineTo(-this.radius/2, 0); ctx.lineTo(0, this.radius); ctx.fill();
                } else if (this.subtype === 'ice') {
                    ctx.globalAlpha = 0.7; ctx.roundRect(-this.radius, -this.radius, this.radius*2, this.radius*2, 5); ctx.fill();
                    ctx.globalAlpha = 1.0; ctx.strokeStyle = 'white'; ctx.stroke();
                    ctx.fillStyle = 'white'; ctx.fillText('-_-', -10, 5);
                } else if (this.subtype === 'puffer') {
                    ctx.beginPath(); ctx.arc(0,0,this.radius, 0, Math.PI*2); ctx.fill();
                    for(let i=0; i<8; i++) { const ang = i * Math.PI/4; ctx.beginPath(); ctx.moveTo(Math.cos(ang)*this.radius, Math.sin(ang)*this.radius); ctx.lineTo(Math.cos(ang)*(this.radius+5), Math.sin(ang)*(this.radius+5)); ctx.strokeStyle = this.color; ctx.lineWidth=2; ctx.stroke(); }
                    ctx.fillStyle='white'; ctx.beginPath(); ctx.arc(5, -5, 5, 0, Math.PI*2); ctx.fill(); ctx.fillStyle='black'; ctx.beginPath(); ctx.arc(6, -5, 2, 0, Math.PI*2); ctx.fill();
                } else if (this.subtype === 'whale') {
                    ctx.beginPath(); ctx.ellipse(0, 0, this.radius*1.5, this.radius*0.8, 0, 0, Math.PI*2); ctx.fill();
                    ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(this.radius*0.8, -this.radius*0.2, this.radius*0.1, 0, Math.PI*2); ctx.fill();
                } else if (this.subtype === 'shark') {
                    ctx.beginPath(); ctx.ellipse(0, 0, this.radius*1.8, this.radius*0.6, 0, 0, Math.PI*2); ctx.fill();
                    ctx.beginPath(); ctx.moveTo(0, -this.radius*0.5); ctx.lineTo(this.radius*0.5, -this.radius*1.2); ctx.lineTo(this.radius*0.8, -this.radius*0.5); ctx.fill();
                    ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(this.radius, -this.radius*0.1, 5, 0, Math.PI*2); ctx.fill();
                } else if (this.subtype === 'octopus') {
                    ctx.beginPath(); ctx.arc(0, -5, this.radius*0.8, Math.PI, 0); ctx.lineTo(this.radius*0.8, 5); ctx.quadraticCurveTo(5, 15, 0, 5); ctx.quadraticCurveTo(-5, 15, -this.radius*0.8, 5); ctx.fill();
                    ctx.fillStyle='white'; ctx.beginPath(); ctx.arc(5, -5, 5, 0, Math.PI*2); ctx.fill(); ctx.fillStyle='black'; ctx.beginPath(); ctx.arc(5, -5, 2, 0, Math.PI*2); ctx.fill();
                } else if (this.subtype === 'shadow') {
                    ctx.globalAlpha = 0.8; ctx.beginPath(); ctx.moveTo(this.radius, 0); ctx.lineTo(-this.radius, -10); ctx.lineTo(-this.radius, 10); ctx.fill();
                    ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(0, -5, 3, 0, Math.PI*2); ctx.fill(); ctx.globalAlpha = 1.0;
                } else {
                    drawCuteFish(ctx, 0, 0, this.radius, 0, this.color, false, null);
                    ctx.save(); ctx.translate(this.radius*0.4, -this.radius*0.2); ctx.rotate(0.2); ctx.fillStyle = 'white'; ctx.fillRect(0,0,5,2); ctx.restore();
                }
            }
            ctx.restore();
        }
    }

    function init(difficultyKey) {
        currentDifficulty = DIFFICULTY_SETTINGS[difficultyKey];
        player = new Player();
        guardian = new Guardian();
        items = [];
        score = 0;
        feverValue = 0; isFeverMode = false;
        feverBar.style.width = "0%";
        body.style.background = "linear-gradient(to bottom, #ff9a9e, #fad0c4)";
        body.classList.remove('fever-mode-bg');
        scoreEl.innerText = score;
        sizeEl.innerText = 1;
        frameCount = 0;
        isPaused = false;
        unlockedStages = { 500: false, 1000: false, 2000: false, 3000: false };
        currentEvent = null; nextEventCooldown = 600; eventBanner.style.opacity = 0;
        input.x = canvas.width / 2; input.y = canvas.height / 2;
        updateBuffUI(player.buffs, guardian.active);
    }

    function gameLoop() {
        if (!gameRunning) return;
        if (isPaused) return;

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        player.update();
        updateBuffUI(player.buffs, guardian.active);
        if (guardian.active) { guardian.update(player.x, player.y); guardian.draw(); }
        player.draw();

        updateEventLogic();

        frameCount++;
        if (frameCount % currentDifficulty.spawnRate === 0) {
            items.push(new Item(currentDifficulty));
        }

        for (let i = items.length - 1; i >= 0; i--) {
            let item = items[i];
            item.update();
            item.draw();

            if (item.x < -200 || item.x > canvas.width + 200) { items.splice(i, 1); continue; }

            const dist = Math.hypot(player.x - item.x, player.y - item.y);
            if (dist < player.radius + item.radius) {

                if (item.type === 'heart') {
                    items.splice(i, 1);
                    score += item.score;
                    addFever(item.fever || 5);
                    scoreEl.innerText = score;
                    checkGameEvolution();
                    spawnFloatingText(item.name + "!", player.x, player.y - 30, item.color);

                    if (item.subtype === 'diamond') { feverValue = 100; activateFever(); }

                    if (player.radius < 60) {
                        player.radius += 0.05;
                        if (guardian.active) guardian.radius += 0.04;
                        sizeEl.innerText = Math.floor(player.radius - 9);
                    }
                }
                else if (item.type === 'buff') {
                    items.splice(i, 1);
                    if (item.subtype === 'summon') {
                        if (guardian.active) spawnFloatingText("èªä»”åœ¨å‘¢!", player.x, player.y - 30, '#00BFFF');
                        else { guardian.active = true; guardian.x = player.x - 50; guardian.y = player.y; spawnFloatingText("èªä»”å®ˆæŠ¤!", player.x, player.y - 30, '#00BFFF'); }
                    } else {
                        spawnFloatingText(item.name + "!", player.x, player.y - 30, item.color);
                        if (item.subtype === 'candy') player.buffs.speed = 300;
                        if (item.subtype === 'magnet') player.buffs.magnet = 400;
                    }
                }
                else if (item.type === 'bad') {
                    if (isFeverMode) {
                        items.splice(i, 1);
                        spawnFloatingText("ç²‰ç¢éšœç¢!", player.x, player.y - 30, '#FF1493', 24);
                        score += 10; scoreEl.innerText = score;
                        if(navigator.vibrate) navigator.vibrate(50);
                    }
                    else if (item.subtype === 'ice') {
                        items.splice(i, 1);
                        spawnFloatingText("å†»ç»“! å‡é€Ÿ!", player.x, player.y - 30, '#00BCD4');
                        player.buffs.slowed = 180; // 3ç§’å‡é€Ÿ
                        player.buffs.speed = 0;    // ç§»é™¤åŠ é€Ÿ
                    }
                    else {
                        if (player.radius > item.radius) {
                            items.splice(i, 1);
                            spawnFloatingText("æ‰“è´¥" + item.name + "!", player.x, player.y - 30);
                            score += 5; scoreEl.innerText = score;
                        } else {
                            if (guardian.active) {
                                items.splice(i, 1);
                                guardian.active = false;
                                spawnFloatingText("èªä»”æŒ¡åˆ€!", player.x, player.y - 40, '#ff4444');
                                if(navigator.vibrate) navigator.vibrate(200);
                            } else {
                                deathReasonEl.innerText = `è¢«"${item.name}"ç»Šå€’äº†...`;
                                endGame();
                            }
                        }
                    }
                }
            }
        }

        if (currentEvent === 'current') {
            ctx.save();
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.15)'; ctx.lineWidth = 2; ctx.beginPath();
            flowParticles.forEach(p => {
                p.x += currentForce.x * 2; p.y += currentForce.y * 2;
                if(p.x > canvas.width) p.x = 0; else if(p.x < 0) p.x = canvas.width;
                if(p.y > canvas.height) p.y = 0; else if(p.y < 0) p.y = canvas.height;
                ctx.moveTo(p.x, p.y); ctx.lineTo(p.x - currentForce.x * 2, p.y - currentForce.y * 2);
            });
            ctx.stroke(); ctx.restore();
        }

        if (currentEvent === 'fog') {
            const fogR = currentDifficulty.fogRadius || 100;
            const grad = ctx.createRadialGradient(player.x, player.y, fogR, player.x, player.y, Math.max(canvas.width, canvas.height)/2);
            grad.addColorStop(0, "rgba(0,0,0,0)");
            grad.addColorStop(1, "rgba(0,0,0,0.98)");
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        animationId = requestAnimationFrame(gameLoop);
    }

    function startGame(difficulty) {
        startScreen.style.display = 'none'; gameOverScreen.style.display = 'none'; pauseScreen.style.display = 'none';
        uiLayer.style.display = 'block'; pauseBtn.style.display = 'flex';
        init(difficulty); gameRunning = true; gameLoop();
    }
    function pauseGame() { if (!gameRunning) return; isPaused = true; cancelAnimationFrame(animationId); pauseScreen.style.display = 'flex'; }
    function resumeGame() { isPaused = false; pauseScreen.style.display = 'none'; gameLoop(); }
    function quitGameFromPause() { pauseScreen.style.display = 'none'; deathReasonEl.innerText = "ä¼‘æ¯å¥½äº†å—ï¼Ÿéšæ—¶éƒ½å¯ä»¥å›æ¥å“¦~"; endGame(); }
    function showStartScreen() {
        startScreen.style.display = 'flex'; gameOverScreen.style.display = 'none'; uiLayer.style.display = 'none';
        pauseBtn.style.display = 'none'; pauseScreen.style.display = 'none'; ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
    function endGame() {
        gameRunning = false; isPaused = false; cancelAnimationFrame(animationId);
        finalScoreEl.innerText = score; pauseBtn.style.display = 'none'; gameOverScreen.style.display = 'flex';
        body.classList.remove('fever-mode-bg'); body.style.background = "linear-gradient(to bottom, #ff9a9e, #fad0c4)";
    }

    showStartScreen();
</script>
</body>
</html>